<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>لوحة التحكم - نظام الشكاوى الموحد</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        *{box-sizing:border-box;margin:0;padding:0;font-family:'Cairo',sans-serif;-webkit-tap-highlight-color:transparent}
        html{font-size:16px;scroll-behavior:smooth}
        body{background:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%);color:#333;line-height:1.6;min-height:100vh;overflow-x:hidden;padding-bottom:80px}
        .container{max-width:1400px;margin:0 auto;padding:15px}
        .login-container{display:flex;justify-content:center;align-items:center;min-height:100vh;padding:20px;background:linear-gradient(135deg,#1a5fb4 0%,#2d8fd5 100%)}
        .login-box{background:#fff;border-radius:20px;padding:30px 25px;width:100%;max-width:400px;box-shadow:0 20px 40px rgba(0,0,0,.2);text-align:center;animation:slideUp .5s ease}
        @keyframes slideUp{from{opacity:0;transform:translateY(50px)}to{opacity:1;transform:translateY(0)}}
        .login-logo{font-size:3rem;color:#1a5fb4;margin-bottom:15px}
        .login-title{font-size:1.6rem;color:#2c3e50;margin-bottom:25px;font-weight:700}
        .login-form .form-group{margin-bottom:20px;text-align:right}
        .login-form .form-label{display:block;margin-bottom:8px;font-weight:600;color:#2c3e50;font-size:1rem}
        .login-form .form-control{width:100%;padding:16px 15px;border:2px solid #ddd;border-radius:10px;font-size:16px;transition:all .3s;background:#f8f9fa}
        .login-form .form-control:focus{border-color:#1a5fb4;outline:none;box-shadow:0 0 0 3px rgba(26,95,180,.1);background:#fff}
        .login-btn{width:100%;padding:18px;background:linear-gradient(to right,#1a5fb4,#2d8fd5);color:#fff;border:none;border-radius:10px;font-size:18px;font-weight:700;cursor:pointer;transition:all .3s;display:flex;align-items:center;justify-content:center;gap:10px;margin-top:10px}
        .login-btn:hover{background:linear-gradient(to right,#155093,#1a5fb4);transform:translateY(-2px);box-shadow:0 10px 20px rgba(0,0,0,.15)}
        .login-error{color:#e74c3c;margin-top:15px;padding:15px;background:#fde8e8;border-radius:10px;display:none;font-size:.95rem}
        header{background:linear-gradient(135deg,#1a5fb4 0%,#2d8fd5 100%);color:#fff;padding:20px 0 25px;text-align:center;border-radius:0 0 25px 25px;box-shadow:0 8px 25px rgba(0,0,0,.15);margin-bottom:20px;position:relative;overflow:hidden}
        header::before{content:'';position:absolute;top:0;left:0;right:0;height:5px;background:linear-gradient(90deg,#ff7e5f,#feb47b,#86a8e7,#91eae4);background-size:400% 400%;animation:gradientShift 8s ease infinite}
        @keyframes gradientShift{0%{background-position:0 50%}50%{background-position:100% 50%}100%{background-position:0 50%}}
        .logo{font-size:1.8rem;margin-bottom:8px;text-shadow:2px 2px 4px rgba(0,0,0,.2);padding:0 15px;line-height:1.4}
        .subtitle{font-size:1rem;opacity:.9;max-width:600px;margin:0 auto;padding:0 15px;line-height:1.5}
        .admin-bar{background:linear-gradient(135deg,#2c3e50 0%,#4a6572 100%);color:#fff;padding:15px;border-radius:15px;margin-bottom:20px;box-shadow:0 5px 15px rgba(0,0,0,.1);display:flex;flex-direction:column;gap:15px}
        .admin-info{display:flex;align-items:center;gap:12px}
        .admin-avatar{width:50px;height:50px;border-radius:50%;background:linear-gradient(135deg,#3498db,#2c3e50);display:flex;align-items:center;justify-content:center;font-size:1.4rem;box-shadow:0 4px 10px rgba(0,0,0,.2);flex-shrink:0}
        .admin-text{flex-grow:1;overflow:hidden}
        .admin-text h3{margin-bottom:5px;font-size:1.1rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .admin-text p{opacity:.9;font-size:.85rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .admin-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
        .stat-box{background:rgba(255,255,255,.15);padding:12px 8px;border-radius:10px;text-align:center;backdrop-filter:blur(10px)}
        .stat-value{font-size:1.5rem;font-weight:700;margin-bottom:5px}
        .stat-label{font-size:.8rem;opacity:.9;line-height:1.3}
        .logout-btn{background:#e74c3c;color:#fff;border:none;padding:12px 20px;border-radius:10px;cursor:pointer;font-weight:600;transition:all .3s;display:flex;align-items:center;justify-content:center;gap:8px;font-size:1rem;width:100%}
        .logout-btn:hover{background:#c0392b;transform:translateY(-2px)}
        .dashboard-grid{display:flex;flex-direction:column;gap:20px}
        .sidebar-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);z-index:999;animation:fadeIn .3s ease}
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        .sidebar{background:#fff;border-radius:20px 0 0 20px;padding:25px 20px;box-shadow:0 0 30px rgba(0,0,0,.3);height:100vh;width:280px;position:fixed;top:0;right:-300px;z-index:1000;transition:right .3s ease;overflow-y:auto}
        .sidebar.active{right:0}
        .sidebar-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;padding-bottom:15px;border-bottom:2px solid #f0f0f0}
        .sidebar-title{font-size:1.3rem;color:#2c3e50;font-weight:700}
        .close-sidebar{background:none;border:none;font-size:1.5rem;color:#666;cursor:pointer;padding:5px}
        .sidebar-menu{list-style:none}
        .menu-item{padding:16px 15px;margin-bottom:8px;border-radius:12px;cursor:pointer;transition:all .3s ease;display:flex;align-items:center;gap:12px;color:#555;font-size:1rem;position:relative}
        .menu-item:hover{background:#f8f9fa;transform:translateX(-5px)}
        .menu-item.active{background:linear-gradient(to right,#1a5fb4,#2d8fd5);color:#fff;box-shadow:0 5px 15px rgba(26,95,180,.3)}
        .menu-icon{font-size:1.2rem;width:24px;text-align:center}
        .badge{background:#e74c3c;color:#fff;border-radius:50%;padding:4px 8px;font-size:.75rem;margin-right:auto;display:inline-block;min-width:22px;text-align:center;font-weight:700;animation:pulse 2s infinite}
        @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
        .main-content{background:#fff;border-radius:20px;padding:20px;box-shadow:0 5px 20px rgba(0,0,0,.08);margin-bottom:80px}
        .footer{text-align:center;padding:20px 15px;color:#666;font-size:.9rem;margin-top:30px;background:#fff;border-radius:15px;box-shadow:0 5px 15px rgba(0,0,0,.05);line-height:1.7}
        .footer a{color:#1a5fb4;text-decoration:none;font-weight:700;display:inline-flex;align-items:center;gap:6px}
        .footer a:hover{color:#155093}
        .admin-only{display:none}
        .loading-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,.9);display:none;justify-content:center;align-items:center;z-index:9999}
        .loading-spinner{width:60px;height:60px;border:5px solid #f3f3f3;border-top:5px solid #1a5fb4;border-radius:50%;animation:spin 1s linear infinite}
        @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
        .message{position:fixed;top:20px;right:20px;padding:15px 20px;border-radius:12px;z-index:10000;box-shadow:0 10px 30px rgba(0,0,0,.2);max-width:90%;animation:slideInMessage .3s ease;font-size:.95rem;line-height:1.5;background:#d4edda;color:#155724}
        .message.error{background:#f8d7da;color:#721c24}
        @keyframes slideInMessage{from{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:translateY(0)}}
        .complaint-details-modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.9);display:none;justify-content:center;align-items:center;z-index:1100;padding:15px}
        .modal-content{background:#fff;border-radius:20px;width:100%;max-width:900px;max-height:90vh;overflow-y:auto;position:relative;animation:modalSlideUp .3s ease}
        @keyframes modalSlideUp{from{opacity:0;transform:translateY(50px)}to{opacity:1;transform:translateY(0)}}
        .modal-header{background:linear-gradient(135deg,#1a5fb4 0%,#2d8fd5 100%);color:#fff;padding:20px;border-radius:20px 20px 0 0;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:1}
        .modal-title{font-size:1.4rem;font-weight:700}
        .close-modal{background:none;border:none;color:#fff;font-size:2rem;cursor:pointer;line-height:1;padding:5px}
        .modal-body{padding:20px}
        .details-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:15px;margin-bottom:20px}
        .detail-item{padding:15px;border-bottom:1px solid #eee;background:#f8f9fa;border-radius:10px}
        .detail-item.full-width{grid-column:1/-1}
        .detail-label{font-weight:700;color:#1a5fb4;margin-bottom:8px;font-size:.95rem}
        .detail-value{color:#333;line-height:1.6;white-space:pre-wrap;word-break:break-word}
        .action-btn{padding:10px 15px;border:none;border-radius:8px;cursor:pointer;font-size:.9rem;display:flex;align-items:center;justify-content:center;gap:5px;transition:all .2s.ease;min-width:100px;font-weight:600}
        .btn-view{background:#3498db;color:#fff}
        .btn-view:hover{background:#2980b9}
        .btn-reply{background:#9b59b6;color:#fff}
        .btn-reply:hover{background:#8e44ad}
        .btn-edit{background:#f39c12;color:#fff}
        .btn-edit:hover{background:#e67e22}
        .btn-delete{background:#e74c3c;color:#fff}
        .btn-delete:hover{background:#c0392b}
        .btn-status{background:#27ae60;color:#fff}
        .btn-status:hover{background:#229954}
        .btn-secondary{background:#6c757d;color:#fff}
        .btn-secondary:hover{background:#5a6268}
        .mobile-menu-btn{display:flex;align-items:center;justify-content:center;gap:8px;background:#1a5fb4;color:#fff;border:none;padding:12px 15px;border-radius:10px;cursor:pointer;font-weight:600;margin-bottom:15px;width:100%;display:none}
        .content-section{display:none}
        .content-section.active{display:block}
        .section-header{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:15px;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #f0f0f0}
        .section-title{font-size:1.5rem;color:#2c3e50;font-weight:700}
        .section-controls{display:flex;gap:10px;flex-wrap:wrap}
        .filter-controls{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:20px}
        .filter-group{flex:1;min-width:150px}
        .filter-label{display:block;margin-bottom:5px;font-weight:600;color:#555;font-size:.9rem}
        .filter-select,.filter-input{width:100%;padding:10px;border:2px solid #ddd;border-radius:8px;font-size:.9rem;background:#f8f9fa}
        .filter-select:focus,.filter-input:focus{border-color:#1a5fb4;outline:none;background:#fff}
        .cards-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:20px;margin-bottom:30px}
        .card{background:#fff;border-radius:15px;padding:20px;box-shadow:0 5px 15px rgba(0,0,0,.08);transition:all .3s ease;border:1px solid #eee}
        .card:hover{transform:translateY(-5px);box-shadow:0 15px 30px rgba(0,0,0,.15)}
        .card-icon{font-size:2.5rem;margin-bottom:15px;width:60px;height:60px;display:flex;align-items:center;justify-content:center;border-radius:12px}
        .card-title{font-size:1.1rem;color:#2c3e50;margin-bottom:10px;font-weight:600}
        .card-value{font-size:2.2rem;font-weight:700;color:#1a5fb4;margin-bottom:5px}
        .card-label{font-size:.9rem;color:#666}
        .card-trend{font-size:.85rem;margin-top:10px;display:flex;align-items:center;gap:5px}
        .trend-up{color:#27ae60}
        .trend-down{color:#e74c3c}
        .priority-card.high{background:linear-gradient(135deg,#ff6b6b,#ff8e8e);color:#fff}
        .priority-card.medium{background:linear-gradient(135deg,#f39c12,#f1c40f);color:#fff}
        .priority-card.low{background:linear-gradient(135deg,#2ecc71,#27ae60);color:#fff}
        .status-badge{padding:4px 12px;border-radius:20px;font-size:.8rem;font-weight:600;display:inline-block}
        .status-new{background:#e3f2fd;color:#1565c0}
        .status-in-progress{background:#fff3e0;color:#f57c00}
        .status-resolved{background:#e8f5e9;color:#2e7d32}
        .status-closed{background:#f5f5f5;color:#616161}
        .complaints-table-container{overflow-x:auto;margin-bottom:20px;border-radius:10px;border:1px solid #eee}
        .complaints-table{width:100%;border-collapse:collapse;min-width:900px}
        .complaints-table thead{background:linear-gradient(135deg,#1a5fb4,#2d8fd5);color:#fff}
        .complaints-table th{padding:15px 10px;text-align:right;font-weight:600;font-size:.95rem;white-space:nowrap}
        .complaints-table tbody tr{border-bottom:1px solid #eee;transition:background .2s}
        .complaints-table tbody tr:hover{background:#f8f9fa}
        .complaints-table tbody tr.unread{background:#fff9e6;font-weight:600}
        .complaints-table td{padding:15px 10px;text-align:right;font-size:.9rem}
        .complaints-table .actions{display:flex;gap:8px;flex-wrap:wrap}
        .pagination{display:flex;justify-content:center;align-items:center;gap:10px;margin-top:20px;flex-wrap:wrap}
        .pagination-btn{background:#f8f9fa;border:1px solid #ddd;padding:8px 15px;border-radius:8px;cursor:pointer;font-size:.9rem;transition:all .2s}
        .pagination-btn:hover{background:#e9ecef}
        .pagination-btn:disabled{opacity:.5;cursor:not-allowed}
        .pagination-btn.active{background:#1a5fb4;color:#fff;border-color:#1a5fb4}
        .pagination-info{color:#666;font-size:.9rem}
        .responses-container{margin:25px 0;padding:20px;background:#f8f9fa;border-radius:12px;border:2px solid #e0e0e0}
        .responses-title{color:#2c3e50;margin-bottom:15px;display:flex;align-items:center;gap:10px;font-size:1.2rem;font-weight:700}
        .responses-list{display:flex;flex-direction:column;gap:12px}
        .response-item{padding:15px;border-radius:10px;animation:fadeIn .3s ease}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        .response-admin{background:linear-gradient(135deg,#d4edda,#c3e6cb);border-right:4px solid #28a745;margin-right:20px}
        .response-client{background:linear-gradient(135deg,#e3f2fd,#bbdefb);border-left:4px solid #3498db;margin-left:20px}
        .response-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap;gap:10px}
        .response-sender{display:flex;align-items:center;gap:8px;font-weight:600;color:#2c3e50}
        .response-time{font-size:.85rem;color:#666;font-weight:500}
        .response-content{white-space:pre-line;line-height:1.6;padding:10px;background:rgba(255,255,255,.7);border-radius:8px;margin-top:8px;color:#333}
        .reply-form{margin-top:20px;padding:20px;background:#f8f9fa;border-radius:12px;border:2px solid #e0e0e0}
        .reply-form h4{color:#2c3e50;margin-bottom:15px;display:flex;align-items:center;gap:10px}
        .reply-form textarea{width:100%;min-height:120px;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:.95rem;resize:vertical;font-family:'Cairo',sans-serif}
        .reply-form textarea:focus{border-color:#1a5fb4;outline:none;background:#fff}
        .reply-form .form-actions{display:flex;gap:10px;margin-top:15px;flex-wrap:wrap}
        .status-form{margin-top:20px;padding:20px;background:#f8f9fa;border-radius:12px;border:2px solid #e0e0e0}
        .status-form h4{color:#2c3e50;margin-bottom:15px;display:flex;align-items:center;gap:10px}
        .status-form select{width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:.95rem;background:#fff}
        .status-form select:focus{border-color:#1a5fb4;outline:none}
        .status-form .form-actions{display:flex;gap:10px;margin-top:15px;flex-wrap:wrap}
        .mobile-nav{position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:2px solid #1a5fb4;display:flex;justify-content:space-around;padding:12px 10px;z-index:999;box-shadow:0 -5px 20px rgba(0,0,0,.1);display:none}
        .mobile-nav-item{display:flex;flex-direction:column;align-items:center;gap:5px;color:#666;text-decoration:none;font-size:.8rem;flex:1;padding:8px 5px;border-radius:10px;transition:all .2s}
        .mobile-nav-item.active{background:#1a5fb4;color:#fff}
        .mobile-nav-icon{font-size:1.2rem}
        .national-id{font-family:monospace;font-size:1.05rem;letter-spacing:1px;direction:ltr;text-align:right}
        .new-request-indicator{display:inline-block;width:10px;height:10px;background:#e74c3c;border-radius:50%;margin-left:8px;animation:blink 1.5s infinite}
        @keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
        .btn-export{background:linear-gradient(135deg,#27ae60,#2ecc71);color:#fff;padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-weight:600;display:flex;align-items:center;gap:8px;font-size:.95rem}
        .btn-export:hover{background:linear-gradient(135deg,#229954,#27ae60);transform:translateY(-2px)}
        .btn-add{background:linear-gradient(135deg,#3498db,#2980b9);color:#fff;padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-weight:600;display:flex;align-items:center;gap:8px;font-size:.95rem}
        .btn-add:hover{background:linear-gradient(135deg,#2980b9,#1f618d);transform:translateY(-2px)}
        .users-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:20px;margin-top:20px}
        .user-card{background:#fff;border-radius:15px;padding:20px;box-shadow:0 5px 15px rgba(0,0,0,.08);border:1px solid #eee;transition:all .3s}
        .user-card:hover{transform:translateY(-5px);box-shadow:0 15px 30px rgba(0,0,0,.15)}
        .user-card-header{display:flex;align-items:center;gap:15px;margin-bottom:15px}
        .user-avatar{width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,#3498db,#2c3e50);display:flex;align-items:center;justify-content:center;font-size:1.5rem;color:#fff;flex-shrink:0}
        .user-info h3{color:#2c3e50;font-size:1.1rem;margin-bottom:5px}
        .user-role{display:inline-block;padding:4px 12px;border-radius:20px;font-size:.8rem;font-weight:600;background:#e3f2fd;color:#1565c0;margin-bottom:8px}
        .user-role.admin{background:#e8f5e9;color:#2e7d32}
        .user-email{font-size:.85rem;color:#666;display:flex;align-items:center;gap:5px}
        .user-departments{margin-top:12px;padding-top:12px;border-top:1px solid #eee}
        .user-departments-title{font-size:.85rem;color:#666;margin-bottom:8px;font-weight:600}
        .department-tags{display:flex;flex-wrap:wrap;gap:6px}
        .department-tag{background:#fff3e0;color:#f57c00;padding:4px 10px;border-radius:15px;font-size:.75rem;font-weight:600}
        .user-actions{display:flex;gap:8px;margin-top:15px}
        .user-actions button{flex:1;padding:8px;font-size:.85rem;min-width:0}
        .form-modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.9);display:none;justify-content:center;align-items:center;z-index:1100;padding:15px}
        .form-modal .modal-content{max-width:600px}
        .form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:15px;margin-bottom:15px}
        .form-group{display:flex;flex-direction:column}
        .form-group label{margin-bottom:8px;font-weight:600;color:#2c3e50;font-size:.95rem}
        .form-group input,.form-group select,.form-group textarea{padding:12px;border:2px solid #ddd;border-radius:8px;font-size:.95rem;font-family:'Cairo',sans-serif;background:#f8f9fa}
        .form-group input:focus,.form-group select:focus,.form-group textarea:focus{border-color:#1a5fb4;outline:none;background:#fff}
        .form-group.full-width{grid-column:1/-1}
        .multi-select{min-height:150px;border:2px solid #ddd;border-radius:8px;padding:10px;background:#f8f9fa;max-height:200px;overflow-y:auto}
        .multi-select label{display:flex;align-items:center;gap:10px;padding:8px;margin-bottom:5px;cursor:pointer;border-radius:5px;transition:background .2s}
        .multi-select label:hover{background:#e9ecef}
        .multi-select input[type="checkbox"]{width:18px;height:18px;cursor:pointer}
        .form-actions{display:flex;gap:10px;margin-top:20px;flex-wrap:wrap}
        .form-actions button{flex:1;padding:12px;min-width:120px}
        .settings-grid{display:grid;grid-template-columns:1fr;gap:20px}
        .settings-card{background:#fff;border-radius:15px;padding:25px;box-shadow:0 5px 15px rgba(0,0,0,.08);border:1px solid #eee}
        .settings-card h3{color:#2c3e50;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #f0f0f0;font-size:1.2rem}
        .setting-item{margin-bottom:20px;padding-bottom:20px;border-bottom:1px solid #eee}
        .setting-item:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0}
        .setting-label{display:block;font-weight:600;margin-bottom:8px;color:#2c3e50}
        .setting-description{font-size:.85rem;color:#666;margin-top:5px;line-height:1.5}
        .setting-input,.setting-select,.setting-textarea{width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:.95rem;background:#f8f9fa;font-family:'Cairo',sans-serif}
        .setting-input:focus,.setting-select:focus,.setting-textarea:focus{border-color:#1a5fb4;outline:none;background:#fff}
        .setting-textarea{min-height:120px;resize:vertical}
        .toggle-switch{position:relative;display:inline-block;width:60px;height:34px;vertical-align:middle}
        .toggle-switch input{opacity:0;width:0;height:0}
        .toggle-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;transition:.4s;border-radius:34px}
        .toggle-slider:before{position:absolute;content:"";height:26px;width:26px;left:4px;bottom:4px;background-color:white;transition:.4s;border-radius:50%}
        input:checked+.toggle-slider{background-color:#1a5fb4}
        input:checked+.toggle-slider:before{transform:translateX(26px)}
        .departments-list{display:flex;flex-wrap:wrap;gap:10px;margin-top:15px}
        .department-item{background:#e3f2fd;color:#1565c0;padding:10px 15px;border-radius:20px;display:flex;align-items:center;gap:10px;font-weight:600}
        .department-item .delete-dept{color:#e74c3c;cursor:pointer;font-size:1.1rem;transition:transform .2s}
        .department-item .delete-dept:hover{transform:scale(1.2)}
        .add-department-form{display:flex;gap:10px;margin-top:15px;flex-wrap:wrap}
        .add-department-form input{flex:1;min-width:200px}
        .modal-actions{display:flex;gap:10px;padding:20px;background:#f8f9fa;border-radius:0 0 20px 20px;flex-wrap:wrap}
        .modal-actions button{flex:1;min-width:120px}
        @media (max-width:768px){
            .mobile-menu-btn,.mobile-nav{display:flex}
            .cards-grid{grid-template-columns:1fr}
            .details-grid{grid-template-columns:1fr}
            .complaints-table th,.complaints-table td{padding:10px 8px;font-size:.85rem}
            .section-header{flex-direction:column;align-items:flex-start}
            .filter-controls{flex-direction:column}
            .users-grid{grid-template-columns:1fr}
            .admin-info{flex-direction:column;text-align:center}
            .admin-text h3,.admin-text p{text-align:center}
            .logo{font-size:1.5rem}
            .subtitle{font-size:.9rem}
            .response-admin{margin-right:10px}
            .response-client{margin-left:10px}
            .form-row{grid-template-columns:1fr}
            .form-actions{flex-direction:column}
            .form-actions button{width:100%}
            .modal-content{max-width:100%;max-height:95vh}
            .modal-actions{flex-direction:column}
            .modal-actions button{width:100%}
        }
        @media (min-width:769px){
            .dashboard-grid{display:grid;grid-template-columns:280px 1fr}
            .sidebar{position:static;width:100%;height:auto;right:0;box-shadow:none;border-radius:15px}
            .sidebar-overlay{display:none !important}
            .close-sidebar{display:none}
            .mobile-menu-btn,.mobile-nav{display:none}
        }
        @media (max-width:480px){
            .admin-stats{grid-template-columns:1fr}
            .card-value{font-size:1.8rem}
            .complaints-table .actions{flex-direction:column}
            .action-btn{width:100%}
        }
    </style>
</head>
<body>
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <div class="login-logo">
                <i class="fas fa-user-shield"></i>
            </div>
            <h2 class="login-title">تسجيل دخول المسؤول</h2>
            <form id="loginForm" class="login-form">
                <div class="form-group">
                    <label class="form-label">اسم المستخدم</label>
                    <input type="text" class="form-control" id="username" placeholder="أدخل اسم المستخدم" required>
                </div>
                <div class="form-group">
                    <label class="form-label">كلمة المرور</label>
                    <input type="password" class="form-control" id="password" placeholder="أدخل كلمة المرور" required>
                </div>
                <div class="login-error" id="loginError">
                    اسم المستخدم أو كلمة المرور غير صحيحة
                </div>
                <button type="submit" class="login-btn">
                    <i class="fas fa-sign-in-alt"></i>
                    تسجيل الدخول
                </button>
            </form>
        </div>
    </div>

    <div id="dashboardScreen" style="display:none;">
        <header>
            <div class="container">
                <h1 class="logo">لوحة التحكم - نظام الشكاوى الموحد</h1>
                <p class="subtitle">إدارة الشكاوى والطلبات المقدمة من المواطنين</p>
            </div>
        </header>

        <div class="container">
            <button class="mobile-menu-btn" id="mobileMenuBtn">
                <i class="fas fa-bars"></i>
                عرض القائمة
            </button>

            <div class="admin-bar">
                <div class="admin-info">
                    <div class="admin-avatar">
                        <i class="fas fa-user-shield"></i>
                    </div>
                    <div class="admin-text">
                        <h3 id="adminWelcome">مرحباً، المسؤول</h3>
                        <p id="adminLastLogin">آخر دخول: -</p>
                    </div>
                </div>

                <div class="admin-stats">
                    <div class="stat-box">
                        <div class="stat-value" id="totalComplaints">0</div>
                        <div class="stat-label">إجمالي الشكاوى</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="newComplaints">0</div>
                        <div class="stat-label">شكاوى جديدة</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="resolvedComplaints">0</div>
                        <div class="stat-label">تم حلها</div>
                    </div>
                </div>

                <button class="logout-btn" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    تسجيل الخروج
                </button>
            </div>

            <div class="dashboard-grid">
                <div class="sidebar-overlay" id="sidebarOverlay"></div>
                <div class="sidebar" id="sidebar">
                    <div class="sidebar-header">
                        <h3 class="sidebar-title">القائمة الرئيسية</h3>
                        <button class="close-sidebar" id="closeSidebar">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <ul class="sidebar-menu">
                        <li class="menu-item active" data-section="dashboard">
                            <i class="fas fa-tachometer-alt menu-icon"></i>
                            <span>لوحة التحكم</span>
                        </li>
                        <li class="menu-item" data-section="complaints">
                            <i class="fas fa-file-alt menu-icon"></i>
                            <span>إدارة الشكاوى</span>
                            <span class="badge" id="complaintsBadge" style="display:none;">0</span>
                        </li>
                        <li class="menu-item admin-only" data-section="users">
                            <i class="fas fa-users menu-icon"></i>
                            <span>المستخدمين</span>
                        </li>
                        <li class="menu-item admin-only" data-section="settings">
                            <i class="fas fa-cog menu-icon"></i>
                            <span>الإعدادات</span>
                        </li>
                        <li class="menu-item admin-only" data-section="departments">
                            <i class="fas fa-building menu-icon"></i>
                            <span>الأقسام</span>
                        </li>
                    </ul>
                </div>

                <div class="main-content">
                    <!-- قسم لوحة التحكم -->
                    <div id="dashboardSection" class="content-section active">
                        <div class="section-header">
                            <h2 class="section-title">لوحة التحكم الرئيسية</h2>
                        </div>
                        <div class="cards-grid">
                            <div class="card">
                                <div class="card-icon" style="background:#e3f2fd;color:#1565c0">
                                    <i class="fas fa-inbox"></i>
                                </div>
                                <h3 class="card-title">شكاوى جديدة</h3>
                                <div class="card-value" id="cardNewComplaints">0</div>
                                <p class="card-label">في انتظار المراجعة</p>
                            </div>

                            <div class="card">
                                <div class="card-icon" style="background:#e8f5e9;color:#2e7d32">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <h3 class="card-title">شكاوى مكتملة</h3>
                                <div class="card-value" id="cardCompletedComplaints">0</div>
                                <p class="card-label">تم حلها</p>
                            </div>

                            <div class="card">
                                <div class="card-icon" style="background:#fff3e0;color:#f57c00">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <h3 class="card-title">قيد المعالجة</h3>
                                <div class="card-value" id="cardInProgress">0</div>
                                <p class="card-label">قيد العمل</p>
                            </div>
                        </div>

                        <div class="section-header">
                            <h2 class="section-title">أحدث الشكاوى</h2>
                        </div>
                        <div class="complaints-table-container">
                            <table class="complaints-table">
                                <thead>
                                    <tr>
                                        <th>رقم الشكوى</th>
                                        <th>الاسم</th>
                                        <th>القسم</th>
                                        <th>الحالة</th>
                                        <th>التاريخ</th>
                                        <th>إجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="latestComplaintsBody">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- قسم إدارة الشكاوى -->
                    <div id="complaintsSection" class="content-section">
                        <div class="section-header">
                            <h2 class="section-title">إدارة الشكاوى</h2>
                            <div class="section-controls">
                                <button class="btn-export" onclick="exportToExcel()">
                                    <i class="fas fa-file-excel"></i>
                                    تصدير Excel
                                </button>
                            </div>
                        </div>

                        <div class="filter-controls">
                            <div class="filter-group">
                                <label class="filter-label">البحث</label>
                                <input type="text" id="searchComplaints" class="filter-input" placeholder="ابحث برقم الطلب، الاسم، الرقم القومي...">
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">القسم</label>
                                <select id="filterDepartment" class="filter-select">
                                    <option value="">جميع الأقسام</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">الحالة</label>
                                <select id="filterStatus" class="filter-select">
                                    <option value="">جميع الحالات</option>
                                    <option value="جديدة">جديدة</option>
                                    <option value="قيد المراجعة">قيد المراجعة</option>
                                    <option value="قيد المعالجة">قيد المعالجة</option>
                                    <option value="تم الرد">تم الرد</option>
                                    <option value="مكتملة">مكتملة</option>
                                    <option value="ملغاة">ملغاة</option>
                                </select>
                            </div>
                        </div>

                        <div class="complaints-table-container">
                            <table class="complaints-table">
                                <thead>
                                    <tr>
                                        <th>رقم الشكوى</th>
                                        <th>الاسم</th>
                                        <th>القسم</th>
                                        <th>الحالة</th>
                                        <th>التاريخ</th>
                                        <th>إجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="complaintsTableBody">
                                </tbody>
                            </table>
                        </div>

                        <div class="pagination">
                            <button class="pagination-btn" onclick="changePage(-1)" id="prevPage">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                            <span class="pagination-info" id="pageInfo">الصفحة 1 من 1</span>
                            <button class="pagination-btn" onclick="changePage(1)" id="nextPage">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                        </div>
                    </div>

                    <!-- قسم المستخدمين -->
                    <div id="usersSection" class="content-section">
                        <div class="section-header">
                            <h2 class="section-title">إدارة المستخدمين</h2>
                            <div class="section-controls">
                                <button class="btn-add" onclick="openAddUserModal()">
                                    <i class="fas fa-user-plus"></i>
                                    إضافة مستخدم
                                </button>
                            </div>
                        </div>
                        <div class="users-grid" id="usersGrid">
                        </div>
                    </div>

                    <!-- قسم الإعدادات -->
                    <div id="settingsSection" class="content-section">
                        <div class="section-header">
                            <h2 class="section-title">إعدادات النظام</h2>
                        </div>
                        <div class="settings-grid">
                            <div class="settings-card">
                                <h3><i class="fas fa-cog"></i> الإعدادات العامة</h3>
                                <div class="setting-item">
                                    <label class="setting-label">اسم النظام</label>
                                    <input type="text" class="setting-input" value="نظام الشكاوى الموحد" id="systemName">
                                    <p class="setting-description">الاسم الذي يظهر في رأس الموقع</p>
                                </div>
                                <div class="setting-item">
                                    <label class="setting-label">وصف النظام</label>
                                    <textarea class="setting-textarea" id="systemDescription">خدمة إلكترونية متطورة لتقديم الشكاوى والمشكلات ومتابعتها بكل سهولة</textarea>
                                    <p class="setting-description">الوصف الذي يظهر في رأس الموقع</p>
                                </div>
                                <div class="setting-item">
                                    <label class="setting-label">تفعيل الإشعارات</label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="enableNotifications" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <p class="setting-description">تفعيل إشعارات الطلبات الجديدة</p>
                                </div>
                                <button class="btn-add" onclick="saveSettings()">
                                    <i class="fas fa-save"></i>
                                    حفظ الإعدادات
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- قسم الأقسام -->
                    <div id="departmentsSection" class="content-section">
                        <div class="section-header">
                            <h2 class="section-title">إدارة الأقسام</h2>
                        </div>
                        <div class="settings-card">
                            <h3><i class="fas fa-building"></i> الأقسام المتاحة</h3>
                            <div class="departments-list" id="departmentsList">
                            </div>
                            <div class="add-department-form">
                                <input type="text" id="newDepartmentName" class="setting-input" placeholder="اسم القسم الجديد">
                                <button class="btn-add" onclick="addDepartment()">
                                    <i class="fas fa-plus"></i>
                                    إضافة قسم
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="footer">
                <p>© 2026 نظام الشكاوى الموحد - جميع الحقوق محفوظة</p>
                <p>
                    <i class="fas fa-code"></i>
                    تم برمجة الموقع بكل حب من المهندس
                    <a href="https://www.facebook.com/en.mohamed.nasr" target="_blank">
                        محمد حماد
                        <i class="fab fa-facebook"></i>
                    </a>
                </p>
            </div>
        </div>
    </div>

    <!-- نافذة عرض تفاصيل الشكوى -->
    <div id="complaintModal" class="complaint-details-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">تفاصيل الشكوى</h3>
                <button class="close-modal" onclick="closeComplaintModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="modalBody">
            </div>
        </div>
    </div>

    <!-- نافذة إضافة/تعديل مستخدم -->
    <div id="userModal" class="form-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="userModalTitle">إضافة مستخدم جديد</h3>
                <button class="close-modal" onclick="closeUserModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>الاسم الكامل</label>
                            <input type="text" id="userName" required>
                        </div>
                        <div class="form-group">
                            <label>اسم المستخدم</label>
                            <input type="text" id="userUsername" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>البريد الإلكتروني</label>
                            <input type="email" id="userEmail" required>
                        </div>
                        <div class="form-group">
                            <label>كلمة المرور</label>
                            <input type="password" id="userPassword" placeholder="اتركها فارغة للإبقاء على القديمة">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>الدور الوظيفي</label>
                        <select id="userRole">
                            <option value="user">مستخدم</option>
                            <option value="admin">مدير</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label>الأقسام المخصصة (للمستخدم العادي فقط)</label>
                        <div class="multi-select" id="userDepartments">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-actions">
                <button class="action-btn btn-view" onclick="saveUser()">
                    <i class="fas fa-save"></i>
                    حفظ
                </button>
                <button class="action-btn btn-secondary" onclick="closeUserModal()">
                    <i class="fas fa-times"></i>
                    إلغاء
                </button>
            </div>
        </div>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBIIStbiZD0ZJ6su7C1bwZlBvqx-PP-t58",
            authDomain: "shakawa-e0a3c.firebaseapp.com",
            databaseURL: "https://shakawa-e0a3c-default-rtdb.firebaseio.com",
            projectId: "shakawa-e0a3c",
            storageBucket: "shakawa-e0a3c.firebasestorage.app",
            messagingSenderId: "111620348664",
            appId: "1:111620348664:web:670fdf5caed46eb691b90d",
            measurementId: "G-SGNTJZDQ1L"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // متغيرات عامة
        let isLoggedIn = false;
        let currentUser = null;
        let settings = {};
        let allComplaints = [];
        let filteredComplaints = [];
        let allDepartments = [];
        let allUsers = [];
        let currentPage = 1;
        const itemsPerPage = 20;
        let unreadComplaints = new Set();
        let complaintsListener = null;
        let currentEditingUser = null;
        // دالة تحميل الإعدادات
        function loadSettings() {
            database.ref('settings').once('value', snapshot => {
                const data = snapshot.val() || {};
                settings = data;

                if (settings.systemName) {
                    document.getElementById('systemName').value = settings.systemName;
                    document.querySelector('.logo').textContent = settings.systemName;
                }
                if (settings.systemDescription) {
                    document.getElementById('systemDescription').value = settings.systemDescription;
                    document.querySelector('.subtitle').textContent = settings.systemDescription;
                }
                if (typeof settings.enableNotifications !== 'undefined') {
                    document.getElementById('enableNotifications').checked = settings.enableNotifications;
                }
            });
        }

        function saveSettings() {
            const systemName = document.getElementById('systemName').value.trim();
            const systemDescription = document.getElementById('systemDescription').value.trim();
            const enableNotifications = document.getElementById('enableNotifications').checked;

            const data = {
                systemName: systemName || 'نظام الشكاوى الموحد',
                systemDescription: systemDescription || 'خدمة إلكترونية متطورة لتقديم الشكاوى والمشكلات ومتابعتها بكل سهولة',
                enableNotifications
            };

            database.ref('settings').set(data)
                .then(() => {
                    settings = data;
                    document.querySelector('.logo').textContent = data.systemName;
                    document.querySelector('.subtitle').textContent = data.systemDescription;
                    showMessage('تم حفظ الإعدادات بنجاح', 'success');
                })
                .catch(() => {
                    showMessage('حدث خطأ أثناء حفظ الإعدادات', 'error');
                });
        }

        // تسجيل الدخول (ثابت admin / 742018)
        function handleLogin(username, password) {
            if (username === 'admin' && password === '742018') {
                isLoggedIn = true;
                currentUser = {
                    name: 'المكتب الخدمي للنائب أحمد الحديدي',
                    username: 'admin',
                    role: 'admin',
                    loginTime: new Date().toISOString()
                };

                localStorage.setItem('adminLoggedIn', 'true');
                localStorage.setItem('adminUser', JSON.stringify(currentUser));

                showDashboard();
                return;
            }

            // لو حابب تضيف مستخدمين من قاعدة البيانات فيما بعد يمكن استكمال الكود هنا
            showMessage('اسم المستخدم أو كلمة المرور غير صحيحة', 'error');
            const loginError = document.getElementById('loginError');
            if (loginError) loginError.style.display = 'block';
        }

        function initAuth() {
            const saved = localStorage.getItem('adminLoggedIn');
            const savedUser = localStorage.getItem('adminUser');

            if (saved === 'true' && savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    isLoggedIn = true;
                    showDashboard();
                } catch {
                    localStorage.removeItem('adminLoggedIn');
                    localStorage.removeItem('adminUser');
                }
            }
        }

        function logout() {
            isLoggedIn = false;
            currentUser = null;
            localStorage.removeItem('adminLoggedIn');
            localStorage.removeItem('adminUser');
            document.getElementById('dashboardScreen').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'flex';
        }

        function showDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboardScreen').style.display = 'block';
            updateAdminWelcome();
            updateSidebarPermissions();
            showSection('dashboard');
            loadSettings();
            loadDepartments();
            loadUsers();
            loadComplaints();
            setupRealtimeListener();
        }

        function updateAdminWelcome() {
            if (!currentUser) return;
            document.getElementById('adminWelcome').textContent = `مرحباً، ${currentUser.name}`;
            if (currentUser.loginTime) {
                const d = new Date(currentUser.loginTime);
                document.getElementById('adminLastLogin').textContent =
                    'آخر دخول: ' + d.toLocaleString('ar-EG');
            }
        }

        function updateSidebarPermissions() {
            const adminOnly = document.querySelectorAll('.admin-only');
            if (currentUser && currentUser.role === 'admin') {
                adminOnly.forEach(el => el.style.display = 'flex');
            } else {
                adminOnly.forEach(el => el.style.display = 'none');
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('active');
            overlay.style.display = sidebar.classList.contains('active') ? 'block' : 'none';
        }

        function showSection(section) {
            document.querySelectorAll('.content-section').forEach(sec => {
                sec.classList.remove('active');
            });
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });

            const target = document.getElementById(section + 'Section');
            if (target) target.classList.add('active');

            const activeMenu = document.querySelector(`.menu-item[data-section="${section}"]`);
            if (activeMenu) activeMenu.classList.add('active');

            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            if (sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
                overlay.style.display = 'none';
            }
        }

        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        let messageTimeout = null;
        function showMessage(text, type = 'success') {
            if (messageTimeout) clearTimeout(messageTimeout);
            const old = document.querySelector('.message');
            if (old) old.remove();

            const div = document.createElement('div');
            div.className = 'message' + (type === 'error' ? ' error' : '');
            div.textContent = text;
            document.body.appendChild(div);

            messageTimeout = setTimeout(() => {
                div.remove();
            }, 4000);
        }

        function setupRealtimeListener() {
            if (complaintsListener) {
                complaintsListener.off();
            }

            complaintsListener = database.ref('complaints');

            complaintsListener.on('child_added', (snapshot) => {
                const complaint = { key: snapshot.key, ...snapshot.val() };
                if (shouldShowComplaint(complaint)) {
                    if (!complaint.viewedBy || !complaint.viewedBy[currentUser.username]) {
                        unreadComplaints.add(complaint.key);
                        updateUnreadBadge();
                        if (document.getElementById('enableNotifications').checked) {
                            showMessage('تم استلام طلب جديد', 'success');
                        }
                    }
                    const existingIndex = allComplaints.findIndex(c => c.key === complaint.key);
                    if (existingIndex === -1) {
                        allComplaints.unshift(complaint);
                        filterComplaints();
                        updateDashboardStats();
                        displayLatestComplaints();
                        updateDashboardCards();
                    }
                }
            });

            complaintsListener.on('child_changed', (snapshot) => {
                const complaint = { key: snapshot.key, ...snapshot.val() };
                const index = allComplaints.findIndex(c => c.key === complaint.key);
                if (index !== -1) {
                    allComplaints[index] = complaint;
                    filterComplaints();
                    updateDashboardStats();
                    displayLatestComplaints();
                    updateDashboardCards();
                }
            });

            complaintsListener.on('child_removed', (snapshot) => {
                const index = allComplaints.findIndex(c => c.key === snapshot.key);
                if (index !== -1) {
                    allComplaints.splice(index, 1);
                    unreadComplaints.delete(snapshot.key);
                    updateUnreadBadge();
                    filterComplaints();
                    updateDashboardStats();
                    displayLatestComplaints();
                    updateDashboardCards();
                }
            });
        }

        function shouldShowComplaint(complaint) {
            if (!currentUser) return false;
            if (currentUser.role === 'admin') return true;
            if (currentUser.departments && currentUser.departments.length > 0) {
                return currentUser.departments.includes(complaint.department);
            }
            return false;
        }

        function updateUnreadBadge() {
            const count = unreadComplaints.size;
            const badge = document.getElementById('complaintsBadge');
            if (!badge) return;
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }

        // تحميل الأقسام
        function loadDepartments() {
            database.ref('departments').once('value', snapshot => {
                const data = snapshot.val() || {};
                allDepartments = Object.keys(data).map(key => ({
                    key,
                    ...data[key]
                }));

                populateDepartmentFilter();
                populateUserDepartments();
                displayDepartmentsGrid();
            });
        }

        // تحميل المستخدمين
        function loadUsers() {
            database.ref('users').once('value', snapshot => {
                const data = snapshot.val() || {};
                allUsers = Object.keys(data).map(key => ({
                    key,
                    ...data[key]
                }));
                displayUsersGrid();
            });
        }

        // تحميل الشكاوى
        async function loadComplaints() {
            showLoading();
            try {
                const snapshot = await database.ref('complaints').orderByChild('timestamp').once('value');
                const data = snapshot.val() || {};
                allComplaints = Object.keys(data)
                    .map(key => ({ key, ...data[key] }))
                    .filter(c => shouldShowComplaint(c))
                    .sort((a, b) => new Date(b.timestamp || b.createdAt || 0) - new Date(a.timestamp || a.createdAt || 0));

                filteredComplaints = [...allComplaints];

                unreadComplaints = new Set();
                allComplaints.forEach(c => {
                    if (!c.viewedBy || !c.viewedBy[currentUser.username]) {
                        unreadComplaints.add(c.key);
                    }
                });
                updateUnreadBadge();

                populateDepartmentFilter();
                updateDashboardStats();
                updateDashboardCards();
                displayComplaintsTable();
                displayLatestComplaints();
            } catch (error) {
                console.error(error);
                showMessage('حدث خطأ أثناء تحميل الشكاوى', 'error');
            } finally {
                hideLoading();
            }
        }

        function populateDepartmentFilter() {
            const select = document.getElementById('filterDepartment');
            if (!select) return;

            const departments = [...new Set(allDepartments.map(d => d.name))];

            let options = '<option value="">جميع الأقسام</option>';
            departments.forEach(dept => {
                options += `<option value="${dept}">${dept}</option>`;
            });

            select.innerHTML = options;
        }

        function populateUserDepartments() {
            const container = document.getElementById('userDepartments');
            if (!container) return;

            let html = '';
            allDepartments.forEach(dept => {
                html += `
                    <label>
                        <input type="checkbox" value="${dept.name}" class="user-dept-checkbox">
                        <span>${dept.name}</span>
                    </label>
                `;
            });

            container.innerHTML = html;
        }

        function filterComplaints() {
            const search = document.getElementById('searchComplaints').value.toLowerCase();
            const department = document.getElementById('filterDepartment').value;
            const status = document.getElementById('filterStatus').value;

            filteredComplaints = allComplaints.filter(c => {
                const searchMatch = !search ||
                    (c.complaintNumber && c.complaintNumber.toLowerCase().includes(search)) ||
                    (c.fullName && c.fullName.toLowerCase().includes(search)) ||
                    (c.nationalId && c.nationalId.includes(search)) ||
                    (c.phone1 && c.phone1.includes(search)) ||
                    (c.problemDetails && c.problemDetails.toLowerCase().includes(search));

                const departmentMatch = !department || c.department === department;
                const statusMatch = !status || c.status === status;

                return searchMatch && departmentMatch && statusMatch;
            });

            currentPage = 1;
            displayComplaintsTable();
        }

        function displayComplaintsTable() {
            const tbody = document.getElementById('complaintsTableBody');
            if (!tbody) return;

            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageComplaints = filteredComplaints.slice(start, end);

            let html = '';
            pageComplaints.forEach(complaint => {
                const isUnread = unreadComplaints.has(complaint.key);
                const rowClass = isUnread ? 'unread' : '';

                html += `
                    <tr class="${rowClass}">
                        <td>
                            ${isUnread ? '<span class="new-request-indicator"></span>' : ''}
                            ${complaint.complaintNumber || '-'}
                        </td>
                        <td>${complaint.fullName || '-'}</td>
                        <td>${complaint.department || '-'}</td>
                        <td><span class="status-badge ${getStatusClass(complaint.status)}">${complaint.status || 'جديدة'}</span></td>
                        <td>${formatDate(complaint.timestamp || complaint.createdAt)}</td>
                        <td class="actions">
                            <button class="action-btn btn-view" onclick="viewComplaint('${complaint.key}')">
                                <i class="fas fa-eye"></i>
                                عرض
                            </button>
                            <button class="action-btn btn-secondary" onclick="downloadComplaintPDF('${complaint.key}')">
                                <i class="fas fa-file-pdf"></i>
                                PDF
                            </button>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html || '<tr><td colspan="6" style="text-align:center;padding:40px;color:#666;">لا توجد شكاوى</td></tr>';
            updatePagination();
        }

        function displayLatestComplaints() {
            const tbody = document.getElementById('latestComplaintsBody');
            if (!tbody) return;

            const latest = allComplaints.slice(0, 5);

            let html = '';
            latest.forEach(complaint => {
                const isUnread = unreadComplaints.has(complaint.key);
                const rowClass = isUnread ? 'unread' : '';

                html += `
                    <tr class="${rowClass}">
                        <td>
                            ${isUnread ? '<span class="new-request-indicator"></span>' : ''}
                            ${complaint.complaintNumber || '-'}
                        </td>
                        <td>${complaint.fullName || '-'}</td>
                        <td>${complaint.department || '-'}</td>
                        <td><span class="status-badge ${getStatusClass(complaint.status)}">${complaint.status || 'جديدة'}</span></td>
                        <td>${formatDate(complaint.timestamp || complaint.createdAt)}</td>
                        <td class="actions">
                            <button class="action-btn btn-view" onclick="viewComplaint('${complaint.key}')">
                                <i class="fas fa-eye"></i>
                                عرض
                            </button>
                            <button class="action-btn btn-secondary" onclick="downloadComplaintPDF('${complaint.key}')">
                                <i class="fas fa-file-pdf"></i>
                                PDF
                            </button>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html || '<tr><td colspan="6" style="text-align:center;padding:40px;color:#666;">لا توجد شكاوى</td></tr>';
        }

        function updatePagination() {
            const totalPages = Math.max(1, Math.ceil(filteredComplaints.length / itemsPerPage));
            if (currentPage > totalPages) currentPage = totalPages;

            document.getElementById('pageInfo').textContent = `الصفحة ${currentPage} من ${totalPages}`;
            document.getElementById('prevPage').disabled = (currentPage === 1);
            document.getElementById('nextPage').disabled = (currentPage === totalPages);
        }

        function changePage(delta) {
            const totalPages = Math.max(1, Math.ceil(filteredComplaints.length / itemsPerPage));
            const newPage = currentPage + delta;
            if (newPage < 1 || newPage > totalPages) return;
            currentPage = newPage;
            displayComplaintsTable();
            updatePagination();
        }

        function updateDashboardStats() {
            const total = allComplaints.length;
            const newCount = allComplaints.filter(c => c.status === 'جديدة' || !c.status).length;
            const resolved = allComplaints.filter(c => c.status === 'مكتملة' || c.status === 'تم الرد').length;

            document.getElementById('totalComplaints').textContent = total;
            document.getElementById('newComplaints').textContent = newCount;
            document.getElementById('resolvedComplaints').textContent = resolved;
        }

        function updateDashboardCards() {
            const newCount = allComplaints.filter(c => c.status === 'جديدة' || !c.status).length;
            const completed = allComplaints.filter(c => c.status === 'مكتملة').length;
            const inProgress = allComplaints.filter(c => c.status === 'قيد المعالجة' || c.status === 'قيد المراجعة').length;

            document.getElementById('cardNewComplaints').textContent = newCount;
            document.getElementById('cardCompletedComplaints').textContent = completed;
            document.getElementById('cardInProgress').textContent = inProgress;
        }

        function getStatusClass(status) {
            switch (status) {
                case 'جديدة': return 'status-new';
                case 'قيد المراجعة':
                case 'قيد المعالجة': return 'status-in-progress';
                case 'تم الرد':
                case 'مكتملة': return 'status-resolved';
                case 'ملغاة': return 'status-closed';
                default: return 'status-new';
            }
        }

        function formatDate(timestamp) {
            if (!timestamp) return '-';
            try {
                const d = new Date(timestamp);
                return d.toLocaleString('ar-EG');
            } catch {
                return '-';
            }
        }

        async function viewComplaint(key) {
            showLoading();
            try {
                const snapshot = await database.ref(`complaints/${key}`).once('value');
                const complaint = snapshot.val();

                if (!complaint) {
                    showMessage('لم يتم العثور على الشكوى', 'error');
                    return;
                }

                const viewedBy = complaint.viewedBy || {};
                viewedBy[currentUser.username] = {
                    name: currentUser.name,
                    timestamp: new Date().toISOString()
                };

                await database.ref(`complaints/${key}/viewedBy`).set(viewedBy);

                unreadComplaints.delete(key);
                updateUnreadBadge();
                displayComplaintDetails(key, complaint);
                filterComplaints();
                displayLatestComplaints();
            } catch (error) {
                console.error('Error viewing complaint:', error);
                showMessage('حدث خطأ أثناء عرض التفاصيل', 'error');
            } finally {
                hideLoading();
            }
        }

        function displayComplaintDetails(key, complaint) {
            const modalBody = document.getElementById('modalBody');

            const priority = complaint.problemPriority || complaint.problemType || 'عادية';

            let html = `
                <div class="details-grid">
                    <div class="detail-item">
                        <div class="detail-label">رقم الشكوى</div>
                        <div class="detail-value">${complaint.complaintNumber || '-'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">الاسم الكامل</div>
                        <div class="detail-value">${complaint.fullName || '-'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">الرقم القومي</div>
                        <div class="detail-value national-id">${complaint.nationalId || '-'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">المحافظة</div>
                        <div class="detail-value">الدقهلية</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">بلد الإقامة</div>
                        <div class="detail-value">${complaint.localUnit || complaint.residence || '-'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">رقم الهاتف 1</div>
                        <div class="detail-value">${complaint.phone1 || '-'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">رقم الهاتف 2</div>
                        <div class="detail-value">${complaint.phone2 || '-'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">القسم</div>
                        <div class="detail-value">${complaint.department || '-'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">درجة أهمية المشكلة</div>
                        <div class="detail-value">${priority}</div>
                    </div>
                    <div class="detail-item full-width">
                        <div class="detail-label">نوع المشكلة</div>
                        <div class="detail-value">${complaint.problemType || '-'}</div>
                    </div>
                    <div class="detail-item full-width">
                        <div class="detail-label">تفاصيل المشكلة</div>
                        <div class="detail-value">${complaint.problemDetails || '-'}</div>
                    </div>
                </div>
            `;

            html += `
                <div class="status-form">
                    <h4><i class="fas fa-exchange-alt"></i> تغيير حالة الشكوى</h4>
                    <select id="complaintStatusSelect">
                        <option value="جديدة" ${complaint.status === 'جديدة' || !complaint.status ? 'selected' : ''}>جديدة</option>
                        <option value="قيد المراجعة" ${complaint.status === 'قيد المراجعة' ? 'selected' : ''}>قيد المراجعة</option>
                        <option value="قيد المعالجة" ${complaint.status === 'قيد المعالجة' ? 'selected' : ''}>قيد المعالجة</option>
                        <option value="تم الرد" ${complaint.status === 'تم الرد' ? 'selected' : ''}>تم الرد</option>
                        <option value="مكتملة" ${complaint.status === 'مكتملة' ? 'selected' : ''}>مكتملة</option>
                        <option value="ملغاة" ${complaint.status === 'ملغاة' ? 'selected' : ''}>ملغاة</option>
                    </select>

                    <h4 style="margin-top:15px;"><i class="fas fa-flag"></i> درجة أهمية المشكلة</h4>
                    <select id="complaintPrioritySelect">
                        <option value="عادية" ${priority === 'عادية' ? 'selected' : ''}>عادية</option>
                        <option value="مهمة" ${priority === 'مهمة' ? 'selected' : ''}>مهمة</option>
                        <option value="عاجلة" ${priority === 'عاجلة' ? 'selected' : ''}>عاجلة</option>
                        <option value="تستدعي التدخل الفوري" ${priority === 'تستدعي التدخل الفوري' ? 'selected' : ''}>تستدعي التدخل الفوري</option>
                    </select>

                    <div class="form-actions">
                        <button class="action-btn btn-status" onclick="updateComplaintStatus('${key}')">
                            <i class="fas fa-save"></i>
                            حفظ الحالة / النوع
                        </button>
                    </div>
                </div>
            `;

            html += `
                <div class="responses-container">
                    <div class="responses-title">
                        <i class="fas fa-comments"></i>
                        الردود على الشكوى
                    </div>
                    <div class="responses-list">
            `;

            if (complaint.responses) {
                const responsesArray = Object.values(complaint.responses).sort(
                    (a, b) => new Date(a.timestamp) - new Date(b.timestamp)
                );
                responsesArray.forEach(res => {
                    const isAdmin = res.senderRole === 'admin';
                    const senderName = isAdmin
                        ? 'المكتب الخدمي للنائب أحمد الحديدي'
                        : (res.senderName || complaint.fullName || 'العميل');

                    html += `
                        <div class="response-item ${isAdmin ? 'response-admin' : 'response-client'}">
                            <div class="response-header">
                                <div class="response-sender">
                                    <i class="fas ${isAdmin ? 'fa-user-shield' : 'fa-user'}"></i>
                                    <span>${senderName}</span>
                                </div>
                                <div class="response-time">
                                    ${formatDate(res.timestamp)}
                                </div>
                            </div>
                            <div class="response-content">${res.message || ''}</div>
                        </div>
                    `;
                });
            } else {
                html += `
                    <p style="color:#666;">لا توجد ردود حتى الآن.</p>
                `;
            }

            html += `
                    </div>
                </div>
            `;

            html += `
                <div class="reply-form">
                    <h4><i class="fas fa-reply"></i> إضافة رد من المكتب الخدمي للنائب أحمد الحديدي</h4>
                    <textarea id="replyMessage" placeholder="اكتب ردك هنا..."></textarea>
                    <div class="form-actions">
                        <button class="action-btn btn-reply" onclick="sendReply('${key}')">
                            <i class="fas fa-paper-plane"></i>
                            إرسال الرد
                        </button>
                    </div>
                </div>
            `;

            html += `
                <div class="form-actions" style="margin-top:20px;">
                    <button class="action-btn btn-view" onclick="downloadComplaintPDF('${key}')">
                        <i class="fas fa-file-pdf"></i>
                        تصدير PDF
                    </button>
                    <button class="action-btn btn-delete" onclick="deleteComplaint('${key}')">
                        <i class="fas fa-trash"></i>
                        حذف الشكوى
                    </button>
                    <button class="action-btn btn-secondary" onclick="closeComplaintModal()">
                        <i class="fas fa-times"></i>
                        إغلاق
                    </button>
                </div>
            `;

            modalBody.innerHTML = html;
            document.getElementById('complaintModal').style.display = 'flex';
        }

        function closeComplaintModal() {
            document.getElementById('complaintModal').style.display = 'none';
        }

        async function updateComplaintStatus(key) {
            const status = document.getElementById('complaintStatusSelect').value;
            const priority = document.getElementById('complaintPrioritySelect').value;
            try {
                await database.ref(`complaints/${key}`).update({
                    status,
                    problemPriority: priority,
                    updatedAt: new Date().toISOString()
                });
                showMessage('تم تحديث حالة الشكوى ودرجة الأهمية بنجاح', 'success');
                loadComplaints();
            } catch (err) {
                console.error(err);
                showMessage('حدث خطأ أثناء تحديث الحالة', 'error');
            }
        }

        async function sendReply(key) {
            const textarea = document.getElementById('replyMessage');
            const message = textarea.value.trim();
            if (!message) {
                showMessage('من فضلك اكتب نص الرد أولاً', 'error');
                return;
            }

            const newRef = database.ref(`complaints/${key}/responses`).push();
            const data = {
                message,
                senderName: 'المكتب الخدمي للنائب أحمد الحديدي',
                senderRole: 'admin',
                timestamp: new Date().toISOString()
            };

            try {
                await newRef.set(data);
                textarea.value = '';
                showMessage('تم إرسال الرد بنجاح', 'success');
                viewComplaint(key);
            } catch (err) {
                console.error(err);
                showMessage('حدث خطأ أثناء إرسال الرد', 'error');
            }
        }

        async function deleteComplaint(key) {
            if (!confirm('هل أنت متأكد من حذف هذه الشكوى؟')) return;
            try {
                await database.ref(`complaints/${key}`).remove();
                showMessage('تم حذف الشكوى بنجاح', 'success');
                closeComplaintModal();
            } catch (err) {
                console.error(err);
                showMessage('حدث خطأ أثناء حذف الشكوى', 'error');
            }
        }

        // دوال التصدير
        function exportToExcel() {
            if (!allComplaints.length) {
                showMessage('لا توجد بيانات لتصديرها', 'error');
                return;
            }

            const data = allComplaints.map(c => ({
                'رقم الشكوى': c.complaintNumber || '',
                'الاسم بالكامل': c.fullName || '',
                'القسم': c.department || '',
                'درجة الأهمية': c.problemPriority || c.problemType || 'عادية',
                'الحالة': c.status || 'جديدة',
                'تاريخ الإرسال': c.createdAt
                    ? new Date(c.createdAt).toLocaleString('ar-EG')
                    : (c.timestamp ? new Date(c.timestamp).toLocaleString('ar-EG') : '')
            }));

            const worksheet = XLSX.utils.json_to_sheet(data);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'الشكاوى');

            XLSX.writeFile(workbook, 'complaints.xlsx');
            showMessage('تم بدء تنزيل ملف Excel', 'success');
        }

        function getComplaintField(c, field) {
            switch (field) {
                case 'country':
                    return c.country || c.countryName || c.residence || c.localUnit || '-';
                case 'governorate':
                    return 'الدقهلية';
                case 'city':
                    return c.city || c.localUnit || '-';
                case 'address':
                    return c.address || c.fullAddress || '-';
                case 'phone':
                    return c.phone1 || c.phone || '-';
                case 'phone2':
                    return c.phone2 || '-';
                case 'email':
                    return c.email || '-';
                default:
                    return '-';
            }
        }

        async function downloadComplaintPDF(complaintKey) {
            const complaint = allComplaints.find(c => c.key === complaintKey);
            if (!complaint) return;

            try {
                showLoading();

                const priority = complaint.problemPriority || complaint.problemType || 'عادية';

                const htmlContent = `
                    <!DOCTYPE html>
                    <html dir="rtl">
                    <head>
                        <meta charset="UTF-8">
                        <title>تقرير الشكوى</title>
                        <style>
                            body { font-family: 'Cairo', sans-serif; padding: 20px; color: #333; }
                            .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #1a5fb4; padding-bottom: 15px; }
                            .header h1 { color: #1a5fb4; margin-bottom: 10px; }
                            .info-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                            .info-table td { padding: 10px; border: 1px solid #ddd; }
                            .info-table .label { background: #f8f9fa; font-weight: bold; width: 30%; }
                            .details { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 20px 0; border-right: 4px solid #1a5fb4; }
                            .response { padding: 15px; border-radius: 8px; margin: 10px 0; }
                            .footer { margin-top: 40px; text-align: center; color: #666; font-size: 12px; border-top: 1px solid #ddd; padding-top: 15px; }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>نظام الشكاوى الموحد</h1>
                            <h2>تفاصيل الشكوى رقم: ${complaint.complaintNumber || ''}</h2>
                            <p>تم إنشاء هذا التقرير في: ${new Date().toLocaleString('ar-EG')}</p>
                        </div>

                        <table class="info-table">
                            <tr><td class="label">رقم الشكوى:</td><td>${complaint.complaintNumber || ''}</td></tr>
                            <tr><td class="label">الاسم بالكامل:</td><td>${complaint.fullName || ''}</td></tr>
                            <tr><td class="label">الرقم القومي:</td><td>${complaint.nationalId || 'غير متوفر'}</td></tr>
                            <tr><td class="label">بلد الإقامة:</td><td>${getComplaintField(complaint, 'country')}</td></tr>
                            <tr><td class="label">المحافظة:</td><td>${getComplaintField(complaint, 'governorate')}</td></tr>
                            <tr><td class="label">المدينة/القرية:</td><td>${getComplaintField(complaint, 'city')}</td></tr>
                            <tr><td class="label">العنوان بالتفصيل:</td><td>${getComplaintField(complaint, 'address')}</td></tr>
                            <tr><td class="label">رقم الهاتف (1):</td><td>${getComplaintField(complaint, 'phone')}</td></tr>
                            <tr><td class="label">رقم الهاتف (2):</td><td>${getComplaintField(complaint, 'phone2')}</td></tr>
                            <tr><td class="label">البريد الإلكتروني:</td><td>${getComplaintField(complaint, 'email')}</td></tr>
                            <tr><td class="label">القسم:</td><td>${complaint.department || ''}</td></tr>
                            <tr><td class="label">درجة أهمية المشكلة:</td><td>${priority}</td></tr>
                            <tr><td class="label">نوع المشكلة:</td><td>${complaint.problemType || ''}</td></tr>
                            <tr><td class="label">الحالة:</td><td>${complaint.status || ''}</td></tr>
                            <tr><td class="label">تاريخ الإرسال:</td><td>${complaint.createdAt ? new Date(complaint.createdAt).toLocaleString('ar-EG') : (complaint.timestamp ? new Date(complaint.timestamp).toLocaleString('ar-EG') : '-')}</td></tr>
                            <tr><td class="label">آخر تحديث:</td><td>${complaint.updatedAt ? new Date(complaint.updatedAt).toLocaleString('ar-EG') : '-'}</td></tr>
                        </table>

                        <h3>تفاصيل المشكلة:</h3>
                        <div class="details">${complaint.problemDetails || ''}</div>

                        ${complaint.responses ? `
                        <h3>سجل المحادثة:</h3>
                        ${Object.values(complaint.responses)
                            .sort((a,b)=>new Date(a.timestamp)-new Date(b.timestamp))
                            .map(response => {
                                const isAdmin = response.senderRole === 'admin';
                                const date = new Date(response.timestamp).toLocaleString('ar-EG');
                                const senderName = isAdmin
                                    ? 'المكتب الخدمي للنائب أحمد الحديدي'
                                    : (response.senderName || complaint.fullName || 'العميل');
                                return `
                                <div class="response" style="border-right:4px solid ${isAdmin ? '#28a745' : '#3498db'}; background:${isAdmin ? '#d4edda' : '#e3f2fd'};">
                                    <div style="display:flex;justify-content:space-between;">
                                        <strong>${senderName}</strong>
                                        <small>${date}</small>
                                    </div>
                                    <div style="margin-top:5px;">${response.message || ''}</div>
                                </div>
                                `;
                            }).join('')}
                        ` : ''}

                        <div class="footer">
                            <p>© 2026 نظام الشكاوى الموحد - جميع الحقوق محفوظة</p>
                            <p>المكتب الخدمي للنائب أحمد الحديدي</p>
                        </div>
                    </body>
                    </html>
                `;

                const printWindow = window.open('', '_blank');
                printWindow.document.write(htmlContent);
                printWindow.document.close();
                printWindow.focus();
                printWindow.print();

                showMessage('جاري تحضير ملف PDF للطباعة أو الحفظ', 'success');
            } catch (err) {
                console.error(err);
                showMessage('حدث خطأ أثناء إنشاء ملف PDF', 'error');
            } finally {
                hideLoading();
            }
        }
        // دوال المستخدمين
        function displayUsersGrid() {
            const container = document.getElementById('usersGrid');
            if (!container) return;

            if (!allUsers.length) {
                container.innerHTML = '<p style="padding:20px;color:#666;">لا يوجد مستخدمون حتى الآن.</p>';
                return;
            }

            let html = '';
            allUsers.forEach(user => {
                html += `
                    <div class="user-card">
                        <div class="user-card-header">
                            <div class="user-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="user-info">
                                <h3>${user.name || '-'}</h3>
                                <span class="user-role ${user.role === 'admin' ? 'admin' : ''}">
                                    ${user.role === 'admin' ? 'مدير' : 'مستخدم'}
                                </span>
                                <div class="user-email">
                                    <i class="fas fa-user-tag"></i>
                                    ${user.username || '-'}
                                </div>
                                <div class="user-email">
                                    <i class="fas fa-envelope"></i>
                                    ${user.email || '-'}
                                </div>
                            </div>
                        </div>
                        <div class="user-departments">
                            <div class="user-departments-title">الأقسام المخصصة:</div>
                            <div class="department-tags">
                `;
                if (user.departments && user.departments.length) {
                    user.departments.forEach(d => {
                        html += `<span class="department-tag">${d}</span>`;
                    });
                } else {
                    html += '<span style="color:#888;font-size:.85rem;">كل الأقسام</span>';
                }

                html += `
                            </div>
                        </div>
                        <div class="user-actions">
                            <button class="action-btn btn-edit" onclick="editUser('${user.key}')">
                                <i class="fas fa-edit"></i>
                                تعديل
                            </button>
                            <button class="action-btn btn-delete" onclick="deleteUser('${user.key}')">
                                <i class="fas fa-trash"></i>
                                حذف
                            </button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function openAddUserModal() {
            currentEditingUser = null;
            document.getElementById('userModalTitle').textContent = 'إضافة مستخدم جديد';
            document.getElementById('userName').value = '';
            document.getElementById('userUsername').value = '';
            document.getElementById('userEmail').value = '';
            document.getElementById('userPassword').value = '';
            document.getElementById('userRole').value = 'user';

            document.querySelectorAll('.user-dept-checkbox').forEach(ch => {
                ch.checked = false;
            });

            document.getElementById('userModal').style.display = 'flex';
        }

        function closeUserModal() {
            document.getElementById('userModal').style.display = 'none';
        }

        function editUser(key) {
            const user = allUsers.find(u => u.key === key);
            if (!user) return;
            currentEditingUser = user;

            document.getElementById('userModalTitle').textContent = 'تعديل بيانات المستخدم';
            document.getElementById('userName').value = user.name || '';
            document.getElementById('userUsername').value = user.username || '';
            document.getElementById('userEmail').value = user.email || '';
            document.getElementById('userPassword').value = '';
            document.getElementById('userRole').value = user.role || 'user';

            document.querySelectorAll('.user-dept-checkbox').forEach(ch => {
                ch.checked = user.departments && user.departments.includes(ch.value);
            });

            document.getElementById('userModal').style.display = 'flex';
        }

        async function saveUser() {
            const name = document.getElementById('userName').value.trim();
            const username = document.getElementById('userUsername').value.trim();
            const email = document.getElementById('userEmail').value.trim();
            const password = document.getElementById('userPassword').value;
            const role = document.getElementById('userRole').value;

            if (!name || !username || !email) {
                showMessage('من فضلك أكمل جميع الحقول الأساسية', 'error');
                return;
            }

            const departments = [];
            document.querySelectorAll('.user-dept-checkbox:checked').forEach(ch => {
                departments.push(ch.value);
            });

            const data = {
                name,
                username,
                email,
                role,
                departments
            };

            if (!currentEditingUser && !password) {
                showMessage('من فضلك أدخل كلمة مرور للمستخدم الجديد', 'error');
                return;
            }

            if (password) data.password = password;

            try {
                if (currentEditingUser) {
                    await database.ref(`users/${currentEditingUser.key}`).update(data);
                    showMessage('تم تحديث بيانات المستخدم', 'success');
                } else {
                    const newRef = database.ref('users').push();
                    await newRef.set(data);
                    showMessage('تم إضافة المستخدم بنجاح', 'success');
                }
                closeUserModal();
                loadUsers();
            } catch (err) {
                console.error(err);
                showMessage('حدث خطأ أثناء حفظ بيانات المستخدم', 'error');
            }
        }

        async function deleteUser(key) {
            if (!confirm('هل أنت متأكد من حذف هذا المستخدم؟')) return;
            try {
                await database.ref(`users/${key}`).remove();
                showMessage('تم حذف المستخدم بنجاح', 'success');
                loadUsers();
            } catch (err) {
                console.error(err);
                showMessage('حدث خطأ أثناء حذف المستخدم', 'error');
            }
        }

        // دوال الأقسام
        function displayDepartmentsGrid() {
            const container = document.getElementById('departmentsList');
            if (!container) return;

            if (!allDepartments.length) {
                container.innerHTML = '<p style="padding:10px;color:#666;">لا توجد أقسام حالياً.</p>';
                return;
            }

            let html = '';
            allDepartments.forEach(dep => {
                html += `
                    <div class="department-item">
                        <span>${dep.name}</span>
                        <span class="delete-dept" onclick="deleteDepartment('${dep.key || ''}')">
                            <i class="fas fa-times"></i>
                        </span>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        async function addDepartment() {
            const name = document.getElementById('newDepartmentName').value.trim();
            if (!name) {
                showMessage('من فضلك أدخل اسم القسم', 'error');
                return;
            }

            try {
                const newRef = database.ref('departments').push();
                await newRef.set({ name });
                document.getElementById('newDepartmentName').value = '';
                showMessage('تم إضافة القسم بنجاح', 'success');
                loadDepartments();
            } catch (err) {
                console.error(err);
                showMessage('حدث خطأ أثناء إضافة القسم', 'error');
            }
        }

        async function deleteDepartment(key) {
            if (!key) {
                showMessage('لا يمكن حذف هذا القسم', 'error');
                return;
            }
            if (!confirm('هل أنت متأكد من حذف هذا القسم؟')) return;

            try {
                await database.ref(`departments/${key}`).remove();
                showMessage('تم حذف القسم بنجاح', 'success');
                loadDepartments();
            } catch (err) {
                console.error(err);
                showMessage('حدث خطأ أثناء حذف القسم', 'error');
            }
        }

        // ربط الأحداث عند تحميل الصفحة
        window.onload = function() {
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const username = document.getElementById('username').value.trim();
                    const password = document.getElementById('password').value;
                    handleLogin(username, password);
                });
            }

            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', logout);
            }

            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', function() {
                    const section = this.getAttribute('data-section');
                    showSection(section);
                });
            });

            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            const closeSidebarBtn = document.getElementById('closeSidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');

            if (mobileMenuBtn) {
                mobileMenuBtn.addEventListener('click', toggleSidebar);
            }
            if (closeSidebarBtn) {
                closeSidebarBtn.addEventListener('click', toggleSidebar);
            }
            if (sidebarOverlay) {
                sidebarOverlay.addEventListener('click', toggleSidebar);
            }

            const searchInput = document.getElementById('searchComplaints');
            const filterDepartment = document.getElementById('filterDepartment');
            const filterStatus = document.getElementById('filterStatus');

            if (searchInput) {
                searchInput.addEventListener('input', filterComplaints);
            }
            if (filterDepartment) {
                filterDepartment.addEventListener('change', filterComplaints);
            }
            if (filterStatus) {
                filterStatus.addEventListener('change', filterComplaints);
            }

            initAuth();
        };

        window.onclick = function(event) {
            const complaintModal = document.getElementById('complaintModal');
            const userModal = document.getElementById('userModal');
            if (event.target === complaintModal) {
                closeComplaintModal();
            }
            if (event.target === userModal) {
                closeUserModal();
            }
        };
    </script>
</body>
</html>
