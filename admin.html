<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>لوحة التحكم - نظام الشكاوى الموحد</title>
    
    <link rel="manifest" href="manifest-admin.json">
    <meta name="theme-color" content="#1a5fb4">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="إدارة الشكاوى">
    
    <style>
        /* خط Cairo من Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap');
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="icon" type="image/png" href="icon-192x192.png">
    <link rel="apple-touch-icon" href="icon-512x512.png">
    
    <style>
        /* ==================== أنماط CSS الرئيسية ==================== */
        *{box-sizing:border-box;margin:0;padding:0;font-family:'Cairo',sans-serif;-webkit-tap-highlight-color:transparent}
        html{font-size:16px;scroll-behavior:smooth}
        body{background:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%);color:#333;line-height:1.6;min-height:100vh;overflow-x:hidden;padding-bottom:80px}
        .container{max-width:1400px;margin:0 auto;padding:15px}
        
        /* أنماط تسجيل الدخول */
        .login-container{display:flex;justify-content:center;align-items:center;min-height:100vh;padding:20px;background:linear-gradient(135deg,#1a5fb4 0%,#2d8fd5 100%)}
        .login-box{background:#fff;border-radius:20px;padding:30px 25px;width:100%;max-width:400px;box-shadow:0 20px 40px rgba(0,0,0,.2);text-align:center;animation:slideUp .5s ease}
        @keyframes slideUp{from{opacity:0;transform:translateY(50px)}to{opacity:1;transform:translateY(0)}}
        .login-logo{font-size:3rem;color:#1a5fb4;margin-bottom:15px}
        .login-title{font-size:1.6rem;color:#2c3e50;margin-bottom:25px;font-weight:700}
        .login-form .form-group{margin-bottom:20px;text-align:right}
        .login-form .form-label{display:block;margin-bottom:8px;font-weight:600;color:#2c3e50;font-size:1rem}
        .login-form .form-control{width:100%;padding:16px 15px;border:2px solid #ddd;border-radius:10px;font-size:16px;transition:all .3s;background:#f8f9fa}
        .login-form .form-control:focus{border-color:#1a5fb4;outline:none;box-shadow:0 0 0 3px rgba(26,95,180,.1);background:#fff}
        .login-btn{width:100%;padding:18px;background:linear-gradient(to right,#1a5fb4,#2d8fd5);color:#fff;border:none;border-radius:10px;font-size:18px;font-weight:700;cursor:pointer;transition:all .3s;display:flex;align-items:center;justify-content:center;gap:10px;margin-top:10px}
        .login-btn:hover{background:linear-gradient(to right,#155093,#1a5fb4);transform:translateY(-2px);box-shadow:0 10px 20px rgba(0,0,0,.15)}
        .login-error{color:#e74c3c;margin-top:15px;padding:15px;background:#fde8e8;border-radius:10px;display:none;font-size:.95rem}
        
        /* الهيدر */
        header{background:linear-gradient(135deg,#1a5fb4 0%,#2d8fd5 100%);color:#fff;padding:20px 0 25px;text-align:center;border-radius:0 0 25px 25px;box-shadow:0 8px 25px rgba(0,0,0,.15);margin-bottom:20px;position:relative;overflow:hidden}
        header::before{content:'';position:absolute;top:0;left:0;right:0;height:5px;background:linear-gradient(90deg,#ff7e5f,#feb47b,#86a8e7,#91eae4);background-size:400% 400%;animation:gradientShift 8s ease infinite}
        @keyframes gradientShift{0%{background-position:0 50%}50%{background-position:100% 50%}100%{background-position:0 50%}}
        .logo{font-size:1.8rem;margin-bottom:8px;text-shadow:2px 2px 4px rgba(0,0,0,.2);padding:0 15px;line-height:1.4}
        .subtitle{font-size:1rem;opacity:.9;max-width:600px;margin:0 auto;padding:0 15px;line-height:1.5}
        
        /* شريط المسؤول */
        .admin-bar{background:linear-gradient(135deg,#2c3e50 0%,#4a6572 100%);color:#fff;padding:15px;border-radius:15px;margin-bottom:20px;box-shadow:0 5px 15px rgba(0,0,0,.1);display:flex;flex-direction:column;gap:15px}
        .admin-info{display:flex;align-items:center;gap:12px}
        .admin-avatar{width:50px;height:50px;border-radius:50%;background:linear-gradient(135deg,#3498db,#2c3e50);display:flex;align-items:center;justify-content:center;font-size:1.4rem;box-shadow:0 4px 10px rgba(0,0,0,.2);flex-shrink:0}
        .admin-text{flex-grow:1;overflow:hidden}
        .admin-text h3{margin-bottom:5px;font-size:1.1rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .admin-text p{opacity:.9;font-size:.85rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .admin-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
        .stat-box{background:rgba(255,255,255,.15);padding:12px 8px;border-radius:10px;text-align:center;backdrop-filter:blur(10px)}
        .stat-value{font-size:1.5rem;font-weight:700;margin-bottom:5px}
        .stat-label{font-size:.8rem;opacity:.9;line-height:1.3}
        .logout-btn{background:#e74c3c;color:#fff;border:none;padding:12px 20px;border-radius:10px;cursor:pointer;font-weight:600;transition:all .3s;display:flex;align-items:center;justify-content:center;gap:8px;font-size:1rem;width:100%}
        .logout-btn:hover{background:#c0392b;transform:translateY(-2px)}
        
        /* الشبكة الرئيسية */
        .dashboard-grid{display:flex;flex-direction:column;gap:20px}
        .sidebar-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);z-index:999;animation:fadeIn .3s ease}
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        .sidebar{background:#fff;border-radius:20px 0 0 20px;padding:25px 20px;box-shadow:0 0 30px rgba(0,0,0,.3);height:100vh;width:280px;position:fixed;top:0;right:-300px;z-index:1000;transition:right .3s ease;overflow-y:auto}
        .sidebar.active{right:0}
        .sidebar-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;padding-bottom:15px;border-bottom:2px solid #f0f0f0}
        .sidebar-title{font-size:1.3rem;color:#2c3e50;font-weight:700}
        .close-sidebar{background:none;border:none;font-size:1.5rem;color:#666;cursor:pointer;padding:5px}
        .sidebar-menu{list-style:none}
        .menu-item{padding:16px 15px;margin-bottom:8px;border-radius:12px;cursor:pointer;transition:all .3s ease;display:flex;align-items:center;gap:12px;color:#555;font-size:1rem;position:relative}
        .menu-item:hover{background:#f8f9fa;transform:translateX(-5px)}
        .menu-item.active{background:linear-gradient(to right,#1a5fb4,#2d8fd5);color:#fff;box-shadow:0 5px 15px rgba(26,95,180,.3)}
        .menu-icon{font-size:1.2rem;width:24px;text-align:center}
        .badge{background:#e74c3c;color:#fff;border-radius:50%;padding:4px 8px;font-size:.75rem;margin-right:auto;display:inline-block;min-width:22px;text-align:center;font-weight:700;animation:pulse 2s infinite}
        @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
        
        /* المحتوى الرئيسي */
        .main-content{background:#fff;border-radius:20px;padding:20px;box-shadow:0 5px 20px rgba(0,0,0,.08);margin-bottom:80px}
        .footer{text-align:center;padding:20px 15px;color:#666;font-size:.9rem;margin-top:30px;background:#fff;border-radius:15px;box-shadow:0 5px 15px rgba(0,0,0,.05);line-height:1.7}
        .footer a{color:#1a5fb4;text-decoration:none;font-weight:700;display:inline-flex;align-items:center;gap:6px}
        .footer a:hover{color:#155093}
        .admin-only{display:none}
        
        /* نافذة التحميل */
        .loading-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,.9);display:none;justify-content:center;align-items:center;z-index:9999}
        .loading-spinner{width:60px;height:60px;border:5px solid #f3f3f3;border-top:5px solid #1a5fb4;border-radius:50%;animation:spin 1s linear infinite}
        @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
        
        /* الرسائل */
        .message{position:fixed;top:20px;right:20px;padding:15px 20px;border-radius:12px;z-index:10000;box-shadow:0 10px 30px rgba(0,0,0,.2);max-width:90%;animation:slideInMessage .3s ease;font-size:.95rem;line-height:1.5;background:#d4edda;color:#155724}
        .message.error{background:#f8d7da;color:#721c24}
        @keyframes slideInMessage{from{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:translateY(0)}}
        
        /* أنماط PWA */
        .install-container{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.8);display:flex;justify-content:center;align-items:center;z-index:99999;animation:fadeIn .3s ease}
        .install-card{background:white;border-radius:20px;padding:30px;max-width:400px;width:90%;text-align:center;box-shadow:0 20px 50px rgba(0,0,0,.3);animation:slideUp .5s ease}
        .install-icon{font-size:4rem;color:#1a5fb4;margin-bottom:20px;animation:bounce 2s infinite}
        @keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
        .install-text h3{color:#2c3e50;margin-bottom:10px;font-size:1.5rem}
        .install-text p{color:#666;margin-bottom:25px;line-height:1.6}
        .install-btn,.cancel-btn{padding:15px 30px;border:none;border-radius:50px;font-size:1.1rem;font-weight:700;cursor:pointer;transition:all .3s ease;width:100%;margin:5px 0}
        .install-btn{background:linear-gradient(135deg,#1a5fb4 0%,#2d8fd5 100%);color:white;box-shadow:0 10px 30px rgba(26,95,180,.4)}
        .install-btn:hover{transform:translateY(-3px);box-shadow:0 15px 40px rgba(26,95,180,.5)}
        .cancel-btn{background:#f8f9fa;color:#666;border:2px solid #e0e0e0}
        .cancel-btn:hover{background:#e9ecef}
        .floating-install-btn{position:fixed;bottom:100px;right:20px;background:linear-gradient(135deg,#1a5fb4 0%,#2d8fd5 100%);color:white;width:60px;height:60px;border-radius:50%;display:none;justify-content:center;align-items:center;font-size:1.5rem;cursor:pointer;z-index:1000;box-shadow:0 10px 30px rgba(26,95,180,.4);transition:all .3s ease;animation:pulse 2s infinite}
        
        /* بقية الأنماط */
        .content-section{display:none}
        .content-section.active{display:block}
        .section-header{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:15px;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #f0f0f0}
        .section-title{font-size:1.5rem;color:#2c3e50;font-weight:700}
        .section-controls{display:flex;gap:10px;flex-wrap:wrap}
        .filter-controls{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:20px}
        .filter-group{flex:1;min-width:150px}
        .filter-label{display:block;margin-bottom:5px;font-weight:600;color:#555;font-size:.9rem}
        .filter-select,.filter-input{width:100%;padding:10px;border:2px solid #ddd;border-radius:8px;font-size:.9rem;background:#f8f9fa}
        .filter-select:focus,.filter-input:focus{border-color:#1a5fb4;outline:none;background:#fff}
        .cards-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:20px;margin-bottom:30px}
        .card{background:#fff;border-radius:15px;padding:20px;box-shadow:0 5px 15px rgba(0,0,0,.08);transition:all .3s ease;border:1px solid #eee}
        .card:hover{transform:translateY(-5px);box-shadow:0 15px 30px rgba(0,0,0,.15)}
        .card-icon{font-size:2.5rem;margin-bottom:15px;width:60px;height:60px;display:flex;align-items:center;justify-content:center;border-radius:12px}
        .card-title{font-size:1.1rem;color:#2c3e50;margin-bottom:10px;font-weight:600}
        .card-value{font-size:2.2rem;font-weight:700;color:#1a5fb4;margin-bottom:5px}
        .card-label{font-size:.9rem;color:#666}
        .card-trend{font-size:.85rem;margin-top:10px;display:flex;align-items:center;gap:5px}
        .trend-up{color:#27ae60}
        .trend-down{color:#e74c3c}
        .priority-card.high{background:linear-gradient(135deg,#ff6b6b,#ff8e8e);color:#fff}
        .priority-card.medium{background:linear-gradient(135deg,#f39c12,#f1c40f);color:#fff}
        .priority-card.low{background:linear-gradient(135deg,#2ecc71,#27ae60);color:#fff}
        .status-badge{padding:4px 12px;border-radius:20px;font-size:.8rem;font-weight:600;display:inline-block}
        .status-new{background:#e3f2fd;color:#1565c0}
        .status-in-progress{background:#fff3e0;color:#f57c00}
        .status-resolved{background:#e8f5e9;color:#2e7d32}
        .status-closed{background:#f5f5f5;color:#616161}
        .complaints-table-container{overflow-x:auto;margin-bottom:20px;border-radius:10px;border:1px solid #eee;-webkit-overflow-scrolling: touch;}
        .complaints-table{width:100%;border-collapse:collapse;min-width:900px}
        .complaints-table thead{background:linear-gradient(135deg,#1a5fb4,#2d8fd5);color:#fff}
        .complaints-table th{padding:15px 10px;text-align:right;font-weight:600;font-size:.95rem;white-space:nowrap}
        .complaints-table tbody tr{border-bottom:1px solid #eee;transition:background .2s}
        .complaints-table tbody tr:hover{background:#f8f9fa}
        .complaints-table tbody tr.unread{background:#fff9e6;font-weight:600}
        .complaints-table td{padding:15px 10px;text-align:right;font-size:.9rem}
        .complaints-table .actions{display:flex;gap:8px;flex-wrap:wrap}
        .pagination{display:flex;justify-content:center;align-items:center;gap:10px;margin-top:20px;flex-wrap:wrap}
        .pagination-btn{background:#f8f9fa;border:1px solid #ddd;padding:8px 15px;border-radius:8px;cursor:pointer;font-size:.9rem;transition:all .2s}
        .pagination-btn:hover{background:#e9ecef}
        .pagination-btn:disabled{opacity:.5;cursor:not-allowed}
        .pagination-btn.active{background:#1a5fb4;color:#fff;border-color:#1a5fb4}
        .pagination-info{color:#666;font-size:.9rem}
        .responses-container{margin:25px 0;padding:20px;background:#f8f9fa;border-radius:12px;border:2px solid #e0e0e0}
        .responses-title{color:#2c3e50;margin-bottom:15px;display:flex;align-items:center;gap:10px;font-size:1.2rem;font-weight:700}
        .responses-list{display:flex;flex-direction:column;gap:12px}
        .response-item{padding:15px;border-radius:10px;animation:fadeIn .3s ease}
        .response-admin{background:linear-gradient(135deg,#d4edda,#c3e6cb);border-right:4px solid #28a745;margin-right:20px}
        .response-client{background:linear-gradient(135deg,#e3f2fd,#bbdefb);border-left:4px solid #3498db;margin-left:20px}
        .response-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap;gap:10px}
        .response-sender{display:flex;align-items:center;gap:8px;font-weight:600;color:#2c3e50}
        .response-time{font-size:.85rem;color:#666;font-weight:500}
        .response-content{white-space:pre-line;line-height:1.6;padding:10px;background:rgba(255,255,255,.7);border-radius:8px;margin-top:8px;color:#333}
        .reply-form{margin-top:20px;padding:20px;background:#f8f9fa;border-radius:12px;border:2px solid #e0e0e0}
        .reply-form h4{color:#2c3e50;margin-bottom:15px;display:flex;align-items:center;gap:10px}
        .reply-form textarea{width:100%;min-height:120px;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:.95rem;resize:vertical}
        .reply-form textarea:focus{border-color:#1a5fb4;outline:none;background:#fff}
        .reply-form .form-actions{display:flex;gap:10px;margin-top:15px;flex-wrap:wrap}
        .status-form{margin-top:20px;padding:20px;background:#f8f9fa;border-radius:12px;border:2px solid #e0e0e0}
        .status-form h4{color:#2c3e50;margin-bottom:15px;display:flex;align-items:center;gap:10px}
        .status-form select{width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:.95rem;background:#fff}
        .status-form select:focus{border-color:#1a5fb4;outline:none}
        .status-form .form-actions{display:flex;gap:10px;margin-top:15px;flex-wrap:wrap}
        .mobile-menu-btn{display:flex;align-items:center;justify-content:center;gap:8px;background:#1a5fb4;color:#fff;border:none;padding:12px 15px;border-radius:10px;cursor:pointer;font-weight:600;margin-bottom:15px;width:100%;display:none}
        .mobile-nav{position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:2px solid #1a5fb4;display:flex;justify-content:space-around;padding:12px 10px;z-index:999;box-shadow:0 -5px 20px rgba(0,0,0,.1);display:flex}
        .mobile-nav-item{display:flex;flex-direction:column;align-items:center;gap:5px;color:#666;text-decoration:none;font-size:.8rem;flex:1;padding:8px 5px;border-radius:10px;transition:all .2s;position:relative;cursor:pointer}
        .mobile-nav-item:hover{background:#f8f9fa}
        .mobile-nav-item.active{background:#1a5fb4;color:#fff}
        .mobile-nav-icon{font-size:1.2rem}
        .mobile-nav-badge{position:absolute;top:-5px;right:10px;background:#e74c3c;color:#fff;border-radius:50%;padding:2px 6px;font-size:.7rem;min-width:18px;text-align:center;font-weight:700;display:none}
        .install-btn-container{text-align:center;margin:15px 0;display:none}
        .btn-export{background:linear-gradient(135deg,#27ae60,#2ecc71);color:#fff;padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-weight:600;display:flex;align-items:center;gap:8px;font-size:.95rem}
        .btn-export:hover{background:linear-gradient(135deg,#229954,#27ae60);transform:translateY(-2px)}
        .btn-add{background:linear-gradient(135deg,#3498db,#2980b9);color:#fff;padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-weight:600;display:flex;align-items:center;gap:8px;font-size:.95rem}
        .btn-add:hover{background:linear-gradient(135deg,#2980b9,#1f618d);transform:translateY(-2px)}
        .users-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:20px;margin-top:20px}
        .user-card{background:#fff;border-radius:15px;padding:20px;box-shadow:0 5px 15px rgba(0,0,0,.08);border:1px solid #eee;transition:all .3s}
        .user-card:hover{transform:translateY(-5px);box-shadow:0 15px 30px rgba(0,0,0,.15)}
        .user-card-header{display:flex;align-items:center;gap:15px;margin-bottom:15px}
        .user-avatar{width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,#3498db,#2c3e50);display:flex;align-items:center;justify-content:center;font-size:1.5rem;color:#fff;flex-shrink:0}
        .user-info h3{color:#2c3e50;font-size:1.1rem;margin-bottom:5px}
        .user-role{display:inline-block;padding:4px 12px;border-radius:20px;font-size:.8rem;font-weight:600;background:#e3f2fd;color:#1565c0;margin-bottom:8px}
        .user-role.admin{background:#e8f5e9;color:#2e7d32}
        .user-email{font-size:.85rem;color:#666;display:flex;align-items:center;gap:5px}
        .user-departments{margin-top:12px;padding-top:12px;border-top:1px solid #eee}
        .user-departments-title{font-size:.85rem;color:#666;margin-bottom:8px;font-weight:600}
        .department-tags{display:flex;flex-wrap:wrap;gap:6px}
        .department-tag{background:#fff3e0;color:#f57c00;padding:4px 10px;border-radius:15px;font-size:.75rem;font-weight:600}
        .user-actions{display:flex;gap:8px;margin-top:15px}
        .user-actions button{flex:1;padding:8px;font-size:.85rem;min-width:0}
        .form-modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.9);display:none;justify-content:center;align-items:center;z-index:1100;padding:15px}
        .form-modal .modal-content{max-width:600px}
        .form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:15px;margin-bottom:15px}
        .form-group{display:flex;flex-direction:column}
        .form-group label{margin-bottom:8px;font-weight:600;color:#2c3e50;font-size:.95rem}
        .form-group input,.form-group select,.form-group textarea{padding:12px;border:2px solid #ddd;border-radius:8px;font-size:.95rem;background:#f8f9fa}
        .form-group input:focus,.form-group select:focus,.form-group textarea:focus{border-color:#1a5fb4;outline:none;background:#fff}
        .form-group.full-width{grid-column:1/-1}
        .multi-select{min-height:150px;border:2px solid #ddd;border-radius:8px;padding:10px;background:#f8f9fa;max-height:200px;overflow-y:auto}
        .multi-select label{display:flex;align-items:center;gap:10px;padding:8px;margin-bottom:5px;cursor:pointer;border-radius:5px;transition:background .2s}
        .multi-select label:hover{background:#e9ecef}
        .multi-select input[type="checkbox"]{width:18px;height:18px;cursor:pointer}
        .form-actions{display:flex;gap:10px;margin-top:20px;flex-wrap:wrap}
        .form-actions button{flex:1;padding:12px;min-width:120px}
        .settings-grid{display:grid;grid-template-columns:1fr;gap:20px}
        .settings-card{background:#fff;border-radius:15px;padding:25px;box-shadow:0 5px 15px rgba(0,0,0,.08);border:1px solid #eee}
        .settings-card h3{color:#2c3e50;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #f0f0f0;font-size:1.2rem}
        .setting-item{margin-bottom:20px;padding-bottom:20px;border-bottom:1px solid #eee}
        .setting-item:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0}
        .setting-label{display:block;font-weight:600;margin-bottom:8px;color:#2c3e50}
        .setting-description{font-size:.85rem;color:#666;margin-top:5px;line-height:1.5}
        .setting-input,.setting-select,.setting-textarea{width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:.95rem;background:#f8f9fa}
        .setting-input:focus,.setting-select:focus,.setting-textarea:focus{border-color:#1a5fb4;outline:none;background:#fff}
        .setting-textarea{min-height:120px;resize:vertical}
        .toggle-switch{position:relative;display:inline-block;width:60px;height:34px;vertical-align:middle}
        .toggle-switch input{opacity:0;width:0;height:0}
        .toggle-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;transition:.4s;border-radius:34px}
        .toggle-slider:before{position:absolute;content:"";height:26px;width:26px;left:4px;bottom:4px;background-color:white;transition:.4s;border-radius:50%}
        input:checked+.toggle-slider{background-color:#1a5fb4}
        input:checked+.toggle-slider:before{transform:translateX(26px)}
        .departments-list{display:flex;flex-wrap:wrap;gap:10px;margin-top:15px}
        .department-item{background:#e3f2fd;color:#1565c0;padding:10px 15px;border-radius:20px;display:flex;align-items:center;gap:10px;font-weight:600}
        .department-item .delete-dept{color:#e74c3c;cursor:pointer;font-size:1.1rem;transition:transform .2s}
        .department-item .delete-dept:hover{transform:scale(1.2)}
        .add-department-form{display:flex;gap:10px;margin-top:15px;flex-wrap:wrap}
        .add-department-form input{flex:1;min-width:200px}
        .modal-actions{display:flex;gap:10px;padding:20px;background:#f8f9fa;border-radius:0 0 20px 20px;flex-wrap:wrap}
        .modal-actions button{flex:1;min-width:120px}
        
        /* أنماط تفاصيل الشكوى */
        .complaint-details-modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.9);display:none;justify-content:center;align-items:center;z-index:1100;padding:15px}
        .modal-content{background:#fff;border-radius:20px;width:100%;max-width:900px;max-height:90vh;overflow-y:auto;position:relative;animation:modalSlideUp .3s ease}
        @keyframes modalSlideUp{from{opacity:0;transform:translateY(50px)}to{opacity:1;transform:translateY(0)}}
        .modal-header{background:linear-gradient(135deg,#1a5fb4 0%,#2d8fd5 100%);color:#fff;padding:20px;border-radius:20px 20px 0 0;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:1}
        .modal-title{font-size:1.4rem;font-weight:700}
        .close-modal{background:none;border:none;color:#fff;font-size:2rem;cursor:pointer;line-height:1;padding:5px}
        .modal-body{padding:20px}
        .details-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:15px;margin-bottom:20px}
        .detail-item{padding:15px;border-bottom:1px solid #eee;background:#f8f9fa;border-radius:10px}
        .detail-item.full-width{grid-column:1/-1}
        .detail-label{font-weight:700;color:#1a5fb4;margin-bottom:8px;font-size:.95rem}
        .detail-value{color:#333;line-height:1.6;white-space:pre-wrap;word-break:break-word}
        .action-btn{padding:10px 15px;border:none;border-radius:8px;cursor:pointer;font-size:.9rem;display:flex;align-items:center;justify-content:center;gap:5px;transition:all .2s ease;min-width:100px;font-weight:600}
        .btn-view{background:#3498db;color:#fff}
        .btn-view:hover{background:#2980b9}
        .btn-reply{background:#9b59b6;color:#fff}
        .btn-reply:hover{background:#8e44ad}
        .btn-edit{background:#f39c12;color:#fff}
        .btn-edit:hover{background:#e67e22}
        .btn-delete{background:#e74c3c;color:#fff}
        .btn-delete:hover{background:#c0392b}
        .btn-status{background:#27ae60;color:#fff}
        .btn-status:hover{background:#229954}
        .btn-secondary{background:#6c757d;color:#fff}
        .btn-secondary:hover{background:#5a6268}
        .national-id{font-family:monospace;font-size:1.05rem;letter-spacing:1px;direction:ltr;text-align:right}
        .new-request-indicator{display:inline-block;width:10px;height:10px;background:#e74c3c;border-radius:50%;margin-left:8px;animation:blink 1.5s infinite}
        @keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
        
        /* Toast للإشعارات */
        #pwa-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 12px;
            color: white;
            font-weight: bold;
            z-index: 10000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            max-width: 400px;
            animation: slideIn 0.3s ease;
            display: none;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        /* التجاوب مع الشاشات */
        @media (max-width:768px){
            .mobile-menu-btn,.mobile-nav{display:flex}
            .cards-grid{grid-template-columns:1fr}
            .details-grid{grid-template-columns:1fr}
            .complaints-table th,.complaints-table td{padding:10px 8px;font-size:.85rem}
            .section-header{flex-direction:column;align-items:flex-start}
            .filter-controls{flex-direction:column}
            .users-grid{grid-template-columns:1fr}
            .admin-info{flex-direction:column;text-align:center}
            .admin-text h3,.admin-text p{text-align:center}
            .logo{font-size:1.5rem}
            .subtitle{font-size:.9rem}
            .response-admin{margin-right:10px}
            .response-client{margin-left:10px}
            .form-row{grid-template-columns:1fr}
            .form-actions{flex-direction:column}
            .form-actions button{width:100%}
            .modal-content{max-width:100%;max-height:95vh}
            .modal-actions{flex-direction:column}
            .modal-actions button{width:100%}
        }
        @media (min-width:769px){
            .dashboard-grid{display:grid;grid-template-columns:280px 1fr}
            .sidebar{position:static;width:100%;height:auto;right:0;box-shadow:none;border-radius:15px}
            .sidebar-overlay{display:none !important}
            .close-sidebar{display:none}
            .mobile-menu-btn,.mobile-nav{display:none}
        }
        @media (max-width:480px){
            .admin-stats{grid-template-columns:1fr}
            .card-value{font-size:1.8rem}
            .complaints-table .actions{flex-direction:column}
            .action-btn{width:100%}
        }
    </style>
</head>
<body>
    <div id="installContainer" class="install-container" style="display: none;">
        <div class="install-card">
            <div class="install-icon">
                <i class="fas fa-user-shield"></i>
            </div>
            <div class="install-text">
                <h3 id="installTitle">تثبيت تطبيق الإدارة</h3>
                <p id="installDescription">جاري تحميل التعليمات...</p>
            </div>
            <button class="install-btn" id="installButton">
                <i class="fas fa-download"></i> تثبيت التطبيق
            </button>
            <button class="cancel-btn" id="cancelInstall">
                لاحقاً
            </button>
        </div>
    </div>

    <div class="floating-install-btn" id="floatingInstallBtn">
        <i class="fas fa-download"></i>
    </div>

    <div id="pwa-toast"></div>

    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <div class="login-logo">
                <i class="fas fa-user-shield"></i>
            </div>
            <h2 class="login-title">تسجيل دخول المسؤول</h2>
            <form id="loginForm" class="login-form">
                <div class="form-group">
                    <label class="form-label">اسم المستخدم</label>
                    <input type="text" class="form-control" id="username" placeholder="أدخل اسم المستخدم" required>
                </div>
                <div class="form-group">
                    <label class="form-label">كلمة المرور</label>
                    <input type="password" class="form-control" id="password" placeholder="أدخل كلمة المرور" required>
                </div>
                <div class="login-error" id="loginError">
                    اسم المستخدم أو كلمة المرور غير صحيحة
                </div>
                <button type="submit" class="login-btn">
                    <i class="fas fa-sign-in-alt"></i>
                    تسجيل الدخول
                </button>
            </form>
        </div>
    </div>

    <div id="dashboardScreen" style="display:none;">
        <header>
            <div class="container">
                <h1 class="logo">لوحة التحكم - نظام الشكاوى الموحد</h1>
                <p class="subtitle">إدارة الشكاوى والطلبات المقدمة من المواطنين</p>
            </div>
        </header>

        <div class="container">
            <button class="mobile-menu-btn" id="mobileMenuBtn">
                <i class="fas fa-bars"></i>
                عرض القائمة
            </button>

            <div class="admin-bar">
                <div class="admin-info">
                    <div class="admin-avatar">
                        <i class="fas fa-user-shield"></i>
                    </div>
                    <div class="admin-text">
                        <h3 id="adminWelcome">مرحباً، المسؤول</h3>
                        <p id="adminLastLogin">آخر دخول: -</p>
                    </div>
                </div>

                <div class="admin-stats">
                    <div class="stat-box">
                        <div class="stat-value" id="totalComplaints">0</div>
                        <div class="stat-label">إجمالي الشكاوى</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="newComplaints">0</div>
                        <div class="stat-label">شكاوى جديدة</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="resolvedComplaints">0</div>
                        <div class="stat-label">تم حلها</div>
                    </div>
                </div>

                <button class="logout-btn" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    تسجيل الخروج
                </button>
            </div>

            <div class="dashboard-grid">
                <div class="sidebar-overlay" id="sidebarOverlay"></div>
                <div class="sidebar" id="sidebar">
                    <div class="sidebar-header">
                        <h3 class="sidebar-title">القائمة الرئيسية</h3>
                        <button class="close-sidebar" id="closeSidebar">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <ul class="sidebar-menu">
                        <li class="menu-item active" data-section="dashboard">
                            <i class="fas fa-tachometer-alt menu-icon"></i>
                            <span>لوحة التحكم</span>
                        </li>
                        <li class="menu-item" data-section="complaints">
                            <i class="fas fa-file-alt menu-icon"></i>
                            <span>إدارة الشكاوى</span>
                            <span class="badge" id="complaintsBadge" style="display:none;">0</span>
                        </li>
                        <li class="menu-item admin-only" data-section="reports">
                            <i class="fas fa-chart-bar menu-icon"></i>
                            <span>التقارير والتحليلات</span>
                        </li>
                        <li class="menu-item admin-only" data-section="templates">
                            <i class="fas fa-file-alt menu-icon"></i>
                            <span>القوالب والردود</span>
                        </li>
                        <li class="menu-item admin-only" data-section="workflow">
                            <i class="fas fa-cogs menu-icon"></i>
                            <span>سير العمل</span>
                        </li>
                        <li class="menu-item admin-only" data-section="users">
                            <i class="fas fa-users menu-icon"></i>
                            <span>المستخدمين</span>
                        </li>
                        <li class="menu-item admin-only" data-section="settings">
                            <i class="fas fa-cog menu-icon"></i>
                            <span>الإعدادات</span>
                        </li>
                        <li class="menu-item admin-only" data-section="departments">
                            <i class="fas fa-building menu-icon"></i>
                            <span>الأقسام</span>
                        </li>
                        <li class="menu-item admin-only" data-section="audit">
                            <i class="fas fa-history menu-icon"></i>
                            <span>سجلات التدقيق</span>
                        </li>
                        <li class="menu-item admin-only" data-section="tasks">
                            <i class="fas fa-tasks menu-icon"></i>
                            <span>المهام</span>
                        </li>
                    </ul>
                    
                    <div class="install-btn-container" id="installBtnContainer">
                        <button class="install-btn" id="installBtn">
                            <i class="fas fa-download"></i>
                            تثبيت التطبيق
                        </button>
                    </div>
                </div>

                <div class="main-content">
                    <div id="dashboardSection" class="content-section active">
                        <div class="section-header">
                            <h2 class="section-title">لوحة التحكم الرئيسية</h2>
                            <div class="section-controls">
                                <button class="btn-export" onclick="dashboardHandler.generateDailyReport()">
                                    <i class="fas fa-file-pdf"></i>
                                    تقرير يومي
                                </button>
                                <button class="btn-add" onclick="showNotificationSettings()">
                                    <i class="fas fa-bell"></i>
                                    إعداد التنبيهات
                                </button>
                            </div>
                        </div>
                        
                        <div class="cards-grid">
                            <div class="card priority-card high">
                                <div class="card-icon">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </div>
                                <h3 class="card-title">شكاوى عاجلة</h3>
                                <div class="card-value" id="urgentComplaints">0</div>
                                <p class="card-label">تحتاج متابعة فورية</p>
                            </div>

                            <div class="card">
                                <div class="card-icon" style="background:#e3f2fd;color:#1565c0">
                                    <i class="fas fa-inbox"></i>
                                </div>
                                <h3 class="card-title">شكاوى جديدة</h3>
                                <div class="card-value" id="cardNewComplaints">0</div>
                                <p class="card-label">في انتظار المراجعة</p>
                            </div>

                            <div class="card">
                                <div class="card-icon" style="background:#e8f5e9;color:#2e7d32">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <h3 class="card-title">شكاوى مكتملة</h3>
                                <div class="card-value" id="cardCompletedComplaints">0</div>
                                <p class="card-label">تم حلها</p>
                            </div>

                            <div class="card">
                                <div class="card-icon" style="background:#fff3e0;color:#f57c00">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <h3 class="card-title">قيد المعالجة</h3>
                                <div class="card-value" id="cardInProgress">0</div>
                                <p class="card-label">قيد العمل</p>
                            </div>
                            
                            <div class="card">
                                <div class="card-icon" style="background:#f3e5f5;color:#7b1fa2">
                                    <i class="fas fa-user-clock"></i>
                                </div>
                                <h3 class="card-title">SLA المتأخرة</h3>
                                <div class="card-value" id="slaOverdue">0</div>
                                <p class="card-label">تجاوز الوقت المحدد</p>
                            </div>
                            
                            <div class="card">
                                <div class="card-icon" style="background:#e8f4fd;color:#0d47a1">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                                <h3 class="card-title">معدل الحل</h3>
                                <div class="card-value" id="resolutionRate">0%</div>
                                <p class="card-label">نسبة الحل اليومية</p>
                            </div>
                        </div>

                        <div class="section-header">
                            <h2 class="section-title">أحدث الشكاوى العاجلة</h2>
                        </div>
                        <div class="complaints-table-container">
                            <table class="complaints-table">
                                <thead>
                                    <tr>
                                        <th>رقم الشكوى</th>
                                        <th>الاسم</th>
                                        <th>القسم</th>
                                        <th>الأولوية</th>
                                        <th>مدة الانتظار</th>
                                        <th>إجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="urgentComplaintsBody">
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="section-header">
                            <h2 class="section-title">أحدث الشكاوى</h2>
                        </div>
                        <div class="complaints-table-container">
                            <table class="complaints-table">
                                <thead>
                                    <tr>
                                        <th>رقم الشكوى</th>
                                        <th>الاسم</th>
                                        <th>القسم</th>
                                        <th>الحالة</th>
                                        <th>التاريخ</th>
                                        <th>إجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="latestComplaintsBody">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="complaintsSection" class="content-section">
                        <div class="section-header">
                            <h2 class="section-title">إدارة الشكاوى</h2>
                            <div class="section-controls">
                                <button class="btn-add" onclick="complaintHandler.openAdvancedSearch()">
                                    <i class="fas fa-search-plus"></i>
                                    بحث متقدم
                                </button>
                                <button class="btn-export" onclick="exportToExcel()">
                                    <i class="fas fa-file-excel"></i>
                                    تصدير Excel
                                </button>
                                <button class="btn-export" onclick="complaintHandler.exportFilteredData()">
                                    <i class="fas fa-file-export"></i>
                                    تصدير مخصص
                                </button>
                            </div>
                        </div>

                        <div class="filter-controls">
                            <div class="filter-group">
                                <label class="filter-label">البحث المتقدم</label>
                                <div style="display:flex;gap:5px;">
                                    <input type="text" id="searchComplaints" class="filter-input" placeholder="ابحث برقم الطلب، الاسم، الرقم القومي...">
                                    <button class="action-btn btn-view" onclick="complaintHandler.voiceSearch()" style="padding:8px 12px;min-width:auto;">
                                        <i class="fas fa-microphone"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">القسم</label>
                                <select id="filterDepartment" class="filter-select">
                                    <option value="">جميع الأقسام</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">الحالة</label>
                                <select id="filterStatus" class="filter-select">
                                    <option value="">جميع الحالات</option>
                                    <option value="جديدة">جديدة</option>
                                    <option value="قيد المراجعة">قيد المراجعة</option>
                                    <option value="قيد المعالجة">قيد المعالجة</option>
                                    <option value="تم الرد">تم الرد</option>
                                    <option value="مكتملة">مكتملة</option>
                                    <option value="ملغاة">ملغاة</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">الأولوية</label>
                                <select id="filterPriority" class="filter-select">
                                    <option value="">جميع الأولويات</option>
                                    <option value="عادية">عادية</option>
                                    <option value="مهمة">مهمة</option>
                                    <option value="فى غاية الأهمية">فى غاية الأهمية</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">من تاريخ</label>
                                <input type="date" id="filterDateFrom" class="filter-input">
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">إلى تاريخ</label>
                                <input type="date" id="filterDateTo" class="filter-input">
                            </div>
                        </div>

                        <div class="complaints-table-container">
                            <table class="complaints-table">
                                <thead>
                                    <tr>
                                        <th>رقم الشكوى</th>
                                        <th>الاسم</th>
                                        <th>القسم</th>
                                        <th>الحالة</th>
                                        <th>الأولوية</th>
                                        <th>التاريخ</th>
                                        <th>إجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="complaintsTableBody">
                                </tbody>
                            </table>
                        </div>

                        <div class="pagination">
                            <button class="pagination-btn" onclick="changePage(-1)" id="prevPage">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                            <span class="pagination-info" id="pageInfo">الصفحة 1 من 1</span>
                            <button class="pagination-btn" onclick="changePage(1)" id="nextPage">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- قسم التقارير والتحليلات -->
                    <div id="reportsSection" class="content-section">
                        <div class="section-header">
                            <h2 class="section-title">التقارير والتحليلات</h2>
                            <div class="section-controls">
                                <button class="btn-export" onclick="reportsHandler.generateDailyReport()">
                                    <i class="fas fa-file-pdf"></i>
                                    تقرير يومي
                                </button>
                                <button class="btn-export" onclick="reportsHandler.generateWeeklyReport()">
                                    <i class="fas fa-chart-bar"></i>
                                    تقرير أسبوعي
                                </button>
                                <button class="btn-export" onclick="reportsHandler.generateMonthlyReport()">
                                    <i class="fas fa-chart-line"></i>
                                    تقرير شهري
                                </button>
                            </div>
                        </div>
                        
                        <div class="cards-grid">
                            <div class="card">
                                <div class="card-icon" style="background:#e3f2fd;color:#1565c0">
                                    <i class="fas fa-chart-pie"></i>
                                </div>
                                <h3 class="card-title">توزيع الحالات</h3>
                                <div class="card-value" id="reportStatusDistribution">0</div>
                                <p class="card-label">حالات مختلفة</p>
                            </div>
                            
                            <div class="card">
                                <div class="card-icon" style="background:#e8f5e9;color:#2e7d32">
                                    <i class="fas fa-building"></i>
                                </div>
                                <h3 class="card-title">توزيع الأقسام</h3>
                                <div class="card-value" id="reportDepartmentDistribution">0</div>
                                <p class="card-label">أقسام مختلفة</p>
                            </div>
                            
                            <div class="card">
                                <div class="card-icon" style="background:#fff3e0;color:#f57c00">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <h3 class="card-title">متوسط وقت الحل</h3>
                                <div class="card-value" id="reportAvgResolutionTime">0</div>
                                <p class="card-label">بالساعات</p>
                            </div>
                            
                            <div class="card">
                                <div class="card-icon" style="background:#f3e5f5;color:#7b1fa2">
                                    <i class="fas fa-trend-up"></i>
                                </div>
                                <h3 class="card-title">معدل النمو</h3>
                                <div class="card-value" id="reportGrowthRate">0%</div>
                                <p class="card-label">الشهر الحالي</p>
                            </div>
                        </div>
                        
                        <div class="section-header">
                            <h2 class="section-title">تقارير سريعة</h2>
                        </div>
                        
                        <div class="filter-controls">
                            <div class="filter-group">
                                <label class="filter-label">نوع التقرير</label>
                                <select id="reportType" class="filter-select" onchange="reportsHandler.loadReportData()">
                                    <option value="daily">تقرير يومي</option>
                                    <option value="weekly">تقرير أسبوعي</option>
                                    <option value="monthly">تقرير شهري</option>
                                    <option value="department">حسب الأقسام</option>
                                    <option value="employee">أداء الموظفين</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">الفترة الزمنية</label>
                                <select id="reportPeriod" class="filter-select" onchange="reportsHandler.loadReportData()">
                                    <option value="today">اليوم</option>
                                    <option value="yesterday">أمس</option>
                                    <option value="week">هذا الأسبوع</option>
                                    <option value="month">هذا الشهر</option>
                                    <option value="last_month">الشهر الماضي</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">تصدير التقرير</label>
                                <button class="btn-export" onclick="reportsHandler.exportCurrentReport()" style="width:100%">
                                    <i class="fas fa-download"></i>
                                    تصدير
                                </button>
                            </div>
                        </div>
                        
                        <div id="reportResults" style="margin-top:20px;padding:20px;background:#f8f9fa;border-radius:10px;">
                            <p style="text-align:center;color:#666;">اختر نوع التقرير والفترة الزمنية لعرض البيانات</p>
                        </div>
                    </div>
                    
                    <!-- قسم القوالب والردود -->
                    <div id="templatesSection" class="content-section">
                        <div class="section-header">
                            <h2 class="section-title">إدارة القوالب والردود الجاهزة</h2>
                            <div class="section-controls">
                                <button class="btn-add" onclick="templatesHandler.openTemplateModal()">
                                    <i class="fas fa-plus"></i>
                                    إضافة قالب
                                </button>
                            </div>
                        </div>
                        
                        <div class="filter-controls">
                            <div class="filter-group">
                                <label class="filter-label">بحث في القوالب</label>
                                <input type="text" id="searchTemplates" class="filter-input" placeholder="ابحث في القوالب..." oninput="templatesHandler.searchTemplates()">
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">القسم</label>
                                <select id="templateDepartment" class="filter-select" onchange="templatesHandler.filterTemplates()">
                                    <option value="">جميع الأقسام</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">نوع القالب</label>
                                <select id="templateType" class="filter-select" onchange="templatesHandler.filterTemplates()">
                                    <option value="">جميع الأنواع</option>
                                    <option value="welcome">ترحيب</option>
                                    <option value="response">رد</option>
                                    <option value="followup">متابعة</option>
                                    <option value="resolution">حل</option>
                                    <option value="closure">إغلاق</option>
                                </select>
                            </div>
                        </div>
                        
                        <div id="templatesList" class="users-grid">
                            <!-- ستتم إضافة القوالب هنا ديناميكياً -->
                        </div>
                    </div>
                    
                    <!-- قسم سير العمل -->
                    <div id="workflowSection" class="content-section">
                        <div class="section-header">
                            <h2 class="section-title">إعدادات سير العمل التلقائي</h2>
                        </div>
                        
                        <div class="settings-card">
                            <h3><i class="fas fa-cogs"></i> أتمتة سير العمل</h3>
                            
                            <div class="setting-item">
                                <label class="setting-label">توزيع الشكاوى تلقائياً</label>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="autoAssign" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                                <p class="setting-description">توزيع الشكاوى الجديدة على الموظفين تلقائياً</p>
                            </div>
                            
                            <div class="setting-item">
                                <label class="setting-label">الرد التلقائي</label>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="autoReply" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                                <p class="setting-description">إرسال رد تلقائي عند استلام الشكوى</p>
                            </div>
                            
                            <div class="setting-item">
                                <label class="setting-label">نص الرد التلقائي</label>
                                <textarea class="setting-textarea" id="autoReplyText" placeholder="أدخل نص الرد التلقائي...">شكراً لتواصلكم معنا. تم استلام شكواك وسيتم مراجعتها من قبل الفريق المختص في أقرب وقت ممكن.</textarea>
                            </div>
                            
                            <div class="setting-item">
                                <label class="setting-label">تصعيد الشكاوى تلقائياً</label>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="autoEscalation" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                                <p class="setting-description">تصعيد الشكاوى المتأخرة إلى المدير تلقائياً</p>
                            </div>
                            
                            <div class="setting-item">
                                <label class="setting-label">مدة التصعيد (ساعات)</label>
                                <input type="number" class="setting-input" id="escalationTime" value="24" min="1" max="168">
                                <p class="setting-description">عدد الساعات قبل تصعيد الشكوى</p>
                            </div>
                            
                            <div class="setting-item">
                                <label class="setting-label">إغلاق الشكاوى تلقائياً</label>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="autoClosure">
                                    <span class="toggle-slider"></span>
                                </label>
                                <p class="setting-description">إغلاق الشكاوى بعد تأكيد العميل</p>
                            </div>
                            
                            <div class="setting-item">
                                <label class="setting-label">أرشفة الشكاوى تلقائياً</label>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="autoArchive" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                                <p class="setting-description">أرشفة الشكاوى المكتملة بعد 30 يوماً</p>
                            </div>
                            
                            <button class="btn-add" onclick="workflowHandler.saveSettings()">
                                <i class="fas fa-save"></i>
                                حفظ إعدادات سير العمل
                            </button>
                        </div>
                    </div>

                    <div id="usersSection" class="content-section">
                        <div class="section-header">
                            <h2 class="section-title">إدارة المستخدمين</h2>
                            <div class="section-controls">
                                <button class="btn-add" onclick="openAddUserModal()">
                                    <i class="fas fa-user-plus"></i>
                                    إضافة مستخدم
                                </button>
                            </div>
                        </div>
                        <div class="users-grid" id="usersGrid">
                        </div>
                    </div>

                    <div id="settingsSection" class="content-section">
                        <div class="section-header">
                            <h2 class="section-title">إعدادات النظام</h2>
                        </div>
                        <div class="settings-grid">
                            <div class="settings-card">
                                <h3><i class="fas fa-cog"></i> الإعدادات العامة</h3>
                                <div class="setting-item">
                                    <label class="setting-label">اسم النظام</label>
                                    <input type="text" class="setting-input" value="نظام الشكاوى الموحد" id="systemName">
                                    <p class="setting-description">الاسم الذي يظهر في رأس الموقع</p>
                                </div>
                                <div class="setting-item">
                                    <label class="setting-label">وصف النظام</label>
                                    <textarea class="setting-textarea" id="systemDescription">خدمة إلكترونية متطورة لتقديم الشكاوى والمشكلات ومتابعتها بكل سهولة</textarea>
                                    <p class="setting-description">الوصف الذي يظهر في رأس الموقع</p>
                                </div>
                                <div class="setting-item">
                                    <label class="setting-label">تفعيل الإشعارات</label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="enableNotifications" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <p class="setting-description">تفعيل إشعارات الطلبات الجديدة</p>
                                </div>
                                <div class="setting-item">
                                    <label class="setting-label">طلب إذن الإشعارات</label>
                                    <button class="btn-add" onclick="requestNotificationPermission()">
                                        <i class="fas fa-bell"></i>
                                        تفعيل الإشعارات
                                    </button>
                                    <p class="setting-description">يجب تفعيل الإشعارات لتلقي تنبيهات الطلبات الجديدة</p>
                                </div>
                                <button class="btn-add" onclick="saveSettings()">
                                    <i class="fas fa-save"></i>
                                    حفظ الإعدادات
                                </button>
                            </div>

                            <!-- قسم النسخ الاحتياطي والاستعادة -->
                            <div class="settings-card">
                                <h3><i class="fas fa-database"></i> النسخ الاحتياطي والاستعادة</h3>
                                <div class="setting-item">
                                    <label class="setting-label">إنشاء نسخة احتياطية</label>
                                    <p class="setting-description">
                                        قم بتحميل نسخة كاملة من قاعدة البيانات (الشكاوى، المستخدمين، الأقسام، الإعدادات)
                                    </p>
                                    <button class="btn-export" onclick="createBackup()">
                                        <i class="fas fa-download"></i>
                                        إنشاء نسخة احتياطية
                                    </button>
                                </div>
                                
                                <div class="setting-item">
                                    <label class="setting-label">استعادة نسخة احتياطية</label>
                                    <p class="setting-description">
                                        استعادة جميع البيانات من ملف النسخة الاحتياطية (سيتم حذف البيانات الحالية)
                                    </p>
                                    <button class="btn-add" onclick="restoreBackup()" style="background:linear-gradient(135deg,#e74c3c,#c0392b)">
                                        <i class="fas fa-upload"></i>
                                        استعادة البيانات
                                    </button>
                                </div>
                                
                                <div class="setting-item">
                                    <label class="setting-label">تلميحات مهمة:</label>
                                    <ul class="setting-description" style="padding-right:20px;">
                                        <li>النسخة الاحتياطية تحتوي على <strong>جميع البيانات</strong> بما في ذلك المرفقات إذا وجدت</li>
                                        <li>احتفظ بالنسخة الاحتياطية في مكان آمن</li>
                                        <li>يمكنك استعادة البيانات عند تغيير Firebase أو في حالات الطوارئ</li>
                                        <li>الاستعادة تحذف <strong>جميع البيانات الحالية</strong> وتستبدلها</li>
                                        <li>النسخة الاحتياطية متوافقة مع GitHub Pages</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <!-- قسم إعدادات التنبيهات -->
                            <div class="settings-card">
                                <h3><i class="fas fa-bell"></i> إعدادات التنبيهات والتذكيرات</h3>
                                
                                <div class="setting-item">
                                    <label class="setting-label">تنبيهات الشكاوى الجديدة</label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="alertNewComplaints" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <p class="setting-description">إرسال تنبيه فوري عند وصول شكوى جديدة</p>
                                </div>
                                
                                <div class="setting-item">
                                    <label class="setting-label">تذكير الشكاوى المعلقة</label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="alertPendingReminders" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <p class="setting-description">تذكير يومي بالشكاوى المعلقة</p>
                                </div>
                                
                                <div class="setting-item">
                                    <label class="setting-label">تنبيهات تجاوز SLA</label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="alertSLAOverdue" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <p class="setting-description">تنبيه عند تجاوز الوقت المحدد للشكوى</p>
                                </div>
                                
                                <div class="setting-item">
                                    <label class="setting-label">تنبيهات تحديث الحالة</label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="alertStatusUpdate" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <p class="setting-description">تنبيه العميل عند تحديث حالة شكواه</p>
                                </div>
                                
                                <div class="setting-item">
                                    <label class="setting-label">التنبيهات الصوتية</label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="alertSoundEnabled" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <p class="setting-description">تفعيل صوت التنبيه داخل التطبيق</p>
                                </div>
                                
                                <div class="setting-item">
                                    <label class="setting-label">وقت التذكير اليومي</label>
                                    <input type="time" class="setting-input" id="dailyReminderTime" value="09:00">
                                    <p class="setting-description">وقت إرسال التذكيرات اليومية</p>
                                </div>
                                
                                <button class="btn-add" onclick="saveAlertSettings()">
                                    <i class="fas fa-save"></i>
                                    حفظ إعدادات التنبيهات
                                </button>
                            </div>
                            
                            <!-- قسم إعدادات الأولويات -->
                            <div class="settings-card">
                                <h3><i class="fas fa-flag"></i> إعدادات نظام الأولويات</h3>
                                
                                <div class="setting-item">
                                    <label class="setting-label">تحديث الأولوية تلقائياً</label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="priorityAutoUpdate" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <p class="setting-description">تغيير الأولوية تلقائياً مع مرور الوقت</p>
                                </div>
                                
                                <div class="setting-item">
                                    <label class="setting-label">تصعيد تلقائي للشكاوى الحرجة</label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="priorityAutoEscalation" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <p class="setting-description">تصعيد الشكاوى العاجلة إلى قائمة "الشكاوى الساخنة"</p>
                                </div>
                                
                                <div class="setting-item">
                                    <label class="setting-label">مدة الترقية للأولوية (ساعات)</label>
                                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                                        <div>
                                            <label style="font-size:0.8rem;color:#666;">من عادية إلى مهمة</label>
                                            <input type="number" class="setting-input" id="priorityNormalToImportant" value="48" min="1">
                                        </div>
                                        <div>
                                            <label style="font-size:0.8rem;color:#666;">من مهمة إلى عاجلة</label>
                                            <input type="number" class="setting-input" id="priorityImportantToUrgent" value="24" min="1">
                                        </div>
                                    </div>
                                </div>
                                
                                <button class="btn-add" onclick="savePrioritySettings()">
                                    <i class="fas fa-save"></i>
                                    حفظ إعدادات الأولويات
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="departmentsSection" class="content-section">
                        <div class="section-header">
                            <h2 class="section-title">إدارة الأقسام</h2>
                        </div>
                        <div class="settings-card">
                            <h3><i class="fas fa-building"></i> الأقسام المتاحة</h3>
                            <div class="departments-list" id="departmentsList">
                            </div>
                            <div class="add-department-form">
                                <input type="text" id="newDepartmentName" class="setting-input" placeholder="اسم القسم الجديد">
                                <button class="btn-add" onclick="addDepartment()">
                                    <i class="fas fa-plus"></i>
                                    إضافة قسم
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- قسم سجلات التدقيق -->
                    <div id="auditSection" class="content-section">
                        <div class="section-header">
                            <h2 class="section-title">سجلات التدقيق والمراقبة</h2>
                            <div class="section-controls">
                                <button class="btn-export" onclick="auditHandler.exportAuditLogs()">
                                    <i class="fas fa-file-export"></i>
                                    تصدير السجلات
                                </button>
                            </div>
                        </div>
                        
                        <div class="filter-controls">
                            <div class="filter-group">
                                <label class="filter-label">بحث في السجلات</label>
                                <input type="text" id="searchAuditLogs" class="filter-input" placeholder="ابحث في السجلات..." oninput="auditHandler.searchLogs()">
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">نوع الإجراء</label>
                                <select id="auditActionType" class="filter-select" onchange="auditHandler.filterLogs()">
                                    <option value="">جميع الإجراءات</option>
                                    <option value="login">تسجيل الدخول</option>
                                    <option value="logout">تسجيل الخروج</option>
                                    <option value="create">إنشاء</option>
                                    <option value="update">تحديث</option>
                                    <option value="delete">حذف</option>
                                    <option value="reply">رد</option>
                                    <option value="status_change">تغيير حالة</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">من تاريخ</label>
                                <input type="date" id="auditDateFrom" class="filter-input" onchange="auditHandler.filterLogs()">
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">إلى تاريخ</label>
                                <input type="date" id="auditDateTo" class="filter-input" onchange="auditHandler.filterLogs()">
                            </div>
                        </div>
                        
                        <div class="complaints-table-container">
                            <table class="complaints-table">
                                <thead>
                                    <tr>
                                        <th>التاريخ والوقت</th>
                                        <th>المستخدم</th>
                                        <th>نوع الإجراء</th>
                                        <th>التفاصيل</th>
                                        <th>رقم الشكوى</th>
                                        <th>عنوان IP</th>
                                    </tr>
                                </thead>
                                <tbody id="auditLogsBody">
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="pagination">
                            <button class="pagination-btn" onclick="auditHandler.changePage(-1)" id="auditPrevPage">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                            <span class="pagination-info" id="auditPageInfo">الصفحة 1 من 1</span>
                            <button class="pagination-btn" onclick="auditHandler.changePage(1)" id="auditNextPage">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- قسم المهام -->
                    <div id="tasksSection" class="content-section">
                        <div class="section-header">
                            <h2 class="section-title">إدارة المهام والمتابعة</h2>
                            <div class="section-controls">
                                <button class="btn-add" onclick="tasksHandler.openTaskModal()">
                                    <i class="fas fa-plus"></i>
                                    مهمة جديدة
                                </button>
                            </div>
                        </div>
                        
                        <div class="filter-controls">
                            <div class="filter-group">
                                <label class="filter-label">بحث في المهام</label>
                                <input type="text" id="searchTasks" class="filter-input" placeholder="ابحث في المهام..." oninput="tasksHandler.searchTasks()">
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">الحالة</label>
                                <select id="taskStatus" class="filter-select" onchange="tasksHandler.filterTasks()">
                                    <option value="">جميع الحالات</option>
                                    <option value="pending">معلقة</option>
                                    <option value="in_progress">قيد التنفيذ</option>
                                    <option value="completed">مكتملة</option>
                                    <option value="overdue">متأخرة</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">المسؤول</label>
                                <select id="taskAssignee" class="filter-select" onchange="tasksHandler.filterTasks()">
                                    <option value="">جميع المسؤولين</option>
                                </select>
                            </div>
                        </div>
                        
                        <div id="tasksContainer" class="users-grid">
                            <!-- ستتم إضافة المهام هنا ديناميكياً -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="mobile-nav" id="mobileNav">
                <div class="mobile-nav-item active" data-section="dashboard">
                    <i class="fas fa-tachometer-alt mobile-nav-icon"></i>
                    <span>الرئيسية</span>
                </div>
                <div class="mobile-nav-item" data-section="complaints">
                    <i class="fas fa-file-alt mobile-nav-icon"></i>
                    <span>الشكاوى</span>
                    <span class="mobile-nav-badge" id="mobileNavBadge" style="display:none;">0</span>
                </div>
                <div class="mobile-nav-item admin-only" data-section="reports">
                    <i class="fas fa-chart-bar mobile-nav-icon"></i>
                    <span>التقارير</span>
                </div>
                <div class="mobile-nav-item admin-only" data-section="tasks">
                    <i class="fas fa-tasks mobile-nav-icon"></i>
                    <span>المهام</span>
                </div>
                <div class="mobile-nav-item admin-only" data-section="settings">
                    <i class="fas fa-cog mobile-nav-icon"></i>
                    <span>الإعدادات</span>
                </div>
            </div>

            <div class="footer">
                <p>© 2026 نظام الشكاوى الموحد - جميع الحقوق محفوظة</p>
                <p>
                    <i class="fas fa-code"></i>
                    تم برمجة الموقع بكل حب من المهندس
                    <a href="https://www.facebook.com/en.mohamed.nasr" target="_blank">
                        محمد حماد
                        <i class="fab fa-facebook"></i>
                    </a>
                </p>
            </div>
        </div>
    </div>

    <div id="complaintModal" class="complaint-details-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">تفاصيل الشكوى</h3>
                <button class="close-modal" onclick="closeComplaintModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="modalBody">
            </div>
        </div>
    </div>

    <div id="userModal" class="form-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="userModalTitle">إضافة مستخدم جديد</h3>
                <button class="close-modal" onclick="closeUserModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="userForm" onsubmit="return false;">
                    <div class="form-row">
                        <div class="form-group">
                            <label>الاسم الكامل</label>
                            <input type="text" id="userName" required>
                        </div>
                        <div class="form-group">
                            <label>اسم المستخدم</label>
                            <input type="text" id="userUsername" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>البريد الإلكتروني</label>
                            <input type="email" id="userEmail" required>
                        </div>
                        <div class="form-group">
                            <label>كلمة المرور</label>
                            <input type="password" id="userPassword" placeholder="اتركها فارغة للإبقاء على القديمة">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>الدور الوظيفي</label>
                        <select id="userRole">
                            <option value="user">مستخدم</option>
                            <option value="admin">مدير</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label>الأقسام المخصصة (للمستخدم العادي فقط)</label>
                        <div class="multi-select" id="userDepartments">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-actions">
                <button class="action-btn btn-view" onclick="saveUser()">
                    <i class="fas fa-save"></i>
                    حفظ
                </button>
                <button class="action-btn btn-secondary" onclick="closeUserModal()">
                    <i class="fas fa-times"></i>
                    إلغاء
                </button>
            </div>
        </div>
    </div>
    
    <!-- نافذة القالب -->
    <div id="templateModal" class="form-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="templateModalTitle">إضافة قالب جديد</h3>
                <button class="close-modal" onclick="templatesHandler.closeTemplateModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="templateForm" onsubmit="return false;">
                    <div class="form-group">
                        <label>اسم القالب</label>
                        <input type="text" id="templateName" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>القسم</label>
                            <select id="templateDepartmentSelect">
                                <option value="">عام (لجميع الأقسام)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>نوع القالب</label>
                            <select id="templateTypeSelect" required>
                                <option value="welcome">ترحيب</option>
                                <option value="response">رد</option>
                                <option value="followup">متابعة</option>
                                <option value="resolution">حل</option>
                                <option value="closure">إغلاق</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>نص القالب</label>
                        <textarea id="templateContent" rows="8" required placeholder="أدخل نص القالب... يمكنك استخدام المتغيرات التالية: {{اسم_العميل}} {{رقم_الشكوى}} {{التاريخ}} {{القسم}}"></textarea>
                        <p class="setting-description">المتغيرات المتاحة: {{اسم_العميل}} {{رقم_شكوى}} {{التاريخ}} {{القسم}} {{الوقت}} {{المشكلة}}</p>
                    </div>
                    <div class="form-group">
                        <label>وصف القالب</label>
                        <textarea id="templateDescription" rows="3" placeholder="وصف مختصر للقالب..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-actions">
                <button class="action-btn btn-view" onclick="templatesHandler.saveTemplate()">
                    <i class="fas fa-save"></i>
                    حفظ القالب
                </button>
                <button class="action-btn btn-secondary" onclick="templatesHandler.closeTemplateModal()">
                    <i class="fas fa-times"></i>
                    إلغاء
                </button>
            </div>
        </div>
    </div>
    
    <!-- نافذة المهمة -->
    <div id="taskModal" class="form-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="taskModalTitle">مهمة جديدة</h3>
                <button class="close-modal" onclick="tasksHandler.closeTaskModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="taskForm" onsubmit="return false;">
                    <div class="form-group">
                        <label>عنوان المهمة</label>
                        <input type="text" id="taskTitle" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>المسؤول</label>
                            <select id="taskAssigneeSelect" required>
                                <option value="">اختر المسؤول</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>تاريخ الاستحقاق</label>
                            <input type="date" id="taskDueDate" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>الأولوية</label>
                            <select id="taskPriority" required>
                                <option value="low">منخفضة</option>
                                <option value="medium" selected>متوسطة</option>
                                <option value="high">عالية</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>الحالة</label>
                            <select id="taskStatusSelect" required>
                                <option value="pending">معلقة</option>
                                <option value="in_progress">قيد التنفيذ</option>
                                <option value="completed">مكتملة</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>وصف المهمة</label>
                        <textarea id="taskDescription" rows="6" required placeholder="وصف تفصيلي للمهمة..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>ربط بشكوى (اختياري)</label>
                        <select id="taskComplaint">
                            <option value="">لا يوجد</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-actions">
                <button class="action-btn btn-view" onclick="tasksHandler.saveTask()">
                    <i class="fas fa-save"></i>
                    حفظ المهمة
                </button>
                <button class="action-btn btn-secondary" onclick="tasksHandler.closeTaskModal()">
                    <i class="fas fa-times"></i>
                    إلغاء
                </button>
            </div>
        </div>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script>
        // =============== PWA Handler for both apps ===============
        class PWAHandler {
            constructor(appType = 'client') {
                this.appType = appType;
                this.deferredPrompt = null;
                this.isAppInstalled = false;
                this.init();
            }

            init() {
                this.checkIfAppInstalled();
                this.registerServiceWorker();
                this.setupEventListeners();
                this.showWelcomeMessage();
            }

            registerServiceWorker() {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('sw.js')
                        .then(registration => {
                            console.log('Service Worker registered successfully:', registration);
                            
                            this.requestNotificationPermission();
                            
                            registration.addEventListener('updatefound', () => {
                                const newWorker = registration.installing;
                                newWorker.addEventListener('statechange', () => {
                                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                        this.showUpdateMessage();
                                    }
                                });
                            });
                        })
                        .catch(error => {
                            console.error('Service Worker registration failed:', error);
                        });
                }
            }

            checkIfAppInstalled() {
                const isStandalone = window.matchMedia('(display-mode: standalone)').matches;
                const isFullscreen = window.matchMedia('(display-mode: fullscreen)').matches;
                const isIOS = window.navigator.standalone === true;
                const localStorageInstalled = localStorage.getItem(`appInstalled_${this.appType}`) === 'true';

                this.isAppInstalled = isStandalone || isFullscreen || isIOS || localStorageInstalled;
                
                if (this.isAppInstalled) {
                    this.hideInstallButton();
                }
            }

            setupEventListeners() {
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    this.deferredPrompt = e;
                    this.showInstallPrompt();
                });

                window.addEventListener('appinstalled', () => {
                    console.log('App installed successfully');
                    this.isAppInstalled = true;
                    localStorage.setItem(`appInstalled_${this.appType}`, 'true');
                    this.hideInstallPrompt();
                    this.showSuccessMessage();
                });

                window.matchMedia('(display-mode: standalone)').addEventListener('change', (e) => {
                    this.isAppInstalled = e.matches;
                    if (this.isAppInstalled) {
                        this.hideInstallButton();
                    }
                });
            }

            showWelcomeMessage() {
                if (!this.isAppInstalled && !localStorage.getItem(`welcomeShown_${this.appType}`)) {
                    setTimeout(() => {
                        const message = this.appType === 'client' 
                            ? '📱 يمكنك تثبيت تطبيق الشكاوى على شاشتك الرئيسية للوصول السريع!'
                            : '📱 يمكنك تثبيت لوحة التحكم على شاشتك الرئيسية لإدارة الشكاوى بسهولة!';
                        
                        this.showToast(message, 'info', 5000);
                        localStorage.setItem(`welcomeShown_${this.appType}`, 'true');
                    }, 3000);
                }
            }

            showInstallPrompt() {
                if (this.isAppInstalled || !this.deferredPrompt) return;

                const installContainer = document.getElementById('installContainer');
                const installDescription = document.getElementById('installDescription');
                
                if (!installContainer) return;

                let instructions = '';
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

                if (isIOS) {
                    instructions = `
                        <p><strong>لتثبيت التطبيق على iOS:</strong></p>
                        <ol style="text-align: right; margin-right: 15px;">
                            <li>اضغط على زر "مشاركة" في أسفل المتصفح</li>
                            <li>اختر "أضف إلى الشاشة الرئيسية"</li>
                            <li>اضغط على "إضافة" في الزاوية العليا اليمنى</li>
                        </ol>
                    `;
                } else {
                    instructions = `
                        <p><strong>لتثبيت التطبيق على Android:</strong></p>
                        <ol style="text-align: right; margin-right: 15px;">
                            <li>اضغط على زر "تثبيت" أدناه</li>
                            <li>في النافذة المنبثقة، اضغط على "تثبيت"</li>
                            <li>سيظهر التطبيق على شاشتك الرئيسية</li>
                        </ol>
                    `;
                }

                const appName = this.appType === 'client' ? 'تطبيق الشكاوى' : 'لوحة التحكم';
                installDescription.innerHTML = `
                    <p>${this.appType === 'client' 
                        ? 'ثبت تطبيق الشكاوى على شاشتك الرئيسية لتقديم ومتابعة الشكاوى بسهولة' 
                        : 'ثبت لوحة التحكم على شاشتك الرئيسية لإدارة الشكاوى بسهولة'}</p>
                    ${instructions}
                `;

                installContainer.style.display = 'flex';
            }

            hideInstallPrompt() {
                const installContainer = document.getElementById('installContainer');
                if (installContainer) {
                    installContainer.style.display = 'none';
                }
            }

            hideInstallButton() {
                const floatingBtn = document.getElementById('floatingInstallBtn');
                if (floatingBtn) {
                    floatingBtn.style.display = 'none';
                }
            }

            requestNotificationPermission() {
                if ('Notification' in window && Notification.permission === 'default') {
                    setTimeout(() => {
                        Notification.requestPermission().then(permission => {
                            if (permission === 'granted') {
                                console.log('Notification permission granted');
                                if (this.appType === 'admin') {
                                    this.sendWelcomeNotification();
                                }
                            }
                        });
                    }, 2000);
                }
            }

            sendWelcomeNotification() {
                if ('serviceWorker' in navigator && Notification.permission === 'granted') {
                    navigator.serviceWorker.ready.then(registration => {
                        const title = this.appType === 'client' 
                            ? 'مرحباً بكم في تطبيق الشكاوى' 
                            : 'مرحباً بك في لوحة التحكم';
                        
                        const body = this.appType === 'client'
                            ? 'يمكنك الآن تقديم ومتابعة شكواك بسهولة'
                            : 'يمكنك الآن إدارة الشكاوى والطلبات بكل سهولة';

                        registration.showNotification(title, {
                            body: body,
                            icon: 'icon-192x192.png',
                            badge: 'icon-192x192.png',
                            vibrate: [200, 100, 200]
                        });
                    });
                }
            }

            showUpdateMessage() {
                const message = '🔄 تم تحديث التطبيق! يرجى إعادة تحميل الصفحة للحصول على أحدث الميزات.';
                this.showToast(message, 'info', 10000);
            }

            showSuccessMessage() {
                const message = this.appType === 'client'
                    ? '✅ تم تثبيت تطبيق الشكاوى بنجاح على شاشتك الرئيسية!'
                    : '✅ تم تثبيت لوحة التحكم بنجاح على شاشتك الرئيسية!';
                
                this.showToast(message, 'success', 5000);
            }

            showToast(message, type = 'info', duration = 3000) {
                let toast = document.getElementById('pwa-toast');
                if (!toast) {
                    toast = document.createElement('div');
                    toast.id = 'pwa-toast';
                    toast.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        padding: 15px 20px;
                        border-radius: 12px;
                        color: white;
                        font-weight: bold;
                        z-index: 10000;
                        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                        max-width: 400px;
                        animation: slideIn 0.3s ease;
                    `;
                    document.body.appendChild(toast);
                }

                const colors = {
                    success: 'linear-gradient(135deg, #1a5fb4, #2d8fd5)',
                    error: 'linear-gradient(135deg, #e74c3c, #c0392b)',
                    info: 'linear-gradient(135deg, #3498db, #2980b9)',
                    warning: 'linear-gradient(135deg, #f39c12, #e67e22)'
                };

                toast.style.background = colors[type] || colors.info;
                toast.innerHTML = message;
                toast.style.display = 'block';

                setTimeout(() => {
                    toast.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => {
                        toast.style.display = 'none';
                        toast.style.animation = '';
                    }, 300);
                }, duration);
            }

            async install() {
                if (this.deferredPrompt) {
                    this.deferredPrompt.prompt();
                    const { outcome } = await this.deferredPrompt.userChoice;
                    
                    if (outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                    }
                    
                    this.deferredPrompt = null;
                    this.hideInstallPrompt();
                }
            }

            checkOnlineStatus() {
                if (!navigator.onLine) {
                    this.showToast('⚠️ أنت غير متصل بالإنترنت', 'warning', 5000);
                }
                
                window.addEventListener('online', () => {
                    this.showToast('✅ تم استعادة الاتصال بالإنترنت', 'success', 3000);
                });
                
                window.addEventListener('offline', () => {
                    this.showToast('⚠️ فقدت الاتصال بالإنترنت', 'warning', 5000);
                });
            }

            updateApp() {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.ready.then(registration => {
                        registration.update();
                    });
                }
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const isAdminPage = window.location.pathname.includes('admin.html') || 
                               window.location.pathname.includes('admin') ||
                               document.title.includes('لوحة التحكم');
            const appType = isAdminPage ? 'admin' : 'client';
            
            window.pwaHandler = new PWAHandler(appType);
            
            window.pwaHandler.checkOnlineStatus();
            
            document.addEventListener('click', function(e) {
                if (e.target.id === 'installButton' || e.target.closest('#installButton')) {
                    window.pwaHandler.install();
                }
                
                if (e.target.id === 'cancelInstall' || e.target.closest('#cancelInstall')) {
                    window.pwaHandler.hideInstallPrompt();
                }
                
                if (e.target.id === 'floatingInstallBtn' || e.target.closest('#floatingInstallBtn')) {
                    window.pwaHandler.showInstallPrompt();
                }
            });
        });
    </script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBIIStbiZD0ZJ6su7C1bwZlBvqx-PP-t58",
            authDomain: "shakawa-e0a3c.firebaseapp.com",
            databaseURL: "https://shakawa-e0a3c-default-rtdb.firebaseio.com",
            projectId: "shakawa-e0a3c",
            storageBucket: "shakawa-e0a3c.firebasestorage.app",
            messagingSenderId: "111620348664",
            appId: "1:111620348664:web:670fdf5caed46eb691b90d",
            measurementId: "G-SGNTJZDQ1L"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let isLoggedIn = false;
        let currentUser = null;
        let settings = {};
        let allComplaints = [];
        let filteredComplaints = [];
        let allDepartments = [];
        let allUsers = [];
        let currentPage = 1;
        const itemsPerPage = 20;
        let unreadComplaints = new Set();
        let complaintsListener = null;
        let currentEditingUser = null;
        
        // ==================== نظام التنبيهات الذكية ====================
        const alertSystem = {
            init() {
                this.checkPendingComplaints();
                this.setupDailyReminder();
                this.setupSLAAlerts();
                this.setupPriorityUpdates();
            },
            
            async checkPendingComplaints() {
                try {
                    const snapshot = await database.ref('complaints').once('value');
                    const complaints = snapshot.val() || {};
                    
                    Object.keys(complaints).forEach(key => {
                        const complaint = complaints[key];
                        if (complaint.status === 'جديدة' || complaint.status === 'قيد المراجعة') {
                            const createdAt = new Date(complaint.createdAt);
                            const now = new Date();
                            const hoursDiff = (now - createdAt) / (1000 * 60 * 60);
                            
                            // تنبيه للشكاوى المعلقة أكثر من 24 ساعة
                            if (hoursDiff > 24) {
                                this.sendPendingAlert(complaint, hoursDiff);
                            }
                        }
                    });
                } catch (error) {
                    console.error('Error checking pending complaints:', error);
                }
            },
            
            sendPendingAlert(complaint, hours) {
                if (Notification.permission === 'granted') {
                    navigator.serviceWorker.ready.then(registration => {
                        registration.showNotification('⏰ شكوى معلقة', {
                            body: `الشكوى ${complaint.complaintNumber} معلقة منذ ${Math.floor(hours)} ساعة`,
                            icon: 'icon-192x192.png',
                            badge: 'icon-192x192.png',
                            tag: 'pending-alert',
                            vibrate: [200, 100, 200],
                            actions: [
                                { action: 'view', title: 'عرض الشكوى' }
                            ]
                        });
                    });
                }
            },
            
            setupDailyReminder() {
                // جدولة التذكير اليومي الساعة 9 صباحاً
                const now = new Date();
                const reminderTime = new Date();
                reminderTime.setHours(9, 0, 0, 0);
                
                if (now > reminderTime) {
                    reminderTime.setDate(reminderTime.getDate() + 1);
                }
                
                const timeUntilReminder = reminderTime.getTime() - now.getTime();
                
                setTimeout(() => {
                    this.sendDailyReminder();
                    // كرر كل 24 ساعة
                    setInterval(() => this.sendDailyReminder(), 24 * 60 * 60 * 1000);
                }, timeUntilReminder);
            },
            
            async sendDailyReminder() {
                try {
                    const snapshot = await database.ref('complaints').once('value');
                    const complaints = snapshot.val() || {};
                    
                    let pendingCount = 0;
                    Object.keys(complaints).forEach(key => {
                        const complaint = complaints[key];
                        if (complaint.status === 'جديدة' || complaint.status === 'قيد المراجعة') {
                            pendingCount++;
                        }
                    });
                    
                    if (pendingCount > 0 && Notification.permission === 'granted') {
                        navigator.serviceWorker.ready.then(registration => {
                            registration.showNotification('📋 تقرير الشكاوى اليومي', {
                                body: `لديك ${pendingCount} شكوى معلقة تحتاج متابعة`,
                                icon: 'icon-192x192.png',
                                badge: 'icon-192x192.png',
                                tag: 'daily-reminder'
                            });
                        });
                    }
                } catch (error) {
                    console.error('Error sending daily reminder:', error);
                }
            },
            
            setupSLAAlerts() {
                // التحقق من SLA كل ساعة
                setInterval(() => this.checkSLA(), 60 * 60 * 1000);
            },
            
            async checkSLA() {
                try {
                    const snapshot = await database.ref('complaints').once('value');
                    const complaints = snapshot.val() || {};
                    
                    Object.keys(complaints).forEach(key => {
                        const complaint = complaints[key];
                        const createdAt = new Date(complaint.createdAt);
                        const now = new Date();
                        const hoursDiff = (now - createdAt) / (1000 * 60 * 60);
                        
                        // SLA: 72 ساعة للشكاوى العادية
                        if (hoursDiff > 72 && complaint.status !== 'مكتملة' && complaint.status !== 'تم الرد') {
                            this.sendSLAAlert(complaint, hoursDiff);
                        }
                    });
                } catch (error) {
                    console.error('Error checking SLA:', error);
                }
            },
            
            sendSLAAlert(complaint, hours) {
                if (Notification.permission === 'granted') {
                    navigator.serviceWorker.ready.then(registration => {
                        registration.showNotification('🚨 تجاوز وقت الاستجابة', {
                            body: `الشكوى ${complaint.complaintNumber} تجاوزت وقت الاستجابة بـ ${Math.floor(hours - 72)} ساعة`,
                            icon: 'icon-192x192.png',
                            badge: 'icon-192x192.png',
                            tag: 'sla-alert',
                            vibrate: [500, 100, 500]
                        });
                    });
                }
            },
            
            setupPriorityUpdates() {
                // تحديث الأولويات كل 6 ساعات
                setInterval(() => this.updatePriorities(), 6 * 60 * 60 * 1000);
            },
            
            async updatePriorities() {
                try {
                    const snapshot = await database.ref('complaints').once('value');
                    const complaints = snapshot.val() || {};
                    
                    Object.keys(complaints).forEach(key => {
                        const complaint = complaints[key];
                        if (complaint.status !== 'مكتملة' && complaint.status !== 'تم الرد') {
                            const createdAt = new Date(complaint.createdAt);
                            const now = new Date();
                            const hoursDiff = (now - createdAt) / (1000 * 60 * 60);
                            
                            let newPriority = complaint.priority || 'عادية';
                            
                            // ترقية الأولوية مع الوقت
                            if (hoursDiff > 48 && newPriority === 'عادية') {
                                newPriority = 'مهمة';
                                database.ref(`complaints/${key}/priority`).set(newPriority);
                                this.sendPriorityUpdateAlert(complaint, newPriority);
                            } else if (hoursDiff > 72 && newPriority === 'مهمة') {
                                newPriority = 'فى غاية الأهمية';
                                database.ref(`complaints/${key}/priority`).set(newPriority);
                                this.sendPriorityUpdateAlert(complaint, newPriority);
                            }
                        }
                    });
                } catch (error) {
                    console.error('Error updating priorities:', error);
                }
            },
            
            sendPriorityUpdateAlert(complaint, newPriority) {
                if (Notification.permission === 'granted') {
                    navigator.serviceWorker.ready.then(registration => {
                        registration.showNotification('🚩 تحديث أولوية', {
                            body: `تم تحديث أولوية الشكوى ${complaint.complaintNumber} إلى "${newPriority}"`,
                            icon: 'icon-192x192.png',
                            badge: 'icon-192x192.png',
                            tag: 'priority-update'
                        });
                    });
                }
            },
            
            sendStatusUpdateToUser(complaint, newStatus) {
                // هنا يمكن إضافة إرسال إشعار للعميل (إما عبر البريد أو رسالة SMS)
                console.log(`إشعار للعميل: تم تحديث حالة شكواك ${complaint.complaintNumber} إلى ${newStatus}`);
            },
            
            playSound() {
                const audio = new Audio('data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA==');
                audio.play().catch(e => console.log('Audio play failed:', e));
            }
        };
        
        // ==================== نظام التقارير والتحليلات ====================
        const reportsHandler = {
            async generateDailyReport() {
                try {
                    showLoading();
                    
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const tomorrow = new Date(today);
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    
                    const snapshot = await database.ref('complaints').once('value');
                    const complaints = snapshot.val() || {};
                    
                    let newCount = 0;
                    let resolvedCount = 0;
                    let pendingCount = 0;
                    let inProgressCount = 0;
                    
                    Object.keys(complaints).forEach(key => {
                        const complaint = complaints[key];
                        const complaintDate = new Date(complaint.createdAt);
                        
                        if (complaintDate >= today && complaintDate < tomorrow) {
                            if (complaint.status === 'جديدة') newCount++;
                            if (complaint.status === 'مكتملة' || complaint.status === 'تم الرد') resolvedCount++;
                            if (complaint.status === 'قيد المراجعة') pendingCount++;
                            if (complaint.status === 'قيد المعالجة') inProgressCount++;
                        }
                    });
                    
                    const reportHTML = `
                        <div style="padding:20px;background:white;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.1);">
                            <h3 style="color:#1a5fb4;text-align:center;margin-bottom:20px;">📊 التقرير اليومي - ${today.toLocaleDateString('ar-EG')}</h3>
                            
                            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:15px;margin-bottom:20px;">
                                <div style="background:#e3f2fd;padding:15px;border-radius:10px;text-align:center;">
                                    <div style="font-size:24px;font-weight:bold;color:#1565c0;">${newCount}</div>
                                    <div style="color:#1565c0;">شكاوى جديدة</div>
                                </div>
                                <div style="background:#e8f5e9;padding:15px;border-radius:10px;text-align:center;">
                                    <div style="font-size:24px;font-weight:bold;color:#2e7d32;">${resolvedCount}</div>
                                    <div style="color:#2e7d32;">تم حلها</div>
                                </div>
                                <div style="background:#fff3e0;padding:15px;border-radius:10px;text-align:center;">
                                    <div style="font-size:24px;font-weight:bold;color:#f57c00;">${pendingCount}</div>
                                    <div style="color:#f57c00;">قيد المراجعة</div>
                                </div>
                                <div style="background:#f3e5f5;padding:15px;border-radius:10px;text-align:center;">
                                    <div style="font-size:24px;font-weight:bold;color:#7b1fa2;">${inProgressCount}</div>
                                    <div style="color:#7b1fa2;">قيد المعالجة</div>
                                </div>
                            </div>
                            
                            <h4 style="color:#333;margin-bottom:10px;">📈 تحليل الأداء</h4>
                            <div style="background:#f8f9fa;padding:15px;border-radius:10px;">
                                <p>معدل الحل اليومي: ${resolvedCount > 0 ? Math.round((resolvedCount/(newCount||1))*100) : 0}%</p>
                                <p>متوسط وقت المعالجة: ${this.calculateAverageResolutionTime(complaints)} ساعة</p>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('reportResults').innerHTML = reportHTML;
                    showMessage('تم إنشاء التقرير اليومي', 'success');
                    
                } catch (error) {
                    console.error('Error generating daily report:', error);
                    showMessage('حدث خطأ أثناء إنشاء التقرير', 'error');
                } finally {
                    hideLoading();
                }
            },
            
            async generateWeeklyReport() {
                try {
                    showLoading();
                    
                    const now = new Date();
                    const startOfWeek = new Date(now);
                    startOfWeek.setDate(now.getDate() - now.getDay());
                    startOfWeek.setHours(0, 0, 0, 0);
                    
                    const snapshot = await database.ref('complaints').once('value');
                    const complaints = snapshot.val() || {};
                    
                    let weeklyStats = {
                        new: 0,
                        resolved: 0,
                        pending: 0,
                        inProgress: 0
                    };
                    
                    Object.keys(complaints).forEach(key => {
                        const complaint = complaints[key];
                        const complaintDate = new Date(complaint.createdAt);
                        
                        if (complaintDate >= startOfWeek) {
                            if (complaint.status === 'جديدة') weeklyStats.new++;
                            if (complaint.status === 'مكتملة' || complaint.status === 'تم الرد') weeklyStats.resolved++;
                            if (complaint.status === 'قيد المراجعة') weeklyStats.pending++;
                            if (complaint.status === 'قيد المعالجة') weeklyStats.inProgress++;
                        }
                    });
                    
                    const reportHTML = `
                        <div style="padding:20px;background:white;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.1);">
                            <h3 style="color:#1a5fb4;text-align:center;margin-bottom:20px;">📅 التقرير الأسبوعي</h3>
                            
                            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:15px;margin-bottom:20px;">
                                <div style="background:#e3f2fd;padding:15px;border-radius:10px;text-align:center;">
                                    <div style="font-size:24px;font-weight:bold;color:#1565c0;">${weeklyStats.new}</div>
                                    <div style="color:#1565c0;">جديدة هذا الأسبوع</div>
                                </div>
                                <div style="background:#e8f5e9;padding:15px;border-radius:10px;text-align:center;">
                                    <div style="font-size:24px;font-weight:bold;color:#2e7d32;">${weeklyStats.resolved}</div>
                                    <div style="color:#2e7d32;">تم حلها هذا الأسبوع</div>
                                </div>
                                <div style="background:#fff3e0;padding:15px;border-radius:10px;text-align:center;">
                                    <div style="font-size:24px;font-weight:bold;color:#f57c00;">${weeklyStats.pending}</div>
                                    <div style="color:#f57c00;">قيد المراجعة</div>
                                </div>
                                <div style="background:#f3e5f5;padding:15px;border-radius:10px;text-align:center;">
                                    <div style="font-size:24px;font-weight:bold;color:#7b1fa2;">${weeklyStats.inProgress}</div>
                                    <div style="color:#7b1fa2;">قيد المعالجة</div>
                                </div>
                            </div>
                            
                            <h4 style="color:#333;margin-bottom:10px;">📊 مقارنة مع الأسبوع الماضي</h4>
                            <div style="background:#f8f9fa;padding:15px;border-radius:10px;">
                                <p>معدل النمو: ${this.calculateGrowthRate(complaints)}%</p>
                                <p>أداء الأقسام: ${this.getTopDepartments(complaints)}</p>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('reportResults').innerHTML = reportHTML;
                    showMessage('تم إنشاء التقرير الأسبوعي', 'success');
                    
                } catch (error) {
                    console.error('Error generating weekly report:', error);
                    showMessage('حدث خطأ أثناء إنشاء التقرير', 'error');
                } finally {
                    hideLoading();
                }
            },
            
            async generateMonthlyReport() {
                try {
                    showLoading();
                    
                    const now = new Date();
                    const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                    
                    const snapshot = await database.ref('complaints').once('value');
                    const complaints = snapshot.val() || {};
                    
                    let monthlyStats = {
                        new: 0,
                        resolved: 0,
                        pending: 0,
                        inProgress: 0,
                        byDepartment: {}
                    };
                    
                    Object.keys(complaints).forEach(key => {
                        const complaint = complaints[key];
                        const complaintDate = new Date(complaint.createdAt);
                        
                        if (complaintDate >= startOfMonth) {
                            if (complaint.status === 'جديدة') monthlyStats.new++;
                            if (complaint.status === 'مكتملة' || complaint.status === 'تم الرد') monthlyStats.resolved++;
                            if (complaint.status === 'قيد المراجعة') monthlyStats.pending++;
                            if (complaint.status === 'قيد المعالجة') monthlyStats.inProgress++;
                            
                            // تجميع حسب الأقسام
                            const dept = complaint.department || 'غير محدد';
                            monthlyStats.byDepartment[dept] = (monthlyStats.byDepartment[dept] || 0) + 1;
                        }
                    });
                    
                    // ترتيب الأقسام حسب العدد
                    const sortedDepartments = Object.entries(monthlyStats.byDepartment)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 5);
                    
                    let departmentsHTML = '';
                    sortedDepartments.forEach(([dept, count], index) => {
                        departmentsHTML += `
                            <div style="display:flex;justify-content:space-between;padding:8px;border-bottom:1px solid #eee;">
                                <span>${index + 1}. ${dept}</span>
                                <span style="font-weight:bold;">${count}</span>
                            </div>
                        `;
                    });
                    
                    const reportHTML = `
                        <div style="padding:20px;background:white;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.1);">
                            <h3 style="color:#1a5fb4;text-align:center;margin-bottom:20px;">📈 التقرير الشهري - ${now.toLocaleDateString('ar-EG', { month: 'long', year: 'numeric' })}</h3>
                            
                            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:15px;margin-bottom:20px;">
                                <div style="background:#e3f2fd;padding:15px;border-radius:10px;text-align:center;">
                                    <div style="font-size:24px;font-weight:bold;color:#1565c0;">${monthlyStats.new}</div>
                                    <div style="color:#1565c0;">شكاوى جديدة</div>
                                </div>
                                <div style="background:#e8f5e9;padding:15px;border-radius:10px;text-align:center;">
                                    <div style="font-size:24px;font-weight:bold;color:#2e7d32;">${monthlyStats.resolved}</div>
                                    <div style="color:#2e7d32;">تم حلها</div>
                                </div>
                                <div style="background:#fff3e0;padding:15px;border-radius:10px;text-align:center;">
                                    <div style="font-size:24px;font-weight:bold;color:#f57c00;">${monthlyStats.pending}</div>
                                    <div style="color:#f57c00;">قيد المراجعة</div>
                                </div>
                                <div style="background:#f3e5f5;padding:15px;border-radius:10px;text-align:center;">
                                    <div style="font-size:24px;font-weight:bold;color:#7b1fa2;">${monthlyStats.inProgress}</div>
                                    <div style="color:#7b1fa2;">قيد المعالجة</div>
                                </div>
                            </div>
                            
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;">
                                <div>
                                    <h4 style="color:#333;margin-bottom:10px;">🏆 أفضل 5 أقسام</h4>
                                    <div style="background:#f8f9fa;padding:15px;border-radius:10px;">
                                        ${departmentsHTML}
                                    </div>
                                </div>
                                <div>
                                    <h4 style="color:#333;margin-bottom:10px;">📊 مؤشرات الأداء</h4>
                                    <div style="background:#f8f9fa;padding:15px;border-radius:10px;">
                                        <p>معدل الرضا: ${this.calculateSatisfactionRate(complaints)}%</p>
                                        <p>متوسط وقت الحل: ${this.calculateAverageResolutionTime(complaints)} ساعة</p>
                                        <p>نسبة الإنجاز: ${monthlyStats.new > 0 ? Math.round((monthlyStats.resolved/monthlyStats.new)*100) : 0}%</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('reportResults').innerHTML = reportHTML;
                    showMessage('تم إنشاء التقرير الشهري', 'success');
                    
                } catch (error) {
                    console.error('Error generating monthly report:', error);
                    showMessage('حدث خطأ أثناء إنشاء التقرير', 'error');
                } finally {
                    hideLoading();
                }
            },
            
            calculateAverageResolutionTime(complaints) {
                let totalTime = 0;
                let resolvedCount = 0;
                
                Object.keys(complaints).forEach(key => {
                    const complaint = complaints[key];
                    if (complaint.status === 'مكتملة' && complaint.createdAt && complaint.updatedAt) {
                        const created = new Date(complaint.createdAt);
                        const updated = new Date(complaint.updatedAt);
                        const hours = (updated - created) / (1000 * 60 * 60);
                        totalTime += hours;
                        resolvedCount++;
                    }
                });
                
                return resolvedCount > 0 ? Math.round(totalTime / resolvedCount) : 0;
            },
            
            calculateGrowthRate(complaints) {
                // حساب معدل النمو مقارنة بالشهر الماضي
                const now = new Date();
                const currentMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                const monthBeforeLast = new Date(now.getFullYear(), now.getMonth() - 2, 1);
                
                let currentCount = 0;
                let lastMonthCount = 0;
                
                Object.keys(complaints).forEach(key => {
                    const complaint = complaints[key];
                    const complaintDate = new Date(complaint.createdAt);
                    
                    if (complaintDate >= currentMonth && complaintDate < lastMonth) {
                        currentCount++;
                    } else if (complaintDate >= lastMonth && complaintDate < monthBeforeLast) {
                        lastMonthCount++;
                    }
                });
                
                if (lastMonthCount === 0) return 100;
                return Math.round(((currentCount - lastMonthCount) / lastMonthCount) * 100);
            },
            
            getTopDepartments(complaints) {
                const deptCount = {};
                
                Object.keys(complaints).forEach(key => {
                    const complaint = complaints[key];
                    const dept = complaint.department || 'غير محدد';
                    deptCount[dept] = (deptCount[dept] || 0) + 1;
                });
                
                const sorted = Object.entries(deptCount)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 3)
                    .map(([dept, count]) => `${dept} (${count})`)
                    .join('، ');
                
                return sorted || 'لا توجد بيانات';
            },
            
            calculateSatisfactionRate(complaints) {
                // هذا مثال بسيط، يمكن تحسينه بناءً على تقييمات العملاء
                let satisfied = 0;
                let totalWithResponse = 0;
                
                Object.keys(complaints).forEach(key => {
                    const complaint = complaints[key];
                    if (complaint.responses && Object.keys(complaint.responses).length > 0) {
                        totalWithResponse++;
                        // نفترض أن الشكاوى التي تم الرد عليها وحُلت تعتبر راضية
                        if (complaint.status === 'مكتملة' || complaint.status === 'تم الرد') {
                            satisfied++;
                        }
                    }
                });
                
                return totalWithResponse > 0 ? Math.round((satisfied / totalWithResponse) * 100) : 0;
            },
            
            async loadReportData() {
                const reportType = document.getElementById('reportType').value;
                const period = document.getElementById('reportPeriod').value;
                
                switch (reportType) {
                    case 'daily':
                        this.generateDailyReport();
                        break;
                    case 'weekly':
                        this.generateWeeklyReport();
                        break;
                    case 'monthly':
                        this.generateMonthlyReport();
                        break;
                    case 'department':
                        this.generateDepartmentReport();
                        break;
                    case 'employee':
                        this.generateEmployeeReport();
                        break;
                }
            },
            
            async generateDepartmentReport() {
                try {
                    showLoading();
                    
                    const snapshot = await database.ref('complaints').once('value');
                    const complaints = snapshot.val() || {};
                    
                    const deptStats = {};
                    
                    Object.keys(complaints).forEach(key => {
                        const complaint = complaints[key];
                        const dept = complaint.department || 'غير محدد';
                        
                        if (!deptStats[dept]) {
                            deptStats[dept] = {
                                total: 0,
                                new: 0,
                                resolved: 0,
                                pending: 0,
                                inProgress: 0
                            };
                        }
                        
                        deptStats[dept].total++;
                        
                        switch (complaint.status) {
                            case 'جديدة':
                                deptStats[dept].new++;
                                break;
                            case 'مكتملة':
                            case 'تم الرد':
                                deptStats[dept].resolved++;
                                break;
                            case 'قيد المراجعة':
                                deptStats[dept].pending++;
                                break;
                            case 'قيد المعالجة':
                                deptStats[dept].inProgress++;
                                break;
                        }
                    });
                    
                    let reportHTML = `
                        <div style="padding:20px;background:white;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.1);">
                            <h3 style="color:#1a5fb4;text-align:center;margin-bottom:20px;">🏢 تقرير أداء الأقسام</h3>
                    `;
                    
                    Object.keys(deptStats).forEach(dept => {
                        const stats = deptStats[dept];
                        const resolutionRate = stats.total > 0 ? Math.round((stats.resolved / stats.total) * 100) : 0;
                        
                        reportHTML += `
                            <div style="background:#f8f9fa;padding:15px;border-radius:10px;margin-bottom:15px;">
                                <h4 style="color:#333;margin-bottom:10px;">${dept}</h4>
                                <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;">
                                    <div style="text-align:center;">
                                        <div style="font-weight:bold;color:#1565c0;">${stats.total}</div>
                                        <div style="font-size:12px;color:#666;">إجمالي</div>
                                    </div>
                                    <div style="text-align:center;">
                                        <div style="font-weight:bold;color:#f57c00;">${stats.new}</div>
                                        <div style="font-size:12px;color:#666;">جديدة</div>
                                    </div>
                                    <div style="text-align:center;">
                                        <div style="font-weight:bold;color:#2e7d32;">${stats.resolved}</div>
                                        <div style="font-size:12px;color:#666;">تم حلها</div>
                                    </div>
                                    <div style="text-align:center;">
                                        <div style="font-weight:bold;color:#1a5fb4;">${resolutionRate}%</div>
                                        <div style="font-size:12px;color:#666;">نسبة الحل</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    reportHTML += '</div>';
                    document.getElementById('reportResults').innerHTML = reportHTML;
                    showMessage('تم إنشاء تقرير الأقسام', 'success');
                    
                } catch (error) {
                    console.error('Error generating department report:', error);
                    showMessage('حدث خطأ أثناء إنشاء التقرير', 'error');
                } finally {
                    hideLoading();
                }
            },
            
            async generateEmployeeReport() {
                try {
                    showLoading();
                    
                    const [complaintsSnapshot, usersSnapshot] = await Promise.all([
                        database.ref('complaints').once('value'),
                        database.ref('users').once('value')
                    ]);
                    
                    const complaints = complaintsSnapshot.val() || {};
                    const users = usersSnapshot.val() || {};
                    
                    const employeeStats = {};
                    
                    // تهيئة إحصاءات للموظفين
                    Object.keys(users).forEach(key => {
                        const user = users[key];
                        if (user.role === 'user') {
                            employeeStats[user.username] = {
                                name: user.name,
                                totalAssigned: 0,
                                resolved: 0,
                                pending: 0,
                                avgResolutionTime: 0
                            };
                        }
                    });
                    
                    // حساب الإحصاءات
                    Object.keys(complaints).forEach(key => {
                        const complaint = complaints[key];
                        if (complaint.assignedTo) {
                            const employee = employeeStats[complaint.assignedTo];
                            if (employee) {
                                employee.totalAssigned++;
                                
                                if (complaint.status === 'مكتملة' || complaint.status === 'تم الرد') {
                                    employee.resolved++;
                                    
                                    // حساب متوسط وقت الحل
                                    if (complaint.createdAt && complaint.updatedAt) {
                                        const created = new Date(complaint.createdAt);
                                        const updated = new Date(complaint.updatedAt);
                                        const hours = (updated - created) / (1000 * 60 * 60);
                                        employee.avgResolutionTime = (employee.avgResolutionTime * (employee.resolved - 1) + hours) / employee.resolved;
                                    }
                                } else if (complaint.status === 'قيد المراجعة' || complaint.status === 'قيد المعالجة') {
                                    employee.pending++;
                                }
                            }
                        }
                    });
                    
                    let reportHTML = `
                        <div style="padding:20px;background:white;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.1);">
                            <h3 style="color:#1a5fb4;text-align:center;margin-bottom:20px;">👥 تقرير أداء الموظفين</h3>
                    `;
                    
                    Object.keys(employeeStats).forEach(username => {
                        const stats = employeeStats[username];
                        const resolutionRate = stats.totalAssigned > 0 ? Math.round((stats.resolved / stats.totalAssigned) * 100) : 0;
                        
                        reportHTML += `
                            <div style="background:#f8f9fa;padding:15px;border-radius:10px;margin-bottom:15px;">
                                <h4 style="color:#333;margin-bottom:10px;">${stats.name}</h4>
                                <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;">
                                    <div style="text-align:center;">
                                        <div style="font-weight:bold;color:#1565c0;">${stats.totalAssigned}</div>
                                        <div style="font-size:12px;color:#666;">مكلف بها</div>
                                    </div>
                                    <div style="text-align:center;">
                                        <div style="font-weight:bold;color:#2e7d32;">${stats.resolved}</div>
                                        <div style="font-size:12px;color:#666;">تم حلها</div>
                                    </div>
                                    <div style="text-align:center;">
                                        <div style="font-weight:bold;color:#f57c00;">${stats.pending}</div>
                                        <div style="font-size:12px;color:#666;">قيد العمل</div>
                                    </div>
                                    <div style="text-align:center;">
                                        <div style="font-weight:bold;color:#1a5fb4;">${resolutionRate}%</div>
                                        <div style="font-size:12px;color:#666;">كفاءة</div>
                                    </div>
                                </div>
                                ${stats.resolved > 0 ? `<p style="margin-top:10px;font-size:12px;color:#666;">متوسط وقت الحل: ${Math.round(stats.avgResolutionTime)} ساعة</p>` : ''}
                            </div>
                        `;
                    });
                    
                    reportHTML += '</div>';
                    document.getElementById('reportResults').innerHTML = reportHTML;
                    showMessage('تم إنشاء تقرير الموظفين', 'success');
                    
                } catch (error) {
                    console.error('Error generating employee report:', error);
                    showMessage('حدث خطأ أثناء إنشاء التقرير', 'error');
                } finally {
                    hideLoading();
                }
            },
            
            async exportCurrentReport() {
                const reportType = document.getElementById('reportType').value;
                const period = document.getElementById('reportPeriod').value;
                
                const reportData = {
                    type: reportType,
                    period: period,
                    generatedAt: new Date().toISOString(),
                    generatedBy: currentUser?.name || 'غير معروف'
                };
                
                // إنشاء ملف Excel
                const wsData = [
                    ['نوع التقرير', reportType === 'daily' ? 'يومي' : reportType === 'weekly' ? 'أسبوعي' : 'شهري'],
                    ['الفترة الزمنية', period],
                    ['تاريخ الإنشاء', new Date().toLocaleString('ar-EG')],
                    ['تم الإنشاء بواسطة', currentUser?.name || 'غير معروف'],
                    [''],
                    ['ملاحظة:', 'هذا ملف تصدير للبيانات الإحصائية']
                ];
                
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'التقرير');
                
                const fileName = `report-${reportType}-${new Date().toISOString().slice(0,10)}.xlsx`;
                XLSX.writeFile(wb, fileName);
                showMessage('تم تصدير التقرير بنجاح', 'success');
            }
        };
        
        // ==================== نظام القوالب والردود الجاهزة ====================
        const templatesHandler = {
            templates: [],
            currentEditingTemplate: null,
            
            async loadTemplates() {
                try {
                    const snapshot = await database.ref('templates').once('value');
                    const templates = snapshot.val() || {};
                    this.templates = Object.keys(templates).map(key => ({
                        key,
                        ...templates[key]
                    }));
                    this.displayTemplates();
                    this.populateTemplateFilters();
                } catch (error) {
                    console.error('Error loading templates:', error);
                }
            },
            
            displayTemplates() {
                const container = document.getElementById('templatesList');
                if (!container) return;
                
                if (this.templates.length === 0) {
                    container.innerHTML = '<p style="text-align:center;color:#666;padding:40px;">لا توجد قوالب حالياً</p>';
                    return;
                }
                
                let html = '';
                this.templates.forEach(template => {
                    const typeNames = {
                        welcome: 'ترحيب',
                        response: 'رد',
                        followup: 'متابعة',
                        resolution: 'حل',
                        closure: 'إغلاق'
                    };
                    
                    html += `
                        <div class="user-card">
                            <div class="user-card-header">
                                <div class="user-avatar" style="background:linear-gradient(135deg,#9b59b6,#8e44ad);">
                                    <i class="fas fa-file-alt"></i>
                                </div>
                                <div class="user-info">
                                    <h3>${template.name}</h3>
                                    <span class="user-role">${typeNames[template.type] || template.type}</span>
                                    ${template.department ? `<div class="user-email"><i class="fas fa-building"></i> ${template.department}</div>` : ''}
                                </div>
                            </div>
                            
                            <div class="user-departments">
                                <div class="user-departments-title">وصف القالب:</div>
                                <p style="color:#666;font-size:0.85rem;line-height:1.5;">${template.description || 'لا يوجد وصف'}</p>
                            </div>
                            
                            <div style="margin-top:15px;padding:10px;background:#f8f9fa;border-radius:8px;max-height:100px;overflow-y:auto;">
                                <p style="font-size:0.8rem;color:#333;line-height:1.4;">${template.content.substring(0, 150)}${template.content.length > 150 ? '...' : ''}</p>
                            </div>
                            
                            <div class="user-actions">
                                <button class="action-btn btn-edit" onclick="templatesHandler.editTemplate('${template.key}')">
                                    <i class="fas fa-edit"></i>
                                    تعديل
                                </button>
                                <button class="action-btn btn-view" onclick="templatesHandler.useTemplate('${template.key}')">
                                    <i class="fas fa-copy"></i>
                                    استخدام
                                </button>
                                <button class="action-btn btn-delete" onclick="templatesHandler.deleteTemplate('${template.key}')">
                                    <i class="fas fa-trash"></i>
                                    حذف
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            },
            
            populateTemplateFilters() {
                const deptSelect = document.getElementById('templateDepartment');
                const departments = [...new Set(this.templates.map(t => t.department).filter(d => d))];
                
                let options = '<option value="">جميع الأقسام</option>';
                departments.forEach(dept => {
                    options += `<option value="${dept}">${dept}</option>`;
                });
                
                if (deptSelect) deptSelect.innerHTML = options;
            },
            
            openTemplateModal(template = null) {
                this.currentEditingTemplate = template;
                const modal = document.getElementById('templateModal');
                const title = document.getElementById('templateModalTitle');
                const deptSelect = document.getElementById('templateDepartmentSelect');
                
                title.textContent = template ? 'تعديل القالب' : 'إضافة قالب جديد';
                
                // تعبئة اختيار الأقسام
                let deptOptions = '<option value="">عام (لجميع الأقسام)</option>';
                allDepartments.forEach(dept => {
                    deptOptions += `<option value="${dept.name}">${dept.name}</option>`;
                });
                deptSelect.innerHTML = deptOptions;
                
                // إذا كان تعديل، تعبئة البيانات
                if (template) {
                    document.getElementById('templateName').value = template.name;
                    document.getElementById('templateDepartmentSelect').value = template.department || '';
                    document.getElementById('templateTypeSelect').value = template.type;
                    document.getElementById('templateContent').value = template.content;
                    document.getElementById('templateDescription').value = template.description || '';
                } else {
                    // إعادة تعيين النموذج
                    document.getElementById('templateName').value = '';
                    document.getElementById('templateDepartmentSelect').value = '';
                    document.getElementById('templateTypeSelect').value = 'welcome';
                    document.getElementById('templateContent').value = '';
                    document.getElementById('templateDescription').value = '';
                }
                
                modal.style.display = 'flex';
            },
            
            closeTemplateModal() {
                document.getElementById('templateModal').style.display = 'none';
                this.currentEditingTemplate = null;
            },
            
            async saveTemplate() {
                const name = document.getElementById('templateName').value.trim();
                const department = document.getElementById('templateDepartmentSelect').value.trim() || '';
                const type = document.getElementById('templateTypeSelect').value;
                const content = document.getElementById('templateContent').value.trim();
                const description = document.getElementById('templateDescription').value.trim();
                
                if (!name || !content) {
                    showMessage('من فضلك أدخل اسم القالب ونصه', 'error');
                    return;
                }
                
                const templateData = {
                    name,
                    department,
                    type,
                    content,
                    description,
                    createdAt: new Date().toISOString(),
                    createdBy: currentUser?.name || 'غير معروف'
                };
                
                try {
                    if (this.currentEditingTemplate) {
                        await database.ref(`templates/${this.currentEditingTemplate.key}`).update(templateData);
                        showMessage('تم تحديث القالب بنجاح', 'success');
                    } else {
                        await database.ref('templates').push(templateData);
                        showMessage('تم إضافة القالب بنجاح', 'success');
                    }
                    
                    this.closeTemplateModal();
                    this.loadTemplates();
                } catch (error) {
                    console.error('Error saving template:', error);
                    showMessage('حدث خطأ أثناء حفظ القالب', 'error');
                }
            },
            
            async deleteTemplate(key) {
                if (!confirm('هل أنت متأكد من حذف هذا القالب؟')) return;
                
                try {
                    await database.ref(`templates/${key}`).remove();
                    showMessage('تم حذف القالب بنجاح', 'success');
                    this.loadTemplates();
                } catch (error) {
                    console.error('Error deleting template:', error);
                    showMessage('حدث خطأ أثناء حذف القالب', 'error');
                }
            },
            
            useTemplate(templateKey) {
                const template = this.templates.find(t => t.key === templateKey);
                if (!template) return;
                
                // عرض القالب في نافذة منبثقة للنسخ
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0,0,0,0.8);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                    padding: 20px;
                `;
                
                modal.innerHTML = `
                    <div style="background: white; border-radius: 15px; padding: 25px; max-width: 600px; width: 100%; max-height: 80vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="color: #2c3e50;">${template.name}</h3>
                            <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 24px; color: #666; cursor: pointer;">×</button>
                        </div>
                        <div style="margin-bottom: 20px;">
                            <p style="color: #666; margin-bottom: 10px;">نص القالب:</p>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
                                <pre style="white-space: pre-wrap; font-family: inherit; margin: 0;">${template.content}</pre>
                            </div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="navigator.clipboard.writeText('${template.content.replace(/'/g, "\\'")}'); showMessage('تم نسخ القالب إلى الحافظة', 'success'); this.parentElement.parentElement.remove();" 
                                    style="flex: 1; padding: 12px; background: #1a5fb4; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                <i class="fas fa-copy"></i> نسخ النص
                            </button>
                            <button onclick="this.parentElement.parentElement.remove()" 
                                    style="flex: 1; padding: 12px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                <i class="fas fa-times"></i> إغلاق
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            },
            
            editTemplate(key) {
                const template = this.templates.find(t => t.key === key);
                if (template) {
                    this.openTemplateModal(template);
                }
            },
            
            searchTemplates() {
                const searchTerm = document.getElementById('searchTemplates').value.toLowerCase();
                const filtered = this.templates.filter(template => 
                    template.name.toLowerCase().includes(searchTerm) ||
                    template.content.toLowerCase().includes(searchTerm) ||
                    (template.description && template.description.toLowerCase().includes(searchTerm))
                );
                
                this.displayFilteredTemplates(filtered);
            },
            
            filterTemplates() {
                const deptFilter = document.getElementById('templateDepartment').value;
                const typeFilter = document.getElementById('templateType').value;
                
                const filtered = this.templates.filter(template => {
                    const deptMatch = !deptFilter || template.department === deptFilter;
                    const typeMatch = !typeFilter || template.type === typeFilter;
                    return deptMatch && typeMatch;
                });
                
                this.displayFilteredTemplates(filtered);
            },
            
            displayFilteredTemplates(templates) {
                const container = document.getElementById('templatesList');
                if (!container) return;
                
                if (templates.length === 0) {
                    container.innerHTML = '<p style="text-align:center;color:#666;padding:40px;">لا توجد قوالب تطابق البحث</p>';
                    return;
                }
                
                let html = '';
                templates.forEach(template => {
                    const typeNames = {
                        welcome: 'ترحيب',
                        response: 'رد',
                        followup: 'متابعة',
                        resolution: 'حل',
                        closure: 'إغلاق'
                    };
                    
                    html += `
                        <div class="user-card">
                            <div class="user-card-header">
                                <div class="user-avatar" style="background:linear-gradient(135deg,#9b59b6,#8e44ad);">
                                    <i class="fas fa-file-alt"></i>
                                </div>
                                <div class="user-info">
                                    <h3>${template.name}</h3>
                                    <span class="user-role">${typeNames[template.type] || template.type}</span>
                                    ${template.department ? `<div class="user-email"><i class="fas fa-building"></i> ${template.department}</div>` : ''}
                                </div>
                            </div>
                            
                            <div style="margin-top:15px;padding:10px;background:#f8f9fa;border-radius:8px;max-height:100px;overflow-y:auto;">
                                <p style="font-size:0.8rem;color:#333;line-height:1.4;">${template.content.substring(0, 150)}${template.content.length > 150 ? '...' : ''}</p>
                            </div>
                            
                            <div class="user-actions">
                                <button class="action-btn btn-edit" onclick="templatesHandler.editTemplate('${template.key}')">
                                    <i class="fas fa-edit"></i>
                                    تعديل
                                </button>
                                <button class="action-btn btn-view" onclick="templatesHandler.useTemplate('${template.key}')">
                                    <i class="fas fa-copy"></i>
                                    استخدام
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            },
            
            processTemplate(template, data) {
                let processed = template.content;
                
                // استبدال المتغيرات
                processed = processed.replace(/{{اسم_العميل}}/g, data.customerName || 'عميلنا الكريم');
                processed = processed.replace(/{{رقم_شكوى}}/g, data.complaintNumber || '');
                processed = processed.replace(/{{التاريخ}}/g, new Date().toLocaleDateString('ar-EG'));
                processed = processed.replace(/{{الوقت}}/g, new Date().toLocaleTimeString('ar-EG'));
                processed = processed.replace(/{{القسم}}/g, data.department || '');
                processed = processed.replace(/{{المشكلة}}/g, data.problem || '');
                
                return processed;
            }
        };
        
        // ==================== نظام سير العمل التلقائي ====================
        const workflowHandler = {
            settings: {},
            
            async loadSettings() {
                try {
                    const snapshot = await database.ref('workflowSettings').once('value');
                    this.settings = snapshot.val() || {};
                    
                    // تعيين القيم الافتراضية
                    if (typeof this.settings.autoAssign === 'undefined') this.settings.autoAssign = true;
                    if (typeof this.settings.autoReply === 'undefined') this.settings.autoReply = true;
                    if (typeof this.settings.autoEscalation === 'undefined') this.settings.autoEscalation = true;
                    if (typeof this.settings.autoClosure === 'undefined') this.settings.autoClosure = false;
                    if (typeof this.settings.autoArchive === 'undefined') this.settings.autoArchive = true;
                    
                    // تحديث واجهة المستخدم
                    this.updateUISettings();
                } catch (error) {
                    console.error('Error loading workflow settings:', error);
                }
            },
            
            updateUISettings() {
                document.getElementById('autoAssign').checked = this.settings.autoAssign || false;
                document.getElementById('autoReply').checked = this.settings.autoReply || false;
                document.getElementById('autoEscalation').checked = this.settings.autoEscalation || false;
                document.getElementById('autoClosure').checked = this.settings.autoClosure || false;
                document.getElementById('autoArchive').checked = this.settings.autoArchive || false;
                document.getElementById('escalationTime').value = this.settings.escalationTime || 24;
                document.getElementById('autoReplyText').value = this.settings.autoReplyText || 'شكراً لتواصلكم معنا. تم استلام شكواك وسيتم مراجعتها من قبل الفريق المختص في أقرب وقت ممكن.';
            },
            
            async saveSettings() {
                try {
                    const settings = {
                        autoAssign: document.getElementById('autoAssign').checked,
                        autoReply: document.getElementById('autoReply').checked,
                        autoReplyText: document.getElementById('autoReplyText').value,
                        autoEscalation: document.getElementById('autoEscalation').checked,
                        escalationTime: parseInt(document.getElementById('escalationTime').value) || 24,
                        autoClosure: document.getElementById('autoClosure').checked,
                        autoArchive: document.getElementById('autoArchive').checked,
                        updatedAt: new Date().toISOString(),
                        updatedBy: currentUser?.name || 'غير معروف'
                    };
                    
                    await database.ref('workflowSettings').set(settings);
                    this.settings = settings;
                    showMessage('تم حفظ إعدادات سير العمل', 'success');
                } catch (error) {
                    console.error('Error saving workflow settings:', error);
                    showMessage('حدث خطأ أثناء حفظ الإعدادات', 'error');
                }
            },
            
            async autoAssignComplaint(complaintKey, complaintData) {
                if (!this.settings.autoAssign) return;
                
                try {
                    // البحث عن مستخدم مناسب بناءً على القسم
                    const usersSnapshot = await database.ref('users').once('value');
                    const users = usersSnapshot.val() || {};
                    
                    let assignedUser = null;
                    
                    Object.keys(users).forEach(key => {
                        const user = users[key];
                        if (user.role === 'user' && user.departments && user.departments.includes(complaintData.department)) {
                            if (!assignedUser) {
                                assignedUser = user;
                            }
                        }
                    });
                    
                    if (assignedUser) {
                        await database.ref(`complaints/${complaintKey}`).update({
                            assignedTo: assignedUser.username,
                            assignedAt: new Date().toISOString()
                        });
                        
                        console.log(`تم تعيين الشكوى ${complaintKey} إلى ${assignedUser.name}`);
                    }
                } catch (error) {
                    console.error('Error auto-assigning complaint:', error);
                }
            },
            
            async autoReplyToComplaint(complaintKey, complaintData) {
                if (!this.settings.autoReply) return;
                
                try {
                    const replyText = this.settings.autoReplyText || 'شكراً لتواصلكم معنا. تم استلام شكواك وسيتم مراجعتها من قبل الفريق المختص في أقرب وقت ممكن.';
                    
                    const responseKey = `auto_response_${new Date().getTime()}`;
                    const responseData = {
                        message: replyText,
                        senderName: 'النظام التلقائي',
                        senderRole: 'system',
                        timestamp: new Date().toISOString(),
                        isAutoReply: true
                    };
                    
                    await database.ref(`complaints/${complaintKey}/responses/${responseKey}`).set(responseData);
                    
                    // تحديث حالة الشكوى
                    await database.ref(`complaints/${complaintKey}`).update({
                        status: 'قيد المراجعة',
                        updatedAt: new Date().toISOString()
                    });
                    
                    console.log(`تم إرسال رد تلقائي للشكوى ${complaintKey}`);
                } catch (error) {
                    console.error('Error auto-replying to complaint:', error);
                }
            },
            
            async checkForEscalation() {
                if (!this.settings.autoEscalation) return;
                
                try {
                    const escalationHours = this.settings.escalationTime || 24;
                    const now = new Date();
                    
                    const snapshot = await database.ref('complaints').once('value');
                    const complaints = snapshot.val() || {};
                    
                    Object.keys(complaints).forEach(key => {
                        const complaint = complaints[key];
                        
                        // التحقق من الشكاوى التي تجاوزت وقت التصعيد
                        if (complaint.createdAt && 
                            (complaint.status === 'جديدة' || complaint.status === 'قيد المراجعة') &&
                            !complaint.escalated) {
                            
                            const created = new Date(complaint.createdAt);
                            const hoursDiff = (now - created) / (1000 * 60 * 60);
                            
                            if (hoursDiff > escalationHours) {
                                this.escalateComplaint(key, complaint);
                            }
                        }
                    });
                } catch (error) {
                    console.error('Error checking for escalation:', error);
                }
            },
            
            async escalateComplaint(complaintKey, complaintData) {
                try {
                    // تحديث حالة الشكوى للإشارة إلى التصعيد
                    await database.ref(`complaints/${complaintKey}`).update({
                        escalated: true,
                        escalatedAt: new Date().toISOString(),
                        priority: 'فى غاية الأهمية'
                    });
                    
                    // إرسال إشعار للمدير
                    if (Notification.permission === 'granted') {
                        navigator.serviceWorker.ready.then(registration => {
                            registration.showNotification('🚨 شكوى متصاعدة', {
                                body: `الشكوى ${complaintData.complaintNumber} متأخرة وتحتاج متابعة عاجلة`,
                                icon: 'icon-192x192.png',
                                badge: 'icon-192x192.png',
                                tag: 'escalation-alert',
                                vibrate: [500, 100, 500, 100, 500]
                            });
                        });
                    }
                    
                    console.log(`تم تصعيد الشكوى ${complaintKey} إلى المدير`);
                } catch (error) {
                    console.error('Error escalating complaint:', error);
                }
            },
            
            async autoCloseComplaints() {
                if (!this.settings.autoClosure) return;
                
                try {
                    const now = new Date();
                    const daysThreshold = 7; // إغلاق بعد 7 أيام من آخر تحديث
                    
                    const snapshot = await database.ref('complaints').once('value');
                    const complaints = snapshot.val() || {};
                    
                    Object.keys(complaints).forEach(async key => {
                        const complaint = complaints[key];
                        
                        // التحقق من الشكاوى التي تم الرد عليها ولم يتم تحديثها مؤخراً
                        if (complaint.status === 'تم الرد' && complaint.updatedAt) {
                            const updated = new Date(complaint.updatedAt);
                            const daysDiff = (now - updated) / (1000 * 60 * 60 * 24);
                            
                            if (daysDiff > daysThreshold) {
                                await database.ref(`complaints/${key}`).update({
                                    status: 'مكتملة',
                                    closedAt: new Date().toISOString(),
                                    closedAutomatically: true
                                });
                                
                                console.log(`تم إغلاق الشكوى ${key} تلقائياً`);
                            }
                        }
                    });
                } catch (error) {
                    console.error('Error auto-closing complaints:', error);
                }
            },
            
            async autoArchiveComplaints() {
                if (!this.settings.autoArchive) return;
                
                try {
                    const now = new Date();
                    const archiveThreshold = 30; // أرشفة بعد 30 يوم من الإغلاق
                    
                    const snapshot = await database.ref('complaints').once('value');
                    const complaints = snapshot.val() || {};
                    
                    Object.keys(complaints).forEach(async key => {
                        const complaint = complaints[key];
                        
                        // التحقق من الشكاوى المكتملة القديمة
                        if (complaint.status === 'مكتملة' && complaint.closedAt) {
                            const closed = new Date(complaint.closedAt);
                            const daysDiff = (now - closed) / (1000 * 60 * 60 * 24);
                            
                            if (daysDiff > archiveThreshold && !complaint.archived) {
                                await database.ref(`complaints/${key}`).update({
                                    archived: true,
                                    archivedAt: new Date().toISOString()
                                });
                                
                                console.log(`تم أرشفة الشكوى ${key} تلقائياً`);
                            }
                        }
                    });
                } catch (error) {
                    console.error('Error auto-archiving complaints:', error);
                }
            },
            
            init() {
                this.loadSettings();
                
                // تشغيل المهام الدورية
                setInterval(() => this.checkForEscalation(), 60 * 60 * 1000); // كل ساعة
                setInterval(() => this.autoCloseComplaints(), 24 * 60 * 60 * 1000); // كل يوم
                setInterval(() => this.autoArchiveComplaints(), 24 * 60 * 60 * 1000); // كل يوم
            }
        };
        
        // ==================== نظام البحث المتقدم ====================
        const complaintHandler = {
            openAdvancedSearch() {
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0,0,0,0.8);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                    padding: 20px;
                `;
                
                modal.innerHTML = `
                    <div style="background: white; border-radius: 15px; padding: 25px; max-width: 800px; width: 100%; max-height: 80vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="color: #2c3e50;">بحث متقدم في الشكاوى</h3>
                            <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 24px; color: #666; cursor: pointer;">×</button>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">رقم الشكوى</label>
                                <input type="text" id="advComplaintNumber" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">الاسم</label>
                                <input type="text" id="advCustomerName" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">الرقم القومي</label>
                                <input type="text" id="advNationalId" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">رقم الهاتف</label>
                                <input type="text" id="advPhone" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">نص البحث (في جميع الحقول)</label>
                            <input type="text" id="advFullText" placeholder="ابحث في جميع حقول الشكوى..." style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 25px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">من تاريخ</label>
                                <input type="date" id="advDateFrom" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">إلى تاريخ</label>
                                <input type="date" id="advDateTo" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">نوع المشكلة</label>
                                <input type="text" id="advProblemType" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button onclick="complaintHandler.performAdvancedSearch()" 
                                    style="flex: 1; padding: 12px; background: #1a5fb4; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                                <i class="fas fa-search"></i> بحث
                            </button>
                            <button onclick="this.parentElement.parentElement.remove()" 
                                    style="flex: 1; padding: 12px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">
                                <i class="fas fa-times"></i> إغلاق
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            },
            
            performAdvancedSearch() {
                const complaintNumber = document.getElementById('advComplaintNumber').value.toLowerCase();
                const customerName = document.getElementById('advCustomerName').value.toLowerCase();
                const nationalId = document.getElementById('advNationalId').value;
                const phone = document.getElementById('advPhone').value;
                const fullText = document.getElementById('advFullText').value.toLowerCase();
                const dateFrom = document.getElementById('advDateFrom').value;
                const dateTo = document.getElementById('advDateTo').value;
                const problemType = document.getElementById('advProblemType').value.toLowerCase();
                
                filteredComplaints = allComplaints.filter(complaint => {
                    let matches = true;
                    
                    if (complaintNumber && !(complaint.complaintNumber && complaint.complaintNumber.toLowerCase().includes(complaintNumber))) {
                        matches = false;
                    }
                    
                    if (customerName && !(complaint.fullName && complaint.fullName.toLowerCase().includes(customerName))) {
                        matches = false;
                    }
                    
                    if (nationalId && !(complaint.nationalId && complaint.nationalId.includes(nationalId))) {
                        matches = false;
                    }
                    
                    if (phone && !((complaint.phone1 && complaint.phone1.includes(phone)) || 
                                  (complaint.phone2 && complaint.phone2.includes(phone)))) {
                        matches = false;
                    }
                    
                    if (fullText) {
                        const searchFields = [
                            complaint.complaintNumber,
                            complaint.fullName,
                            complaint.nationalId,
                            complaint.phone1,
                            complaint.phone2,
                            complaint.problemDetails,
                            complaint.problemType,
                            complaint.department
                        ].join(' ').toLowerCase();
                        
                        if (!searchFields.includes(fullText)) {
                            matches = false;
                        }
                    }
                    
                    if (dateFrom) {
                        const complaintDate = new Date(complaint.createdAt);
                        const fromDate = new Date(dateFrom);
                        if (complaintDate < fromDate) {
                            matches = false;
                        }
                    }
                    
                    if (dateTo) {
                        const complaintDate = new Date(complaint.createdAt);
                        const toDate = new Date(dateTo);
                        toDate.setHours(23, 59, 59, 999);
                        if (complaintDate > toDate) {
                            matches = false;
                        }
                    }
                    
                    if (problemType && !(complaint.problemType && complaint.problemType.toLowerCase().includes(problemType))) {
                        matches = false;
                    }
                    
                    return matches;
                });
                
                currentPage = 1;
                displayComplaintsTable();
                
                // إغلاق نافذة البحث
                const modal = document.querySelector('div[style*="position: fixed; top: 0; left: 0"]');
                if (modal) modal.remove();
                
                showMessage(`تم العثور على ${filteredComplaints.length} نتيجة`, 'success');
            },
            
            async voiceSearch() {
                if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
                    showMessage('متصفحك لا يدعم البحث الصوتي', 'error');
                    return;
                }
                
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                const recognition = new SpeechRecognition();
                recognition.lang = 'ar-SA';
                recognition.interimResults = false;
                recognition.maxAlternatives = 1;
                
                recognition.start();
                
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    document.getElementById('searchComplaints').value = transcript;
                    filterComplaints();
                    showMessage(`تم البحث عن: "${transcript}"`, 'success');
                };
                
                recognition.onerror = (event) => {
                    showMessage('حدث خطأ في التعرف الصوتي', 'error');
                };
            },
            
            exportFilteredData() {
                if (filteredComplaints.length === 0) {
                    showMessage('لا توجد بيانات لتصديرها', 'error');
                    return;
                }
                
                const data = filteredComplaints.map(c => ({
                    'رقم الشكوى': c.complaintNumber || '',
                    'الاسم بالكامل': c.fullName || '',
                    'الرقم القومي': c.nationalId || '',
                    'القسم': c.department || '',
                    'نوع المشكلة': c.problemType || '',
                    'الأولوية': c.priority || 'عادية',
                    'الحالة': c.status || 'جديدة',
                    'تاريخ الإرسال': c.createdAt ? new Date(c.createdAt).toLocaleString('ar-EG') : '',
                    'رقم الهاتف 1': c.phone1 || '',
                    'رقم الهاتف 2': c.phone2 || '',
                    'تفاصيل المشكلة': c.problemDetails || ''
                }));
                
                const worksheet = XLSX.utils.json_to_sheet(data);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'نتائج البحث');
                
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                XLSX.writeFile(workbook, `search-results-${timestamp}.xlsx`);
                showMessage('تم تصدير نتائج البحث بنجاح', 'success');
            },
            
            saveSearchQuery(name) {
                const searchParams = {
                    search: document.getElementById('searchComplaints').value,
                    department: document.getElementById('filterDepartment').value,
                    status: document.getElementById('filterStatus').value,
                    priority: document.getElementById('filterPriority').value,
                    dateFrom: document.getElementById('filterDateFrom').value,
                    dateTo: document.getElementById('filterDateTo').value,
                    savedAt: new Date().toISOString(),
                    name: name || `بحث محفوظ ${new Date().toLocaleDateString('ar-EG')}`
                };
                
                try {
                    database.ref('savedSearches').push(searchParams);
                    showMessage('تم حفظ معايير البحث بنجاح', 'success');
                } catch (error) {
                    console.error('Error saving search query:', error);
                    showMessage('حدث خطأ أثناء حفظ البحث', 'error');
                }
            },
            
            async loadSavedSearches() {
                try {
                    const snapshot = await database.ref('savedSearches').once('value');
                    const searches = snapshot.val() || {};
                    
                    // يمكن عرضها في قائمة منسدلة أو قائمة
                    return Object.keys(searches).map(key => ({
                        key,
                        ...searches[key]
                    }));
                } catch (error) {
                    console.error('Error loading saved searches:', error);
                    return [];
                }
            }
        };
        
        // ==================== نظام سجلات التدقيق ====================
        const auditHandler = {
            logs: [],
            filteredLogs: [],
            currentPage: 1,
            itemsPerPage: 20,
            auditListener: null,
            
            init() {
                this.setupRealtimeListener();
            },
            
            setupRealtimeListener() {
                if (this.auditListener) {
                    this.auditListener.off();
                }
                
                this.auditListener = database.ref('auditLogs').orderByChild('timestamp');
                
                this.auditListener.on('child_added', (snapshot) => {
                    const log = { key: snapshot.key, ...snapshot.val() };
                    // إضافة السجل في بداية القائمة
                    this.logs.unshift(log);
                    
                    // فلترة لتظهر للمسؤول 742018 فقط
                    if (currentUser && currentUser.username === 'admin' && currentUser.role === 'admin') {
                        this.filteredLogs.unshift(log);
                        
                        // تحديث العرض تلقائياً فقط إذا كان المستخدم في قسم سجلات التدقيق
                        if (document.getElementById('auditSection')?.classList.contains('active')) {
                            this.displayLogs();
                        }
                    }
                });
            },
            
            async loadLogs() {
                try {
                    showLoading();
                    const snapshot = await database.ref('auditLogs').orderByChild('timestamp').once('value');
                    const logs = snapshot.val() || {};
                    
                    this.logs = Object.keys(logs)
                        .map(key => ({ key, ...logs[key] }))
                        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    
                    // فلترة السجلات لعرضها للمسؤول 742018 فقط
                    if (currentUser && currentUser.username === 'admin' && currentUser.role === 'admin') {
                        this.filteredLogs = [...this.logs];
                    } else {
                        this.filteredLogs = [];
                    }
                    
                    this.displayLogs();
                } catch (error) {
                    console.error('Error loading audit logs:', error);
                    showMessage('حدث خطأ أثناء تحميل سجلات التدقيق', 'error');
                } finally {
                    hideLoading();
                }
            },
            
            displayLogs() {
                const tbody = document.getElementById('auditLogsBody');
                if (!tbody) return;
                
                // التحقق من صلاحيات المستخدم
                if (!currentUser || currentUser.username !== 'admin' || currentUser.role !== 'admin') {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:#666;font-weight:bold;">⛔ غير مصرح لك بالوصول إلى سجلات التدقيق</td></tr>';
                    this.updatePagination();
                    return;
                }
                
                const start = (this.currentPage - 1) * this.itemsPerPage;
                const end = start + this.itemsPerPage;
                const pageLogs = this.filteredLogs.slice(start, end);
                
                let html = '';
                pageLogs.forEach(log => {
                    const actionNames = {
                        login: 'تسجيل دخول',
                        logout: 'تسجيل خروج',
                        create: 'إنشاء',
                        update: 'تحديث',
                        delete: 'حذف',
                        reply: 'رد',
                        status_change: 'تغيير حالة',
                        view: 'عرض',
                        export: 'تصدير',
                        backup: 'نسخ احتياطي',
                        restore: 'استعادة'
                    };
                    
                    const actionIcon = {
                        login: 'fas fa-sign-in-alt',
                        logout: 'fas fa-sign-out-alt',
                        create: 'fas fa-plus',
                        update: 'fas fa-edit',
                        delete: 'fas fa-trash',
                        reply: 'fas fa-reply',
                        status_change: 'fas fa-exchange-alt',
                        view: 'fas fa-eye',
                        export: 'fas fa-download',
                        backup: 'fas fa-save',
                        restore: 'fas fa-upload'
                    };
                    
                    html += `
                        <tr>
                            <td>${formatDate(log.timestamp)}</td>
                            <td>
                                <div style="display:flex;align-items:center;gap:8px;">
                                    <i class="${actionIcon[log.action] || 'fas fa-history'}" style="color:#666;"></i>
                                    <span>${log.userName}</span>
                                </div>
                            </td>
                            <td><span class="status-badge">${actionNames[log.action] || log.action}</span></td>
                            <td>${log.details || '-'}</td>
                            <td>${log.complaintId || '-'}</td>
                            <td>${log.ipAddress || '-'}</td>
                        </tr>
                    `;
                });
                
                tbody.innerHTML = html || '<tr><td colspan="6" style="text-align:center;padding:40px;color:#666;">لا توجد سجلات</td></tr>';
                this.updatePagination();
            },
            
            searchLogs() {
                const searchTerm = document.getElementById('searchAuditLogs').value.toLowerCase();
                
                this.filteredLogs = this.logs.filter(log => 
                    log.userName.toLowerCase().includes(searchTerm) ||
                    log.details.toLowerCase().includes(searchTerm) ||
                    (log.complaintId && log.complaintId.toLowerCase().includes(searchTerm)) ||
                    log.action.toLowerCase().includes(searchTerm)
                );
                
                this.currentPage = 1;
                this.displayLogs();
            },
            
            filterLogs() {
                const actionType = document.getElementById('auditActionType').value;
                const dateFrom = document.getElementById('auditDateFrom').value;
                const dateTo = document.getElementById('auditDateTo').value;
                
                this.filteredLogs = this.logs.filter(log => {
                    let matches = true;
                    
                    if (actionType && log.action !== actionType) {
                        matches = false;
                    }
                    
                    if (dateFrom) {
                        const logDate = new Date(log.timestamp);
                        const fromDate = new Date(dateFrom);
                        if (logDate < fromDate) {
                            matches = false;
                        }
                    }
                    
                    if (dateTo) {
                        const logDate = new Date(log.timestamp);
                        const toDate = new Date(dateTo);
                        toDate.setHours(23, 59, 59, 999);
                        if (logDate > toDate) {
                            matches = false;
                        }
                    }
                    
                    return matches;
                });
                
                this.currentPage = 1;
                this.displayLogs();
            },
            
            updatePagination() {
                const totalPages = Math.max(1, Math.ceil(this.filteredLogs.length / this.itemsPerPage));
                if (this.currentPage > totalPages) this.currentPage = totalPages;
                
                document.getElementById('auditPageInfo').textContent = `الصفحة ${this.currentPage} من ${totalPages}`;
                document.getElementById('auditPrevPage').disabled = (this.currentPage === 1);
                document.getElementById('auditNextPage').disabled = (this.currentPage === totalPages);
            },
            
            changePage(delta) {
                const totalPages = Math.max(1, Math.ceil(this.filteredLogs.length / this.itemsPerPage));
                const newPage = this.currentPage + delta;
                if (newPage < 1 || newPage > totalPages) return;
                this.currentPage = newPage;
                this.displayLogs();
            },
            
            async exportAuditLogs() {
                // التحقق من صلاحيات المستخدم
                if (!currentUser || currentUser.username !== 'admin' || currentUser.role !== 'admin') {
                    showMessage('⛔ غير مصرح لك بتصدير سجلات التدقيق', 'error');
                    return;
                }
                
                if (this.logs.length === 0) {
                    showMessage('لا توجد سجلات لتصديرها', 'error');
                    return;
                }
                
                const data = this.logs.map(log => ({
                    'التاريخ والوقت': formatDate(log.timestamp),
                    'المستخدم': log.userName,
                    'الدور': log.userRole === 'admin' ? 'مدير' : 'مستخدم',
                    'نوع الإجراء': log.action,
                    'التفاصيل': log.details || '',
                    'رقم الشكوى': log.complaintId || '',
                    'عنوان IP': log.ipAddress || ''
                }));
                
                const worksheet = XLSX.utils.json_to_sheet(data);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'سجلات التدقيق');
                
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                XLSX.writeFile(workbook, `audit-logs-${timestamp}.xlsx`);
                showMessage('تم تصدير سجلات التدقيق بنجاح', 'success');
            }
        };
        
        // ==================== نظام المهام والمتابعة ====================
        const tasksHandler = {
            tasks: [],
            filteredTasks: [],
            currentEditingTask: null,
            
            async loadTasks() {
                try {
                    const snapshot = await database.ref('tasks').once('value');
                    const tasks = snapshot.val() || {};
                    this.tasks = Object.keys(tasks).map(key => ({
                        key,
                        ...tasks[key]
                    }));
                    this.displayTasks();
                    this.populateTaskFilters();
                } catch (error) {
                    console.error('Error loading tasks:', error);
                }
            },
            
            displayTasks() {
                const container = document.getElementById('tasksContainer');
                if (!container) return;
                
                if (this.tasks.length === 0) {
                    container.innerHTML = '<p style="text-align:center;color:#666;padding:40px;">لا توجد مهام حالياً</p>';
                    return;
                }
                
                let html = '';
                this.tasks.forEach(task => {
                    const priorityColors = {
                        low: '#27ae60',
                        medium: '#f39c12',
                        high: '#e74c3c'
                    };
                    
                    const statusNames = {
                        pending: 'معلقة',
                        in_progress: 'قيد التنفيذ',
                        completed: 'مكتملة',
                        overdue: 'متأخرة'
                    };
                    
                    const dueDate = new Date(task.dueDate);
                    const now = new Date();
                    const isOverdue = dueDate < now && task.status !== 'completed';
                    
                    html += `
                        <div class="user-card" style="border-left: 4px solid ${priorityColors[task.priority] || '#3498db'};">
                            <div class="user-card-header">
                                <div class="user-avatar" style="background:linear-gradient(135deg,${priorityColors[task.priority] || '#3498db'},#2c3e50);">
                                    <i class="fas fa-tasks"></i>
                                </div>
                                <div class="user-info">
                                    <h3>${task.title}</h3>
                                    <span class="user-role">${statusNames[task.status] || task.status}</span>
                                    <div class="user-email">
                                        <i class="fas fa-user"></i>
                                        ${this.getAssigneeName(task.assignee) || 'غير محدد'}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="user-departments">
                                <div class="user-departments-title">وصف المهمة:</div>
                                <p style="color:#666;font-size:0.85rem;line-height:1.5;">${task.description.substring(0, 100)}${task.description.length > 100 ? '...' : ''}</p>
                            </div>
                            
                            <div style="margin-top:15px;padding:10px;background:#f8f9fa;border-radius:8px;">
                                <div style="display:flex;justify-content:space-between;align-items:center;">
                                    <div>
                                        <div style="font-size:0.8rem;color:#666;">تاريخ الاستحقاق:</div>
                                        <div style="font-weight:bold;color:${isOverdue ? '#e74c3c' : '#333'};">${new Date(task.dueDate).toLocaleDateString('ar-EG')}</div>
                                    </div>
                                    ${task.complaintId ? `
                                        <div>
                                            <div style="font-size:0.8rem;color:#666;">مرتبطة بشكوى:</div>
                                            <div style="font-weight:bold;color:#3498db;">${task.complaintId}</div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                            
                            <div class="user-actions">
                                <button class="action-btn btn-edit" onclick="tasksHandler.editTask('${task.key}')">
                                    <i class="fas fa-edit"></i>
                                    تعديل
                                </button>
                                <button class="action-btn btn-status" onclick="tasksHandler.updateTaskStatus('${task.key}', '${task.status === 'completed' ? 'pending' : 'completed'}')">
                                    <i class="fas ${task.status === 'completed' ? 'fa-undo' : 'fa-check'}"></i>
                                    ${task.status === 'completed' ? 'إعادة فتح' : 'إكمال'}
                                </button>
                                <button class="action-btn btn-delete" onclick="tasksHandler.deleteTask('${task.key}')">
                                    <i class="fas fa-trash"></i>
                                    حذف
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            },
            
            getAssigneeName(username) {
                const user = allUsers.find(u => u.username === username);
                return user ? user.name : username;
            },
            
            populateTaskFilters() {
                const assigneeSelect = document.getElementById('taskAssignee');
                const uniqueAssignees = [...new Set(this.tasks.map(t => t.assignee).filter(a => a))];
                
                let options = '<option value="">جميع المسؤولين</option>';
                uniqueAssignees.forEach(username => {
                    const name = this.getAssigneeName(username);
                    options += `<option value="${username}">${name} (${username})</option>`;
                });
                
                if (assigneeSelect) assigneeSelect.innerHTML = options;
            },
            
            openTaskModal(task = null) {
                this.currentEditingTask = task;
                const modal = document.getElementById('taskModal');
                const title = document.getElementById('taskModalTitle');
                const assigneeSelect = document.getElementById('taskAssigneeSelect');
                const complaintSelect = document.getElementById('taskComplaint');
                
                title.textContent = task ? 'تعديل المهمة' : 'مهمة جديدة';
                
                // تعبئة اختيار المسؤولين
                let assigneeOptions = '<option value="">اختر المسؤول</option>';
                allUsers.forEach(user => {
                    assigneeOptions += `<option value="${user.username}">${user.name} (${user.role === 'admin' ? 'مدير' : 'مستخدم'})</option>`;
                });
                assigneeSelect.innerHTML = assigneeOptions;
                
                // تعبئة اختيار الشكاوى
                let complaintOptions = '<option value="">لا يوجد</option>';
                allComplaints.forEach(complaint => {
                    complaintOptions += `<option value="${complaint.complaintNumber}">${complaint.complaintNumber} - ${complaint.fullName}</option>`;
                });
                complaintSelect.innerHTML = complaintOptions;
                
                // إذا كان تعديل، تعبئة البيانات
                if (task) {
                    document.getElementById('taskTitle').value = task.title;
                    document.getElementById('taskAssigneeSelect').value = task.assignee;
                    document.getElementById('taskDueDate').value = task.dueDate.split('T')[0];
                    document.getElementById('taskPriority').value = task.priority;
                    document.getElementById('taskStatusSelect').value = task.status;
                    document.getElementById('taskDescription').value = task.description;
                    document.getElementById('taskComplaint').value = task.complaintId || '';
                } else {
                    // إعادة تعيين النموذج
                    const tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    
                    document.getElementById('taskTitle').value = '';
                    document.getElementById('taskAssigneeSelect').value = '';
                    document.getElementById('taskDueDate').value = tomorrow.toISOString().split('T')[0];
                    document.getElementById('taskPriority').value = 'medium';
                    document.getElementById('taskStatusSelect').value = 'pending';
                    document.getElementById('taskDescription').value = '';
                    document.getElementById('taskComplaint').value = '';
                }
                
                modal.style.display = 'flex';
            },
            
            closeTaskModal() {
                document.getElementById('taskModal').style.display = 'none';
                this.currentEditingTask = null;
            },
            
            async saveTask() {
                const title = document.getElementById('taskTitle').value.trim();
                const assignee = document.getElementById('taskAssigneeSelect').value;
                const dueDate = document.getElementById('taskDueDate').value;
                const priority = document.getElementById('taskPriority').value;
                const status = document.getElementById('taskStatusSelect').value;
                const description = document.getElementById('taskDescription').value.trim();
                const complaintId = document.getElementById('taskComplaint').value;
                
                if (!title || !assignee || !dueDate || !description) {
                    showMessage('من فضلك أكمل جميع الحقول المطلوبة', 'error');
                    return;
                }
                
                const taskData = {
                    title,
                    assignee,
                    dueDate,
                    priority,
                    status,
                    description,
                    complaintId: complaintId || null,
                    createdAt: new Date().toISOString(),
                    createdBy: currentUser?.name || 'غير معروف',
                    updatedAt: new Date().toISOString()
                };
                
                try {
                    if (this.currentEditingTask) {
                        await database.ref(`tasks/${this.currentEditingTask.key}`).update(taskData);
                        showMessage('تم تحديث المهمة بنجاح', 'success');
                    } else {
                        await database.ref('tasks').push(taskData);
                        showMessage('تم إضافة المهمة بنجاح', 'success');
                    }
                    
                    this.closeTaskModal();
                    this.loadTasks();
                } catch (error) {
                    console.error('Error saving task:', error);
                    showMessage('حدث خطأ أثناء حفظ المهمة', 'error');
                }
            },
            
            async updateTaskStatus(taskKey, newStatus) {
                try {
                    await database.ref(`tasks/${taskKey}`).update({
                        status: newStatus,
                        updatedAt: new Date().toISOString()
                    });
                    
                    showMessage('تم تحديث حالة المهمة', 'success');
                    this.loadTasks();
                } catch (error) {
                    console.error('Error updating task status:', error);
                    showMessage('حدث خطأ أثناء تحديث المهمة', 'error');
                }
            },
            
            async deleteTask(taskKey) {
                if (!confirm('هل أنت متأكد من حذف هذه المهمة؟')) return;
                
                try {
                    await database.ref(`tasks/${taskKey}`).remove();
                    showMessage('تم حذف المهمة بنجاح', 'success');
                    this.loadTasks();
                } catch (error) {
                    console.error('Error deleting task:', error);
                    showMessage('حدث خطأ أثناء حذف المهمة', 'error');
                }
            },
            
            searchTasks() {
                const searchTerm = document.getElementById('searchTasks').value.toLowerCase();
                this.filteredTasks = this.tasks.filter(task => 
                    task.title.toLowerCase().includes(searchTerm) ||
                    task.description.toLowerCase().includes(searchTerm) ||
                    (task.complaintId && task.complaintId.toLowerCase().includes(searchTerm))
                );
                
                this.displayFilteredTasks();
            },
            
            filterTasks() {
                const statusFilter = document.getElementById('taskStatus').value;
                const assigneeFilter = document.getElementById('taskAssignee').value;
                
                this.filteredTasks = this.tasks.filter(task => {
                    let matches = true;
                    
                    if (statusFilter && task.status !== statusFilter) {
                        matches = false;
                    }
                    
                    if (assigneeFilter && task.assignee !== assigneeFilter) {
                        matches = false;
                    }
                    
                    return matches;
                });
                
                this.displayFilteredTasks();
            },
            
            displayFilteredTasks() {
                const container = document.getElementById('tasksContainer');
                if (!container) return;
                
                if (this.filteredTasks.length === 0) {
                    container.innerHTML = '<p style="text-align:center;color:#666;padding:40px;">لا توجد مهام تطابق البحث</p>';
                    return;
                }
                
                let html = '';
                this.filteredTasks.forEach(task => {
                    const priorityColors = {
                        low: '#27ae60',
                        medium: '#f39c12',
                        high: '#e74c3c'
                    };
                    
                    const statusNames = {
                        pending: 'معلقة',
                        in_progress: 'قيد التنفيذ',
                        completed: 'مكتملة',
                        overdue: 'متأخرة'
                    };
                    
                    const dueDate = new Date(task.dueDate);
                    const now = new Date();
                    const isOverdue = dueDate < now && task.status !== 'completed';
                    
                    html += `
                        <div class="user-card" style="border-left: 4px solid ${priorityColors[task.priority] || '#3498db'};">
                            <div class="user-card-header">
                                <div class="user-avatar" style="background:linear-gradient(135deg,${priorityColors[task.priority] || '#3498db'},#2c3e50);">
                                    <i class="fas fa-tasks"></i>
                                </div>
                                <div class="user-info">
                                    <h3>${task.title}</h3>
                                    <span class="user-role">${statusNames[task.status] || task.status}</span>
                                    <div class="user-email">
                                        <i class="fas fa-user"></i>
                                        ${this.getAssigneeName(task.assignee) || 'غير محدد'}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="user-actions">
                                <button class="action-btn btn-edit" onclick="tasksHandler.editTask('${task.key}')">
                                    <i class="fas fa-edit"></i>
                                    تعديل
                                </button>
                                <button class="action-btn btn-status" onclick="tasksHandler.updateTaskStatus('${task.key}', '${task.status === 'completed' ? 'pending' : 'completed'}')">
                                    <i class="fas ${task.status === 'completed' ? 'fa-undo' : 'fa-check'}"></i>
                                    ${task.status === 'completed' ? 'إعادة فتح' : 'إكمال'}
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
            }
        };
        
        // ==================== دوال الإدارة الرئيسية ====================

        function handleLogin(username, password) {
            if (username === 'admin' && password === '742018') {
                isLoggedIn = true;
                currentUser = {
                    name: 'المكتب الخدمي للنائب أحمد الحديدي',
                    username: 'admin',
                    role: 'admin',
                    loginTime: new Date().toISOString()
                };

                localStorage.setItem('adminLoggedIn', 'true');
                localStorage.setItem('adminUser', JSON.stringify(currentUser));
                
                // تسجيل عملية تسجيل الدخول
                auditHandler.logAction('login', 'تسجيل دخول المدير الرئيسي');

                showDashboard();
                return;
            }

            database.ref('users').once('value').then(snapshot => {
                const users = snapshot.val() || {};
                let userFound = false;
                
                Object.keys(users).forEach(key => {
                    const user = users[key];
                    if (user.username === username && user.password === password) {
                        isLoggedIn = true;
                        currentUser = {
                            name: user.name,
                            username: user.username,
                            role: user.role || 'user',
                            departments: user.departments || [],
                            loginTime: new Date().toISOString()
                        };

                        localStorage.setItem('adminLoggedIn', 'true');
                        localStorage.setItem('adminUser', JSON.stringify(currentUser));
                        
                        // تسجيل عملية تسجيل الدخول
                        auditHandler.logAction('login', `تسجيل دخول المستخدم: ${user.name}`);

                        showDashboard();
                        userFound = true;
                    }
                });
                
                if (!userFound) {
                    showMessage('اسم المستخدم أو كلمة المرور غير صحيحة', 'error');
                    const loginError = document.getElementById('loginError');
                    if (loginError) loginError.style.display = 'block';
                }
            });
        }

        function initAuth() {
            const saved = localStorage.getItem('adminLoggedIn');
            const savedUser = localStorage.getItem('adminUser');

            if (saved === 'true' && savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    isLoggedIn = true;
                    showDashboard();
                } catch {
                    localStorage.removeItem('adminLoggedIn');
                    localStorage.removeItem('adminUser');
                }
            }
        }

        function logout() {
            // تسجيل عملية تسجيل الخروج
            auditHandler.logAction('logout', 'تسجيل خروج المستخدم');
            
            isLoggedIn = false;
            currentUser = null;
            localStorage.removeItem('adminLoggedIn');
            localStorage.removeItem('adminUser');
            document.getElementById('dashboardScreen').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'flex';
        }

        function showDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboardScreen').style.display = 'block';
            updateAdminWelcome();
            updateSidebarPermissions();
            updateMobileNavPermissions();
            showSection('dashboard');
            loadSettings();
            loadDepartments();
            loadUsers();
            loadComplaints();
            setupRealtimeListener();
            
            // تهيئة الأنظمة الجديدة
            alertSystem.init();
            workflowHandler.init();
            templatesHandler.loadTemplates();
            auditHandler.init(); // تغيير من loadLogs() إلى init()
            tasksHandler.loadTasks();
            
            // تحديث إحصائيات لوحة التحكم
            updateDashboardStats();
        }

        function updateAdminWelcome() {
            if (!currentUser) return;
            document.getElementById('adminWelcome').textContent = `مرحباً، ${currentUser.name}`;
            if (currentUser.loginTime) {
                const d = new Date(currentUser.loginTime);
                document.getElementById('adminLastLogin').textContent =
                    'آخر دخول: ' + d.toLocaleString('ar-EG');
            }
        }

        function updateSidebarPermissions() {
            const adminOnly = document.querySelectorAll('.admin-only');
            if (currentUser && currentUser.role === 'admin') {
                adminOnly.forEach(el => el.style.display = 'flex');
            } else {
                adminOnly.forEach(el => el.style.display = 'none');
            }
        }

        function updateMobileNavPermissions() {
            const adminOnly = document.querySelectorAll('.mobile-nav-item.admin-only');
            if (currentUser && currentUser.role === 'admin') {
                adminOnly.forEach(el => el.style.display = 'flex');
            } else {
                adminOnly.forEach(el => el.style.display = 'none');
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('active');
            overlay.style.display = sidebar.classList.contains('active') ? 'block' : 'none';
        }

        function showSection(section) {
            document.querySelectorAll('.content-section').forEach(sec => {
                sec.classList.remove('active');
            });
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });

            const target = document.getElementById(section + 'Section');
            if (target) target.classList.add('active');

            const activeMenu = document.querySelector(`.menu-item[data-section="${section}"]`);
            if (activeMenu) activeMenu.classList.add('active');

            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            if (sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
                overlay.style.display = 'none';
            }

            updateMobileNav(section);
            
            // عند عرض قسم التقارير، تحميل بيانات التقرير اليومي
            if (section === 'reports') {
                reportsHandler.generateDailyReport();
            }
            
            // عند عرض قسم سجلات التدقيق، تحميل السجلات
            if (section === 'audit') {
                auditHandler.loadLogs();
            }
        }

        function updateMobileNav(section) {
            const navItems = document.querySelectorAll('.mobile-nav-item');
            navItems.forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-section') === section) {
                    item.classList.add('active');
                }
            });
        }

        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        let messageTimeout = null;
        function showMessage(text, type = 'success') {
            if (messageTimeout) clearTimeout(messageTimeout);
            const old = document.querySelector('.message');
            if (old) old.remove();

            const div = document.createElement('div');
            div.className = 'message' + (type === 'error' ? ' error' : '');
            div.textContent = text;
            document.body.appendChild(div);

            messageTimeout = setTimeout(() => {
                div.remove();
            }, 4000);
        }

        function setupRealtimeListener() {
            if (complaintsListener) {
                complaintsListener.off();
            }

            complaintsListener = database.ref('complaints');

            complaintsListener.on('child_added', (snapshot) => {
                const complaint = { key: snapshot.key, ...snapshot.val() };
                if (shouldShowComplaint(complaint)) {
                    if (!complaint.viewedBy || !complaint.viewedBy[currentUser.username]) {
                        unreadComplaints.add(complaint.key);
                        updateUnreadBadge();
                        updateMobileNavBadge();
                        
                        // إرسال إشعار PWA
                        if (Notification.permission === 'granted' && 'serviceWorker' in navigator) {
                            navigator.serviceWorker.ready.then(registration => {
                                registration.showNotification('شكوى جديدة 📝', {
                                    body: `تم استلام شكوى جديدة من ${complaint.fullName || 'عميل'}`,
                                    icon: 'icon-192x192.png',
                                    badge: 'icon-192x192.png',
                                    vibrate: [200, 100, 200],
                                    data: {
                                        url: window.location.href,
                                        complaintId: complaint.key
                                    }
                                });
                            });
                        }
                        
                        // تشغيل صوت التنبيه
                        if (document.getElementById('alertSoundEnabled')?.checked) {
                            alertSystem.playSound();
                        }
                    }
                    const existingIndex = allComplaints.findIndex(c => c.key === complaint.key);
                    if (existingIndex === -1) {
                        allComplaints.unshift(complaint);
                        filterComplaints();
                        updateDashboardStats();
                        displayLatestComplaints();
                        updateDashboardCards();
                        updateUrgentComplaints();
                    }
                    
                    // تطبيق سير العمل التلقائي
                    workflowHandler.autoAssignComplaint(complaint.key, complaint);
                    workflowHandler.autoReplyToComplaint(complaint.key, complaint);
                }
            });

            complaintsListener.on('child_changed', (snapshot) => {
                const complaint = { key: snapshot.key, ...snapshot.val() };
                const index = allComplaints.findIndex(c => c.key === complaint.key);
                if (index !== -1) {
                    allComplaints[index] = complaint;
                    filterComplaints();
                    updateDashboardStats();
                    displayLatestComplaints();
                    updateDashboardCards();
                    updateUrgentComplaints();
                }
            });

            complaintsListener.on('child_removed', (snapshot) => {
                const index = allComplaints.findIndex(c => c.key === snapshot.key);
                if (index !== -1) {
                    allComplaints.splice(index, 1);
                    unreadComplaints.delete(snapshot.key);
                    updateUnreadBadge();
                    updateMobileNavBadge();
                    filterComplaints();
                    updateDashboardStats();
                    displayLatestComplaints();
                    updateDashboardCards();
                    updateUrgentComplaints();
                }
            });
        }

        function updateMobileNavBadge() {
            const count = unreadComplaints.size;
            const badge = document.getElementById('mobileNavBadge');
            if (!badge) return;
            
            if (count > 0) {
                badge.textContent = count > 9 ? '9+' : count.toString();
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }

        function updateUnreadBadge() {
            const count = unreadComplaints.size;
            const badge = document.getElementById('complaintsBadge');
            if (!badge) return;
            if (count > 0) {
                badge.textContent = count > 9 ? '9+' : count.toString();
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }

        function shouldShowComplaint(complaint) {
            if (!currentUser) return false;
            if (currentUser.role === 'admin') return true;
            if (currentUser.departments && currentUser.departments.length > 0) {
                return currentUser.departments.includes(complaint.department);
            }
            return false;
        }

        // ==================== دوال تحميل البيانات ====================

        async function loadComplaints() {
            showLoading();
            try {
                const snapshot = await database.ref('complaints').orderByChild('createdAt').once('value');
                const data = snapshot.val() || {};
                allComplaints = Object.keys(data)
                    .map(key => ({ key, ...data[key] }))
                    .filter(c => shouldShowComplaint(c))
                    .sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));

                filteredComplaints = [...allComplaints];

                unreadComplaints = new Set();
                allComplaints.forEach(c => {
                    if (!c.viewedBy || !c.viewedBy[currentUser.username]) {
                        unreadComplaints.add(c.key);
                    }
                });
                updateUnreadBadge();
                updateMobileNavBadge();

                populateDepartmentFilter();
                updateDashboardStats();
                updateDashboardCards();
                displayComplaintsTable();
                displayLatestComplaints();
                updateUrgentComplaints();
            } catch (error) {
                console.error(error);
                showMessage('حدث خطأ أثناء تحميل الشكاوى', 'error');
            } finally {
                hideLoading();
            }
        }

        function loadDepartments() {
            database.ref('departments').once('value', snapshot => {
                const data = snapshot.val() || {};
                allDepartments = Object.keys(data).map(key => ({
                    key,
                    ...data[key]
                }));

                populateDepartmentFilter();
                populateUserDepartments();
                displayDepartmentsGrid();
            });
        }

        function loadUsers() {
            database.ref('users').once('value', snapshot => {
                const data = snapshot.val() || {};
                allUsers = Object.keys(data).map(key => ({
                    key,
                    ...data[key]
                }));
                displayUsersGrid();
            });
        }

        function loadSettings() {
            database.ref('settings').once('value', snapshot => {
                const data = snapshot.val() || {};
                settings = data;

                if (settings.systemName) {
                    document.getElementById('systemName').value = settings.systemName;
                    document.querySelector('.logo').textContent = settings.systemName;
                }
                if (settings.systemDescription) {
                    document.getElementById('systemDescription').value = settings.systemDescription;
                    document.querySelector('.subtitle').textContent = settings.systemDescription;
                }
                if (typeof settings.enableNotifications !== 'undefined') {
                    document.getElementById('enableNotifications').checked = settings.enableNotifications;
                }
            });
        }

        // ==================== دوال العرض ====================

        function populateDepartmentFilter() {
            const select = document.getElementById('filterDepartment');
            if (!select) return;

            const departments = [...new Set(allDepartments.map(d => d.name))];

            let options = '<option value="">جميع الأقسام</option>';
            departments.forEach(dept => {
                options += `<option value="${dept}">${dept}</option>`;
            });

            select.innerHTML = options;
        }

        function populateUserDepartments() {
            const container = document.getElementById('userDepartments');
            if (!container) return;

            let html = '';
            allDepartments.forEach(dept => {
                html += `
                    <label>
                        <input type="checkbox" value="${dept.name}" class="user-dept-checkbox">
                        <span>${dept.name}</span>
                    </label>
                `;
            });

            container.innerHTML = html;
        }

        function displayComplaintsTable() {
            const tbody = document.getElementById('complaintsTableBody');
            if (!tbody) return;

            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageComplaints = filteredComplaints.slice(start, end);

            let html = '';
            pageComplaints.forEach(complaint => {
                const isUnread = unreadComplaints.has(complaint.key);
                const rowClass = isUnread ? 'unread' : '';
                const priority = complaint.priority || complaint.problemType || 'عادية';

                // التحقق مما إذا كان المستخدم الحالي هو المسؤول 742018
                const isAdmin742018 = currentUser && currentUser.username === 'admin' && currentUser.role === 'admin';
                
                html += `
                    <tr class="${rowClass}">
                        <td>
                            ${isUnread ? '<span class="new-request-indicator"></span>' : ''}
                            ${complaint.complaintNumber || '-'}
                        </td>
                        <td>${complaint.fullName || '-'}</td>
                        <td>${complaint.department || '-'}</td>
                        <td><span class="status-badge ${getStatusClass(complaint.status)}">${complaint.status || 'جديدة'}</span></td>
                        <td><span class="status-badge ${getPriorityClass(priority)}">${priority}</span></td>
                        <td>${formatDate(complaint.createdAt)}</td>
                        <td class="actions">
                            <button class="action-btn btn-view" onclick="viewComplaint('${complaint.key}')">
                                <i class="fas fa-eye"></i>
                                عرض
                            </button>
                            <button class="action-btn btn-secondary" onclick="downloadComplaintPDF('${complaint.key}')">
                                <i class="fas fa-file-pdf"></i>
                                PDF
                            </button>
                            ${isAdmin742018 ? `
                                <button class="action-btn btn-delete" onclick="deleteComplaint('${complaint.key}')">
                                    <i class="fas fa-trash"></i>
                                    حذف
                                </button>
                            ` : ''}
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html || '<tr><td colspan="7" style="text-align:center;padding:40px;color:#666;">لا توجد شكاوى</td></tr>';
            updatePagination();
        }

        function displayLatestComplaints() {
            const tbody = document.getElementById('latestComplaintsBody');
            if (!tbody) return;

            const latest = allComplaints.slice(0, 5);

            let html = '';
            latest.forEach(complaint => {
                const isUnread = unreadComplaints.has(complaint.key);
                const rowClass = isUnread ? 'unread' : '';
                const priority = complaint.priority || complaint.problemType || 'عادية';

                html += `
                    <tr class="${rowClass}">
                        <td>
                            ${isUnread ? '<span class="new-request-indicator"></span>' : ''}
                            ${complaint.complaintNumber || '-'}
                        </td>
                        <td>${complaint.fullName || '-'}</td>
                        <td>${complaint.department || '-'}</td>
                        <td><span class="status-badge ${getStatusClass(complaint.status)}">${complaint.status || 'جديدة'}</span></td>
                        <td>${formatDate(complaint.createdAt)}</td>
                        <td class="actions">
                            <button class="action-btn btn-view" onclick="viewComplaint('${complaint.key}')">
                                <i class="fas fa-eye"></i>
                                عرض
                            </button>
                            <button class="action-btn btn-secondary" onclick="downloadComplaintPDF('${complaint.key}')">
                                <i class="fas fa-file-pdf"></i>
                                PDF
                            </button>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html || '<tr><td colspan="6" style="text-align:center;padding:40px;color:#666;">لا توجد شكاوى</td></tr>';
        }

        function updateUrgentComplaints() {
            const urgent = allComplaints.filter(c => {
                const priority = c.priority || c.problemType || 'عادية';
                return (priority === 'فى غاية الأهمية' || c.escalated) && 
                       (c.status === 'جديدة' || c.status === 'قيد المراجعة');
            }).slice(0, 5);
            
            const tbody = document.getElementById('urgentComplaintsBody');
            if (!tbody) return;
            
            let html = '';
            urgent.forEach(complaint => {
                const priority = complaint.priority || complaint.problemType || 'عادية';
                const created = new Date(complaint.createdAt);
                const now = new Date();
                const hoursDiff = Math.floor((now - created) / (1000 * 60 * 60));
                
                html += `
                    <tr>
                        <td>
                            <span class="new-request-indicator"></span>
                            ${complaint.complaintNumber || '-'}
                        </td>
                        <td>${complaint.fullName || '-'}</td>
                        <td>${complaint.department || '-'}</td>
                        <td><span class="status-badge ${getPriorityClass(priority)}">${priority}</span></td>
                        <td>${hoursDiff} ساعة</td>
                        <td class="actions">
                            <button class="action-btn btn-view" onclick="viewComplaint('${complaint.key}')">
                                <i class="fas fa-eye"></i>
                                عرض
                            </button>
                            <button class="action-btn btn-reply" onclick="viewComplaint('${complaint.key}')">
                                <i class="fas fa-reply"></i>
                                رد عاجل
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html || '<tr><td colspan="6" style="text-align:center;padding:40px;color:#666;">لا توجد شكاوى عاجلة</td></tr>';
            
            // تحديث العداد
            document.getElementById('urgentComplaints').textContent = urgent.length;
            
            // تحديث عدادات SLA
            const slaOverdue = allComplaints.filter(c => {
                const created = new Date(c.createdAt);
                const now = new Date();
                const hoursDiff = (now - created) / (1000 * 60 * 60);
                return hoursDiff > 72 && c.status !== 'مكتملة' && c.status !== 'تم الرد';
            }).length;
            
            document.getElementById('slaOverdue').textContent = slaOverdue;
            
            // تحديث معدل الحل
            const resolved = allComplaints.filter(c => c.status === 'مكتملة' || c.status === 'تم الرد').length;
            const total = allComplaints.length;
            const resolutionRate = total > 0 ? Math.round((resolved / total) * 100) : 0;
            document.getElementById('resolutionRate').textContent = resolutionRate + '%';
        }

        function displayUsersGrid() {
            const container = document.getElementById('usersGrid');
            if (!container) return;

            let html = '';
            
            if (allUsers.length === 0) {
                html = '<p style="text-align:center;color:#666;padding:40px;">لا يوجد مستخدمين مسجلين</p>';
            } else {
                allUsers.forEach(user => {
                    if (user.username === 'admin') return;
                    
                    const roleClass = user.role === 'admin' ? 'admin' : '';
                    
                    let departmentsHtml = '';
                    if (user.departments && user.departments.length > 0) {
                        user.departments.forEach(dept => {
                            departmentsHtml += `<span class="department-tag">${dept}</span>`;
                        });
                    } else {
                        departmentsHtml = '<span style="color:#999;">لا توجد أقسام</span>';
                    }
                    
                    html += `
                        <div class="user-card">
                            <div class="user-card-header">
                                <div class="user-avatar">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="user-info">
                                    <h3>${user.name || 'غير معروف'}</h3>
                                    <span class="user-role ${roleClass}">${user.role === 'admin' ? 'مدير' : 'مستخدم'}</span>
                                    <div class="user-email">
                                        <i class="fas fa-envelope"></i>
                                        ${user.email || 'لا يوجد بريد'}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="user-departments">
                                <div class="user-departments-title">الأقسام المخصصة:</div>
                                <div class="department-tags">
                                    ${departmentsHtml}
                                </div>
                            </div>
                            
                            <div class="user-actions">
                                <button class="action-btn btn-edit" onclick="editUser('${user.key}')">
                                    <i class="fas fa-edit"></i>
                                    تعديل
                                </button>
                                <button class="action-btn btn-delete" onclick="deleteUser('${user.key}')">
                                    <i class="fas fa-trash"></i>
                                    حذف
                                </button>
                            </div>
                        </div>
                    `;
                });
            }
            
            container.innerHTML = html;
        }

        function displayDepartmentsGrid() {
            const container = document.getElementById('departmentsList');
            if (!container) return;

            if (!allDepartments.length) {
                container.innerHTML = '<p style="padding:10px;color:#666;">لا توجد أقسام حالياً.</p>';
                return;
            }

            let html = '';
            allDepartments.forEach(dep => {
                html += `
                    <div class="department-item">
                        <span>${dep.name}</span>
                        <span class="delete-dept" onclick="deleteDepartment('${dep.key || ''}')">
                            <i class="fas fa-times"></i>
                        </span>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // ==================== دوال المساعدة ====================

        function filterComplaints() {
            const search = document.getElementById('searchComplaints').value.toLowerCase();
            const department = document.getElementById('filterDepartment').value;
            const status = document.getElementById('filterStatus').value;
            const priority = document.getElementById('filterPriority').value;
            const dateFrom = document.getElementById('filterDateFrom').value;
            const dateTo = document.getElementById('filterDateTo').value;

            filteredComplaints = allComplaints.filter(c => {
                const searchMatch = !search ||
                    (c.complaintNumber && c.complaintNumber.toLowerCase().includes(search)) ||
                    (c.fullName && c.fullName.toLowerCase().includes(search)) ||
                    (c.nationalId && c.nationalId.includes(search)) ||
                    (c.phone1 && c.phone1.includes(search)) ||
                    (c.problemDetails && c.problemDetails.toLowerCase().includes(search));

                const departmentMatch = !department || c.department === department;
                const statusMatch = !status || c.status === status;
                const priorityMatch = !priority || (c.priority || c.problemType || 'عادية') === priority;
                
                let dateMatch = true;
                if (dateFrom) {
                    const complaintDate = new Date(c.createdAt);
                    const fromDate = new Date(dateFrom);
                    if (complaintDate < fromDate) {
                        dateMatch = false;
                    }
                }
                
                if (dateTo) {
                    const complaintDate = new Date(c.createdAt);
                    const toDate = new Date(dateTo);
                    toDate.setHours(23, 59, 59, 999);
                    if (complaintDate > toDate) {
                        dateMatch = false;
                    }
                }

                return searchMatch && departmentMatch && statusMatch && priorityMatch && dateMatch;
            });

            currentPage = 1;
            displayComplaintsTable();
        }

        function updatePagination() {
            const totalPages = Math.max(1, Math.ceil(filteredComplaints.length / itemsPerPage));
            if (currentPage > totalPages) currentPage = totalPages;

            document.getElementById('pageInfo').textContent = `الصفحة ${currentPage} من ${totalPages}`;
            document.getElementById('prevPage').disabled = (currentPage === 1);
            document.getElementById('nextPage').disabled = (currentPage === totalPages);
        }

        function changePage(delta) {
            const totalPages = Math.max(1, Math.ceil(filteredComplaints.length / itemsPerPage));
            const newPage = currentPage + delta;
            if (newPage < 1 || newPage > totalPages) return;
            currentPage = newPage;
            displayComplaintsTable();
            updatePagination();
        }

        function updateDashboardStats() {
            const total = allComplaints.length;
            const newCount = allComplaints.filter(c => c.status === 'جديدة' || !c.status).length;
            const resolved = allComplaints.filter(c => c.status === 'مكتملة' || c.status === 'تم الرد').length;

            document.getElementById('totalComplaints').textContent = total;
            document.getElementById('newComplaints').textContent = newCount;
            document.getElementById('resolvedComplaints').textContent = resolved;
        }

        function updateDashboardCards() {
            const newCount = allComplaints.filter(c => c.status === 'جديدة' || !c.status).length;
            const completed = allComplaints.filter(c => c.status === 'مكتملة').length;
            const inProgress = allComplaints.filter(c => c.status === 'قيد المعالجة' || c.status === 'قيد المراجعة').length;

            document.getElementById('cardNewComplaints').textContent = newCount;
            document.getElementById('cardCompletedComplaints').textContent = completed;
            document.getElementById('cardInProgress').textContent = inProgress;
        }

        function getStatusClass(status) {
            switch (status) {
                case 'جديدة': return 'status-new';
                case 'قيد المراجعة':
                case 'قيد المعالجة': return 'status-in-progress';
                case 'تم الرد':
                case 'مكتملة': return 'status-resolved';
                case 'ملغاة': return 'status-closed';
                default: return 'status-new';
            }
        }
        
        function getPriorityClass(priority) {
            switch (priority) {
                case 'فى غاية الأهمية': return 'status-closed';
                case 'مهمة': return 'status-in-progress';
                case 'عادية': return 'status-new';
                default: return 'status-new';
            }
        }

        function formatDate(timestamp) {
            if (!timestamp) return '-';
            try {
                const d = new Date(timestamp);
                return d.toLocaleString('ar-EG');
            } catch {
                return '-';
            }
        }

        // ==================== دوال إدارة الشكاوى ====================

        async function viewComplaint(key) {
            showLoading();
            try {
                const snapshot = await database.ref(`complaints/${key}`).once('value');
                const complaint = snapshot.val();

                if (!complaint) {
                    showMessage('لم يتم العثور على الشكوى', 'error');
                    return;
                }

                const viewedBy = complaint.viewedBy || {};
                viewedBy[currentUser.username] = {
                    name: currentUser.name,
                    timestamp: new Date().toISOString()
                };

                await database.ref(`complaints/${key}/viewedBy`).set(viewedBy);
                
                // تسجيل عملية العرض
                auditHandler.logAction('view', `عرض الشكوى ${complaint.complaintNumber}`, complaint.complaintNumber);

                unreadComplaints.delete(key);
                updateUnreadBadge();
                updateMobileNavBadge();
                displayComplaintDetails(key, complaint);
                filterComplaints();
                displayLatestComplaints();
                updateUrgentComplaints();
            } catch (error) {
                console.error('Error viewing complaint:', error);
                showMessage('حدث خطأ أثناء عرض التفاصيل', 'error');
            } finally {
                hideLoading();
            }
        }

        function displayComplaintDetails(key, complaint) {
            const modalBody = document.getElementById('modalBody');

            const priority = complaint.priority || complaint.problemType || 'عادية';

            let html = `
                <div class="details-grid">
                    <div class="detail-item">
                        <div class="detail-label">رقم الشكوى</div>
                        <div class="detail-value">${complaint.complaintNumber || '-'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">الاسم الكامل</div>
                        <div class="detail-value">${complaint.fullName || '-'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">الرقم القومي</div>
                        <div class="detail-value national-id">${complaint.nationalId || '-'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">المحافظة</div>
                        <div class="detail-value">الدقهلية</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">بلد الإقامة</div>
                        <div class="detail-value">${complaint.localUnit || complaint.residence || '-'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">رقم الهاتف 1</div>
                        <div class="detail-value">${complaint.phone1 || '-'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">رقم الهاتف 2</div>
                        <div class="detail-value">${complaint.phone2 || '-'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">القسم</div>
                        <div class="detail-value">${complaint.department || '-'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">درجة أهمية المشكلة</div>
                        <div class="detail-value">${priority}</div>
                    </div>
                    <div class="detail-item full-width">
                        <div class="detail-label">نوع المشكلة</div>
                        <div class="detail-value">${complaint.problemType || '-'}</div>
                    </div>
                    <div class="detail-item full-width">
                        <div class="detail-label">تفاصيل المشكلة</div>
                        <div class="detail-value">${complaint.problemDetails || '-'}</div>
                    </div>
                </div>
            `;

            html += `
                <div class="status-form">
                    <h4><i class="fas fa-exchange-alt"></i> تغيير حالة الشكوى</h4>
                    <select id="complaintStatusSelect">
                        <option value="جديدة" ${complaint.status === 'جديدة' || !complaint.status ? 'selected' : ''}>جديدة</option>
                        <option value="قيد المراجعة" ${complaint.status === 'قيد المراجعة' ? 'selected' : ''}>قيد المراجعة</option>
                        <option value="قيد المعالجة" ${complaint.status === 'قيد المعالجة' ? 'selected' : ''}>قيد المعالجة</option>
                        <option value="تم الرد" ${complaint.status === 'تم الرد' ? 'selected' : ''}>تم الرد</option>
                        <option value="مكتملة" ${complaint.status === 'مكتملة' ? 'selected' : ''}>مكتملة</option>
                        <option value="ملغاة" ${complaint.status === 'ملغاة' ? 'selected' : ''}>ملغاة</option>
                    </select>

                    <h4 style="margin-top:15px;"><i class="fas fa-flag"></i> درجة أهمية المشكلة</h4>
                    <select id="complaintPrioritySelect">
                        <option value="عادية" ${priority === 'عادية' ? 'selected' : ''}>عادية</option>
                        <option value="مهمة" ${priority === 'مهمة' ? 'selected' : ''}>مهمة</option>
                        <option value="فى غاية الأهمية" ${priority === 'فى غاية الأهمية' ? 'selected' : ''}>فى غاية الأهمية</option>
                    </select>

                    <div class="form-actions">
                        <button class="action-btn btn-status" onclick="updateComplaintStatus('${key}')">
                            <i class="fas fa-save"></i>
                            حفظ الحالة / النوع
                        </button>
                    </div>
                </div>
            `;

            html += `
                <div class="responses-container">
                    <div class="responses-title">
                        <i class="fas fa-comments"></i>
                        سجل متابعة الطلب
                    </div>
                    <div class="responses-list">
            `;

            if (complaint.responses && Object.keys(complaint.responses).length > 0) {
                const responsesArray = Object.values(complaint.responses);
                responsesArray.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                
                responsesArray.forEach(response => {
                    const isAdmin = response.senderRole === 'admin';
                    const isSystem = response.senderRole === 'system';
                    const senderName = isSystem ? 'النظام التلقائي' : 
                                    isAdmin ? 'المكتب الخدمي للنائب أحمد الحديدي' : 
                                    (response.senderName || complaint.fullName || 'العميل');

                    html += `
                        <div class="response-item ${isSystem ? 'response-client' : (isAdmin ? 'response-admin' : 'response-client')}">
                            <div class="response-header">
                                <div class="response-sender">
                                    <i class="fas ${isSystem ? 'fa-robot' : (isAdmin ? 'fa-user-shield' : 'fa-user')}"></i>
                                    <span>${senderName}</span>
                                </div>
                                <div class="response-time">
                                    ${formatDate(response.timestamp)}
                                </div>
                            </div>
                            <div class="response-content">${response.message || ''}</div>
                        </div>
                    `;
                });
            } else {
                html += `
                    <p style="color:#666;">لا توجد ردود حتى الآن.</p>
                `;
            }

            html += `
                    </div>
                </div>
            `;

            html += `
                <div class="reply-form">
                    <h4><i class="fas fa-reply"></i> إضافة رد من المكتب الخدمي للنائب أحمد الحديدي</h4>
                    <div style="display:flex;gap:10px;margin-bottom:10px;">
                        <button class="action-btn btn-secondary" onclick="complaintHandler.useTemplateInReply('${key}')">
                            <i class="fas fa-file-alt"></i>
                            استخدام قالب
                        </button>
                        <button class="action-btn btn-secondary" onclick="complaintHandler.showTemplateMenu('${key}')">
                            <i class="fas fa-bolt"></i>
                            رد سريع
                        </button>
                    </div>
                    <textarea id="replyMessage" placeholder="اكتب ردك هنا..."></textarea>
                    <div class="form-actions">
                        <button class="action-btn btn-reply" onclick="sendReply('${key}')">
                            <i class="fas fa-paper-plane"></i>
                            إرسال الرد
                        </button>
                    </div>
                </div>
            `;

            // التحقق مما إذا كان المستخدم الحالي هو المسؤول 742018
            const isAdmin742018 = currentUser && currentUser.username === 'admin' && currentUser.role === 'admin';
            
            html += `
                <div class="form-actions" style="margin-top:20px;">
                    <button class="action-btn btn-view" onclick="downloadComplaintPDF('${key}')">
                        <i class="fas fa-file-pdf"></i>
                        تصدير PDF
                    </button>
                    ${isAdmin742018 ? `
                        <button class="action-btn btn-delete" onclick="deleteComplaint('${key}')">
                            <i class="fas fa-trash"></i>
                            حذف الشكوى
                        </button>
                    ` : ''}
                    <button class="action-btn btn-secondary" onclick="closeComplaintModal()">
                        <i class="fas fa-times"></i>
                        إغلاق
                    </button>
                </div>
            `;

            modalBody.innerHTML = html;
            document.getElementById('complaintModal').style.display = 'flex';
        }

        function closeComplaintModal() {
            document.getElementById('complaintModal').style.display = 'none';
        }

        async function updateComplaintStatus(key) {
            const status = document.getElementById('complaintStatusSelect').value;
            const priority = document.getElementById('complaintPrioritySelect').value;
            const oldStatus = allComplaints.find(c => c.key === key)?.status;
            
            try {
                await database.ref(`complaints/${key}`).update({
                    status,
                    priority: priority,
                    updatedAt: new Date().toISOString()
                });
                
                // تسجيل عملية تغيير الحالة
                auditHandler.logAction('status_change', 
                    `تغيير حالة الشكوى من "${oldStatus}" إلى "${status}" والأولوية إلى "${priority}"`, 
                    allComplaints.find(c => c.key === key)?.complaintNumber);
                
                // إرسال تنبيه للعميل إذا كان مفعلاً
                if (document.getElementById('alertStatusUpdate')?.checked && status !== oldStatus) {
                    alertSystem.sendStatusUpdateToUser(allComplaints.find(c => c.key === key), status);
                }
                
                showMessage('تم تحديث حالة الشكوى ودرجة الأهمية بنجاح', 'success');
                loadComplaints();
            } catch (err) {
                console.error(err);
                showMessage('حدث خطأ أثناء تحديث الحالة', 'error');
            }
        }

        async function sendReply(key) {
            const textarea = document.getElementById('replyMessage');
            const message = textarea.value.trim();
            if (!message) {
                showMessage('من فضلك اكتب نص الرد أولاً', 'error');
                return;
            }

            const timestamp = new Date().toISOString();
            const responseKey = `response_${timestamp.replace(/[^0-9]/g, '')}`;
            const data = {
                message,
                senderName: 'المكتب الخدمي للنائب أحمد الحديدي',
                senderRole: 'admin',
                timestamp: timestamp
            };

            try {
                await database.ref(`complaints/${key}/responses/${responseKey}`).set(data);
                await database.ref(`complaints/${key}`).update({
                    updatedAt: timestamp,
                    status: 'تم الرد'
                });
                
                // تسجيل عملية الرد
                auditHandler.logAction('reply', 
                    `إرسال رد على الشكوى`, 
                    allComplaints.find(c => c.key === key)?.complaintNumber);
                
                textarea.value = '';
                showMessage('تم إرسال الرد بنجاح', 'success');
                viewComplaint(key);
            } catch (err) {
                console.error(err);
                showMessage('حدث خطأ أثناء إرسال الرد', 'error');
            }
        }

        async function deleteComplaint(key) {
            // التحقق مما إذا كان المستخدم الحالي هو المسؤول 742018
            if (!currentUser || currentUser.username !== 'admin' || currentUser.role !== 'admin') {
                showMessage('⛔ غير مصرح لك بحذف الشكاوى', 'error');
                return;
            }
            
            const complaint = allComplaints.find(c => c.key === key);
            if (!complaint) return;
            
            if (!confirm(`هل أنت متأكد من حذف الشكوى ${complaint.complaintNumber}؟`)) return;
            
            try {
                await database.ref(`complaints/${key}`).remove();
                
                // تسجيل عملية الحذف
                auditHandler.logAction('delete', 
                    `حذف الشكوى ${complaint.complaintNumber}`, 
                    complaint.complaintNumber);
                
                showMessage('تم حذف الشكوى بنجاح', 'success');
                closeComplaintModal();
            } catch (err) {
                console.error(err);
                showMessage('حدث خطأ أثناء حذف الشكوى', 'error');
            }
        }

        function getComplaintField(c, field) {
            switch (field) {
                case 'country':
                    return c.country || c.countryName || c.residence || c.localUnit || '-';
                case 'governorate':
                    return 'الدقهلية';
                case 'city':
                    return c.city || c.localUnit || '-';
                case 'address':
                    return c.address || c.fullAddress || '-';
                case 'phone':
                    return c.phone1 || c.phone || '-';
                case 'phone2':
                    return c.phone2 || '-';
                case 'email':
                    return c.email || '-';
                default:
                    return '-';
            }
        }

        async function downloadComplaintPDF(complaintKey) {
            const complaint = allComplaints.find(c => c.key === complaintKey);
            if (!complaint) return;

            try {
                showLoading();

                const priority = complaint.priority || complaint.problemType || 'عادية';
                const complaintDirectLink = `https://mohamednasr5.github.io/shakawa/?id=${complaint.complaintNumber}`;

                const encodedLink = encodeURIComponent(complaintDirectLink);
                const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodedLink}`;

                // تحميل صورة QR code بشكل صحيح
                const response = await fetch(qrCodeUrl);
                const blob = await response.blob();
                const reader = new FileReader();
                
                reader.onload = function() {
                    const qrCodeDataUrl = reader.result;
                    
                    const htmlContent = `
                        <!DOCTYPE html>
                        <html dir="rtl">
                        <head>
                            <meta charset="UTF-8">
                            <title>تقرير الشكوى - ${complaint.complaintNumber}</title>
                            <style>
                                body { 
                                    font-family: 'Cairo', sans-serif; 
                                    padding: 20px; 
                                    color: #333; 
                                    max-width: 100%;
                                }
                                .header { 
                                    text-align: center; 
                                    margin-bottom: 30px; 
                                    border: 3px solid #000; 
                                    padding: 25px; 
                                    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                                    border-radius: 10px;
                                    position: relative;
                                }
                                .header h1 { 
                                    color: #000; 
                                    margin-bottom: 15px; 
                                    font-size: 28px;
                                    font-weight: bold;
                                }
                                .complaint-number-display {
                                    font-size: 26px;
                                    color: #000;
                                    font-weight: bold;
                                    margin: 15px 0;
                                    letter-spacing: 2px;
                                }
                                .qrcode-container {
                                    background: #fff;
                                    padding: 20px;
                                    border-radius: 10px;
                                    margin: 20px auto;
                                    display: inline-block;
                                    border: 3px solid #000;
                                    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                                }
                                .qrcode-container img {
                                    display: block;
                                    width: 200px;
                                    height: 200px;
                                    margin: 0 auto;
                                    max-width: 100%;
                                }
                                .qrcode-label {
                                    color: #000;
                                    font-size: 13px;
                                    margin-top: 12px;
                                    font-weight: bold;
                                    text-align: center;
                                    line-height: 1.5;
                                }
                                .print-date {
                                    color: #666;
                                    font-size: 12px;
                                    margin-top: 15px;
                                }
                                .info-table { 
                                    width: 100%; 
                                    border-collapse: collapse; 
                                    margin-bottom: 20px; 
                                }
                                .info-table td { 
                                    padding: 10px; 
                                    border: 1px solid #ddd; 
                                }
                                .info-table .label { 
                                    background: #f8f9fa; 
                                    font-weight: bold; 
                                    width: 30%; 
                                }
                                .details { 
                                    background: #f8f9fa; 
                                    padding: 15px; 
                                    border-radius: 8px; 
                                    margin: 20px 0; 
                                    border-right: 4px solid #1a5fb4; 
                                }
                                .response { 
                                    padding: 15px; 
                                    border-radius: 8px; 
                                    margin: 10px 0; 
                                }
                                .footer { 
                                    margin-top: 40px; 
                                    text-align: center; 
                                    color: #666; 
                                    font-size: 12px; 
                                    border-top: 1px solid #ddd; 
                                    padding-top: 15px; 
                                }
                                @media print {
                                    body { padding: 0; }
                                    .header {
                                        -webkit-print-color-adjust: exact;
                                        print-color-adjust: exact;
                                        break-inside: avoid;
                                    }
                                    .qrcode-container img {
                                        -webkit-print-color-adjust: exact;
                                        print-color-adjust: exact;
                                    }
                                    .info-table, .details, .response {
                                        break-inside: avoid;
                                    }
                                }
                            </style>
                        </head>
                        <body>
                            <div class="header">
                                <h1>🏛️ نظام الشكاوى الموحد - الإدارة</h1>
                                <div class="complaint-number-display">رقم الطلب: ${complaint.complaintNumber}</div>

                                <div class="qrcode-container">
                                    <img src="${qrCodeDataUrl}" alt="QR Code">
                                    <div class="qrcode-label">
                                        📱 للوصول المباشر للطلب<br>
                                        ${complaintDirectLink}
                                    </div>
                                </div>

                                <p class="print-date">تاريخ الطباعة: ${new Date().toLocaleString('ar-EG')}</p>
                            </div>

                            <table class="info-table">
                                <tr><td class="label">رقم الشكوى</td><td>${complaint.complaintNumber || '-'}</td></tr>
                                <tr><td class="label">الاسم الكامل</td><td>${complaint.fullName || '-'}</td></tr>
                                <tr><td class="label">الرقم القومي</td><td>${complaint.nationalId || '-'}</td></tr>
                                <tr><td class="label">بلد الإقامة</td><td>${getComplaintField(complaint, 'country')}</td></tr>
                                <tr><td class="label">المحافظة</td><td>${getComplaintField(complaint, 'governorate')}</td></tr>
                                <tr><td class="label">المدينة</td><td>${getComplaintField(complaint, 'city')}</td></tr>
                                <tr><td class="label">العنوان</td><td>${getComplaintField(complaint, 'address')}</td></tr>
                                <tr><td class="label">رقم الهاتف 1</td><td>${getComplaintField(complaint, 'phone')}</td></tr>
                                <tr><td class="label">رقم الهاتف 2</td><td>${getComplaintField(complaint, 'phone2')}</td></tr>
                                <tr><td class="label">البريد الإلكتروني</td><td>${getComplaintField(complaint, 'email')}</td></tr>
                                <tr><td class="label">القسم المختص</td><td>${complaint.department || '-'}</td></tr>
                                <tr><td class="label">الأولوية</td><td>${priority}</td></tr>
                                <tr><td class="label">نوع المشكلة</td><td>${complaint.problemType || '-'}</td></tr>
                                <tr><td class="label">حالة الشكوى</td><td>${complaint.status || '-'}</td></tr>
                                <tr><td class="label">تاريخ التقديم</td><td>${complaint.createdAt ? new Date(complaint.createdAt).toLocaleString('ar-EG') : '-'}</td></tr>
                                <tr><td class="label">آخر تحديث</td><td>${complaint.updatedAt ? new Date(complaint.updatedAt).toLocaleString('ar-EG') : '-'}</td></tr>
                            </table>

                            <h3>📝 تفاصيل المشكلة</h3>
                            <div class="details">${complaint.problemDetails || '-'}</div>

                            ${complaint.responses && Object.keys(complaint.responses).length > 0 ? `
                                <h3>💬 الردود والمتابعات</h3>
                                ${Object.values(complaint.responses)
                                    .sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp))
                                    .map(response => {
                                        const isAdmin = response.senderRole === 'admin';
                                        const date = new Date(response.timestamp).toLocaleString('ar-EG');
                                        const senderName = isAdmin ? response.senderName : complaint.fullName;
                                        return `
                                            <div class="response" style="border-right: 4px solid ${isAdmin ? '#28a745' : '#3498db'}; background: ${isAdmin ? '#d4edda' : '#e3f2fd'};">
                                                <div style="display:flex;justify-content:space-between;">
                                                    <strong>${senderName}</strong>
                                                    <small>${date}</small>
                                                </div>
                                                <div style="margin-top:5px;">${response.message}</div>
                                            </div>
                                        `;
                                    }).join('')}
                            ` : ''}

                            <div class="footer">
                                <p>© 2026 نظام الشكاوى الموحد - الإدارة</p>
                                <p>تم الإنشاء بواسطة: <strong>Mohamed Nasr</strong></p>
                                <p style="margin-top: 10px; font-size: 10px; word-break: break-all;">
                                    الرابط المباشر: ${complaintDirectLink}
                                </p>
                            </div>
                        </body>
                        </html>
                    `;

                    const printWindow = window.open('', '_blank');
                    if (!printWindow) {
                        showMessage('يرجى السماح بالنوافذ المنبثقة', 'error');
                        return;
                    }

                    printWindow.document.write(htmlContent);
                    printWindow.document.close();

                    // إضافة script للطباعة بعد تحميل الصور
                    printWindow.onload = function() {
                        setTimeout(() => {
                            printWindow.print();
                        }, 1000);
                    };
                };
                
                reader.readAsDataURL(blob);
                
                // تسجيل عملية التصدير
                auditHandler.logAction('export', 
                    `تصدير ملف PDF للشكوى ${complaint.complaintNumber}`, 
                    complaint.complaintNumber);
                
                showMessage('تم تحضير PDF بنجاح', 'success');

            } catch (err) {
                console.error(err);
                showMessage('حدث خطأ أثناء إنشاء ملف PDF', 'error');
            } finally {
                hideLoading();
            }
        }

        function exportToExcel() {
            if (!allComplaints.length) {
                showMessage('لا توجد بيانات لتصديرها', 'error');
                return;
            }

            const data = allComplaints.map(c => ({
                'رقم الشكوى': c.complaintNumber || '',
                'الاسم بالكامل': c.fullName || '',
                'القسم': c.department || '',
                'درجة الأهمية': c.priority || c.problemType || 'عادية',
                'الحالة': c.status || 'جديدة',
                'تاريخ الإرسال': c.createdAt
                    ? new Date(c.createdAt).toLocaleString('ar-EG')
                    : ''
            }));

            const worksheet = XLSX.utils.json_to_sheet(data);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'الشكاوى');

            XLSX.writeFile(workbook, 'complaints.xlsx');
            
            // تسجيل عملية التصدير
            auditHandler.logAction('export', 'تصدير جميع الشكاوى إلى Excel');
            
            showMessage('تم بدء تنزيل ملف Excel', 'success');
        }

        // ==================== دوال النسخ الاحتياطي والاستعادة ====================

        async function createBackup() {
            showLoading();
            try {
                const [complaintsSnapshot, usersSnapshot, departmentsSnapshot, settingsSnapshot] = await Promise.all([
                    database.ref('complaints').once('value'),
                    database.ref('users').once('value'),
                    database.ref('departments').once('value'),
                    database.ref('settings').once('value')
                ]);

                const backupData = {
                    metadata: {
                        version: "2.0",
                        created: new Date().toISOString(),
                        totalRecords: {
                            complaints: Object.keys(complaintsSnapshot.val() || {}).length,
                            users: Object.keys(usersSnapshot.val() || {}).length,
                            departments: Object.keys(departmentsSnapshot.val() || {}).length
                        },
                        firebaseConfig: {
                            ...firebaseConfig,
                            apiKey: "HIDDEN_FOR_SECURITY",
                            authDomain: firebaseConfig.authDomain,
                            databaseURL: firebaseConfig.databaseURL
                        }
                    },
                    complaints: complaintsSnapshot.val() || {},
                    users: usersSnapshot.val() || {},
                    departments: departmentsSnapshot.val() || {},
                    settings: settingsSnapshot.val() || {}
                };

                const jsonString = JSON.stringify(backupData, null, 2);
                
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                a.download = `firebase-backup-${timestamp}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                // تسجيل عملية النسخ الاحتياطي
                auditHandler.logAction('backup', 'إنشاء نسخة احتياطية كاملة');
                
                showMessage('تم إنشاء النسخة الاحتياطية بنجاح', 'success');
                
                try {
                    const backupLog = {
                        timestamp: new Date().toISOString(),
                        type: "manual",
                        fileSize: blob.size,
                        recordCount: backupData.metadata.totalRecords
                    };
                    
                    await database.ref('backupLogs').push(backupLog);
                } catch (logError) {
                    console.log('Could not save backup log:', logError);
                }
                
            } catch (error) {
                console.error('Error creating backup:', error);
                showMessage('حدث خطأ أثناء إنشاء النسخة الاحتياطية', 'error');
            } finally {
                hideLoading();
            }
        }

        async function restoreBackup() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                if (!confirm('⚠️ تحذير هام: استعادة النسخة الاحتياطية ستحذف جميع البيانات الحالية وتستبدلها بالبيانات من الملف. هل أنت متأكد من المتابعة؟')) {
                    return;
                }
                
                if (!confirm('⚠️ هل أنت متأكد تماماً؟ هذه العملية لا يمكن التراجع عنها!')) {
                    return;
                }
                
                showLoading();
                
                try {
                    const reader = new FileReader();
                    
                    reader.onload = async (event) => {
                        try {
                            const backupData = JSON.parse(event.target.result);
                            
                            if (!backupData.metadata || !backupData.metadata.version) {
                                throw new Error('ملف النسخة الاحتياطية غير صالح أو تالف');
                            }
                            
                            if (!backupData.metadata.version.startsWith('2.')) {
                                if (!confirm('⚠️ ملف النسخة الاحتياطية من إصدار قديم. قد تحدث مشاكل في التوافق. هل تريد المتابعة؟')) {
                                    hideLoading();
                                    return;
                                }
                            }
                            
                            const summary = `
                            ملخص النسخة الاحتياطية:
                            - الشكاوى: ${backupData.metadata.totalRecords?.complaints || 0}
                            - المستخدمين: ${backupData.metadata.totalRecords?.users || 0}
                            - الأقسام: ${backupData.metadata.totalRecords?.departments || 0}
                            - تاريخ الإنشاء: ${new Date(backupData.metadata.created).toLocaleString('ar-EG')}
                            `;
                            
                            if (!confirm(`${summary}\n\nهل تريد متابعة الاستعادة؟`)) {
                                hideLoading();
                                return;
                            }
                            
                            await database.ref().set(null);
                            
                            showMessage('جاري استعادة البيانات...', 'success');
                            
                            const restorePromises = [];
                            
                            if (backupData.complaints && Object.keys(backupData.complaints).length > 0) {
                                restorePromises.push(database.ref('complaints').set(backupData.complaints));
                            } else {
                                restorePromises.push(database.ref('complaints').set({}));
                            }
                            
                            if (backupData.users && Object.keys(backupData.users).length > 0) {
                                restorePromises.push(database.ref('users').set(backupData.users));
                            } else {
                                restorePromises.push(database.ref('users').set({}));
                            }
                            
                            if (backupData.departments && Object.keys(backupData.departments).length > 0) {
                                restorePromises.push(database.ref('departments').set(backupData.departments));
                            } else {
                                restorePromises.push(database.ref('departments').set({}));
                            }
                            
                            if (backupData.settings && Object.keys(backupData.settings).length > 0) {
                                restorePromises.push(database.ref('settings').set(backupData.settings));
                            } else {
                                restorePromises.push(database.ref('settings').set({}));
                            }
                            
                            await Promise.all(restorePromises);
                            
                            // تسجيل عملية الاستعادة
                            auditHandler.logAction('restore', 'استعادة نسخة احتياطية كاملة');
                            
                            showMessage('✅ تم استعادة البيانات بنجاح! سيتم إعادة تحميل الصفحة...', 'success');
                            
                            try {
                                const restoreLog = {
                                    timestamp: new Date().toISOString(),
                                    type: "restore",
                                    fileName: file.name,
                                    fileSize: file.size,
                                    recordCount: backupData.metadata.totalRecords
                                };
                                
                                await database.ref('restoreLogs').push(restoreLog);
                            } catch (logError) {
                                console.log('Could not save restore log:', logError);
                            }
                            
                            setTimeout(() => {
                                window.location.reload();
                            }, 2000);
                            
                        } catch (error) {
                            console.error('Error restoring backup:', error);
                            showMessage('حدث خطأ أثناء استعادة البيانات: ' + error.message, 'error');
                        } finally {
                            hideLoading();
                        }
                    };
                    
                    reader.readAsText(file);
                } catch (error) {
                    console.error('Error reading file:', error);
                    showMessage('حدث خطأ أثناء قراءة الملف', 'error');
                    hideLoading();
                }
            };
            
            input.click();
        }

        // ==================== دوال المستخدمين ====================

        function openAddUserModal() {
            currentEditingUser = null;
            document.getElementById('userModalTitle').textContent = 'إضافة مستخدم جديد';
            document.getElementById('userName').value = '';
            document.getElementById('userUsername').value = '';
            document.getElementById('userEmail').value = '';
            document.getElementById('userPassword').value = '';
            document.getElementById('userRole').value = 'user';
            
            document.querySelectorAll('.user-dept-checkbox').forEach(cb => {
                cb.checked = false;
            });
            
            document.getElementById('userModal').style.display = 'flex';
        }

        function closeUserModal() {
            document.getElementById('userModal').style.display = 'none';
            currentEditingUser = null;
        }

        function editUser(key) {
            const user = allUsers.find(u => u.key === key);
            if (!user) return;
            
            currentEditingUser = user;
            document.getElementById('userModalTitle').textContent = 'تعديل بيانات المستخدم';
            document.getElementById('userName').value = user.name || '';
            document.getElementById('userUsername').value = user.username || '';
            document.getElementById('userEmail').value = user.email || '';
            document.getElementById('userPassword').value = '';
            document.getElementById('userRole').value = user.role || 'user';
            
            document.querySelectorAll('.user-dept-checkbox').forEach(cb => {
                const deptName = cb.value;
                cb.checked = user.departments && user.departments.includes(deptName);
            });
            
            document.getElementById('userModal').style.display = 'flex';
        }

        async function saveUser() {
            const name = document.getElementById('userName').value.trim();
            const username = document.getElementById('userUsername').value.trim();
            const email = document.getElementById('userEmail').value.trim();
            const password = document.getElementById('userPassword').value;
            const role = document.getElementById('userRole').value;

            if (!name || !username || !email) {
                showMessage('من فضلك أكمل جميع الحقول الأساسية', 'error');
                return;
            }

            if (!currentEditingUser) {
                const existingUser = allUsers.find(u => u.username === username);
                if (existingUser) {
                    showMessage('اسم المستخدم هذا موجود بالفعل', 'error');
                    return;
                }
            }

            const departments = [];
            document.querySelectorAll('.user-dept-checkbox:checked').forEach(ch => {
                departments.push(ch.value);
            });

            const data = {
                name,
                username,
                email,
                role,
                departments
            };

            if (!currentEditingUser && !password) {
                showMessage('من فضلك أدخل كلمة مرور للمستخدم الجديد', 'error');
                return;
            }

            if (password) data.password = password;

            try {
                if (currentEditingUser) {
                    await database.ref(`users/${currentEditingUser.key}`).update(data);
                    
                    // تسجيل عملية التحديث
                    auditHandler.logAction('update', `تحديث بيانات المستخدم: ${name}`);
                    
                    showMessage('تم تحديث بيانات المستخدم', 'success');
                } else {
                    const newRef = database.ref('users').push();
                    await newRef.set(data);
                    
                    // تسجيل عملية الإنشاء
                    auditHandler.logAction('create', `إضافة مستخدم جديد: ${name}`);
                    
                    showMessage('تم إضافة المستخدم بنجاح', 'success');
                }
                closeUserModal();
                loadUsers();
            } catch (err) {
                console.error(err);
                showMessage('حدث خطأ أثناء حفظ بيانات المستخدم', 'error');
            }
        }

        async function deleteUser(key) {
            const user = allUsers.find(u => u.key === key);
            if (!user) return;
            
            if (!confirm('هل أنت متأكد من حذف هذا المستخدم؟')) return;
            try {
                await database.ref(`users/${key}`).remove();
                
                // تسجيل عملية الحذف
                auditHandler.logAction('delete', `حذف المستخدم: ${user.name}`);
                
                showMessage('تم حذف المستخدم بنجاح', 'success');
                loadUsers();
            } catch (err) {
                console.error(err);
                showMessage('حدث خطأ أثناء حذف المستخدم', 'error');
            }
        }

        // ==================== دوال الإعدادات ====================

        function saveSettings() {
            const systemName = document.getElementById('systemName').value.trim();
            const systemDescription = document.getElementById('systemDescription').value.trim();
            const enableNotifications = document.getElementById('enableNotifications').checked;

            const data = {
                systemName: systemName || 'نظام الشكاوى الموحد',
                systemDescription: systemDescription || 'خدمة إلكترونية متطورة لتقديم الشكاوى والمشكلات ومتابعتها بكل سهولة',
                enableNotifications
            };

            database.ref('settings').set(data)
                .then(() => {
                    settings = data;
                    document.querySelector('.logo').textContent = data.systemName;
                    document.querySelector('.subtitle').textContent = data.systemDescription;
                    
                    // تسجيل عملية حفظ الإعدادات
                    auditHandler.logAction('update', 'تحديث إعدادات النظام العامة');
                    
                    showMessage('تم حفظ الإعدادات بنجاح', 'success');
                })
                .catch(() => {
                    showMessage('حدث خطأ أثناء حفظ الإعدادات', 'error');
                });
        }

        function saveAlertSettings() {
            const alertSettings = {
                newComplaints: document.getElementById('alertNewComplaints').checked,
                pendingReminders: document.getElementById('alertPendingReminders').checked,
                slaOverdue: document.getElementById('alertSLAOverdue').checked,
                statusUpdate: document.getElementById('alertStatusUpdate').checked,
                soundEnabled: document.getElementById('alertSoundEnabled').checked,
                dailyReminderTime: document.getElementById('dailyReminderTime').value,
                updatedAt: new Date().toISOString()
            };
            
            database.ref('alertSettings').set(alertSettings)
                .then(() => {
                    // تسجيل عملية حفظ الإعدادات
                    auditHandler.logAction('update', 'تحديث إعدادات التنبيهات والتذكيرات');
                    
                    showMessage('تم حفظ إعدادات التنبيهات بنجاح', 'success');
                })
                .catch(() => {
                    showMessage('حدث خطأ أثناء حفظ إعدادات التنبيهات', 'error');
                });
        }
        
        function savePrioritySettings() {
            const prioritySettings = {
                autoUpdate: document.getElementById('priorityAutoUpdate').checked,
                autoEscalation: document.getElementById('priorityAutoEscalation').checked,
                normalToImportant: parseInt(document.getElementById('priorityNormalToImportant').value) || 48,
                importantToUrgent: parseInt(document.getElementById('priorityImportantToUrgent').value) || 24,
                updatedAt: new Date().toISOString()
            };
            
            database.ref('prioritySettings').set(prioritySettings)
                .then(() => {
                    // تسجيل عملية حفظ الإعدادات
                    auditHandler.logAction('update', 'تحديث إعدادات نظام الأولويات');
                    
                    showMessage('تم حفظ إعدادات الأولويات بنجاح', 'success');
                })
                .catch(() => {
                    showMessage('حدث خطأ أثناء حفظ إعدادات الأولويات', 'error');
                });
        }

        function requestNotificationPermission() {
            if (!('Notification' in window)) {
                showMessage('المتصفح لا يدعم الإشعارات', 'error');
                return;
            }

            if (Notification.permission === 'granted') {
                showMessage('الإشعارات مفعلة بالفعل', 'success');
                return;
            }

            if (Notification.permission === 'denied') {
                showMessage('تم رفض الإشعارات. يمكنك تفعيلها من إعدادات المتصفح', 'error');
                return;
            }

            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    showMessage('تم تفعيل الإشعارات بنجاح', 'success');
                }
            });
        }
        
        function showNotificationSettings() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                padding: 20px;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 15px; padding: 25px; max-width: 500px; width: 100%; max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: #2c3e50;">إعدادات التنبيهات والتذكيرات</h3>
                        <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 24px; color: #666; cursor: pointer;">×</button>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <p style="color: #666; margin-bottom: 15px;">تساعدك التنبيهات على متابعة الشكاوى بشكل أفضل:</p>
                        
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                            <span>🔔 تنبيهات الشكاوى الجديدة</span>
                            <label class="toggle-switch">
                                <input type="checkbox" ${document.getElementById('alertNewComplaints')?.checked ? 'checked' : ''} id="modalNewAlerts">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                            <span>⏰ تذكير الشكاوى المعلقة</span>
                            <label class="toggle-switch">
                                <input type="checkbox" ${document.getElementById('alertPendingReminders')?.checked ? 'checked' : ''} id="modalPendingAlerts">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                            <span>🚨 تنبيهات تجاوز SLA</span>
                            <label class="toggle-switch">
                                <input type="checkbox" ${document.getElementById('alertSLAOverdue')?.checked ? 'checked' : ''} id="modalSLAAlerts">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                            <span>🔊 التنبيهات الصوتية</span>
                            <label class="toggle-switch">
                                <input type="checkbox" ${document.getElementById('alertSoundEnabled')?.checked ? 'checked' : ''} id="modalSoundAlerts">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button onclick="
                            document.getElementById('alertNewComplaints').checked = document.getElementById('modalNewAlerts').checked;
                            document.getElementById('alertPendingReminders').checked = document.getElementById('modalPendingAlerts').checked;
                            document.getElementById('alertSLAOverdue').checked = document.getElementById('modalSLAAlerts').checked;
                            document.getElementById('alertSoundEnabled').checked = document.getElementById('modalSoundAlerts').checked;
                            saveAlertSettings();
                            this.parentElement.parentElement.remove();
                        " 
                                style="flex: 1; padding: 12px; background: #1a5fb4; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                            <i class="fas fa-save"></i> حفظ
                        </button>
                        <button onclick="this.parentElement.parentElement.remove()" 
                                style="flex: 1; padding: 12px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            <i class="fas fa-times"></i> إغلاق
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // ==================== دوال الأقسام ====================

        async function addDepartment() {
            const name = document.getElementById('newDepartmentName').value.trim();
            if (!name) {
                showMessage('من فضلك أدخل اسم القسم', 'error');
                return;
            }

            try {
                const newRef = database.ref('departments').push();
                await newRef.set({ name });
                
                // تسجيل عملية الإضافة
                auditHandler.logAction('create', `إضافة قسم جديد: ${name}`);
                
                document.getElementById('newDepartmentName').value = '';
                showMessage('تم إضافة القسم بنجاح', 'success');
                loadDepartments();
            } catch (err) {
                console.error(err);
                showMessage('حدث خطأ أثناء إضافة القسم', 'error');
            }
        }

        async function deleteDepartment(key) {
            if (!key) {
                showMessage('لا يمكن حذف هذا القسم', 'error');
                return;
            }
            
            const department = allDepartments.find(d => d.key === key);
            if (!department) return;
            
            if (!confirm('هل أنت متأكد من حذف هذا القسم؟')) return;

            try {
                await database.ref(`departments/${key}`).remove();
                
                // تسجيل عملية الحذف
                auditHandler.logAction('delete', `حذف قسم: ${department.name}`);
                
                showMessage('تم حذف القسم بنجاح', 'success');
                loadDepartments();
            } catch (err) {
                console.error(err);
                showMessage('حدث خطأ أثناء حذف القسم', 'error');
            }
        }

        // ==================== تهيئة التطبيق ====================

        window.onload = function() {
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const username = document.getElementById('username').value.trim();
                    const password = document.getElementById('password').value;
                    handleLogin(username, password);
                });
            }

            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', logout);
            }

            // القائمة الجانبية
            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', function() {
                    const section = this.getAttribute('data-section');
                    showSection(section);
                });
            });

            // القائمة السفلية للهواتف
            document.querySelectorAll('.mobile-nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    const section = this.getAttribute('data-section');
                    showSection(section);
                });
            });

            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            const closeSidebarBtn = document.getElementById('closeSidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');

            if (mobileMenuBtn) {
                mobileMenuBtn.addEventListener('click', toggleSidebar);
            }
            if (closeSidebarBtn) {
                closeSidebarBtn.addEventListener('click', toggleSidebar);
            }
            if (sidebarOverlay) {
                sidebarOverlay.addEventListener('click', toggleSidebar);
            }

            const searchInput = document.getElementById('searchComplaints');
            const filterDepartment = document.getElementById('filterDepartment');
            const filterStatus = document.getElementById('filterStatus');
            const filterPriority = document.getElementById('filterPriority');
            const filterDateFrom = document.getElementById('filterDateFrom');
            const filterDateTo = document.getElementById('filterDateTo');

            if (searchInput) {
                searchInput.addEventListener('input', filterComplaints);
            }
            if (filterDepartment) {
                filterDepartment.addEventListener('change', filterComplaints);
            }
            if (filterStatus) {
                filterStatus.addEventListener('change', filterComplaints);
            }
            if (filterPriority) {
                filterPriority.addEventListener('change', filterComplaints);
            }
            if (filterDateFrom) {
                filterDateFrom.addEventListener('change', filterComplaints);
            }
            if (filterDateTo) {
                filterDateTo.addEventListener('change', filterComplaints);
            }

            initAuth();
            
            // إضافة وظائف إضافية إلى كائن complaintHandler
            complaintHandler.useTemplateInReply = function(complaintKey) {
                const templateModal = document.createElement('div');
                templateModal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0,0,0,0.8);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 11000;
                    padding: 20px;
                `;
                
                // عرض قائمة القوالب
                let templatesList = '';
                templatesHandler.templates.forEach(template => {
                    templatesList += `
                        <div style="padding: 10px; margin-bottom: 10px; background: #f8f9fa; border-radius: 8px; cursor: pointer;"
                             onclick="
                                const complaint = allComplaints.find(c => c.key === '${complaintKey}');
                                const processed = templatesHandler.processTemplate(${JSON.stringify(template)}, {
                                    customerName: complaint?.fullName || 'عميلنا الكريم',
                                    complaintNumber: complaint?.complaintNumber || '',
                                    department: complaint?.department || '',
                                    problem: complaint?.problemType || ''
                                });
                                document.getElementById('replyMessage').value = processed;
                                this.parentElement.parentElement.remove();
                             ">
                            <div style="font-weight: bold; color: #333;">${template.name}</div>
                            <div style="font-size: 0.85rem; color: #666;">${template.content.substring(0, 80)}...</div>
                        </div>
                    `;
                });
                
                templateModal.innerHTML = `
                    <div style="background: white; border-radius: 15px; padding: 25px; max-width: 600px; width: 100%; max-height: 70vh; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="color: #2c3e50;">اختر قالب للرد</h3>
                            <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 24px; color: #666; cursor: pointer;">×</button>
                        </div>
                        
                        <div style="margin-bottom: 20px; max-height: 50vh; overflow-y: auto;">
                            ${templatesList || '<p style="text-align:center;color:#666;padding:20px;">لا توجد قوالب متاحة</p>'}
                        </div>
                    </div>
                `;
                
                document.body.appendChild(templateModal);
            };
            
            complaintHandler.showTemplateMenu = function(complaintKey) {
                const quickReplies = [
                    {
                        name: 'طلب معلومات إضافية',
                        content: 'تحية طيبة،\n\nنحتاج بعض المعلومات الإضافية للتعامل مع شكواك:\n1. \n2. \n3. \n\nنرجو تزويدنا بهذه المعلومات عند الإمكان.\n\nشكراً لتفهمك.'
                    },
                    {
                        name: 'تأكيد الاستلام',
                        content: 'تحية طيبة،\n\nتم استلام شكواك بنجاح وسيتم مراجعتها من قبل الفريق المختص. سنقوم بالتواصل معك قريباً لمتابعة الموضوع.\n\nشكراً لتواصلك معنا.'
                    },
                    {
                        name: 'طلب الانتظار',
                        content: 'تحية طيبة،\n\nنشكرك على تواصلك معنا. نعمل حالياً على دراسة شكواك وسنقوم بالرد عليك في أقرب وقت ممكن. نرجو منك الانتظار.\n\nشكراً لصبرك وتفهمك.'
                    },
                    {
                        name: 'حل المشكلة',
                        content: 'تحية طيبة،\n\nيسعدنا إعلامك أنه تم حل المشكلة المذكورة في شكواك. إذا كان لديك أي استفسارات أخرى، فلا تتردد في التواصل معنا.\n\nشكراً لثقتك بنا.'
                    }
                ];
                
                const quickModal = document.createElement('div');
                quickModal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0,0,0,0.8);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 11000;
                    padding: 20px;
                `;
                
                let quickList = '';
                quickReplies.forEach(reply => {
                    quickList += `
                        <div style="padding: 10px; margin-bottom: 10px; background: #f8f9fa; border-radius: 8px; cursor: pointer;"
                             onclick="
                                document.getElementById('replyMessage').value = '${reply.content.replace(/'/g, "\\'")}';
                                this.parentElement.parentElement.remove();
                             ">
                            <div style="font-weight: bold; color: #333;">${reply.name}</div>
                        </div>
                    `;
                });
                
                quickModal.innerHTML = `
                    <div style="background: white; border-radius: 15px; padding: 25px; max-width: 400px; width: 100%;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="color: #2c3e50;">ردود سريعة</h3>
                            <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 24px; color: #666; cursor: pointer;">×</button>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            ${quickList}
                        </div>
                    </div>
                `;
                
                document.body.appendChild(quickModal);
            };
        };

        window.onclick = function(event) {
            const complaintModal = document.getElementById('complaintModal');
            const userModal = document.getElementById('userModal');
            const templateModal = document.getElementById('templateModal');
            const taskModal = document.getElementById('taskModal');
            
            if (event.target === complaintModal) {
                closeComplaintModal();
            }
            if (event.target === userModal) {
                closeUserModal();
            }
            if (event.target === templateModal) {
                templatesHandler.closeTemplateModal();
            }
            if (event.target === taskModal) {
                tasksHandler.closeTaskModal();
            }
        };
    </script>
</body>
</html>
