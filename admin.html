<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>لوحة التحكم - نظام الشكاوى الموحد</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        *{box-sizing:border-box;margin:0;padding:0;font-family:'Cairo',sans-serif;-webkit-tap-highlight-color:transparent}
        html{font-size:16px;scroll-behavior:smooth}
        body{background:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%);color:#333;line-height:1.6;min-height:100vh;overflow-x:hidden;padding-bottom:80px}
        .container{max-width:1400px;margin:0 auto;padding:15px}
        .login-container{display:flex;justify-content:center;align-items:center;min-height:100vh;padding:20px;background:linear-gradient(135deg,#1a5fb4 0%,#2d8fd5 100%)}
        .login-box{background:#fff;border-radius:20px;padding:30px 25px;width:100%;max-width:400px;box-shadow:0 20px 40px rgba(0,0,0,.2);text-align:center;animation:slideUp .5s ease}
        @keyframes slideUp{from{opacity:0;transform:translateY(50px)}to{opacity:1;transform:translateY(0)}}
        .login-logo{font-size:3rem;color:#1a5fb4;margin-bottom:15px}
        .login-title{font-size:1.6rem;color:#2c3e50;margin-bottom:25px;font-weight:700}
        .login-form .form-group{margin-bottom:20px;text-align:right}
        .login-form .form-label{display:block;margin-bottom:8px;font-weight:600;color:#2c3e50;font-size:1rem}
        .login-form .form-control{width:100%;padding:16px 15px;border:2px solid #ddd;border-radius:10px;font-size:16px;transition:all .3s;background:#f8f9fa}
        .login-form .form-control:focus{border-color:#1a5fb4;outline:none;box-shadow:0 0 0 3px rgba(26,95,180,.1);background:#fff}
        .login-btn{width:100%;padding:18px;background:linear-gradient(to right,#1a5fb4,#2d8fd5);color:#fff;border:none;border-radius:10px;font-size:18px;font-weight:700;cursor:pointer;transition:all .3s;display:flex;align-items:center;justify-content:center;gap:10px;margin-top:10px}
        .login-btn:hover{background:linear-gradient(to right,#155093,#1a5fb4);transform:translateY(-2px);box-shadow:0 10px 20px rgba(0,0,0,.15)}
        .login-error{color:#e74c3c;margin-top:15px;padding:15px;background:#fde8e8;border-radius:10px;display:none;font-size:.95rem}
        header{background:linear-gradient(135deg,#1a5fb4 0%,#2d8fd5 100%);color:#fff;padding:20px 0 25px;text-align:center;border-radius:0 0 25px 25px;box-shadow:0 8px 25px rgba(0,0,0,.15);margin-bottom:20px;position:relative;overflow:hidden}
        header::before{content:'';position:absolute;top:0;left:0;right:0;height:5px;background:linear-gradient(90deg,#ff7e5f,#feb47b,#86a8e7,#91eae4);background-size:400% 400%;animation:gradientShift 8s ease infinite}
        @keyframes gradientShift{0%{background-position:0 50%}50%{background-position:100% 50%}100%{background-position:0 50%}}
        .logo{font-size:1.8rem;margin-bottom:8px;text-shadow:2px 2px 4px rgba(0,0,0,.2);padding:0 15px;line-height:1.4}
        .subtitle{font-size:1rem;opacity:.9;max-width:600px;margin:0 auto;padding:0 15px;line-height:1.5}
        .admin-bar{background:linear-gradient(135deg,#2c3e50 0%,#4a6572 100%);color:#fff;padding:15px;border-radius:15px;margin-bottom:20px;box-shadow:0 5px 15px rgba(0,0,0,.1);display:flex;flex-direction:column;gap:15px}
        .admin-info{display:flex;align-items:center;gap:12px}
        .admin-avatar{width:50px;height:50px;border-radius:50%;background:linear-gradient(135deg,#3498db,#2c3e50);display:flex;align-items:center;justify-content:center;font-size:1.4rem;box-shadow:0 4px 10px rgba(0,0,0,.2);flex-shrink:0}
        .admin-text{flex-grow:1;overflow:hidden}
        .admin-text h3{margin-bottom:5px;font-size:1.1rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .admin-text p{opacity:.9;font-size:.85rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .admin-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
        .stat-box{background:rgba(255,255,255,.15);padding:12px 8px;border-radius:10px;text-align:center;backdrop-filter:blur(10px)}
        .stat-value{font-size:1.5rem;font-weight:700;margin-bottom:5px}
        .stat-label{font-size:.8rem;opacity:.9;line-height:1.3}
        .logout-btn{background:#e74c3c;color:#fff;border:none;padding:12px 20px;border-radius:10px;cursor:pointer;font-weight:600;transition:all .3s;display:flex;align-items:center;justify-content:center;gap:8px;font-size:1rem;width:100%}
        .logout-btn:hover{background:#c0392b;transform:translateY(-2px)}
        .dashboard-grid{display:flex;flex-direction:column;gap:20px}
        .sidebar-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);z-index:999;animation:fadeIn .3s ease}
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        .sidebar{background:#fff;border-radius:20px 0 0 20px;padding:25px 20px;box-shadow:0 0 30px rgba(0,0,0,.3);height:100vh;width:280px;position:fixed;top:0;right:-300px;z-index:1000;transition:right .3s ease;overflow-y:auto}
        .sidebar.active{right:0}
        .sidebar-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;padding-bottom:15px;border-bottom:2px solid #f0f0f0}
        .sidebar-title{font-size:1.3rem;color:#2c3e50;font-weight:700}
        .close-sidebar{background:none;border:none;font-size:1.5rem;color:#666;cursor:pointer;padding:5px}
        .sidebar-menu{list-style:none}
        .menu-item{padding:16px 15px;margin-bottom:8px;border-radius:12px;cursor:pointer;transition:all .3s ease;display:flex;align-items:center;gap:12px;color:#555;font-size:1rem}
        .menu-item:hover{background:#f8f9fa;transform:translateX(-5px)}
        .menu-item.active{background:linear-gradient(to right,#1a5fb4,#2d8fd5);color:#fff;box-shadow:0 5px 15px rgba(26,95,180,.3)}
        .menu-icon{font-size:1.2rem;width:24px;text-align:center}
        .badge{background:#e74c3c;color:#fff;border-radius:10px;padding:4px 10px;font-size:.8rem;margin-right:auto;display:none}
        .main-content{background:#fff;border-radius:20px;padding:20px;box-shadow:0 5px 20px rgba(0,0,0,.08);margin-bottom:80px}
        .footer{text-align:center;padding:20px 15px;color:#666;font-size:.9rem;margin-top:30px;background:#fff;border-radius:15px;box-shadow:0 5px 15px rgba(0,0,0,.05);line-height:1.7}
        .footer a{color:#1a5fb4;text-decoration:none;font-weight:700;display:inline-flex;align-items:center;gap:6px}
        .footer a:hover{color:#155093}
        .admin-only{display:none}
        .loading-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,.9);display:none;justify-content:center;align-items:center;z-index:9999}
        .loading-spinner{width:60px;height:60px;border:5px solid #f3f3f3;border-top:5px solid #1a5fb4;border-radius:50%;animation:spin 1s linear infinite}
        @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
        .message{position:fixed;top:20px;right:20px;padding:15px 20px;border-radius:12px;z-index:10000;box-shadow:0 10px 30px rgba(0,0,0,.2);max-width:90%;animation:slideIn .3s ease;font-size:.95rem;line-height:1.5;background:#d4edda;color:#155724}
        .message.error{background:#f8d7da;color:#721c24}
        @keyframes slideIn{from{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:translateY(0)}}
        .complaint-details-modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.9);display:none;justify-content:center;align-items:center;z-index:1100;padding:15px}
        .modal-content{background:#fff;border-radius:20px;width:100%;max-width:500px;max-height:85vh;overflow-y:auto;position:relative;animation:modalSlideUp .3s ease}
        @keyframes modalSlideUp{from{opacity:0;transform:translateY(50px)}to{opacity:1;transform:translateY(0)}}
        .modal-header{background:linear-gradient(135deg,#1a5fb4 0%,#2d8fd5 100%);color:#fff;padding:20px;border-radius:20px 20px 0 0;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:1}
        .modal-title{font-size:1.4rem;font-weight:700}
        .close-modal{background:none;border:none;color:#fff;font-size:2rem;cursor:pointer;line-height:1;padding:5px}
        .modal-body{padding:20px}
        .details-grid{display:grid;grid-template-columns:1fr;gap:15px;margin-bottom:20px}
        .detail-item{padding:15px;border-bottom:1px solid #eee;background:#f8f9fa;border-radius:10px}
        .detail-label{font-weight:700;color:#1a5fb4;margin-bottom:8px;font-size:.95rem}
        .action-btn{padding:8px 12px;border:none;border-radius:8px;cursor:pointer;font-size:.85rem;display:flex;align-items:center;justify-content:center;gap:5px;transition:all .2s ease;min-width:70px}
        .btn-view{background:#3498db;color:#fff}
        .btn-secondary{background:#6c757d;color:#fff}
        
        /* إضافات جديدة */
        .mobile-menu-btn{display:flex;align-items:center;justify-content:center;gap:8px;background:#1a5fb4;color:#fff;border:none;padding:12px 15px;border-radius:10px;cursor:pointer;font-weight:600;margin-bottom:15px;width:100%;display:none}
        .content-section{display:none}
        .content-section.active{display:block}
        .section-header{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:15px;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #f0f0f0}
        .section-title{font-size:1.5rem;color:#2c3e50;font-weight:700}
        .section-controls{display:flex;gap:10px;flex-wrap:wrap}
        .filter-controls{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:20px}
        .filter-group{flex:1;min-width:150px}
        .filter-label{display:block;margin-bottom:5px;font-weight:600;color:#555}
        .filter-select,.filter-input{width:100%;padding:10px;border:2px solid #ddd;border-radius:8px;font-size:.9rem;background:#f8f9fa}
        .cards-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:20px;margin-bottom:30px}
        .card{background:#fff;border-radius:15px;padding:20px;box-shadow:0 5px 15px rgba(0,0,0,.08);transition:all .3s ease;border:1px solid #eee}
        .card:hover{transform:translateY(-5px);box-shadow:0 15px 30px rgba(0,0,0,.15)}
        .card-icon{font-size:2.5rem;margin-bottom:15px;width:60px;height:60px;display:flex;align-items:center;justify-content:center;border-radius:12px}
        .card-title{font-size:1.1rem;color:#2c3e50;margin-bottom:10px;font-weight:600}
        .card-value{font-size:2.2rem;font-weight:700;color:#1a5fb4;margin-bottom:5px}
        .card-label{font-size:.9rem;color:#666}
        .card-trend{font-size:.85rem;margin-top:10px;display:flex;align-items:center;gap:5px}
        .trend-up{color:#27ae60}
        .trend-down{color:#e74c3c}
        .priority-card.high{background:linear-gradient(135deg,#ff6b6b,#ff8e8e);color:#fff}
        .priority-card.medium{background:linear-gradient(135deg,#f39c12,#f1c40f);color:#fff}
        .priority-card.low{background:linear-gradient(135deg,#2ecc71,#27ae60);color:#fff}
        .status-badge{padding:4px 12px;border-radius:20px;font-size:.8rem;font-weight:600;display:inline-block}
        .status-new{background:#e3f2fd;color:#1565c0}
        .status-in-progress{background:#fff3e0;color:#f57c00}
        .status-resolved{background:#e8f5e9;color:#2e7d32}
        .status-closed{background:#f5f5f5;color:#616161}
        .complaints-table-container{overflow-x:auto;margin-bottom:20px;border-radius:10px;border:1px solid #eee}
        .complaints-table{width:100%;border-collapse:collapse;min-width:800px}
        .complaints-table thead{background:linear-gradient(135deg,#1a5fb4,#2d8fd5);color:#fff}
        .complaints-table th{padding:15px;text-align:right;font-weight:600;font-size:.95rem}
        .complaints-table tbody tr{border-bottom:1px solid #eee;transition:background .2s}
        .complaints-table tbody tr:hover{background:#f8f9fa}
        .complaints-table td{padding:15px;text-align:right;font-size:.9rem}
        .complaints-table .actions{display:flex;gap:8px;flex-wrap:wrap}
        .pagination{display:flex;justify-content:center;align-items:center;gap:10px;margin-top:20px;flex-wrap:wrap}
        .pagination-btn{background:#f8f9fa;border:1px solid #ddd;padding:8px 15px;border-radius:8px;cursor:pointer;font-size:.9rem;transition:all .2s}
        .pagination-btn:hover{background:#e9ecef}
        .pagination-btn.active{background:#1a5fb4;color:#fff;border-color:#1a5fb4}
        .pagination-info{color:#666;font-size:.9rem}
        .users-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:20px}
        .user-card{background:#fff;border-radius:15px;padding:20px;box-shadow:0 5px 15px rgba(0,0,0,.08);display:flex;align-items:center;gap:15px}
        .user-avatar{width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,#3498db,#2c3e50);display:flex;align-items:center;justify-content:center;font-size:1.5rem;color:#fff}
        .user-info{flex:1}
        .user-name{font-weight:700;font-size:1.1rem;color:#2c3e50;margin-bottom:5px}
        .user-role{font-size:.9rem;color:#666;margin-bottom:8px}
        .user-email{font-size:.85rem;color:#999}
        .settings-form{max-width:600px}
        .setting-item{margin-bottom:20px;padding-bottom:15px;border-bottom:1px solid #eee}
        .setting-label{display:block;font-weight:600;margin-bottom:8px;color:#2c3e50}
        .setting-description{font-size:.85rem;color:#666;margin-top:5px}
        .setting-input,.setting-select,.setting-textarea{width:100%;padding:12px;border:2px solid #ddd;border-radius:10px;font-size:1rem;background:#f8f9fa;transition:all .3s}
        .setting-input:focus,.setting-select:focus,.setting-textarea:focus{border-color:#1a5fb4;outline:none;box-shadow:0 0 0 3px rgba(26,95,180,.1);background:#fff}
        .setting-textarea{min-height:120px;resize:vertical}
        .save-btn{background:linear-gradient(to right,#1a5fb4,#2d8fd5);color:#fff;border:none;padding:15px 30px;border-radius:10px;font-size:1.1rem;font-weight:600;cursor:pointer;transition:all .3s;display:flex;align-items:center;gap:10px}
        .save-btn:hover{background:linear-gradient(to right,#155093,#1a5fb4);transform:translateY(-2px)}
        .toggle-switch{position:relative;display:inline-block;width:60px;height:34px}
        .toggle-switch input{opacity:0;width:0;height:0}
        .toggle-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;transition:.4s;border-radius:34px}
        .toggle-slider:before{position:absolute;content:"";height:26px;width:26px;left:4px;bottom:4px;background-color:white;transition:.4s;border-radius:50%}
        input:checked + .toggle-slider{background-color:#1a5fb4}
        input:checked + .toggle-slider:before{transform:translateX(26px)}
        
        /* إضافات جديدة للمزايا المطلوبة */
        .mobile-nav{position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:2px solid #1a5fb4;display:flex;justify-content:space-around;padding:12px 10px;z-index:999;box-shadow:0 -5px 20px rgba(0,0,0,.1);display:none}
        .mobile-nav-item{display:flex;flex-direction:column;align-items:center;gap:5px;color:#666;text-decoration:none;font-size:.8rem;flex:1;padding:8px 5px;border-radius:10px;transition:all .2s}
        .mobile-nav-item.active{background:#1a5fb4;color:#fff}
        .mobile-nav-icon{font-size:1.2rem}
        .modal-header-controls{display:flex;gap:10px;margin-top:15px;flex-wrap:wrap}
        .btn-download-pdf{background:#27ae60;color:#fff}
        .btn-reply{background:#9b59b6;color:#fff}
        .btn-edit{background:#3498db;color:#fff}
        .btn-delete{background:#e74c3c;color:#fff}
        .btn-reset-password{background:#f39c12;color:#fff}
        .modal-wide .modal-content{max-width:700px}
        .form-row{display:flex;flex-wrap:wrap;gap:15px;margin-bottom:15px}
        .form-group{flex:1;min-width:200px}
        .user-departments{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
        .department-tag{background:#e3f2fd;color:#1565c0;padding:4px 12px;border-radius:20px;font-size:.85rem;display:inline-flex;align-items:center;gap:5px}
        .department-tag i{cursor:pointer;font-size:.8rem}
        .multi-select{min-height:120px;max-height:200px;overflow-y:auto}
        .multi-select option{padding:10px;margin:5px 0;border-radius:5px}
        .multi-select option:checked{background:#1a5fb4;color:#fff}
        .settings-card{background:#fff;border-radius:15px;padding:25px;box-shadow:0 5px 20px rgba(0,0,0,.08);margin-bottom:20px}
        .settings-card h3{color:#2c3e50;margin-bottom:15px;padding-bottom:10px;border-bottom:2px solid #f0f0f0}
        
        @media (max-width:768px){
            .mobile-menu-btn,.mobile-nav{display:flex}
            .cards-grid{grid-template-columns:1fr}
            .complaints-table th,.complaints-table td{padding:10px 8px;font-size:.85rem}
            .section-header{flex-direction:column;align-items:flex-start}
            .filter-controls{flex-direction:column}
            .users-grid{grid-template-columns:1fr}
            .admin-info{flex-direction:column;text-align:center}
            .admin-text h3,.admin-text p{text-align:center}
            .logo{font-size:1.5rem}
            .subtitle{font-size:.9rem}
            .modal-header-controls{flex-direction:column}
            .modal-header-controls button{width:100%}
            .form-row{flex-direction:column}
            .form-group{width:100%}
        }
        @media (min-width:769px){
            .dashboard-grid{display:grid;grid-template-columns:280px 1fr}
            .sidebar{position:static;width:100%;height:auto;right:0;box-shadow:none;border-radius:15px}
            .sidebar-overlay{display:none !important}
            .close-sidebar{display:none}
            .mobile-menu-btn,.mobile-nav{display:none}
        }
        @media (max-width:480px){
            .admin-stats{grid-template-columns:1fr}
            .card-value{font-size:1.8rem}
            .complaints-table .actions{flex-direction:column}
            .action-btn{width:100%}
        }
    </style>
</head>
<body>
    <!-- شاشة تسجيل الدخول -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <div class="login-logo">
                <i class="fas fa-user-shield"></i>
            </div>
            <h2 class="login-title">تسجيل دخول المسؤول</h2>
            <form id="loginForm" class="login-form">
                <div class="form-group">
                    <label class="form-label">اسم المستخدم</label>
                    <input type="text" class="form-control" id="username" placeholder="أدخل اسم المستخدم" required>
                </div>
                <div class="form-group">
                    <label class="form-label">كلمة المرور</label>
                    <input type="password" class="form-control" id="password" placeholder="أدخل كلمة المرور" required>
                </div>
                <div class="login-error" id="loginError">
                    اسم المستخدم أو كلمة المرور غير صحيحة
                </div>
                <button type="submit" class="login-btn">
                    <i class="fas fa-sign-in-alt"></i>
                    تسجيل الدخول
                </button>
            </form>
        </div>
    </div>

    <!-- لوحة التحكم -->
    <div id="dashboardScreen" style="display:none;">
        <header>
            <div class="container">
                <h1 class="logo">لوحة التحكم - نظام الشكاوى الموحد</h1>
                <p class="subtitle">إدارة الشكاوى والطلبات المقدمة من المواطنين</p>
            </div>
        </header>

        <div class="container">
            <!-- زر القائمة للموبايل -->
            <button class="mobile-menu-btn" id="mobileMenuBtn">
                <i class="fas fa-bars"></i>
                عرض القائمة
            </button>

            <div class="admin-bar">
                <div class="admin-info">
                    <div class="admin-avatar">
                        <i class="fas fa-user-shield"></i>
                    </div>
                    <div class="admin-text">
                        <h3 id="adminWelcome">مرحباً، المسؤول</h3>
                        <p id="adminLastLogin">آخر دخول: -</p>
                    </div>
                </div>

                <div class="admin-stats">
                    <div class="stat-box">
                        <div class="stat-value" id="totalComplaints">0</div>
                        <div class="stat-label">إجمالي الشكاوى</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="newComplaints">0</div>
                        <div class="stat-label">شكاوى جديدة</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="resolvedComplaints">0</div>
                        <div class="stat-label">تم حلها</div>
                    </div>
                </div>

                <button class="logout-btn" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    تسجيل الخروج
                </button>
            </div>

            <div class="dashboard-grid">
                <!-- سايدبار -->
                <div class="sidebar-overlay" id="sidebarOverlay"></div>
                <div class="sidebar" id="sidebar">
                    <div class="sidebar-header">
                        <h3 class="sidebar-title">القائمة الرئيسية</h3>
                        <button class="close-sidebar" id="closeSidebar">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <ul class="sidebar-menu">
                        <li class="menu-item active" data-section="dashboard">
                            <i class="fas fa-tachometer-alt menu-icon"></i>
                            <span>لوحة التحكم</span>
                        </li>
                        <li class="menu-item" data-section="complaints">
                            <i class="fas fa-file-alt menu-icon"></i>
                            <span>إدارة الشكاوى</span>
                            <span class="badge" id="complaintsBadge">0</span>
                        </li>
                        <li class="menu-item admin-only" data-section="users">
                            <i class="fas fa-users menu-icon"></i>
                            <span>المستخدمين</span>
                        </li>
                        <li class="menu-item admin-only" data-section="settings">
                            <i class="fas fa-cog menu-icon"></i>
                            <span>الإعدادات</span>
                        </li>
                        <li class="menu-item" data-section="reports">
                            <i class="fas fa-chart-bar menu-icon"></i>
                            <span>التقارير</span>
                        </li>
                        <li class="menu-item admin-only" data-section="departments">
                            <i class="fas fa-building menu-icon"></i>
                            <span>الأقسام</span>
                        </li>
                    </ul>
                </div>

                <!-- المحتوى الرئيسي -->
                <div class="main-content">
                    <!-- قسم لوحة التحكم -->
                    <div id="dashboardSection" class="content-section active">
                        <div class="section-header">
                            <h2 class="section-title">لوحة التحكم الرئيسية</h2>
                            <div class="section-controls">
                                <select id="dashboardFilter" class="filter-select">
                                    <option value="all">جميع الفترات</option>
                                    <option value="today">اليوم</option>
                                    <option value="week">هذا الأسبوع</option>
                                    <option value="month">هذا الشهر</option>
                                </select>
                            </div>
                        </div>

                        <!-- بطاقات الإحصائيات -->
                        <div class="cards-grid">
                            <div class="card">
                                <div class="card-icon" style="background:#e3f2fd;color:#1565c0">
                                    <i class="fas fa-inbox"></i>
                                </div>
                                <h3 class="card-title">شكاوى جديدة</h3>
                                <div class="card-value" id="cardNewComplaints">0</div>
                                <p class="card-label">في آخر 7 أيام</p>
                                <div class="card-trend trend-up">
                                    <i class="fas fa-arrow-up"></i>
                                    <span>12% زيادة</span>
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-icon" style="background:#e8f5e9;color:#2e7d32">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <h3 class="card-title">شكاوى مكتملة</h3>
                                <div class="card-value" id="cardCompletedComplaints">0</div>
                                <p class="card-label">معدل الإنجاز</p>
                                <div class="card-trend trend-up">
                                    <i class="fas fa-arrow-up"></i>
                                    <span>8% زيادة</span>
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-icon" style="background:#fff3e0;color:#f57c00">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <h3 class="card-title">قيد المعالجة</h3>
                                <div class="card-value" id="cardInProgress">0</div>
                                <p class="card-label">متوسط وقت المعالجة</p>
                                <div class="card-trend trend-down">
                                    <i class="fas fa-arrow-down"></i>
                                    <span>2 يوم</span>
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-icon" style="background:#f3e5f5;color:#7b1fa2">
                                    <i class="fas fa-users"></i>
                                </div>
                                <h3 class="card-title">المستخدمين النشطين</h3>
                                <div class="card-value" id="cardActiveUsers">0</div>
                                <p class="card-label">زيارة اليوم</p>
                                <div class="card-trend trend-up">
                                    <i class="fas fa-arrow-up"></i>
                                    <span>5% زيادة</span>
                                </div>
                            </div>

                            <!-- بطاقات الأولويات -->
                            <div class="card priority-card high">
                                <div class="card-icon">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </div>
                                <h3 class="card-title">عاجلة</h3>
                                <div class="card-value" id="cardHighPriority">0</div>
                                <p class="card-label">شكاوى عاجلة</p>
                            </div>

                            <div class="card priority-card medium">
                                <div class="card-icon">
                                    <i class="fas fa-exclamation-circle"></i>
                                </div>
                                <h3 class="card-title">متوسطة</h3>
                                <div class="card-value" id="cardMediumPriority">0</div>
                                <p class="card-label">شكاوى متوسطة</p>
                            </div>

                            <div class="card priority-card low">
                                <div class="card-icon">
                                    <i class="fas fa-info-circle"></i>
                                </div>
                                <h3 class="card-title">منخفضة</h3>
                                <div class="card-value" id="cardLowPriority">0</div>
                                <p class="card-label">شكاوى منخفضة</p>
                            </div>
                        </div>

                        <!-- أحدث الشكاوى -->
                        <div class="section-header">
                            <h2 class="section-title">أحدث الشكاوى</h2>
                            <a href="#" onclick="showSection('complaints'); return false;" style="color:#1a5fb4;text-decoration:none;display:flex;align-items:center;gap:5px">
                                <span>عرض الكل</span>
                                <i class="fas fa-arrow-left"></i>
                            </a>
                        </div>
                        <div class="complaints-table-container">
                            <table class="complaints-table" id="latestComplaintsTable">
                                <thead>
                                    <tr>
                                        <th>رقم الشكوى</th>
                                        <th>الاسم</th>
                                        <th>القسم</th>
                                        <th>الأولوية</th>
                                        <th>الحالة</th>
                                        <th>التاريخ</th>
                                        <th>إجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="latestComplaintsBody">
                                    <!-- سيتم ملؤها بالجافاسكريبت -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- قسم إدارة الشكاوى -->
                    <div id="complaintsSection" class="content-section">
                        <div class="section-header">
                            <h2 class="section-title">إدارة الشكاوى</h2>
                            <div class="section-controls">
                                <button class="save-btn" onclick="exportComplaints()">
                                    <i class="fas fa-download"></i>
                                    تصدير
                                </button>
                            </div>
                        </div>

                        <div class="filter-controls">
                            <div class="filter-group">
                                <label class="filter-label">بحث</label>
                                <input type="text" id="searchComplaints" class="filter-input" placeholder="ابحث برقم أو اسم...">
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">القسم</label>
                                <select id="filterDepartment" class="filter-select">
                                    <option value="">جميع الأقسام</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">الحالة</label>
                                <select id="filterStatus" class="filter-select">
                                    <option value="">جميع الحالات</option>
                                    <option value="جديدة">جديدة</option>
                                    <option value="قيد المراجعة">قيد المراجعة</option>
                                    <option value="قيد المعالجة">قيد المعالجة</option>
                                    <option value="مكتملة">مكتملة</option>
                                    <option value="ملغاة">ملغاة</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">الأولوية</label>
                                <select id="filterPriority" class="filter-select">
                                    <option value="">جميع الأولويات</option>
                                    <option value="عاجلة">عاجلة</option>
                                    <option value="متوسطة">متوسطة</option>
                                    <option value="منخفضة">منخفضة</option>
                                </select>
                            </div>
                        </div>

                        <div class="complaints-table-container">
                            <table class="complaints-table">
                                <thead>
                                    <tr>
                                        <th>رقم الشكوى</th>
                                        <th>الاسم</th>
                                        <th>القسم</th>
                                        <th>الأولوية</th>
                                        <th>الحالة</th>
                                        <th>التاريخ</th>
                                        <th>إجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="complaintsTableBody">
                                    <!-- سيتم ملؤها بالجافاسكريبت -->
                                </tbody>
                            </table>
                        </div>

                        <div class="pagination">
                            <button class="pagination-btn" id="prevPage" disabled>
                                <i class="fas fa-arrow-right"></i>
                                السابق
                            </button>
                            <span class="pagination-info" id="pageInfo">الصفحة 1 من 1</span>
                            <button class="pagination-btn" id="nextPage" disabled>
                                التالي
                                <i class="fas fa-arrow-left"></i>
                            </button>
                        </div>
                    </div>

                    <!-- قسم المستخدمين -->
                    <div id="usersSection" class="content-section">
                        <div class="section-header">
                            <h2 class="section-title">إدارة المستخدمين</h2>
                            <div class="section-controls">
                                <button class="save-btn" onclick="showAddUserModal()">
                                    <i class="fas fa-user-plus"></i>
                                    إضافة مستخدم
                                </button>
                            </div>
                        </div>

                        <div class="users-grid" id="usersGrid">
                            <!-- سيتم ملؤها بالجافاسكريبت -->
                        </div>
                    </div>

                    <!-- قسم الإعدادات -->
                    <div id="settingsSection" class="content-section">
                        <div class="section-header">
                            <h2 class="section-title">إعدادات النظام</h2>
                        </div>

                        <div class="settings-card">
                            <h3>إعدادات عامة</h3>
                            <form class="settings-form" id="settingsForm">
                                <div class="setting-item">
                                    <label class="setting-label">اسم النظام</label>
                                    <input type="text" class="setting-input" id="systemName" value="نظام الشكاوى الموحد" required>
                                    <p class="setting-description">الاسم الذي يظهر في لوحة التحكم</p>
                                </div>

                                <div class="setting-item">
                                    <label class="setting-label">عنوان النظام</label>
                                    <input type="text" class="setting-input" id="systemTitle" value="لوحة التحكم الإدارية" required>
                                    <p class="setting-description">العنوان الذي يظهر في أعلى الصفحة</p>
                                </div>

                                <div class="setting-item">
                                    <label class="setting-label">عدد العناصر في الصفحة</label>
                                    <select class="setting-select" id="itemsPerPage">
                                        <option value="10">10 عناصر</option>
                                        <option value="25">25 عنصراً</option>
                                        <option value="50">50 عنصراً</option>
                                        <option value="100">100 عنصر</option>
                                    </select>
                                    <p class="setting-description">عدد الشكاوى المعروضة في كل صفحة</p>
                                </div>

                                <div class="setting-item">
                                    <label class="setting-label">تفعيل الإشعارات</label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="enableNotifications" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <p class="setting-description">إرسال إشعارات عند وصول شكاوى جديدة</p>
                                </div>

                                <div class="setting-item">
                                    <label class="setting-label">تفعيل التذكير التلقائي</label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="enableReminders" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                    <p class="setting-description">تذكير تلقائي بالشكاوى المتأخرة</p>
                                </div>

                                <div class="setting-item">
                                    <label class="setting-label">رسالة الترحيب</label>
                                    <textarea class="setting-textarea" id="welcomeMessage">مرحباً بكم في نظام الشكاوى الموحد. نسعى دائماً لتحسين خدماتنا.</textarea>
                                    <p class="setting-description">الرسالة التي تظهر عند تسجيل الدخول</p>
                                </div>

                                <div class="setting-item">
                                    <label class="setting-label">البريد الإلكتروني للإشعارات</label>
                                    <input type="email" class="setting-input" id="notificationEmail" placeholder="admin@example.com">
                                    <p class="setting-description">إرسال نسخة من الإشعارات إلى هذا البريد</p>
                                </div>

                                <button type="submit" class="save-btn">
                                    <i class="fas fa-save"></i>
                                    حفظ الإعدادات
                                </button>
                            </form>
                        </div>

                        <div class="settings-card">
                            <h3>إعدادات مكتب النائب</h3>
                            <form class="settings-form" id="officeSettingsForm">
                                <div class="setting-item">
                                    <label class="setting-label">رقم مكتب النائب للواتساب</label>
                                    <input type="text" class="setting-input" id="officeWhatsappNumber" placeholder="+201234567890" required>
                                    <p class="setting-description">سيظهر هذا الرقم لمقدمي الطلبات للتواصل عبر الواتساب</p>
                                </div>

                                <div class="setting-item">
                                    <label class="setting-label">اسم مكتب الرد الرسمي</label>
                                    <input type="text" class="setting-input" id="officeReplyName" value="مكتب النائب أحمد الحديدي" required>
                                    <p class="setting-description">الاسم الذي سيظهر في الردود الرسمية على الشكاوى</p>
                                </div>

                                <div class="setting-item">
                                    <label class="setting-label">توقيع الرد الرسمي</label>
                                    <textarea class="setting-textarea" id="officeReplySignature">وتفضلوا بقبول فائق الاحترام والتقدير،
مكتب النائب أحمد الحديدي
رقم الهاتف: 
البريد الإلكتروني:</textarea>
                                    <p class="setting-description">التوقيع الذي سيظهر في نهاية كل رد رسمي</p>
                                </div>

                                <button type="submit" class="save-btn">
                                    <i class="fas fa-save"></i>
                                    حفظ إعدادات المكتب
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- قسم التقارير -->
                    <div id="reportsSection" class="content-section">
                        <div class="section-header">
                            <h2 class="section-title">التقارير والإحصائيات</h2>
                            <div class="section-controls">
                                <select id="reportPeriod" class="filter-select">
                                    <option value="week">آخر أسبوع</option>
                                    <option value="month">آخر شهر</option>
                                    <option value="quarter">آخر 3 أشهر</option>
                                    <option value="year">آخر سنة</option>
                                </select>
                            </div>
                        </div>

                        <div class="cards-grid">
                            <div class="card">
                                <h3 class="card-title">إحصائية الشكاوى</h3>
                                <div class="card-value" id="reportTotal">0</div>
                                <p class="card-label">إجمالي الشكاوى في الفترة</p>
                            </div>
                            <div class="card">
                                <h3 class="card-title">معدل الإنجاز</h3>
                                <div class="card-value" id="reportCompletionRate">0%</div>
                                <p class="card-label">نسبة الشكاوى المكتملة</p>
                            </div>
                            <div class="card">
                                <h3 class="card-title">متوسط وقت المعالجة</h3>
                                <div class="card-value" id="reportAvgTime">0 يوم</div>
                                <p class="card-label">متوسط وقت حل الشكوى</p>
                            </div>
                            <div class="card">
                                <h3 class="card-title">رضا العملاء</h3>
                                <div class="card-value" id="reportSatisfaction">0%</div>
                                <p class="card-label">نسبة الرضا عن الخدمة</p>
                            </div>
                        </div>

                        <div style="background:#fff;padding:20px;border-radius:15px;margin-top:20px">
                            <h3 style="margin-bottom:15px;color:#2c3e50">توزيع الشكاوى حسب القسم</h3>
                            <div id="departmentChart" style="height:300px;display:flex;align-items:center;justify-content:center;color:#666">
                                <p>رسم بياني لتوزيع الشكاوى سيظهر هنا</p>
                            </div>
                        </div>
                    </div>

                    <!-- قسم الأقسام -->
                    <div id="departmentsSection" class="content-section">
                        <div class="section-header">
                            <h2 class="section-title">إدارة الأقسام</h2>
                            <button class="save-btn" onclick="addNewDepartment()">
                                <i class="fas fa-plus"></i>
                                إضافة قسم
                            </button>
                        </div>

                        <div class="cards-grid" id="departmentsGrid">
                            <!-- سيتم ملؤها بالجافاسكريبت -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="footer">
                <p>© 2026 نظام الشكاوى الموحد - لوحة التحكم الإدارية</p>
                <p>جميع الحقوق محفوظة - الإصدار 3.0.0</p>
                <p>
                    تم برمجة الموقع من
                    <a href="https://www.facebook.com/en.mohamed.nasr" target="_blank" rel="noopener">
                        المهندس محمد حماد
                        <i class="fab fa-facebook"></i>
                    </a>
                </p>
            </div>
        </div>

        <!-- نافذة تفاصيل الشكوى -->
        <div class="complaint-details-modal modal-wide" id="complaintDetailsModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">تفاصيل الشكوى</h3>
                    <button class="close-modal" id="closeModal">&times;</button>
                    <div class="modal-header-controls" id="modalHeaderControls">
                        <!-- سيتم ملؤها بالجافاسكريبت -->
                    </div>
                </div>
                <div class="modal-body" id="modalBody"></div>
            </div>
        </div>

        <!-- نافذة إضافة/تعديل مستخدم -->
        <div class="complaint-details-modal" id="userModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title" id="userModalTitle">إضافة مستخدم جديد</h3>
                    <button class="close-modal" onclick="closeUserModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="userForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="setting-label">اسم المستخدم (الذي سيظهر)</label>
                                <input type="text" class="setting-input" id="userName" required>
                            </div>
                            <div class="form-group">
                                <label class="setting-label">اسم المستخدم بالانجليزية للتسجيل</label>
                                <input type="text" class="setting-input" id="userUsername" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="setting-label">البريد الإلكتروني</label>
                                <input type="email" class="setting-input" id="userEmail" required>
                            </div>
                            <div class="form-group">
                                <label class="setting-label">رقم الهاتف</label>
                                <input type="text" class="setting-input" id="userPhone">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="setting-label">كلمة السر</label>
                                <input type="password" class="setting-input" id="userPassword" required>
                            </div>
                            <div class="form-group">
                                <label class="setting-label">تأكيد كلمة السر</label>
                                <input type="password" class="setting-input" id="userConfirmPassword" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="setting-label">دور المستخدم</label>
                            <select class="setting-select" id="userRole">
                                <option value="user">مستخدم عادي</option>
                                <option value="admin">مسؤول</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="setting-label">الأقسام المسؤول عنها</label>
                            <select class="setting-select multi-select" id="userDepartments" multiple>
                                <!-- سيتم ملؤها بالجافاسكريبت -->
                            </select>
                            <p class="setting-description">يمكن اختيار أكثر من قسم باستخدام زر Ctrl</p>
                        </div>
                        <div class="form-group">
                            <div class="user-departments" id="selectedDepartments">
                                <!-- سيتم ملؤها بالجافاسكريبت -->
                            </div>
                        </div>
                        <input type="hidden" id="userId">
                        <button type="submit" class="save-btn" style="width:100%;margin-top:20px">
                            <i class="fas fa-save"></i>
                            حفظ المستخدم
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- نافذة الرد على الشكوى -->
        <div class="complaint-details-modal" id="replyModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">الرد على الشكوى</h3>
                    <button class="close-modal" onclick="closeReplyModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <form id="replyForm">
                        <div class="form-group">
                            <label class="setting-label">الرد الرسمي باسم مكتب النائب</label>
                            <textarea class="setting-textarea" id="replyText" rows="8" placeholder="أدخل الرد الرسمي هنا..."></textarea>
                        </div>
                        <input type="hidden" id="replyComplaintId">
                        <div class="modal-header-controls">
                            <button type="submit" class="action-btn btn-reply" style="flex:1">
                                <i class="fas fa-reply"></i>
                                إرسال الرد
                            </button>
                            <button type="button" class="action-btn btn-secondary" onclick="closeReplyModal()" style="flex:1">
                                <i class="fas fa-times"></i>
                                إلغاء
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- شريط التحميل -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-spinner"></div>
        </div>

        <!-- شريط التنقل للهواتف -->
        <div class="mobile-nav" id="mobileNav">
            <a href="#" class="mobile-nav-item active" onclick="showSection('dashboard'); updateMobileNav(this); return false;">
                <i class="fas fa-tachometer-alt mobile-nav-icon"></i>
                <span>لوحة التحكم</span>
            </a>
            <a href="#" class="mobile-nav-item" onclick="showSection('complaints'); updateMobileNav(this); return false;">
                <i class="fas fa-file-alt mobile-nav-icon"></i>
                <span>الشكاوى</span>
            </a>
            <a href="#" class="mobile-nav-item" onclick="if(currentUser && currentUser.role === 'admin'){showSection('users'); updateMobileNav(this);} else {showMessage('يجب تسجيل الدخول كمسؤول', 'error');} return false;">
                <i class="fas fa-users mobile-nav-icon"></i>
                <span>المستخدمين</span>
            </a>
            <a href="#" class="mobile-nav-item" onclick="showSection('settings'); updateMobileNav(this); return false;">
                <i class="fas fa-cog mobile-nav-icon"></i>
                <span>الإعدادات</span>
            </a>
            <a href="#" class="mobile-nav-item" onclick="showSection('reports'); updateMobileNav(this); return false;">
                <i class="fas fa-chart-bar mobile-nav-icon"></i>
                <span>التقارير</span>
            </a>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBIIStbiZD0ZJ6su7C1bwZlBvqx-PP-t58",
            authDomain: "shakawa-e0a3c.firebaseapp.com",
            databaseURL: "https://shakawa-e0a3c-default-rtdb.firebaseio.com",
            projectId: "shakawa-e0a3c",
            storageBucket: "shakawa-e0a3c.firebasestorage.app",
            messagingSenderId: "111620348664",
            appId: "1:111620348664:web:670fdf5caed46eb691b90d",
            measurementId: "G-SGNTJZDQ1L"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let isLoggedIn = false;
        let currentUser = null;
        let currentSection = 'dashboard';
        let allComplaints = [];
        let filteredComplaints = [];
        let allUsers = [];
        let allDepartments = [];
        let currentPage = 1;
        let itemsPerPage = 10;
        let settings = {};
        let officeSettings = {};

        document.addEventListener('DOMContentLoaded', () => {
            initApp();
        });

        function initApp() {
            checkLoginStatus();
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            document.getElementById('closeSidebar').addEventListener('click', closeSidebar);
            document.getElementById('sidebarOverlay').addEventListener('click', closeSidebar);
            document.getElementById('closeModal').addEventListener('click', closeModal);
            document.getElementById('mobileMenuBtn').addEventListener('click', openSidebar);
            
            // إضافة مستمعات للفلاتر
            document.getElementById('searchComplaints').addEventListener('input', filterComplaints);
            document.getElementById('filterDepartment').addEventListener('change', filterComplaints);
            document.getElementById('filterStatus').addEventListener('change', filterComplaints);
            document.getElementById('filterPriority').addEventListener('change', filterComplaints);
            document.getElementById('dashboardFilter').addEventListener('change', updateDashboardCards);
            document.getElementById('reportPeriod').addEventListener('change', generateReports);
            
            // إضافة مستمع للتقسيم
            document.getElementById('prevPage').addEventListener('click', () => changePage(-1));
            document.getElementById('nextPage').addEventListener('click', () => changePage(1));
            
            // إضافة مستمع للإعدادات
            document.getElementById('settingsForm').addEventListener('submit', saveSettings);
            document.getElementById('officeSettingsForm').addEventListener('submit', saveOfficeSettings);
            document.getElementById('userForm').addEventListener('submit', saveUser);
            document.getElementById('replyForm').addEventListener('submit', sendReply);

            // متابعة تغيير الأقسام للمستخدم
            document.getElementById('userDepartments').addEventListener('change', updateSelectedDepartments);

            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', () => {
                    if (item.classList.contains('admin-only') && !(currentUser && currentUser.role === 'admin')) {
                        showMessage('يجب تسجيل الدخول كمسؤول للوصول إلى هذا القسم', 'error');
                        return;
                    }
                    document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    showSection(item.getAttribute('data-section'));
                    closeSidebar();
                });
            });

            loadComplaints();
            loadUsers();
            loadDepartments();
            loadSettings();
            loadOfficeSettings();
        }

        function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const loginError = document.getElementById('loginError');

            if (username === 'admin' && password === '742018') {
                const userData = {
                    username: 'admin',
                    name: 'المدير العام',
                    role: 'admin',
                    phone: ''
                };
                loginError.style.display = 'none';
                loginSuccess(userData);
            } else {
                loginError.style.display = 'block';
            }
        }

        function loginSuccess(userData) {
            isLoggedIn = true;
            currentUser = {
                username: userData.username,
                name: userData.name,
                role: userData.role || 'user',
                phone: userData.phone || '',
                loginTime: new Date().toISOString()
            };
            localStorage.setItem('adminLoggedIn', 'true');
            localStorage.setItem('adminUser', JSON.stringify(currentUser));
            showDashboard();
            showMessage(`مرحباً ${currentUser.name}! ${settings.welcomeMessage || 'تم تسجيل الدخول بنجاح'}`, 'success');
        }

        function handleLogout() {
            if (!confirm('هل تريد تسجيل الخروج من لوحة التحكم؟')) return;
            isLoggedIn = false;
            currentUser = null;
            localStorage.removeItem('adminLoggedIn');
            localStorage.removeItem('adminUser');
            showLogin();
        }

        function checkLoginStatus() {
            const savedLogin = localStorage.getItem('adminLoggedIn');
            const savedUser = localStorage.getItem('adminUser');
            if (savedLogin === 'true' && savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    isLoggedIn = true;
                    showDashboard();
                } catch {
                    localStorage.clear();
                    showLogin();
                }
            } else {
                showLogin();
            }
        }

        function showLogin() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('dashboardScreen').style.display = 'none';
        }

        function showDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboardScreen').style.display = 'block';
            updateAdminWelcome();
            updateSidebarPermissions();
            showSection('dashboard');
        }

        function updateAdminWelcome() {
            if (!currentUser) return;
            document.getElementById('adminWelcome').textContent = `مرحباً، ${currentUser.name}`;
            if (currentUser.loginTime) {
                const d = new Date(currentUser.loginTime);
                document.getElementById('adminLastLogin').textContent =
                    'آخر دخول: ' + d.toLocaleString('ar-EG');
            }
        }

        function updateSidebarPermissions() {
            const adminOnly = document.querySelectorAll('.admin-only');
            if (currentUser && currentUser.role === 'admin') {
                adminOnly.forEach(el => el.style.display = 'flex');
            } else {
                adminOnly.forEach(el => el.style.display = 'none');
            }
        }

        async function loadComplaints() {
            showLoading();
            try {
                const snap = await database.ref('complaints').get();
                allComplaints = [];
                if (snap.exists()) {
                    snap.forEach(ch => {
                        const c = ch.val();
                        c.key = ch.key;
                        allComplaints.push(c);
                    });
                }
                allComplaints.sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));
                updateDashboardStats();
                filteredComplaints = allComplaints.slice();
                displayComplaintsTable();
                displayLatestComplaints();
                updateDashboardCards();
                populateDepartmentFilter();
            } catch(err){
                console.error(err);
                showMessage('حدث خطأ أثناء تحميل الشكاوى','error');
            } finally {
                hideLoading();
            }
        }

        async function loadUsers() {
            try {
                const snap = await database.ref('users').get();
                allUsers = [];
                if (snap.exists()) {
                    snap.forEach(ch => {
                        const u = ch.val();
                        u.key = ch.key;
                        allUsers.push(u);
                    });
                }
                displayUsersGrid();
                populateUserDepartments();
            } catch(err){
                console.error(err);
            }
        }

        async function loadDepartments() {
            try {
                const snap = await database.ref('departments').get();
                allDepartments = [];
                if (snap.exists()) {
                    snap.forEach(ch => {
                        const d = ch.val();
                        d.key = ch.key;
                        allDepartments.push(d);
                    });
                }
                displayDepartmentsGrid();
            } catch(err){
                console.error(err);
            }
        }

        async function loadSettings() {
            try {
                const snap = await database.ref('settings').get();
                if (snap.exists()) {
                    settings = snap.val();
                    applySettings();
                }
            } catch(err){
                console.error(err);
            }
        }

        async function loadOfficeSettings() {
            try {
                const snap = await database.ref('officeSettings').get();
                if (snap.exists()) {
                    officeSettings = snap.val();
                    applyOfficeSettings();
                } else {
                    // إعدادات افتراضية
                    officeSettings = {
                        whatsappNumber: '+201234567890',
                        replyName: 'مكتب النائب أحمد الحديدي',
                        replySignature: 'وتفضلوا بقبول فائق الاحترام والتقدير،\nمكتب النائب أحمد الحديدي\nرقم الهاتف: \nالبريد الإلكتروني:'
                    };
                }
            } catch(err){
                console.error(err);
            }
        }

        function applySettings() {
            if (settings.systemName) {
                document.getElementById('systemName').value = settings.systemName;
                document.getElementById('adminWelcome').textContent = `مرحباً في ${settings.systemName}`;
            }
            if (settings.itemsPerPage) {
                itemsPerPage = parseInt(settings.itemsPerPage) || 10;
                document.getElementById('itemsPerPage').value = itemsPerPage;
            }
            if (settings.enableNotifications !== undefined) {
                document.getElementById('enableNotifications').checked = settings.enableNotifications;
            }
            if (settings.enableReminders !== undefined) {
                document.getElementById('enableReminders').checked = settings.enableReminders;
            }
            if (settings.welcomeMessage) {
                document.getElementById('welcomeMessage').value = settings.welcomeMessage;
            }
            if (settings.notificationEmail) {
                document.getElementById('notificationEmail').value = settings.notificationEmail;
            }
        }

        function applyOfficeSettings() {
            if (officeSettings.whatsappNumber) {
                document.getElementById('officeWhatsappNumber').value = officeSettings.whatsappNumber;
            }
            if (officeSettings.replyName) {
                document.getElementById('officeReplyName').value = officeSettings.replyName;
            }
            if (officeSettings.replySignature) {
                document.getElementById('officeReplySignature').value = officeSettings.replySignature;
            }
        }

        function updateDashboardStats() {
            const total = allComplaints.length;
            const newComplaints = allComplaints.filter(c => c.status === 'جديدة').length;
            const resolvedComplaints = allComplaints.filter(c => c.status === 'مكتملة' || c.status === 'تم الرد').length;
            document.getElementById('totalComplaints').textContent = total;
            document.getElementById('newComplaints').textContent = newComplaints;
            document.getElementById('resolvedComplaints').textContent = resolvedComplaints;
            
            // تحديث البادج
            const badge = document.getElementById('complaintsBadge');
            if (newComplaints > 0) {
                badge.textContent = newComplaints;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }

        function updateDashboardCards() {
            const period = document.getElementById('dashboardFilter').value;
            const now = new Date();
            let startDate;
            
            switch(period) {
                case 'today':
                    startDate = new Date(now.setHours(0,0,0,0));
                    break;
                case 'week':
                    startDate = new Date(now.setDate(now.getDate() - 7));
                    break;
                case 'month':
                    startDate = new Date(now.setMonth(now.getMonth() - 1));
                    break;
                default:
                    startDate = new Date(0);
            }
            
            const filtered = allComplaints.filter(c => new Date(c.createdAt) >= startDate);
            const newComplaints = filtered.filter(c => c.status === 'جديدة').length;
            const completed = filtered.filter(c => c.status === 'مكتملة').length;
            const inProgress = filtered.filter(c => c.status === 'قيد المعالجة' || c.status === 'قيد المراجعة').length;
            const highPriority = filtered.filter(c => c.priority === 'عاجلة').length;
            const mediumPriority = filtered.filter(c => c.priority === 'متوسطة').length;
            const lowPriority = filtered.filter(c => c.priority === 'منخفضة').length;
            
            document.getElementById('cardNewComplaints').textContent = newComplaints;
            document.getElementById('cardCompletedComplaints').textContent = completed;
            document.getElementById('cardInProgress').textContent = inProgress;
            document.getElementById('cardHighPriority').textContent = highPriority;
            document.getElementById('cardMediumPriority').textContent = mediumPriority;
            document.getElementById('cardLowPriority').textContent = lowPriority;
            document.getElementById('cardActiveUsers').textContent = allUsers.length;
        }

        function displayComplaintsTable() {
            const tbody = document.getElementById('complaintsTableBody');
            if (!tbody) return;
            
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const currentItems = filteredComplaints.slice(start, end);
            
            if (!currentItems.length) {
                tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:40px;color:#666;">لا توجد شكاوى</td></tr>`;
                updatePagination();
                return;
            }
            
            let html = '';
            currentItems.forEach(c => {
                const createdAt = c.createdAt ? new Date(c.createdAt).toLocaleDateString('ar-EG') : '-';
                const statusClass = getStatusClass(c.status);
                
                html += `
                <tr>
                    <td><strong>${c.complaintNumber || 'غير معروف'}</strong></td>
                    <td>${c.fullName || ''}</td>
                    <td>${c.department || ''}</td>
                    <td>
                        <span class="status-badge ${getPriorityClass(c.priority)}">
                            ${c.priority || ''}
                        </span>
                    </td>
                    <td>
                        <span class="status-badge ${statusClass}">
                            ${c.status || ''}
                        </span>
                    </td>
                    <td>${createdAt}</td>
                    <td class="actions">
                        <button class="action-btn btn-view" onclick="viewComplaint('${c.key}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="action-btn" style="background:#2ecc71;color:#fff" onclick="updateStatus('${c.key}', 'قيد المراجعة')">
                            <i class="fas fa-play"></i>
                        </button>
                        <button class="action-btn" style="background:#f39c12;color:#fff" onclick="updateStatus('${c.key}', 'قيد المعالجة')">
                            <i class="fas fa-cog"></i>
                        </button>
                        <button class="action-btn" style="background:#27ae60;color:#fff" onclick="updateStatus('${c.key}', 'مكتملة')">
                            <i class="fas fa-check"></i>
                        </button>
                    </td>
                </tr>`;
            });
            tbody.innerHTML = html;
            updatePagination();
        }

        function displayLatestComplaints() {
            const tbody = document.getElementById('latestComplaintsBody');
            if (!tbody) return;
            
            const latest = allComplaints.slice(0, 5);
            
            if (!latest.length) {
                tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:20px;color:#666;">لا توجد شكاوى حديثة</td></tr>`;
                return;
            }
            
            let html = '';
            latest.forEach(c => {
                const createdAt = c.createdAt ? new Date(c.createdAt).toLocaleDateString('ar-EG') : '-';
                const statusClass = getStatusClass(c.status);
                
                html += `
                <tr>
                    <td><strong>${c.complaintNumber || 'غير معروف'}</strong></td>
                    <td>${c.fullName || ''}</td>
                    <td>${c.department || ''}</td>
                    <td>
                        <span class="status-badge ${getPriorityClass(c.priority)}">
                            ${c.priority || ''}
                        </span>
                    </td>
                    <td>
                        <span class="status-badge ${statusClass}">
                            ${c.status || ''}
                        </span>
                    </td>
                    <td>${createdAt}</td>
                    <td class="actions">
                        <button class="action-btn btn-view" onclick="viewComplaint('${c.key}')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>`;
            });
            tbody.innerHTML = html;
        }

        function displayUsersGrid() {
            const container = document.getElementById('usersGrid');
            if (!container) return;
            
            if (!allUsers.length) {
                container.innerHTML = '<p style="text-align:center;color:#666;padding:40px;">لا يوجد مستخدمين مسجلين</p>';
                return;
            }
            
            let html = '';
            allUsers.forEach(u => {
                const roleColor = u.role === 'admin' ? '#e74c3c' : '#3498db';
                const departments = u.departments ? u.departments.join(', ') : 'جميع الأقسام';
                
                html += `
                <div class="user-card">
                    <div class="user-avatar" style="background:linear-gradient(135deg,${roleColor},#2c3e50)">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="user-info">
                        <div class="user-name">${u.name || 'غير معروف'}</div>
                        <div class="user-role">
                            <span style="color:${roleColor};font-weight:600">${u.role === 'admin' ? 'مسؤول' : 'مستخدم'}</span>
                        </div>
                        <div class="user-email">${u.email || 'لا يوجد بريد إلكتروني'}</div>
                        <div class="user-email">${departments}</div>
                    </div>
                    <div style="display:flex;gap:5px;">
                        <button class="action-btn btn-edit" onclick="editUser('${u.key}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn btn-reset-password" onclick="resetUserPassword('${u.key}')">
                            <i class="fas fa-key"></i>
                        </button>
                        <button class="action-btn btn-delete" onclick="deleteUser('${u.key}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        }

        function displayDepartmentsGrid() {
            const container = document.getElementById('departmentsGrid');
            if (!container) return;
            
            const colors = ['#3498db', '#2ecc71', '#9b59b6', '#e74c3c', '#f39c12', '#1abc9c'];
            
            if (!allDepartments.length) {
                container.innerHTML = '<p style="text-align:center;color:#666;padding:40px;">لا يوجد أقسام مسجلة</p>';
                return;
            }
            
            let html = '';
            allDepartments.forEach((d, index) => {
                const color = colors[index % colors.length];
                const complaintsCount = allComplaints.filter(c => c.department === d.name).length;
                
                html += `
                <div class="card">
                    <div class="card-icon" style="background:${color}20;color:${color}">
                        <i class="fas fa-building"></i>
                    </div>
                    <h3 class="card-title">${d.name}</h3>
                    <div class="card-value">${complaintsCount}</div>
                    <p class="card-label">شكوى</p>
                    <div style="margin-top:15px;display:flex;gap:10px">
                        <button class="action-btn" style="background:${color};color:#fff" onclick="editDepartment('${d.key}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn" style="background:#e74c3c;color:#fff" onclick="deleteDepartment('${d.key}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        }

        function populateDepartmentFilter() {
            const select = document.getElementById('filterDepartment');
            if (!select) return;
            
            const departments = [...new Set(allComplaints.map(c => c.department).filter(Boolean))];
            
            let options = '<option value="">جميع الأقسام</option>';
            departments.forEach(dept => {
                options += `<option value="${dept}">${dept}</option>`;
            });
            
            select.innerHTML = options;
        }

        function populateUserDepartments() {
            const select = document.getElementById('userDepartments');
            if (!select) return;
            
            let options = '';
            allDepartments.forEach(dept => {
                options += `<option value="${dept.name}">${dept.name}</option>`;
            });
            
            select.innerHTML = options;
        }

        function filterComplaints() {
            const search = document.getElementById('searchComplaints').value.toLowerCase();
            const department = document.getElementById('filterDepartment').value;
            const status = document.getElementById('filterStatus').value;
            const priority = document.getElementById('filterPriority').value;
            
            filteredComplaints = allComplaints.filter(c => {
                const searchMatch = !search || 
                    (c.complaintNumber && c.complaintNumber.toLowerCase().includes(search)) ||
                    (c.fullName && c.fullName.toLowerCase().includes(search)) ||
                    (c.problemDetails && c.problemDetails.toLowerCase().includes(search));
                
                const departmentMatch = !department || c.department === department;
                const statusMatch = !status || c.status === status;
                const priorityMatch = !priority || c.priority === priority;
                
                return searchMatch && departmentMatch && statusMatch && priorityMatch;
            });
            
            currentPage = 1;
            displayComplaintsTable();
        }

        function updatePagination() {
            const totalPages = Math.ceil(filteredComplaints.length / itemsPerPage);
            const prevBtn = document.getElementById('prevPage');
            const nextBtn = document.getElementById('nextPage');
            const pageInfo = document.getElementById('pageInfo');
            
            prevBtn.disabled = currentPage <= 1;
            nextBtn.disabled = currentPage >= totalPages;
            pageInfo.textContent = `الصفحة ${currentPage} من ${totalPages}`;
        }

        function changePage(direction) {
            const totalPages = Math.ceil(filteredComplaints.length / itemsPerPage);
            const newPage = currentPage + direction;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                displayComplaintsTable();
                document.querySelector('.main-content').scrollIntoView({behavior: 'smooth'});
            }
        }

        function getStatusClass(status) {
            switch(status) {
                case 'جديدة': return 'status-new';
                case 'قيد المراجعة': return 'status-in-progress';
                case 'قيد المعالجة': return 'status-in-progress';
                case 'مكتملة': return 'status-resolved';
                case 'ملغاة': return 'status-closed';
                default: return '';
            }
        }

        function getPriorityClass(priority) {
            switch(priority) {
                case 'عاجلة': return 'high';
                case 'متوسطة': return 'medium';
                case 'منخفضة': return 'low';
                default: return '';
            }
        }

        function viewComplaint(complaintKey) {
            const complaint = allComplaints.find(c => c.key === complaintKey);
            if (!complaint) {
                showMessage('لم يتم العثور على الشكوى','error');
                return;
            }
            const modalBody = document.getElementById('modalBody');
            const createdAt = complaint.createdAt ? new Date(complaint.createdAt).toLocaleString('ar-EG') : '-';
            const updatedAt = complaint.updatedAt ? new Date(complaint.updatedAt).toLocaleString('ar-EG') : createdAt;
            
            // زر تنزيل PDF
            const downloadBtn = `<button class="action-btn btn-download-pdf" onclick="downloadComplaintPDF('${complaint.key}')">
                <i class="fas fa-download"></i> تنزيل PDF
            </button>`;
            
            // زر الرد باسم مكتب النائب
            const replyBtn = `<button class="action-btn btn-reply" onclick="showReplyModal('${complaint.key}')">
                <i class="fas fa-reply"></i> الرد باسم مكتب النائب
            </button>`;
            
            // أزرار التحكم
            const controlBtns = `
                <button class="action-btn btn-edit" onclick="editComplaint('${complaint.key}')">
                    <i class="fas fa-edit"></i> تعديل
                </button>
                <button class="action-btn btn-delete" onclick="deleteComplaint('${complaint.key}')">
                    <i class="fas fa-trash"></i> حذف
                </button>
            `;
            
            document.getElementById('modalHeaderControls').innerHTML = downloadBtn + replyBtn + controlBtns;
            
            modalBody.innerHTML = `
                <div class="details-grid">
                    <div class="detail-item">
                        <div class="detail-label">رقم الشكوى</div>
                        <div><strong>${complaint.complaintNumber || ''}</strong></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">الاسم</div>
                        <div>${complaint.fullName || ''}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">الهاتف</div>
                        <div>${complaint.phone || 'غير متوفر'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">البريد الإلكتروني</div>
                        <div>${complaint.email || 'غير متوفر'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">القسم</div>
                        <div>${complaint.department || ''}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">نوع المشكلة</div>
                        <div>${complaint.priority || ''}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">الحالة</div>
                        <div>${complaint.status || ''}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">تاريخ الإرسال</div>
                        <div>${createdAt}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">آخر تحديث</div>
                        <div>${updatedAt}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">تفاصيل المشكلة</div>
                        <div style="white-space:pre-line;background:#f8f9fa;padding:15px;border-radius:8px;border-right:4px solid #1a5fb4">${complaint.problemDetails || ''}</div>
                    </div>
                    ${complaint.response ? `
                    <div class="detail-item">
                        <div class="detail-label">الرد الرسمي</div>
                        <div style="white-space:pre-line;background:#e8f5e9;padding:15px;border-radius:8px;border-right:4px solid #2e7d32">
                            <strong>${officeSettings.replyName || 'مكتب النائب أحمد الحديدي'}:</strong><br>
                            ${complaint.response}<br><br>
                            ${officeSettings.replySignature || ''}
                        </div>
                    </div>
                    ` : ''}
                </div>
                <div style="margin-top:20px;padding-top:20px;border-top:1px solid #eee">
                    <h4 style="margin-bottom:10px;color:#2c3e50">تغيير الحالة:</h4>
                    <div style="display:flex;flex-wrap:wrap;gap:10px">
                        <button class="action-btn" style="background:#f39c12;color:#fff" onclick="updateStatus('${complaint.key}', 'قيد المراجعة')">
                            قيد المراجعة
                        </button>
                        <button class="action-btn" style="background:#f39c12;color:#fff" onclick="updateStatus('${complaint.key}', 'قيد المعالجة')">
                            قيد المعالجة
                        </button>
                        <button class="action-btn" style="background:#27ae60;color:#fff" onclick="updateStatus('${complaint.key}', 'مكتملة')">
                            مكتملة
                        </button>
                        <button class="action-btn" style="background:#e74c3c;color:#fff" onclick="updateStatus('${complaint.key}', 'ملغاة')">
                            ملغاة
                        </button>
                    </div>
                </div>`;
            
            document.getElementById('complaintDetailsModal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        async function updateStatus(complaintKey, newStatus) {
            if (!confirm(`هل تريد تغيير حالة الشكوى إلى "${newStatus}"؟`)) return;
            
            try {
                showLoading();
                await database.ref(`complaints/${complaintKey}`).update({
                    status: newStatus,
                    updatedAt: new Date().toISOString(),
                    updatedBy: currentUser.name
                });
                
                const index = allComplaints.findIndex(c => c.key === complaintKey);
                if (index !== -1) {
                    allComplaints[index].status = newStatus;
                    allComplaints[index].updatedAt = new Date().toISOString();
                }
                
                updateDashboardStats();
                updateDashboardCards();
                displayComplaintsTable();
                displayLatestComplaints();
                
                showMessage(`تم تحديث حالة الشكوى إلى "${newStatus}" بنجاح`, 'success');
                closeModal();
            } catch(err) {
                console.error(err);
                showMessage('حدث خطأ أثناء تحديث الحالة', 'error');
            } finally {
                hideLoading();
            }
        }

        function showAddUserModal() {
            document.getElementById('userModalTitle').textContent = 'إضافة مستخدم جديد';
            document.getElementById('userForm').reset();
            document.getElementById('userId').value = '';
            document.getElementById('userDepartments').selectedIndex = -1;
            updateSelectedDepartments();
            document.getElementById('userModal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function editUser(userKey) {
            const user = allUsers.find(u => u.key === userKey);
            if (!user) return;
            
            document.getElementById('userModalTitle').textContent = 'تعديل المستخدم';
            document.getElementById('userId').value = userKey;
            document.getElementById('userName').value = user.name || '';
            document.getElementById('userUsername').value = user.username || '';
            document.getElementById('userEmail').value = user.email || '';
            document.getElementById('userPhone').value = user.phone || '';
            document.getElementById('userRole').value = user.role || 'user';
            
            const departmentsSelect = document.getElementById('userDepartments');
            if (user.departments && Array.isArray(user.departments)) {
                for (let i = 0; i < departmentsSelect.options.length; i++) {
                    departmentsSelect.options[i].selected = user.departments.includes(departmentsSelect.options[i].value);
                }
            } else {
                departmentsSelect.selectedIndex = -1;
            }
            
            updateSelectedDepartments();
            document.getElementById('userPassword').required = false;
            document.getElementById('userConfirmPassword').required = false;
            document.getElementById('userModal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function updateSelectedDepartments() {
            const select = document.getElementById('userDepartments');
            const selectedContainer = document.getElementById('selectedDepartments');
            const selected = Array.from(select.selectedOptions).map(opt => opt.value);
            
            let html = '';
            selected.forEach(dept => {
                html += `<span class="department-tag">${dept}</span>`;
            });
            
            selectedContainer.innerHTML = html;
        }

        async function saveUser(e) {
            e.preventDefault();
            
            const userId = document.getElementById('userId').value;
            const name = document.getElementById('userName').value.trim();
            const username = document.getElementById('userUsername').value.trim();
            const email = document.getElementById('userEmail').value.trim();
            const phone = document.getElementById('userPhone').value.trim();
            const role = document.getElementById('userRole').value;
            const password = document.getElementById('userPassword').value;
            const confirmPassword = document.getElementById('userConfirmPassword').value;
            const departmentsSelect = document.getElementById('userDepartments');
            const departments = Array.from(departmentsSelect.selectedOptions).map(opt => opt.value);
            
            if (password && password !== confirmPassword) {
                showMessage('كلمات السر غير متطابقة', 'error');
                return;
            }
            
            const userData = {
                name,
                username,
                email,
                phone,
                role,
                departments,
                updatedAt: new Date().toISOString(),
                updatedBy: currentUser.name
            };
            
            if (password) {
                userData.password = password;
            }
            
            try {
                showLoading();
                if (userId) {
                    await database.ref(`users/${userId}`).update(userData);
                } else {
                    userData.createdAt = new Date().toISOString();
                    await database.ref('users').push(userData);
                }
                
                showMessage(`تم ${userId ? 'تحديث' : 'إضافة'} المستخدم بنجاح`, 'success');
                closeUserModal();
                loadUsers();
            } catch(err) {
                console.error(err);
                showMessage('حدث خطأ أثناء حفظ المستخدم', 'error');
            } finally {
                hideLoading();
            }
        }

        async function resetUserPassword(userKey) {
            const newPassword = prompt('أدخل كلمة السر الجديدة:');
            if (!newPassword) return;
            
            try {
                showLoading();
                await database.ref(`users/${userKey}`).update({
                    password: newPassword,
                    updatedAt: new Date().toISOString(),
                    updatedBy: currentUser.name
                });
                
                showMessage('تم إعادة تعيين كلمة السر بنجاح', 'success');
            } catch(err) {
                console.error(err);
                showMessage('حدث خطأ أثناء إعادة تعيين كلمة السر', 'error');
            } finally {
                hideLoading();
            }
        }

        async function deleteUser(userKey) {
            if (!confirm('هل تريد حذف هذا المستخدم؟ لا يمكن التراجع عن هذا الإجراء.')) return;
            
            try {
                showLoading();
                await database.ref(`users/${userKey}`).remove();
                showMessage('تم حذف المستخدم بنجاح', 'success');
                loadUsers();
            } catch(err) {
                console.error(err);
                showMessage('حدث خطأ أثناء حذف المستخدم', 'error');
            } finally {
                hideLoading();
            }
        }

        function closeUserModal() {
            document.getElementById('userModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function showReplyModal(complaintKey) {
            document.getElementById('replyComplaintId').value = complaintKey;
            document.getElementById('replyModal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        async function sendReply(e) {
            e.preventDefault();
            
            const complaintKey = document.getElementById('replyComplaintId').value;
            const replyText = document.getElementById('replyText').value.trim();
            
            if (!replyText) {
                showMessage('يرجى كتابة نص الرد', 'error');
                return;
            }
            
            try {
                showLoading();
                await database.ref(`complaints/${complaintKey}`).update({
                    response: replyText,
                    status: 'تم الرد',
                    updatedAt: new Date().toISOString(),
                    respondedBy: currentUser.name,
                    responseDate: new Date().toISOString()
                });
                
                const index = allComplaints.findIndex(c => c.key === complaintKey);
                if (index !== -1) {
                    allComplaints[index].response = replyText;
                    allComplaints[index].status = 'تم الرد';
                    allComplaints[index].updatedAt = new Date().toISOString();
                }
                
                showMessage('تم إرسال الرد بنجاح', 'success');
                closeReplyModal();
                closeModal();
                updateDashboardStats();
                displayComplaintsTable();
            } catch(err) {
                console.error(err);
                showMessage('حدث خطأ أثناء إرسال الرد', 'error');
            } finally {
                hideLoading();
            }
        }

        function closeReplyModal() {
            document.getElementById('replyModal').style.display = 'none';
            document.getElementById('replyForm').reset();
            document.body.style.overflow = 'auto';
        }

        async function downloadComplaintPDF(complaintKey) {
            const complaint = allComplaints.find(c => c.key === complaintKey);
            if (!complaint) return;
            
            try {
                showLoading();
                // إنشاء محتوى PDF
                const htmlContent = `
                    <!DOCTYPE html>
                    <html dir="rtl">
                    <head>
                        <meta charset="UTF-8">
                        <style>
                            body { font-family: 'Cairo', sans-serif; padding: 20px; color: #333; }
                            .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #1a5fb4; padding-bottom: 15px; }
                            .header h1 { color: #1a5fb4; margin-bottom: 10px; }
                            .info-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                            .info-table td { padding: 10px; border: 1px solid #ddd; }
                            .info-table .label { background: #f8f9fa; font-weight: bold; width: 30%; }
                            .details { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 20px 0; border-right: 4px solid #1a5fb4; }
                            .response { background: #e8f5e9; padding: 15px; border-radius: 8px; margin: 20px 0; border-right: 4px solid #2e7d32; }
                            .footer { margin-top: 40px; text-align: center; color: #666; font-size: 12px; border-top: 1px solid #ddd; padding-top: 15px; }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1>نظام الشكاوى الموحد</h1>
                            <h2>تفاصيل الشكوى رقم: ${complaint.complaintNumber || ''}</h2>
                            <p>تم إنشاء هذا التقرير في: ${new Date().toLocaleString('ar-EG')}</p>
                        </div>
                        
                        <table class="info-table">
                            <tr><td class="label">رقم الشكوى:</td><td>${complaint.complaintNumber || ''}</td></tr>
                            <tr><td class="label">الاسم:</td><td>${complaint.fullName || ''}</td></tr>
                            <tr><td class="label">الهاتف:</td><td>${complaint.phone || 'غير متوفر'}</td></tr>
                            <tr><td class="label">البريد الإلكتروني:</td><td>${complaint.email || 'غير متوفر'}</td></tr>
                            <tr><td class="label">القسم:</td><td>${complaint.department || ''}</td></tr>
                            <tr><td class="label">نوع المشكلة:</td><td>${complaint.priority || ''}</td></tr>
                            <tr><td class="label">الحالة:</td><td>${complaint.status || ''}</td></tr>
                            <tr><td class="label">تاريخ الإرسال:</td><td>${complaint.createdAt ? new Date(complaint.createdAt).toLocaleString('ar-EG') : '-'}</td></tr>
                            <tr><td class="label">آخر تحديث:</td><td>${complaint.updatedAt ? new Date(complaint.updatedAt).toLocaleString('ar-EG') : '-'}</td></tr>
                        </table>
                        
                        <h3>تفاصيل المشكلة:</h3>
                        <div class="details">${complaint.problemDetails || ''}</div>
                        
                        ${complaint.response ? `
                        <h3>الرد الرسمي:</h3>
                        <div class="response">
                            <strong>${officeSettings.replyName || 'مكتب النائب أحمد الحديدي'}:</strong><br>
                            ${complaint.response}<br><br>
                            ${officeSettings.replySignature || ''}
                        </div>
                        ` : ''}
                        
                        <div class="footer">
                            <p>© 2026 نظام الشكاوى الموحد - جميع الحقوق محفوظة</p>
                            <p>رقم مكتب النائب للتواصل: ${officeSettings.whatsappNumber || '+201234567890'}</p>
                        </div>
                    </body>
                    </html>
                `;
                
                // فتح النافذة لطباعة PDF
                const printWindow = window.open('', '_blank');
                printWindow.document.write(htmlContent);
                printWindow.document.close();
                printWindow.print();
                
                showMessage('جاري تحضير ملف PDF للتنزيل', 'success');
            } catch(err) {
                console.error(err);
                showMessage('حدث خطأ أثناء إنشاء ملف PDF', 'error');
            } finally {
                hideLoading();
            }
        }

        async function editComplaint(complaintKey) {
            showMessage('سيتم إضافة ميزة تعديل الشكوى في التحديثات القادمة', 'success');
        }

        async function deleteComplaint(complaintKey) {
            if (!confirm('هل تريد حذف هذه الشكوى؟ لا يمكن التراجع عن هذا الإجراء.')) return;
            
            try {
                showLoading();
                await database.ref(`complaints/${complaintKey}`).remove();
                
                const index = allComplaints.findIndex(c => c.key === complaintKey);
                if (index !== -1) {
                    allComplaints.splice(index, 1);
                }
                
                showMessage('تم حذف الشكوى بنجاح', 'success');
                closeModal();
                updateDashboardStats();
                displayComplaintsTable();
            } catch(err) {
                console.error(err);
                showMessage('حدث خطأ أثناء حذف الشكوى', 'error');
            } finally {
                hideLoading();
            }
        }

        async function saveSettings(e) {
            e.preventDefault();
            
            const newSettings = {
                systemName: document.getElementById('systemName').value,
                systemTitle: document.getElementById('systemTitle').value,
                itemsPerPage: document.getElementById('itemsPerPage').value,
                enableNotifications: document.getElementById('enableNotifications').checked,
                enableReminders: document.getElementById('enableReminders').checked,
                welcomeMessage: document.getElementById('welcomeMessage').value,
                notificationEmail: document.getElementById('notificationEmail').value
            };
            
            try {
                showLoading();
                await database.ref('settings').set(newSettings);
                settings = newSettings;
                applySettings();
                showMessage('تم حفظ الإعدادات بنجاح', 'success');
            } catch(err) {
                console.error(err);
                showMessage('حدث خطأ أثناء حفظ الإعدادات', 'error');
            } finally {
                hideLoading();
            }
        }

        async function saveOfficeSettings(e) {
            e.preventDefault();
            
            const newOfficeSettings = {
                whatsappNumber: document.getElementById('officeWhatsappNumber').value,
                replyName: document.getElementById('officeReplyName').value,
                replySignature: document.getElementById('officeReplySignature').value
            };
            
            try {
                showLoading();
                await database.ref('officeSettings').set(newOfficeSettings);
                officeSettings = newOfficeSettings;
                applyOfficeSettings();
                showMessage('تم حفظ إعدادات المكتب بنجاح', 'success');
            } catch(err) {
                console.error(err);
                showMessage('حدث خطأ أثناء حفظ إعدادات المكتب', 'error');
            } finally {
                hideLoading();
            }
        }

        function addNewDepartment() {
            showMessage('سيتم إضافة هذه الميزة في التحديثات القادمة', 'success');
        }

        function generateReports() {
            const period = document.getElementById('reportPeriod').value;
            const now = new Date();
            let startDate;
            
            switch(period) {
                case 'week':
                    startDate = new Date(now.setDate(now.getDate() - 7));
                    break;
                case 'month':
                    startDate = new Date(now.setMonth(now.getMonth() - 1));
                    break;
                case 'quarter':
                    startDate = new Date(now.setMonth(now.getMonth() - 3));
                    break;
                case 'year':
                    startDate = new Date(now.setFullYear(now.getFullYear() - 1));
                    break;
            }
            
            const filtered = allComplaints.filter(c => new Date(c.createdAt) >= startDate);
            const total = filtered.length;
            const completed = filtered.filter(c => c.status === 'مكتملة').length;
            const completionRate = total > 0 ? Math.round((completed / total) * 100) : 0;
            
            let totalDays = 0;
            let count = 0;
            filtered.forEach(c => {
                if (c.createdAt && c.updatedAt && c.status === 'مكتملة') {
                    const created = new Date(c.createdAt);
                    const updated = new Date(c.updatedAt);
                    const days = Math.round((updated - created) / (1000 * 60 * 60 * 24));
                    totalDays += days;
                    count++;
                }
            });
            const avgTime = count > 0 ? Math.round(totalDays / count) : 0;
            const satisfactionRate = completionRate > 80 ? 95 : completionRate > 60 ? 85 : 70;
            
            document.getElementById('reportTotal').textContent = total;
            document.getElementById('reportCompletionRate').textContent = `${completionRate}%`;
            document.getElementById('reportAvgTime').textContent = `${avgTime} يوم`;
            document.getElementById('reportSatisfaction').textContent = `${satisfactionRate}%`;
        }

        function exportComplaints() {
            showMessage('سيتم إضافة ميزة التصدير في التحديثات القادمة', 'success');
        }

        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(sec => {
                sec.classList.remove('active');
                if (sec.id === sectionId + 'Section') {
                    sec.classList.add('active');
                }
            });
            
            currentSection = sectionId;
            
            if (sectionId === 'reports') {
                generateReports();
            }
        }

        function updateMobileNav(clickedItem) {
            document.querySelectorAll('.mobile-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            clickedItem.classList.add('active');
        }

        function openSidebar() {
            document.getElementById('sidebar').classList.add('active');
            document.getElementById('sidebarOverlay').style.display = 'block';
        }

        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('active');
            document.getElementById('sidebarOverlay').style.display = 'none';
        }

        function closeModal() {
            document.getElementById('complaintDetailsModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function showMessage(text, type='success') {
            const old = document.getElementById('globalMessage');
            if (old) old.remove();
            const msg = document.createElement('div');
            msg.id = 'globalMessage';
            msg.className = 'message' + (type === 'error' ? ' error' : '');
            msg.textContent = text;
            document.body.appendChild(msg);
            setTimeout(() => { msg.remove(); }, 4000);
        }
    </script>
</body>
</html>
