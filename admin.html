<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>لوحة التحكم - نظام الشكاوى الموحد</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Cairo', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            width: 100%;
        }
        
        /* تحسينات للطباعة */
        @media print {
            body * {
                visibility: hidden;
                background: white !important;
                color: black !important;
            }
            
            .print-content, .print-content * {
                visibility: visible !important;
            }
            
            .print-content {
                position: absolute !important;
                left: 0 !important;
                top: 0 !important;
                width: 100% !important;
                height: auto !important;
                padding: 0 !important;
                margin: 0 !important;
                font-size: 12pt !important;
                line-height: 1.5 !important;
            }
            
            .print-content .no-print {
                display: none !important;
            }
            
            .print-content .break-before {
                page-break-before: always !important;
            }
            
            .print-content .avoid-break {
                page-break-inside: avoid !important;
            }
            
            @page {
                size: A4;
                margin: 20mm;
            }
        }
        
        /* تحسينات للاستجابة */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .admin-bar {
                flex-direction: column !important;
                align-items: stretch !important;
                gap: 15px !important;
            }
            
            .admin-stats {
                flex-wrap: wrap !important;
                justify-content: center !important;
            }
            
            .stat-box {
                min-width: 45% !important;
                margin-bottom: 10px !important;
            }
            
            .filters-container {
                flex-direction: column !important;
            }
            
            .filter-select, .search-input {
                width: 100% !important;
                min-width: unset !important;
                max-width: 100% !important;
            }
            
            .action-buttons {
                flex-wrap: wrap !important;
            }
            
            .action-btn {
                margin-bottom: 5px !important;
            }
            
            .modal-content {
                width: 95% !important;
                max-width: 95% !important;
                margin: 10px !important;
                padding: 15px !important;
            }
        }
        
        @media (max-width: 480px) {
            .stat-box {
                min-width: 100% !important;
            }
            
            .btn {
                padding: 8px 12px !important;
                font-size: 14px !important;
            }
            
            .complaints-table th, 
            .complaints-table td {
                padding: 8px 5px !important;
                font-size: 12px !important;
            }
            
            .status-badge, .priority-badge {
                font-size: 11px !important;
                padding: 4px 8px !important;
                min-width: 80px !important;
            }
        }
    </style>
</head>
<body>
    <!-- شاشة تسجيل الدخول -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <div class="login-logo">
                <i class="fas fa-user-shield"></i>
            </div>
            <h2 class="login-title">تسجيل دخول المسؤول</h2>
            <form id="loginForm" class="login-form">
                <div class="form-group">
                    <label class="form-label">اسم المستخدم / البريد الإلكتروني</label>
                    <input type="text" class="form-control" id="username" placeholder="أدخل اسم المستخدم" required>
                </div>
                <div class="form-group">
                    <label class="form-label">كلمة المرور</label>
                    <input type="password" class="form-control" id="password" placeholder="أدخل كلمة المرور" required>
                </div>
                <div class="login-error" id="loginError">
                    اسم المستخدم أو كلمة المرور غير صحيحة
                </div>
                <button type="submit" class="login-btn">
                    <i class="fas fa-sign-in-alt"></i>
                    تسجيل الدخول
                </button>
            </form>
        </div>
    </div>
    
    <!-- لوحة التحكم (تظهر بعد تسجيل الدخول) -->
    <div id="dashboardScreen" style="display: none;">
        <header>
            <div class="container">
                <h1 class="logo">لوحة التحكم - نظام الشكاوى الموحد</h1>
                <p class="subtitle">إدارة الشكاوى والطلبات المقدمة من المواطنين</p>
            </div>
        </header>
        
        <div class="container">
            <div class="admin-bar">
                <div class="admin-info">
                    <div class="admin-avatar">
                        <i class="fas fa-user-shield"></i>
                    </div>
                    <div>
                        <h3 style="margin-bottom: 5px;" id="adminWelcome">مرحباً، المسؤول أحمد</h3>
                        <p style="opacity: 0.9; font-size: 0.9rem;" id="adminLastLogin">آخر دخول: اليوم الساعة 10:30 صباحاً</p>
                    </div>
                </div>
                
                <div class="admin-stats">
                    <div class="stat-box">
                        <div class="stat-value" id="totalComplaints">0</div>
                        <div class="stat-label">إجمالي الشكاوى</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="newComplaints">0</div>
                        <div class="stat-label">شكاوى جديدة</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="resolvedComplaints">0</div>
                        <div class="stat-label">تم حلها</div>
                    </div>
                </div>
                
                <button class="logout-btn" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    تسجيل الخروج
                </button>
            </div>
            
            <div class="dashboard-grid">
                <!-- ... بقية الكود كما هو ... -->
            </div>
        </div>
        
        <!-- نافذة عرض تفاصيل الشكوى -->
        <div class="complaint-details-modal" id="complaintDetailsModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">تفاصيل الشكوى</h3>
                    <button class="close-modal" id="closeModal">&times;</button>
                </div>
                <div class="modal-body" id="modalBody">
                    <!-- سيتم ملؤها بواسطة JavaScript -->
                </div>
            </div>
        </div>
        
        <!-- نافذة الطباعة المنفصلة (مخفية) -->
        <div id="printContainer" style="display: none; position: absolute; left: -9999px; top: -9999px;"></div>
    </div>
    
    <!-- Firebase SDK - Compat Version -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <script>
        // بيانات المسؤولين الرئيسيين
        const ADMIN_USERS = [
            {
                username: "admin",
                password: "742018",
                name: "مهندس محمد نصر",
                role: "admin"
            },
            {
                username: "engineer",
                password: "123456",
                name: "مهندس محمد نصر",
                role: "admin"
            }
        ];
        
        // قائمة الأقسام المتاحة
        const DEPARTMENTS = [
            "مشكلة خاصة بالقضاء والمحكام",
            "مساعدة مالية",
            "مشكلة خاصة بالصحة",
            "مشكلات مياه الشرب والصرف الصحي",
            "مشكلة خاصة بالتعليم",
            "مشكلة خاصة بالشرطة والداخلية",
            "حالة طارئة",
            "مشكلات أخرى"
        ];
        
        // حالة تسجيل الدخول
        let isLoggedIn = false;
        let currentUser = null;
        
        // متغيرات التطبيق
        let currentSection = 'dashboard';
        let allComplaints = [];
        let filteredComplaints = [];
        let allUsers = [];
        let currentPage = 1;
        const itemsPerPage = 10;
        
        // مراجع الاستماع للتحديثات الفورية
        let complaintsListener = null;
        let usersListener = null;
        
        // تهيئة Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBIIStbiZD0ZJ6su7C1bwZlBvqx-PP-t58",
            authDomain: "shakawa-e0a3c.firebaseapp.com",
            databaseURL: "https://shakawa-e0a3c-default-rtdb.firebaseio.com",
            projectId: "shakawa-e0a3c",
            storageBucket: "shakawa-e0a3c.firebasestorage.app",
            messagingSenderId: "111620348664",
            appId: "1:111620348664:web:670fdf5caed46eb691b90d",
            measurementId: "G-SGNTJZDQ1L"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // تهيئة الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            // التحقق من حالة تسجيل الدخول
            checkLoginStatus();
            
            // إضافة مستمعي الأحداث لتسجيل الدخول
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // إضافة مستمعي الأحداث للقائمة الجانبية
            const menuItems = document.querySelectorAll('.menu-item');
            menuItems.forEach(item => {
                item.addEventListener('click', function() {
                    if (this.classList.contains('admin-only') && !(currentUser && currentUser.role === 'admin')) {
                        showMessage('يجب تسجيل الدخول كمسؤول للوصول إلى هذا القسم', 'error');
                        return;
                    }
                    
                    // إزالة النشاط من جميع العناصر
                    menuItems.forEach(i => i.classList.remove('active'));
                    // إضافة النشاط للعنصر الحالي
                    this.classList.add('active');
                    // عرض القسم المحدد
                    const sectionId = this.getAttribute('data-section');
                    showSection(sectionId);
                });
            });
            
            // إضافة مستمعي الأحداث للتصفية
            document.getElementById('filterStatus').addEventListener('change', filterComplaints);
            document.getElementById('filterDepartment').addEventListener('change', filterComplaints);
            document.getElementById('filterPriority').addEventListener('change', filterComplaints);
            document.getElementById('searchInput').addEventListener('input', filterComplaints);
            
            // إضافة مستمعي الأحداث للترقيم
            document.getElementById('prevPage').addEventListener('click', () => changePage(-1));
            document.getElementById('nextPage').addEventListener('click', () => changePage(1));
            
            // إضافة مستمعي الأحداث للأزرار
            document.getElementById('refreshComplaints').addEventListener('click', loadComplaints);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            document.getElementById('closeModal').addEventListener('click', closeModal);
            
            // إغلاق النافذة المنبثقة عند النقر خارجها
            document.getElementById('complaintDetailsModal').addEventListener('click', function(e) {
                if (e.target === this) closeModal();
            });
            
            // إضافة مستمع لتغيير حجم النافذة لتحسين الاستجابة
            window.addEventListener('resize', handleResize);
            
            // إضافة زر القائمة المتنقلة للشاشات الصغيرة
            addMobileMenuButton();
        });
        
        // دالة التحقق من حالة تسجيل الدخول
        function checkLoginStatus() {
            const savedLogin = localStorage.getItem('adminLoggedIn');
            const savedUser = localStorage.getItem('adminUser');
            
            if (savedLogin === 'true' && savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    isLoggedIn = true;
                    showDashboard();
                    startRealtimeUpdates();
                } catch (e) {
                    localStorage.removeItem('adminLoggedIn');
                    localStorage.removeItem('adminUser');
                    showLogin();
                }
            } else {
                showLogin();
            }
        }
        
        // دالة بدء التحديثات الفورية
        function startRealtimeUpdates() {
            // إيقاف المستمعين السابقين إذا كانوا موجودين
            stopRealtimeUpdates();
            
            // بدء الاستماع للتحديثات الفورية للشكاوى
            complaintsListener = database.ref('complaints').on('value', handleComplaintsUpdate);
            
            // إذا كان المستخدم مسؤولاً، استمع لتحديثات المستخدمين أيضاً
            if (currentUser && currentUser.role === 'admin') {
                usersListener = database.ref('users').on('value', handleUsersUpdate);
            }
        }
        
        // دالة إيقاف التحديثات الفورية
        function stopRealtimeUpdates() {
            if (complaintsListener) {
                database.ref('complaints').off('value', complaintsListener);
                complaintsListener = null;
            }
            
            if (usersListener) {
                database.ref('users').off('value', usersListener);
                usersListener = null;
            }
        }
        
        // معالج تحديث الشكاوى الفوري
        function handleComplaintsUpdate(snapshot) {
            if (!snapshot.exists()) {
                allComplaints = [];
                showMessage('لا توجد شكاوى في النظام', 'info');
                updateDashboardStats();
                filterComplaints();
                updateSidebarBadge();
                return;
            }
            
            allComplaints = [];
            snapshot.forEach((childSnapshot) => {
                const complaint = childSnapshot.val();
                complaint.key = childSnapshot.key;
                allComplaints.push(complaint);
            });
            
            // ترتيب الشكاوى من الأحدث إلى الأقدم
            allComplaints.sort((a, b) => {
                return new Date(b.createdAt) - new Date(a.createdAt);
            });
            
            // تحديث الإحصائيات
            updateDashboardStats();
            
            // تحديث قائمة الشكوى
            filterComplaints();
            
            // تحديث القائمة الجانبية
            updateSidebarBadge();
            
            // التحقق من المشكلات الحرجة
            setTimeout(checkCriticalProblems, 1000);
        }
        
        // معالج تحديث المستخدمين الفوري
        function handleUsersUpdate(snapshot) {
            if (!snapshot.exists()) {
                allUsers = [];
                if (currentSection === 'users') {
                    displayUsersTable();
                }
                return;
            }
            
            allUsers = [];
            snapshot.forEach((childSnapshot) => {
                const user = childSnapshot.val();
                user.key = childSnapshot.key;
                allUsers.push(user);
            });
            
            if (currentSection === 'users') {
                displayUsersTable();
            }
        }
        
        // دالة تسجيل الدخول
        function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');
            
            // البحث عن المستخدم في قائمة المسؤولين الرئيسيين
            const adminUser = ADMIN_USERS.find(user => 
                user.username === username && user.password === password
            );
            
            if (adminUser) {
                loginSuccess(adminUser);
            } else {
                // البحث في قاعدة بيانات المستخدمين
                checkDatabaseUser(username, password);
            }
        }
        
        // دالة تسجيل الدخول الناجح
        function loginSuccess(userData) {
            isLoggedIn = true;
            currentUser = {
                username: userData.username,
                name: userData.name,
                role: userData.role,
                loginTime: new Date().toISOString(),
                allowedDepartments: userData.allowedDepartments || DEPARTMENTS // جميع الأقسام للمسؤولين
            };
            
            // حفظ حالة تسجيل الدخول
            localStorage.setItem('adminLoggedIn', 'true');
            localStorage.setItem('adminUser', JSON.stringify(currentUser));
            
            showDashboard();
            startRealtimeUpdates();
            showMessage(`مرحباً ${currentUser.name}! تم تسجيل الدخول بنجاح`, 'success');
        }
        
        // دالة للتحقق من المستخدمين في قاعدة البيانات
        async function checkDatabaseUser(username, password) {
            try {
                const usersRef = database.ref('users');
                const snapshot = await usersRef.once('value');
                
                if (!snapshot.exists()) {
                    document.getElementById('loginError').style.display = 'block';
                    return;
                }
                
                let userFound = false;
                snapshot.forEach((childSnapshot) => {
                    const user = childSnapshot.val();
                    
                    // التحقق من البريد الإلكتروني أو اسم المستخدم
                    const isEmailMatch = user.email && user.email === username;
                    const isUsernameMatch = user.username && user.username === username;
                    
                    if ((isEmailMatch || isUsernameMatch) && user.password && atob(user.password) === password) {
                        // التحقق من حالة المستخدم
                        if (user.status && user.status !== 'active') {
                            showMessage('حسابك غير نشط، يرجى التواصل مع المسؤول', 'error');
                            return;
                        }
                        
                        isLoggedIn = true;
                        currentUser = {
                            username: user.email || user.username,
                            name: user.name,
                            role: user.role,
                            loginTime: new Date().toISOString(),
                            key: childSnapshot.key,
                            allowedDepartments: user.allowedDepartments || []
                        };
                        
                        // تحديث آخر دخول
                        database.ref('users/' + childSnapshot.key).update({
                            lastLogin: new Date().toISOString(),
                            loginCount: (user.loginCount || 0) + 1
                        });
                        
                        // حفظ حالة تسجيل الدخول
                        localStorage.setItem('adminLoggedIn', 'true');
                        localStorage.setItem('adminUser', JSON.stringify(currentUser));
                        
                        showDashboard();
                        startRealtimeUpdates();
                        showMessage(`مرحباً ${user.name}! تم تسجيل الدخول بنجاح`, 'success');
                        
                        userFound = true;
                    }
                });
                
                if (!userFound) {
                    document.getElementById('loginError').style.display = 'block';
                }
                
            } catch (error) {
                console.error('Error checking database user:', error);
                document.getElementById('loginError').style.display = 'block';
            }
        }
        
        // دالة تسجيل الخروج
        function handleLogout() {
            if (confirm('هل تريد تسجيل الخروج من لوحة التحكم؟')) {
                isLoggedIn = false;
                currentUser = null;
                stopRealtimeUpdates();
                localStorage.removeItem('adminLoggedIn');
                localStorage.removeItem('adminUser');
                showLogin();
            }
        }
        
        // دالة عرض شاشة تسجيل الدخول
        function showLogin() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('dashboardScreen').style.display = 'none';
        }
        
        // دالة عرض لوحة التحكم
        function showDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboardScreen').style.display = 'block';
            
            // تحديث ترحيب المسؤول
            updateAdminWelcome();
            
            // التحكم بعرض عناصر القائمة الجانبية حسب صلاحية المستخدم
            updateSidebarPermissions();
            
            // إظهار قسم لوحة التحكم بشكل افتراضي
            showSection('dashboard');
        }
        
        // دالة تحديث ترحيب المسؤول
        function updateAdminWelcome() {
            if (currentUser) {
                const welcomeElement = document.getElementById('adminWelcome');
                const lastLoginElement = document.getElementById('adminLastLogin');
                
                welcomeElement.textContent = `مرحباً، ${currentUser.name}`;
                
                // تنسيق وقت آخر دخول
                if (currentUser.loginTime) {
                    const loginTime = new Date(currentUser.loginTime);
                    const options = {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    };
                    lastLoginElement.textContent = `آخر دخول: ${loginTime.toLocaleDateString('ar-EG', options)}`;
                }
            }
        }
        
        // دالة معالجة تغيير حجم النافذة
        function handleResize() {
            // تحديث الجداول لتكون متجاوبة
            updateTableResponsiveness();
            
            // إظهار/إخفاء القائمة الجانبية حسب حجم الشاشة
            toggleSidebarForMobile();
        }
        
        // دالة تحديث استجابة الجداول
        function updateTableResponsiveness() {
            const tables = document.querySelectorAll('.complaints-table, .users-table');
            const isMobile = window.innerWidth < 768;
            
            tables.forEach(table => {
                if (isMobile) {
                    table.style.fontSize = '12px';
                } else {
                    table.style.fontSize = '';
                }
            });
        }
        
        // دالة إضافة زر القائمة المتنقلة
        function addMobileMenuButton() {
            const header = document.querySelector('header .container');
            const mobileMenuBtn = document.createElement('button');
            
            mobileMenuBtn.innerHTML = '<i class="fas fa-bars"></i>';
            mobileMenuBtn.className = 'mobile-menu-btn';
            mobileMenuBtn.style.cssText = `
                position: absolute;
                left: 20px;
                top: 20px;
                background: rgba(255,255,255,0.2);
                border: none;
                color: white;
                font-size: 1.5rem;
                padding: 10px;
                border-radius: 5px;
                cursor: pointer;
                display: none;
                z-index: 100;
            `;
            
            header.style.position = 'relative';
            header.appendChild(mobileMenuBtn);
            
            mobileMenuBtn.addEventListener('click', function() {
                const sidebar = document.querySelector('.sidebar');
                if (sidebar.style.display === 'block') {
                    sidebar.style.display = 'none';
                } else {
                    sidebar.style.display = 'block';
                    sidebar.style.position = 'fixed';
                    sidebar.style.top = '80px';
                    sidebar.style.left = '20px';
                    sidebar.style.right = '20px';
                    sidebar.style.zIndex = '99';
                    sidebar.style.boxShadow = '0 10px 30px rgba(0,0,0,0.3)';
                }
            });
            
            // التحقق من حجم الشاشة عند التحميل
            if (window.innerWidth < 1200) {
                mobileMenuBtn.style.display = 'block';
                document.querySelector('.sidebar').style.display = 'none';
            }
            
            // تحديث العرض عند تغيير حجم النافذة
            window.addEventListener('resize', function() {
                if (window.innerWidth < 1200) {
                    mobileMenuBtn.style.display = 'block';
                } else {
                    mobileMenuBtn.style.display = 'none';
                    document.querySelector('.sidebar').style.display = 'block';
                    document.querySelector('.sidebar').style.position = '';
                    document.querySelector('.sidebar').style.top = '';
                    document.querySelector('.sidebar').style.left = '';
                    document.querySelector('.sidebar').style.right = '';
                    document.querySelector('.sidebar').style.zIndex = '';
                    document.querySelector('.sidebar').style.boxShadow = '';
                }
            });
        }
        
        // دالة تبديل القائمة الجانبية للجوال
        function toggleSidebarForMobile() {
            const sidebar = document.querySelector('.sidebar');
            const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
            
            if (window.innerWidth < 1200) {
                if (mobileMenuBtn) mobileMenuBtn.style.display = 'block';
                // لا نخفي القائمة الجانبية إذا كانت مفتوحة
            } else {
                if (mobileMenuBtn) mobileMenuBtn.style.display = 'none';
                sidebar.style.display = 'block';
                sidebar.style.position = '';
                sidebar.style.top = '';
                sidebar.style.left = '';
                sidebar.style.right = '';
                sidebar.style.zIndex = '';
                sidebar.style.boxShadow = '';
            }
        }
        
        // دالة تحديث صلاحيات القائمة الجانبية
        function updateSidebarPermissions() {
            const adminOnlyElements = document.querySelectorAll('.admin-only');
            
            if (currentUser && currentUser.role === 'admin') {
                // المسؤول يرى كل شيء
                adminOnlyElements.forEach(el => {
                    el.classList.add('visible');
                    el.classList.remove('hidden-for-supervisor');
                });
            } else if (currentUser && currentUser.role === 'moderator') {
                // المشرف لا يرى بعض الأقسام
                adminOnlyElements.forEach(el => {
                    if (el.getAttribute('data-section') === 'users' || 
                        el.getAttribute('data-section') === 'settings') {
                        el.classList.add('hidden-for-supervisor');
                        el.classList.remove('visible');
                    } else {
                        el.classList.add('visible');
                        el.classList.remove('hidden-for-supervisor');
                    }
                });
            } else {
                // المستخدم العادي لا يرى أي عناصر إدارية
                adminOnlyElements.forEach(el => {
                    el.classList.remove('visible');
                    el.classList.add('hidden-for-supervisor');
                });
            }
        }
        
        // دالة عرض القسم المحدد
        function showSection(sectionId) {
            // إخفاء جميع الأقسام
            const sections = document.querySelectorAll('.content-section');
            sections.forEach(section => {
                section.style.display = 'none';
            });
            
            // عرض القسم المحدد
            document.getElementById(sectionId + 'Section').style.display = 'block';
            currentSection = sectionId;
            
            // إذا كان القسم هو الشكاوى، قم بتحديث القائمة
            if (sectionId === 'complaints') {
                filterComplaints();
            }
            
            // إذا كان القسم هو المستخدمين، قم بتحميل المستخدمين
            if (sectionId === 'users' && currentUser && currentUser.role === 'admin') {
                displayUsersTable();
            }
            
            // إغلاق القائمة الجانبية على الأجهزة المحمولة
            if (window.innerWidth < 1200) {
                document.querySelector('.sidebar').style.display = 'none';
            }
        }
        
        // دالة تحميل الشكاوى من Firebase (للحالات التي نحتاج فيها إلى تحميل لمرة واحدة)
        async function loadComplaints() {
            try {
                const complaintsRef = database.ref('complaints');
                const snapshot = await complaintsRef.once('value');
                
                if (!snapshot.exists()) {
                    allComplaints = [];
                    showMessage('لا توجد شكاوى في النظام', 'info');
                    return;
                }
                
                allComplaints = [];
                snapshot.forEach((childSnapshot) => {
                    const complaint = childSnapshot.val();
                    complaint.key = childSnapshot.key;
                    allComplaints.push(complaint);
                });
                
                // ترتيب الشكاوى من الأحدث إلى الأقدم
                allComplaints.sort((a, b) => {
                    return new Date(b.createdAt) - new Date(a.createdAt);
                });
                
                // تحديث الإحصائيات
                updateDashboardStats();
                
                // تحديث قائمة الشكوى
                filterComplaints();
                
                // تحديث القائمة الجانبية
                updateSidebarBadge();
                
                // التحقق من المشكلات الحرجة
                setTimeout(checkCriticalProblems, 1000);
                
                showMessage('تم تحديث قائمة الشكاوى', 'success');
                
            } catch (error) {
                console.error('Error loading complaints:', error);
                showMessage('حدث خطأ أثناء تحميل الشكاوى', 'error');
            }
        }
        
        // دالة تصفية الشكاوى مع مراعاة صلاحيات المشرف
        function filterComplaints() {
            const statusFilter = document.getElementById('filterStatus').value;
            const departmentFilter = document.getElementById('filterDepartment').value;
            const priorityFilter = document.getElementById('filterPriority').value;
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            
            // تصفية أولية حسب صلاحيات المستخدم
            let prelimFilteredComplaints = allComplaints;
            
            // إذا كان المستخدم مشرفاً وله أقسام محددة
            if (currentUser && currentUser.role === 'moderator' && 
                currentUser.allowedDepartments && currentUser.allowedDepartments.length > 0) {
                
                prelimFilteredComplaints = allComplaints.filter(complaint => {
                    return currentUser.allowedDepartments.includes(complaint.department);
                });
            }
            
            // تطبيق المرشحات الإضافية
            filteredComplaints = prelimFilteredComplaints.filter(complaint => {
                // تطبيق مرشح الحالة
                if (statusFilter && complaint.status !== statusFilter) {
                    return false;
                }
                
                // تطبيق مرشح القسم
                if (departmentFilter && complaint.department !== departmentFilter) {
                    return false;
                }
                
                // تطبيق مرشح الأولوية
                if (priorityFilter && complaint.priority !== priorityFilter) {
                    return false;
                }
                
                // تطبيق البحث النصي
                if (searchText) {
                    const matchesNumber = complaint.complaintNumber && 
                                          complaint.complaintNumber.toLowerCase().includes(searchText);
                    const matchesName = complaint.fullName && 
                                        complaint.fullName.toLowerCase().includes(searchText);
                    const matchesNationalId = complaint.nationalId && 
                                              complaint.nationalId.includes(searchText);
                    
                    if (!matchesNumber && !matchesName && !matchesNationalId) {
                        return false;
                    }
                }
                
                return true;
            });
            
            // عرض الشكاوى المصفاة
            currentPage = 1;
            displayComplaintsTable();
            updatePagination();
            
            // إذا كان القسم الحالي هو لوحة التحكم، قم بتحديث الشكاوى الأخيرة
            if (currentSection === 'dashboard') {
                displayRecentComplaints();
            }
        }
        
        // دالة طباعة الشكوى بشكل كامل مع تحسينات الطباعة
        function printComplaint(complaintKey) {
            const complaint = allComplaints.find(c => c.key === complaintKey);
            
            if (!complaint) {
                showMessage('لم يتم العثور على الشكوى', 'error');
                return;
            }
            
            // إنشاء محتوى الطباعة
            const printContent = generatePrintContent(complaint);
            
            // إضافة المحتوى إلى حاوية الطباعة المخفية
            const printContainer = document.getElementById('printContainer');
            printContainer.innerHTML = printContent;
            
            // استخدام iframe للطباعة لتحسين التحكم
            const printFrame = document.createElement('iframe');
            printFrame.style.display = 'none';
            document.body.appendChild(printFrame);
            
            const printDocument = printFrame.contentDocument || printFrame.contentWindow.document;
            printDocument.open();
            printDocument.write(`
                <!DOCTYPE html>
                <html dir="rtl" lang="ar">
                <head>
                    <meta charset="UTF-8">
                    <title>طباعة الشكوى - ${complaint.complaintNumber || 'غير معروف'}</title>
                    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
                    <style>
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                            font-family: 'Cairo', sans-serif;
                        }
                        
                        body {
                            padding: 20px;
                            line-height: 1.6;
                            color: #000;
                            font-size: 14pt;
                        }
                        
                        .print-header {
                            text-align: center;
                            margin-bottom: 30px;
                            padding-bottom: 20px;
                            border-bottom: 3px double #333;
                        }
                        
                        .print-logo {
                            font-size: 28px;
                            font-weight: bold;
                            color: #1a5fb4;
                            margin-bottom: 10px;
                        }
                        
                        .print-title {
                            font-size: 22px;
                            margin: 15px 0;
                        }
                        
                        .print-section {
                            margin-bottom: 25px;
                            page-break-inside: avoid;
                        }
                        
                        .print-details-grid {
                            display: grid;
                            grid-template-columns: repeat(3, 1fr);
                            gap: 15px;
                            margin-bottom: 20px;
                        }
                        
                        .print-detail-item {
                            padding: 10px;
                            border-bottom: 1px solid #ddd;
                        }
                        
                        .print-detail-label {
                            font-weight: bold;
                            color: #333;
                            margin-bottom: 5px;
                        }
                        
                        .print-problem-details {
                            background: #f8f9fa;
                            padding: 20px;
                            border-radius: 8px;
                            margin: 20px 0;
                            border-right: 4px solid #1a5fb4;
                        }
                        
                        .print-responses {
                            margin-top: 30px;
                            padding-top: 20px;
                            border-top: 2px solid #333;
                        }
                        
                        .response-item {
                            margin-bottom: 20px;
                            padding: 15px;
                            border: 1px solid #ddd;
                            border-radius: 6px;
                            background: #f9f9f9;
                        }
                        
                        .response-header {
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 10px;
                            font-weight: bold;
                        }
                        
                        .no-print {
                            display: none !important;
                        }
                        
                        @media print {
                            body {
                                font-size: 12pt;
                            }
                            
                            .print-details-grid {
                                grid-template-columns: repeat(2, 1fr) !important;
                            }
                            
                            .print-section {
                                page-break-inside: avoid !important;
                            }
                        }
                    </style>
                </head>
                <body>
                    ${printContent}
                    <script>
                        window.onload = function() {
                            window.print();
                            setTimeout(() => {
                                window.close ? window.close() : document.body.innerHTML = '<p style="padding: 20px; text-align: center;">تم إرسال الطباعة</p>';
                            }, 500);
                        };
                    <\/script>
                </body>
                </html>
            `);
            printDocument.close();
            
            // الانتظار قليلاً لتحميل الخطوط ثم الطباعة
            setTimeout(() => {
                printFrame.contentWindow.focus();
                printFrame.contentWindow.print();
                
                // تنظيف بعد الطباعة
                setTimeout(() => {
                    document.body.removeChild(printFrame);
                    printContainer.innerHTML = '';
                }, 1000);
            }, 500);
        }
        
        // دالة إنشاء محتوى الطباعة
        function generatePrintContent(complaint) {
            // تحديد فئة الأولوية
            let priorityClass = 'priority-normal';
            let priorityText = 'عادية';
            if (complaint.priority === 'مهمة') {
                priorityClass = 'priority-important';
                priorityText = 'مهمة';
            }
            if (complaint.priority === 'فى غاية الأهمية') {
                priorityClass = 'priority-critical';
                priorityText = 'في غاية الأهمية';
            }
            
            // تنسيق التواريخ
            const createdAt = new Date(complaint.createdAt).toLocaleString('ar-EG');
            const updatedAt = new Date(complaint.updatedAt || complaint.createdAt).toLocaleString('ar-EG');
            const printDate = new Date().toLocaleString('ar-EG');
            
            // حساب مدة المعالجة
            const processingTime = calculateProcessingTime(complaint.createdAt, complaint.updatedAt || complaint.createdAt);
            
            // بناء قائمة المرفقات
            let attachmentsHTML = '';
            if (complaint.attachments && complaint.attachments.length > 0) {
                attachmentsHTML = complaint.attachments.map(attachment => `
                    <div style="margin-bottom: 10px;">
                        <strong>${attachment.name || 'مرفق'}</strong> - ${attachment.type || 'غير معروف'}
                        ${attachment.url ? `<br><small>${attachment.url}</small>` : ''}
                    </div>
                `).join('');
            } else {
                attachmentsHTML = '<p>لا توجد مرفقات</p>';
            }
            
            // بناء قائمة الردود
            let responsesHTML = '';
            if (complaint.responses && complaint.responses.length > 0) {
                responsesHTML = complaint.responses.map(response => {
                    const responseDate = new Date(response.date).toLocaleString('ar-EG');
                    const senderType = response.sender === 'admin' ? 'إداري' : 'مقدم الطلب';
                    const senderName = response.sender === 'admin' ? (response.adminName || 'المسؤول') : complaint.fullName;
                    
                    return `
                        <div class="response-item">
                            <div class="response-header">
                                <span>${senderName} (${senderType})</span>
                                <span>${responseDate}</span>
                            </div>
                            <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 4px;">
                                ${response.text}
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                responsesHTML = '<p style="text-align: center; color: #888;">لا توجد ردود حتى الآن</p>';
            }
            
            return `
                <div class="print-content">
                    <div class="print-header">
                        <div class="print-logo">نظام الشكاوى الموحد - مكتب الحاج أحمد الحديدي</div>
                        <h1 class="print-title">تفاصيل الطلب الكاملة</h1>
                        <p>رقم الطلب: <strong>${complaint.complaintNumber || 'غير متوفر'}</strong></p>
                        <p>تاريخ الطباعة: ${printDate}</p>
                    </div>
                    
                    <div class="print-section">
                        <h2 style="color: #1a5fb4; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #1a5fb4;">معلومات مقدم الطلب</h2>
                        <div class="print-details-grid">
                            <div class="print-detail-item">
                                <div class="print-detail-label">الاسم الكامل:</div>
                                <div><strong>${complaint.fullName || 'غير متوفر'}</strong></div>
                            </div>
                            <div class="print-detail-item">
                                <div class="print-detail-label">الرقم القومي:</div>
                                <div>${complaint.nationalId || 'غير متوفر'}</div>
                            </div>
                            <div class="print-detail-item">
                                <div class="print-detail-label">الوحدة المحلية:</div>
                                <div>${complaint.localUnit || 'غير متوفر'}</div>
                            </div>
                            <div class="print-detail-item">
                                <div class="print-detail-label">العنوان:</div>
                                <div>${complaint.address || 'غير متوفر'}</div>
                            </div>
                            <div class="print-detail-item">
                                <div class="print-detail-label">رقم الهاتف:</div>
                                <div>${complaint.phone1 || 'غير متوفر'} ${complaint.phone2 ? ' / ' + complaint.phone2 : ''}</div>
                            </div>
                            <div class="print-detail-item">
                                <div class="print-detail-label">البريد الإلكتروني:</div>
                                <div>${complaint.email || 'غير متوفر'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="print-section">
                        <h2 style="color: #1a5fb4; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #1a5fb4;">معلومات الطلب</h2>
                        <div class="print-details-grid">
                            <div class="print-detail-item">
                                <div class="print-detail-label">القسم:</div>
                                <div><strong>${complaint.department || 'غير متوفر'}</strong></div>
                            </div>
                            <div class="print-detail-item">
                                <div class="print-detail-label">نوع المشكلة:</div>
                                <div><strong>${priorityText}</strong></div>
                            </div>
                            <div class="print-detail-item">
                                <div class="print-detail-label">الحالة:</div>
                                <div><strong>${complaint.status || 'جديدة'}</strong></div>
                            </div>
                            <div class="print-detail-item">
                                <div class="print-detail-label">رقم المرجع:</div>
                                <div>${complaint.referenceNumber || 'غير محدد'}</div>
                            </div>
                            <div class="print-detail-item">
                                <div class="print-detail-label">تاريخ الإرسال:</div>
                                <div>${createdAt}</div>
                            </div>
                            <div class="print-detail-item">
                                <div class="print-detail-label">آخر تحديث:</div>
                                <div>${updatedAt}</div>
                            </div>
                            <div class="print-detail-item">
                                <div class="print-detail-label">مدة المعالجة:</div>
                                <div>${processingTime}</div>
                            </div>
                            <div class="print-detail-item">
                                <div class="print-detail-label">الجهة المحالة إليها:</div>
                                <div>${complaint.assignedTo || 'قيد التحديد'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="print-section">
                        <h2 style="color: #1a5fb4; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #1a5fb4;">تفاصيل المشكلة / الطلب</h2>
                        <div class="print-problem-details">
                            <div style="white-space: pre-line; line-height: 1.8; padding: 15px; background: white; border-radius: 8px;">
                                ${complaint.problemDetails || 'لا توجد تفاصيل'}
                            </div>
                        </div>
                    </div>
                    
                    <div class="print-section">
                        <h2 style="color: #1a5fb4; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #1a5fb4;">المرفقات</h2>
                        <div style="padding: 20px; background: #f8f9fa; border-radius: 8px;">
                            ${attachmentsHTML}
                        </div>
                    </div>
                    
                    <div class="print-section">
                        <h2 style="color: #1a5fb4; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #1a5fb4;">سجل الردود والمتابعات</h2>
                        <div class="print-responses">
                            ${responsesHTML}
                        </div>
                    </div>
                    
                    <div class="print-section" style="margin-top: 50px; padding-top: 30px; border-top: 2px solid #333;">
                        <div style="text-align: center;">
                            <p>ختم الجهة المعنية</p>
                            <div style="margin: 40px 0; min-height: 80px;"></div>
                            <p>_______________________</p>
                            <p>التوقيع</p>
                            <p style="margin-top: 30px;">تاريخ الإصدار: ${new Date().toLocaleDateString('ar-EG')}</p>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // ... بقية الدوال تبقى كما هي مع تعديلات بسيطة ...
        
        // عند إغلاق النافذة المنبثقة للشكوى
        function closeModal() {
            document.getElementById('complaintDetailsModal').style.display = 'none';
        }
        
        // دالة تحميل المستخدمين
        async function loadUsers() {
            if (!currentUser || currentUser.role !== 'admin') {
                showMessage('يجب تسجيل الدخول كمسؤول للوصول إلى إدارة المستخدمين', 'error');
                return;
            }
            
            try {
                const usersRef = database.ref('users');
                const snapshot = await usersRef.once('value');
                
                if (!snapshot.exists()) {
                    allUsers = [];
                    displayUsersTable();
                    return;
                }
                
                allUsers = [];
                snapshot.forEach((childSnapshot) => {
                    const user = childSnapshot.val();
                    user.key = childSnapshot.key;
                    allUsers.push(user);
                });
                
                displayUsersTable();
                
            } catch (error) {
                console.error('Error loading users:', error);
                showMessage('حدث خطأ أثناء تحميل المستخدمين', 'error');
            }
        }
        
        // ... بقية الكود يبقى كما هو مع إضافة التعديلات السابقة ...
    </script>
</body>
</html>
