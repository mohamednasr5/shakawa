<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>لوحة التحكم - نظام الشكاوى الموحد</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /* === إعدادات الصفحة والخطوط === */
        *{box-sizing:border-box;margin:0;padding:0;font-family:'Cairo',sans-serif;-webkit-tap-highlight-color:transparent}
        html{font-size:16px;scroll-behavior:smooth}
        body{background:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%);color:#333;line-height:1.6;min-height:100vh;overflow-x:hidden;padding-bottom:80px}
        
        /* === تنسيقات الطباعة (هام جداً) === */
        @media print {
            body * { visibility: hidden; }
            #complaintDetailsModal, #complaintDetailsModal * { visibility: visible; }
            #complaintDetailsModal { position: absolute; left: 0; top: 0; width: 100%; height: auto; background: white; z-index: 9999; padding: 0; margin: 0; }
            .modal-content { box-shadow: none !important; border: none !important; width: 100% !important; max-width: 100% !important; }
            .modal-header-controls, .close-modal, .action-btn, .mobile-nav, .sidebar, header { display: none !important; }
            .modal-body { padding: 0 !important; }
            /* إجبار الخلفيات والألوان على الظهور في الطباعة */
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }

        /* === الهيكل العام === */
        .container{max-width:1400px;margin:0 auto;padding:15px}
        
        /* === شاشة تسجيل الدخول === */
        .login-container{display:flex;justify-content:center;align-items:center;min-height:100vh;padding:20px;background:linear-gradient(135deg,#1a5fb4 0%,#2d8fd5 100%)}
        .login-box{background:#fff;border-radius:20px;padding:30px 25px;width:100%;max-width:400px;box-shadow:0 20px 40px rgba(0,0,0,.2);text-align:center;animation:slideUp .5s ease}
        @keyframes slideUp{from{opacity:0;transform:translateY(50px)}to{opacity:1;transform:translateY(0)}}
        .login-logo{font-size:3rem;color:#1a5fb4;margin-bottom:15px}
        .login-title{font-size:1.6rem;color:#2c3e50;margin-bottom:25px;font-weight:700}
        .login-form .form-group{margin-bottom:20px;text-align:right}
        .login-form .form-label{display:block;margin-bottom:8px;font-weight:600;color:#2c3e50;font-size:1rem}
        .login-form .form-control{width:100%;padding:16px 15px;border:2px solid #ddd;border-radius:10px;font-size:16px;transition:all .3s;background:#f8f9fa}
        .login-form .form-control:focus{border-color:#1a5fb4;outline:none;box-shadow:0 0 0 3px rgba(26,95,180,.1);background:#fff}
        .login-btn{width:100%;padding:18px;background:linear-gradient(to right,#1a5fb4,#2d8fd5);color:#fff;border:none;border-radius:10px;font-size:18px;font-weight:700;cursor:pointer;transition:all .3s;display:flex;align-items:center;justify-content:center;gap:10px;margin-top:10px}
        .login-btn:hover{background:linear-gradient(to right,#155093,#1a5fb4);transform:translateY(-2px);box-shadow:0 10px 20px rgba(0,0,0,.15)}
        .login-error{color:#e74c3c;margin-top:15px;padding:15px;background:#fde8e8;border-radius:10px;display:none;font-size:.95rem}
        
        /* === رأس الصفحة === */
        header{background:linear-gradient(135deg,#1a5fb4 0%,#2d8fd5 100%);color:#fff;padding:20px 0 25px;text-align:center;border-radius:0 0 25px 25px;box-shadow:0 8px 25px rgba(0,0,0,.15);margin-bottom:20px;position:relative;overflow:hidden}
        header::before{content:'';position:absolute;top:0;left:0;right:0;height:5px;background:linear-gradient(90deg,#ff7e5f,#feb47b,#86a8e7,#91eae4);background-size:400% 400%;animation:gradientShift 8s ease infinite}
        @keyframes gradientShift{0%{background-position:0 50%}50%{background-position:100% 50%}100%{background-position:0 50%}}
        .logo{font-size:1.8rem;margin-bottom:8px;text-shadow:2px 2px 4px rgba(0,0,0,.2);padding:0 15px;line-height:1.4}
        .subtitle{font-size:1rem;opacity:.9;max-width:600px;margin:0 auto;padding:0 15px;line-height:1.5}
        
        /* === شريط الأدوات الإداري === */
        .admin-bar{background:linear-gradient(135deg,#2c3e50 0%,#4a6572 100%);color:#fff;padding:15px;border-radius:15px;margin-bottom:20px;box-shadow:0 5px 15px rgba(0,0,0,.1);display:flex;flex-direction:column;gap:15px}
        .admin-info{display:flex;align-items:center;gap:12px}
        .admin-avatar{width:50px;height:50px;border-radius:50%;background:linear-gradient(135deg,#3498db,#2c3e50);display:flex;align-items:center;justify-content:center;font-size:1.4rem;box-shadow:0 4px 10px rgba(0,0,0,.2);flex-shrink:0}
        .admin-text h3{margin-bottom:5px;font-size:1.1rem}
        .admin-text p{opacity:.9;font-size:.85rem}
        .admin-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
        .stat-box{background:rgba(255,255,255,.15);padding:12px 8px;border-radius:10px;text-align:center;backdrop-filter:blur(10px)}
        .stat-value{font-size:1.5rem;font-weight:700;margin-bottom:5px}
        .stat-label{font-size:.8rem;opacity:.9}
        .logout-btn{background:#e74c3c;color:#fff;border:none;padding:12px 20px;border-radius:10px;cursor:pointer;font-weight:600;transition:all .3s;display:flex;align-items:center;justify-content:center;gap:8px;font-size:1rem;width:100%}
        
        /* === التخطيط الشبكي === */
        .dashboard-grid{display:flex;flex-direction:column;gap:20px}
        
        /* === القائمة الجانبية === */
        .sidebar-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);z-index:999;animation:fadeIn .3s ease}
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        .sidebar{background:#fff;border-radius:20px 0 0 20px;padding:25px 20px;box-shadow:0 0 30px rgba(0,0,0,.3);height:100vh;width:280px;position:fixed;top:0;right:-300px;z-index:1000;transition:right .3s ease;overflow-y:auto}
        .sidebar.active{right:0}
        .sidebar-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;padding-bottom:15px;border-bottom:2px solid #f0f0f0}
        .sidebar-title{font-size:1.3rem;color:#2c3e50;font-weight:700}
        .close-sidebar{background:none;border:none;font-size:1.5rem;color:#666;cursor:pointer;padding:5px}
        .sidebar-menu{list-style:none}
        .menu-item{padding:16px 15px;margin-bottom:8px;border-radius:12px;cursor:pointer;transition:all .3s ease;display:flex;align-items:center;gap:12px;color:#555;font-size:1rem}
        .menu-item:hover{background:#f8f9fa;transform:translateX(-5px)}
        .menu-item.active{background:linear-gradient(to right,#1a5fb4,#2d8fd5);color:#fff;box-shadow:0 5px 15px rgba(26,95,180,.3)}
        .badge{background:#e74c3c;color:#fff;border-radius:10px;padding:4px 10px;font-size:.8rem;margin-right:auto;display:none}

        /* === المحتوى الرئيسي === */
        .main-content{background:#fff;border-radius:20px;padding:20px;box-shadow:0 5px 20px rgba(0,0,0,.08);margin-bottom:80px}
        .content-section{display:none}
        .content-section.active{display:block}
        .section-header{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:15px;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #f0f0f0}
        .section-title{font-size:1.5rem;color:#2c3e50;font-weight:700}
        
        /* === البطاقات والإحصائيات === */
        .cards-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:20px;margin-bottom:30px}
        .card{background:#fff;border-radius:15px;padding:20px;box-shadow:0 5px 15px rgba(0,0,0,.08);transition:all .3s ease;border:1px solid #eee}
        .card:hover{transform:translateY(-5px);box-shadow:0 15px 30px rgba(0,0,0,.15)}
        .card-icon{font-size:2.5rem;margin-bottom:15px;width:60px;height:60px;display:flex;align-items:center;justify-content:center;border-radius:12px}
        .card-value{font-size:2.2rem;font-weight:700;color:#1a5fb4;margin-bottom:5px}
        .priority-card.high{background:linear-gradient(135deg,#ff6b6b,#ff8e8e);color:#fff}
        .priority-card.medium{background:linear-gradient(135deg,#f39c12,#f1c40f);color:#fff}
        .priority-card.low{background:linear-gradient(135deg,#2ecc71,#27ae60);color:#fff}

        /* === الجداول === */
        .complaints-table-container{overflow-x:auto;margin-bottom:20px;border-radius:10px;border:1px solid #eee}
        .complaints-table{width:100%;border-collapse:collapse;min-width:800px}
        .complaints-table thead{background:linear-gradient(135deg,#1a5fb4,#2d8fd5);color:#fff}
        .complaints-table th, .complaints-table td{padding:15px;text-align:right;border-bottom:1px solid #eee}
        .complaints-table tbody tr:hover{background:#f8f9fa}
        
        /* === حالات الشكاوى === */
        .status-badge{padding:4px 12px;border-radius:20px;font-size:.8rem;font-weight:600;display:inline-block}
        .status-new{background:#e3f2fd;color:#1565c0}
        .status-in-progress{background:#fff3e0;color:#f57c00}
        .status-resolved{background:#e8f5e9;color:#2e7d32}
        .status-closed{background:#f5f5f5;color:#616161}
        
        /* === الأزرار والمدخلات === */
        .save-btn, .login-btn{background:linear-gradient(to right,#1a5fb4,#2d8fd5);color:#fff;border:none;padding:12px 20px;border-radius:10px;cursor:pointer;font-weight:600;transition:all .3s}
        .filter-select, .filter-input, .setting-input, .setting-textarea{width:100%;padding:10px;border:2px solid #ddd;border-radius:8px;background:#f8f9fa}
        .mobile-menu-btn{display:flex;align-items:center;justify-content:center;gap:8px;background:#1a5fb4;color:#fff;border:none;padding:12px 15px;border-radius:10px;cursor:pointer;font-weight:600;margin-bottom:15px;width:100%;display:none}

        /* === النوافذ المنبثقة (Modals) === */
        .complaint-details-modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.9);display:none;justify-content:center;align-items:center;z-index:1100;padding:15px}
        .modal-content{background:#fff;border-radius:20px;width:100%;max-width:700px;max-height:85vh;overflow-y:auto;position:relative;animation:modalSlideUp .3s ease}
        @keyframes modalSlideUp{from{opacity:0;transform:translateY(50px)}to{opacity:1;transform:translateY(0)}}
        .modal-header{background:linear-gradient(135deg,#1a5fb4 0%,#2d8fd5 100%);color:#fff;padding:20px;border-radius:20px 20px 0 0;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:1}
        .close-modal{background:none;border:none;color:#fff;font-size:2rem;cursor:pointer;line-height:1;padding:5px}
        .modal-body{padding:20px}
        .details-grid{display:grid;grid-template-columns:1fr;gap:15px;margin-bottom:20px}
        .detail-item{padding:15px;border-bottom:1px solid #eee;background:#f8f9fa;border-radius:10px}
        .detail-label{font-weight:700;color:#1a5fb4;margin-bottom:8px;font-size:.95rem}
        .modal-header-controls{display:flex;gap:10px;margin-top:15px;flex-wrap:wrap;padding: 10px;border-top: 1px solid #eee;}

        /* === أزرار الإجراءات === */
        .action-btn{padding:8px 15px;border:none;border-radius:8px;cursor:pointer;font-size:.9rem;display:flex;align-items:center;justify-content:center;gap:5px;transition:all .2s ease;min-width:80px;color: white;}
        .btn-view{background:#3498db}
        .btn-edit{background:#3498db}
        .btn-delete{background:#e74c3c}
        .btn-download-pdf{background:#27ae60} /* لون مميز للـ PDF */
        .btn-print{background:#34495e} /* لون مميز للطباعة */
        .btn-reply{background:#9b59b6}
        .btn-secondary{background:#6c757d}

        /* === القائمة السفلية للجوال === */
        .mobile-nav{position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:2px solid #1a5fb4;display:flex;justify-content:space-around;padding:12px 10px;z-index:999;box-shadow:0 -5px 20px rgba(0,0,0,.1);display:none}
        .mobile-nav-item{display:flex;flex-direction:column;align-items:center;gap:5px;color:#666;text-decoration:none;font-size:.8rem;flex:1;padding:8px 5px;border-radius:10px;transition:all .2s}
        .mobile-nav-item.active{background:#1a5fb4;color:#fff}

        /* === شاشة التحميل === */
        .loading-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,.9);display:none;justify-content:center;align-items:center;z-index:9999}
        .loading-spinner{width:60px;height:60px;border:5px solid #f3f3f3;border-top:5px solid #1a5fb4;border-radius:50%;animation:spin 1s linear infinite}
        @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}

        /* === التجاوب (Media Queries) === */
        @media (max-width:768px){
            .mobile-menu-btn,.mobile-nav{display:flex}
            .cards-grid{grid-template-columns:1fr}
            .complaints-table th,.complaints-table td{padding:10px 8px;font-size:.85rem}
            .section-header{flex-direction:column;align-items:flex-start}
            .admin-info{flex-direction:column;text-align:center}
            .modal-header-controls{flex-direction:column}
            .modal-header-controls button{width:100%}
        }
        @media (min-width:769px){
            .dashboard-grid{display:grid;grid-template-columns:280px 1fr}
            .sidebar{position:static;width:100%;height:auto;right:0;box-shadow:none;border-radius:15px}
            .sidebar-overlay{display:none !important}.close-sidebar{display:none}.mobile-menu-btn,.mobile-nav{display:none}
        }
    </style>
</head>
<body>
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <div class="login-logo"><i class="fas fa-user-shield"></i></div>
            <h2 class="login-title">تسجيل دخول المسؤول</h2>
            <form id="loginForm" class="login-form">
                <div class="form-group">
                    <label class="form-label">اسم المستخدم</label>
                    <input type="text" class="form-control" id="username" placeholder="أدخل اسم المستخدم" required>
                </div>
                <div class="form-group">
                    <label class="form-label">كلمة المرور</label>
                    <input type="password" class="form-control" id="password" placeholder="أدخل كلمة المرور" required>
                </div>
                <div class="login-error" id="loginError">اسم المستخدم أو كلمة المرور غير صحيحة</div>
                <button type="submit" class="login-btn"><i class="fas fa-sign-in-alt"></i> تسجيل الدخول</button>
            </form>
        </div>
    </div>

    <div id="dashboardScreen" style="display:none;">
        <header>
            <div class="container">
                <h1 class="logo">لوحة التحكم - نظام الشكاوى الموحد</h1>
                <p class="subtitle">إدارة الشكاوى والطلبات المقدمة من المواطنين</p>
            </div>
        </header>
        <div class="container">
            <button class="mobile-menu-btn" id="mobileMenuBtn"><i class="fas fa-bars"></i> عرض القائمة</button>
            <div class="admin-bar">
                <div class="admin-info">
                    <div class="admin-avatar"><i class="fas fa-user-shield"></i></div>
                    <div class="admin-text">
                        <h3 id="adminWelcome">مرحباً، المسؤول</h3>
                        <p id="adminLastLogin">آخر دخول: -</p>
                    </div>
                </div>
                <div class="admin-stats">
                    <div class="stat-box"><div class="stat-value" id="totalComplaints">0</div><div class="stat-label">إجمالي الشكاوى</div></div>
                    <div class="stat-box"><div class="stat-value" id="newComplaints">0</div><div class="stat-label">شكاوى جديدة</div></div>
                    <div class="stat-box"><div class="stat-value" id="resolvedComplaints">0</div><div class="stat-label">تم حلها</div></div>
                </div>
                <button class="logout-btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> تسجيل الخروج</button>
            </div>

            <div class="dashboard-grid">
                <div class="sidebar-overlay" id="sidebarOverlay"></div>
                <div class="sidebar" id="sidebar">
                    <div class="sidebar-header">
                        <h3 class="sidebar-title">القائمة الرئيسية</h3>
                        <button class="close-sidebar" id="closeSidebar"><i class="fas fa-times"></i></button>
                    </div>
                    <ul class="sidebar-menu">
                        <li class="menu-item active" data-section="dashboard"><i class="fas fa-tachometer-alt menu-icon"></i><span>لوحة التحكم</span></li>
                        <li class="menu-item" data-section="complaints"><i class="fas fa-file-alt menu-icon"></i><span>إدارة الشكاوى</span><span class="badge" id="complaintsBadge">0</span></li>
                        <li class="menu-item admin-only" data-section="users"><i class="fas fa-users menu-icon"></i><span>المستخدمين</span></li>
                        <li class="menu-item admin-only" data-section="settings"><i class="fas fa-cog menu-icon"></i><span>الإعدادات</span></li>
                        <li class="menu-item" data-section="reports"><i class="fas fa-chart-bar menu-icon"></i><span>التقارير</span></li>
                        <li class="menu-item admin-only" data-section="departments"><i class="fas fa-building menu-icon"></i><span>الأقسام</span></li>
                    </ul>
                </div>

                <div class="main-content">
                    
                    <div id="dashboardSection" class="content-section active">
                        <div class="section-header">
                            <h2 class="section-title">لوحة التحكم الرئيسية</h2>
                            <select id="dashboardFilter" class="filter-select" style="width: auto;">
                                <option value="all">جميع الفترات</option>
                                <option value="today">اليوم</option>
                                <option value="week">هذا الأسبوع</option>
                            </select>
                        </div>
                        <div class="cards-grid">
                            <div class="card"><div class="card-icon" style="background:#e3f2fd;color:#1565c0"><i class="fas fa-inbox"></i></div><h3 class="card-title">شكاوى جديدة</h3><div class="card-value" id="cardNewComplaints">0</div></div>
                            <div class="card"><div class="card-icon" style="background:#e8f5e9;color:#2e7d32"><i class="fas fa-check-circle"></i></div><h3 class="card-title">شكاوى مكتملة</h3><div class="card-value" id="cardCompletedComplaints">0</div></div>
                            <div class="card"><div class="card-icon" style="background:#fff3e0;color:#f57c00"><i class="fas fa-clock"></i></div><h3 class="card-title">قيد المعالجة</h3><div class="card-value" id="cardInProgress">0</div></div>
                            <div class="card priority-card high"><div class="card-icon"><i class="fas fa-exclamation-triangle"></i></div><h3 class="card-title">عاجلة</h3><div class="card-value" id="cardHighPriority">0</div></div>
                        </div>
                    </div>

                    <div id="complaintsSection" class="content-section">
                        <div class="section-header">
                            <h2 class="section-title">إدارة الشكاوى</h2>
                            </div>
                        <div style="display:flex; gap:10px; margin-bottom:15px; flex-wrap:wrap">
                            <input type="text" id="searchComplaints" class="filter-input" placeholder="بحث..." style="flex:1">
                            <select id="filterStatus" class="filter-select" style="flex:1">
                                <option value="">جميع الحالات</option>
                                <option value="جديدة">جديدة</option>
                                <option value="مكتملة">مكتملة</option>
                            </select>
                        </div>
                        <div class="complaints-table-container">
                            <table class="complaints-table">
                                <thead><tr><th>رقم الشكوى</th><th>الاسم</th><th>القسم</th><th>الأولوية</th><th>الحالة</th><th>التاريخ</th><th>إجراءات</th></tr></thead>
                                <tbody id="complaintsTableBody"></tbody>
                            </table>
                        </div>
                        <div class="pagination">
                            <button id="prevPage" class="action-btn btn-secondary">السابق</button>
                            <span id="pageInfo" style="margin: 0 15px;">1 من 1</span>
                            <button id="nextPage" class="action-btn btn-secondary">التالي</button>
                        </div>
                    </div>

                    <div id="usersSection" class="content-section">
                        <div class="section-header"><h2 class="section-title">إدارة المستخدمين</h2><button class="save-btn" onclick="showAddUserModal()">إضافة مستخدم</button></div>
                        <div class="users-grid" id="usersGrid"></div>
                    </div>

                    <div id="settingsSection" class="content-section">
                        <div class="section-header"><h2 class="section-title">إعدادات النظام</h2></div>
                        <form id="settingsForm"><div class="form-group"><label class="setting-label">اسم النظام</label><input type="text" class="setting-input" id="systemName" value="نظام الشكاوى"></div><button class="save-btn">حفظ</button></form>
                    </div>
                    
                    <div id="reportsSection" class="content-section">
                         <div class="section-header"><h2 class="section-title">التقارير</h2></div>
                         <p>قسم التقارير قيد التطوير...</p>
                    </div>

                    <div id="departmentsSection" class="content-section">
                        <div class="section-header"><h2 class="section-title">إدارة الأقسام</h2><button class="save-btn" onclick="showAddDepartmentModal()">إضافة قسم</button></div>
                        <div id="departmentsGrid" class="cards-grid"></div>
                    </div>
                </div>
            </div>
            
            <div class="footer">
                <p>© 2026 نظام الشكاوى الموحد - جميع الحقوق محفوظة</p>
                <p>برمجة: المهندس محمد حماد</p>
            </div>
        </div>

        <div class="complaint-details-modal" id="complaintDetailsModal">
            <div class="modal-content" id="printArea">
                <div class="modal-header">
                    <h3 class="modal-title">تفاصيل الشكوى</h3>
                    <button class="close-modal" id="closeModal">&times;</button>
                </div>
                <div class="modal-body" id="modalBody">
                    </div>
                <div class="modal-header-controls" id="modalControls">
                    </div>
            </div>
        </div>

        <div class="complaint-details-modal" id="userModal">
            <div class="modal-content">
                <div class="modal-header"><h3>إضافة مستخدم</h3><button class="close-modal" onclick="document.getElementById('userModal').style.display='none'">&times;</button></div>
                <div class="modal-body">
                    <form id="userForm">
                        <div class="form-group"><label>الاسم</label><input type="text" class="setting-input" id="newUserName" required></div>
                        <div class="form-group"><label>اسم المستخدم</label><input type="text" class="setting-input" id="newUserUsername" required></div>
                        <div class="form-group"><label>كلمة المرور</label><input type="password" class="setting-input" id="newUserPassword" required></div>
                        <div class="form-group"><label>الدور</label><select id="newUserRole" class="setting-input"><option value="user">مستخدم</option><option value="admin">مسؤول</option></select></div>
                        <button type="submit" class="save-btn" style="width:100%">حفظ</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="loading-overlay" id="loadingOverlay"><div class="loading-spinner"></div></div>
        
        <div class="mobile-nav">
            <a href="#" class="mobile-nav-item active" onclick="showSection('dashboard');updateMobileNav(this)"><i class="fas fa-tachometer-alt"></i><span>الرئيسية</span></a>
            <a href="#" class="mobile-nav-item" onclick="showSection('complaints');updateMobileNav(this)"><i class="fas fa-file-alt"></i><span>الشكاوى</span></a>
            <a href="#" class="mobile-nav-item" onclick="showSection('settings');updateMobileNav(this)"><i class="fas fa-cog"></i><span>الإعدادات</span></a>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <script>
        // إعدادات فايربيس
        const firebaseConfig = {
            apiKey: "AIzaSyBIIStbiZD0ZJ6su7C1bwZlBvqx-PP-t58",
            authDomain: "shakawa-e0a3c.firebaseapp.com",
            databaseURL: "https://shakawa-e0a3c-default-rtdb.firebaseio.com",
            projectId: "shakawa-e0a3c",
            storageBucket: "shakawa-e0a3c.firebasestorage.app",
            messagingSenderId: "111620348664",
            appId: "1:111620348664:web:670fdf5caed46eb691b90d",
            measurementId: "G-SGNTJZDQ1L"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let currentUser = null;
        let allComplaints = [];
        let filteredComplaints = [];
        let currentPage = 1;
        const itemsPerPage = 10;

        document.addEventListener('DOMContentLoaded', () => {
            // التحقق من الجلسة المخزنة
            const savedUser = localStorage.getItem('adminUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                initDashboard();
            }

            // مستمعي الأحداث
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('logoutBtn').addEventListener('click', () => {
                localStorage.removeItem('adminUser');
                location.reload();
            });
            
            // فتح/غلق القائمة الجانبية
            document.getElementById('mobileMenuBtn').addEventListener('click', () => {
                document.getElementById('sidebar').classList.add('active');
                document.getElementById('sidebarOverlay').style.display = 'block';
            });
            document.getElementById('closeSidebar').addEventListener('click', closeSidebar);
            document.getElementById('sidebarOverlay').addEventListener('click', closeSidebar);
            
            // إغلاق المودال
            document.getElementById('closeModal').addEventListener('click', () => {
                document.getElementById('complaintDetailsModal').style.display = 'none';
            });

            // التنقل بين الأقسام
            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', function() {
                    const section = this.getAttribute('data-section');
                    showSection(section);
                    document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                    if(window.innerWidth < 769) closeSidebar();
                });
            });

            // الفلترة
            document.getElementById('searchComplaints').addEventListener('input', applyFilters);
            document.getElementById('filterStatus').addEventListener('change', applyFilters);
            
            // إضافة مستخدم (تجريبي)
            document.getElementById('userForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const u = {
                    name: document.getElementById('newUserName').value,
                    username: document.getElementById('newUserUsername').value,
                    password: document.getElementById('newUserPassword').value,
                    role: document.getElementById('newUserRole').value,
                };
                await database.ref('users').push(u);
                alert('تمت الإضافة');
                document.getElementById('userModal').style.display = 'none';
            });
        });

        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('active');
            document.getElementById('sidebarOverlay').style.display = 'none';
        }

        async function handleLogin(e) {
            e.preventDefault();
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            
            // تسجيل دخول سريع للمسؤول (يمكن حذفه في الإنتاج)
            if(u === 'admin' && p === '123456') {
                loginSuccess({name: 'المدير العام', role: 'admin'});
                return;
            }

            try {
                const snap = await database.ref('users').get();
                let found = false;
                snap.forEach(child => {
                    const user = child.val();
                    if(user.username === u && user.password === p) {
                        loginSuccess({...user, key: child.key});
                        found = true;
                    }
                });
                if(!found) document.getElementById('loginError').style.display = 'block';
            } catch(err) { console.error(err); }
        }

        function loginSuccess(user) {
            currentUser = user;
            localStorage.setItem('adminUser', JSON.stringify(user));
            initDashboard();
        }

        function initDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboardScreen').style.display = 'block';
            document.getElementById('adminWelcome').textContent = 'مرحباً، ' + currentUser.name;
            
            if(currentUser.role === 'admin') {
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'flex');
            }
            
            loadComplaints();
        }

        function loadComplaints() {
            document.getElementById('loadingOverlay').style.display = 'flex';
            database.ref('complaints').on('value', snap => {
                allComplaints = [];
                snap.forEach(child => allComplaints.push({...child.val(), key: child.key}));
                allComplaints.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                // تحديث الإحصائيات
                document.getElementById('totalComplaints').innerText = allComplaints.length;
                document.getElementById('newComplaints').innerText = allComplaints.filter(c => c.status === 'جديدة').length;
                document.getElementById('resolvedComplaints').innerText = allComplaints.filter(c => c.status === 'مكتملة').length;
                
                document.getElementById('cardNewComplaints').innerText = allComplaints.filter(c => c.status === 'جديدة').length;
                document.getElementById('cardCompletedComplaints').innerText = allComplaints.filter(c => c.status === 'مكتملة').length;
                document.getElementById('cardInProgress').innerText = allComplaints.filter(c => c.status.includes('قيد')).length;
                
                applyFilters();
                document.getElementById('loadingOverlay').style.display = 'none';
            });
        }

        function applyFilters() {
            const search = document.getElementById('searchComplaints').value.toLowerCase();
            const status = document.getElementById('filterStatus').value;
            
            filteredComplaints = allComplaints.filter(c => {
                const matchSearch = (c.fullName || '').toLowerCase().includes(search) || (c.complaintNumber || '').includes(search);
                const matchStatus = status ? c.status === status : true;
                return matchSearch && matchStatus;
            });
            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('complaintsTableBody');
            tbody.innerHTML = '';
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const data = filteredComplaints.slice(start, end);
            
            data.forEach(c => {
                const tr = document.createElement('tr');
                const date = c.createdAt ? new Date(c.createdAt).toLocaleDateString('ar-EG') : '-';
                let statusClass = 'status-new';
                if(c.status === 'مكتملة') statusClass = 'status-resolved';
                else if(c.status === 'ملغاة') statusClass = 'status-closed';
                else if(c.status.includes('قيد')) statusClass = 'status-in-progress';
                
                tr.innerHTML = `
                    <td><strong>${c.complaintNumber || '---'}</strong></td>
                    <td>${c.fullName}</td>
                    <td>${c.department || '-'}</td>
                    <td><span class="status-badge ${c.priority === 'عاجلة' ? 'high' : 'low'}">${c.priority || 'عادية'}</span></td>
                    <td><span class="status-badge ${statusClass}">${c.status}</span></td>
                    <td>${date}</td>
                    <td>
                        <button class="action-btn btn-view" onclick="viewComplaint('${c.key}')"><i class="fas fa-eye"></i> عرض</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            document.getElementById('pageInfo').innerText = `${currentPage} من ${Math.ceil(filteredComplaints.length / itemsPerPage) || 1}`;
        }

        function viewComplaint(key) {
            const c = allComplaints.find(x => x.key === key);
            if(!c) return;

            const modalBody = document.getElementById('modalBody');
            const date = c.createdAt ? new Date(c.createdAt).toLocaleString('ar-EG') : '-';
            
            modalBody.innerHTML = `
                <div class="details-grid">
                    <div class="detail-item"><div class="detail-label">رقم الشكوى</div>${c.complaintNumber || '-'}</div>
                    <div class="detail-item"><div class="detail-label">الاسم بالكامل</div>${c.fullName}</div>
                    <div class="detail-item"><div class="detail-label">الرقم القومي</div>${c.nationalId || '-'}</div>
                    <div class="detail-item"><div class="detail-label">رقم الهاتف</div>${c.phone1 || '-'}</div>
                    <div class="detail-item"><div class="detail-label">القسم</div>${c.department || '-'}</div>
                    <div class="detail-item"><div class="detail-label">الحالة</div>${c.status || 'جديدة'}</div>
                    <div class="detail-item"><div class="detail-label">تاريخ التقديم</div>${date}</div>
                    <div class="detail-item" style="grid-column: 1/-1"><div class="detail-label">تفاصيل المشكلة</div><p style="white-space: pre-line;">${c.problemDetails}</p></div>
                    ${c.address ? `<div class="detail-item" style="grid-column: 1/-1"><div class="detail-label">العنوان</div>${c.address}</div>` : ''}
                </div>
            `;
            
            // حقن الأزرار (طباعة، PDF، وحذف للمسؤول)
            const controls = document.getElementById('modalControls');
            let btnsHTML = `
                <button class="action-btn btn-print" onclick="window.print()"><i class="fas fa-print"></i> طباعة</button>
                <button class="action-btn btn-download-pdf" onclick="downloadComplaintPDF('${c.complaintNumber}')"><i class="fas fa-file-pdf"></i> تحميل PDF</button>
            `;
            if(currentUser.role === 'admin') {
                btnsHTML += `<button class="action-btn btn-delete" onclick="deleteComplaint('${c.key}')"><i class="fas fa-trash"></i> حذف</button>`;
            }
            controls.innerHTML = btnsHTML;

            document.getElementById('complaintDetailsModal').style.display = 'flex';
        }

        // === دالة PDF الجديدة (تدعم العربية) ===
        function downloadComplaintPDF(complaintNo) {
            // إخفاء الأزرار والإغلاق مؤقتاً لتصوير المودال فقط
            const controls = document.getElementById('modalControls');
            const closeBtn = document.querySelector('#complaintDetailsModal .close-modal');
            
            controls.style.display = 'none';
            closeBtn.style.display = 'none';

            const element = document.getElementById('printArea');
            const opt = {
                margin:       10,
                filename:     `شكوى_${complaintNo}.pdf`,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2, useCORS: true },
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(element).save().then(() => {
                // إعادة إظهار الأزرار
                controls.style.display = 'flex';
                closeBtn.style.display = 'block';
            });
        }

        function deleteComplaint(key) {
            if(confirm('هل أنت متأكد من الحذف؟')) {
                database.ref('complaints/'+key).remove();
                document.getElementById('complaintDetailsModal').style.display = 'none';
            }
        }

        function showSection(section) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.getElementById(section + 'Section').classList.add('active');
        }
        
        function updateMobileNav(el) {
            document.querySelectorAll('.mobile-nav-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
        }
        
        function showAddUserModal() { document.getElementById('userModal').style.display = 'flex'; }
        
        // أزرار التقليب
        document.getElementById('prevPage').onclick = () => { if(currentPage > 1) { currentPage--; renderTable(); } };
        document.getElementById('nextPage').onclick = () => { if(currentPage < Math.ceil(filteredComplaints.length / itemsPerPage)) { currentPage++; renderTable(); } };
    </script>
</body>
</html>
