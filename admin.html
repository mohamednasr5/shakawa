<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>لوحة التحكم - نظام الشكاوى الموحد</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* === الأساسيات وتنسيقات الشاشة === */
        *{box-sizing:border-box;margin:0;padding:0;font-family:'Cairo',sans-serif;-webkit-tap-highlight-color:transparent}
        html{font-size:16px;scroll-behavior:smooth}
        body{background:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%);color:#333;line-height:1.6;min-height:100vh;overflow-x:hidden;padding-bottom:80px}
        
        /* === تنسيقات الطباعة (جديد) === */
        @media print {
            body { background: #fff !important; color: #000 !important; padding: 0 !important; overflow: visible !important; }
            .sidebar, .mobile-nav, .admin-bar, .section-controls, .action-btn, .close-modal, .filter-controls, .pagination, header, .footer, .modal-header-controls, .mobile-menu-btn { display: none !important; }
            .modal-content { box-shadow: none !important; border: none !important; max-width: 100% !important; width: 100% !important; padding: 0 !important; position: static !important; }
            .complaint-details-modal { position: static !important; background: #fff !important; padding: 0 !important; display: block !important; z-index: auto !important; height: auto !important; }
            .modal-header { background: #fff !important; color: #000 !important; border-bottom: 2px solid #000 !important; padding: 10px 0 !important; }
            .modal-title { font-size: 24px !important; text-align: center; width: 100%; }
            .detail-item { break-inside: avoid; border-bottom: 1px solid #ccc !important; background: #fff !important; }
            .detail-label { color: #000 !important; font-weight: bold !important; }
            /* إخفاء كل شيء وإظهار المودال فقط إذا كان مفتوحاً */
            body > * { display: none; }
            .complaint-details-modal.active-print { display: block !important; }
            .complaint-details-modal.active-print .modal-content { display: block !important; }
        }

        .container{max-width:1400px;margin:0 auto;padding:15px}
        /* Login Styles */
        .login-container{display:flex;justify-content:center;align-items:center;min-height:100vh;padding:20px;background:linear-gradient(135deg,#1a5fb4 0%,#2d8fd5 100%)}
        .login-box{background:#fff;border-radius:20px;padding:30px 25px;width:100%;max-width:400px;box-shadow:0 20px 40px rgba(0,0,0,.2);text-align:center;animation:slideUp .5s ease}
        @keyframes slideUp{from{opacity:0;transform:translateY(50px)}to{opacity:1;transform:translateY(0)}}
        .login-logo{font-size:3rem;color:#1a5fb4;margin-bottom:15px}
        .login-title{font-size:1.6rem;color:#2c3e50;margin-bottom:25px;font-weight:700}
        .login-form .form-group{margin-bottom:20px;text-align:right}
        .login-form .form-label{display:block;margin-bottom:8px;font-weight:600;color:#2c3e50;font-size:1rem}
        .login-form .form-control{width:100%;padding:16px 15px;border:2px solid #ddd;border-radius:10px;font-size:16px;transition:all .3s;background:#f8f9fa}
        .login-form .form-control:focus{border-color:#1a5fb4;outline:none;box-shadow:0 0 0 3px rgba(26,95,180,.1);background:#fff}
        .login-btn{width:100%;padding:18px;background:linear-gradient(to right,#1a5fb4,#2d8fd5);color:#fff;border:none;border-radius:10px;font-size:18px;font-weight:700;cursor:pointer;transition:all .3s;display:flex;align-items:center;justify-content:center;gap:10px;margin-top:10px}
        .login-btn:hover{background:linear-gradient(to right,#155093,#1a5fb4);transform:translateY(-2px);box-shadow:0 10px 20px rgba(0,0,0,.15)}
        .login-error{color:#e74c3c;margin-top:15px;padding:15px;background:#fde8e8;border-radius:10px;display:none;font-size:.95rem}
        
        /* Header & Layout */
        header{background:linear-gradient(135deg,#1a5fb4 0%,#2d8fd5 100%);color:#fff;padding:20px 0 25px;text-align:center;border-radius:0 0 25px 25px;box-shadow:0 8px 25px rgba(0,0,0,.15);margin-bottom:20px;position:relative;overflow:hidden}
        header::before{content:'';position:absolute;top:0;left:0;right:0;height:5px;background:linear-gradient(90deg,#ff7e5f,#feb47b,#86a8e7,#91eae4);background-size:400% 400%;animation:gradientShift 8s ease infinite}
        @keyframes gradientShift{0%{background-position:0 50%}50%{background-position:100% 50%}100%{background-position:0 50%}}
        .logo{font-size:1.8rem;margin-bottom:8px;text-shadow:2px 2px 4px rgba(0,0,0,.2);padding:0 15px;line-height:1.4}
        .subtitle{font-size:1rem;opacity:.9;max-width:600px;margin:0 auto;padding:0 15px;line-height:1.5}
        
        /* Dashboard Grid */
        .dashboard-grid{display:flex;flex-direction:column;gap:20px}
        @media (min-width:769px){.dashboard-grid{display:grid;grid-template-columns:280px 1fr}.sidebar{position:static;width:100%;height:auto;right:0;box-shadow:none;border-radius:15px}.sidebar-overlay{display:none !important}.close-sidebar{display:none}.mobile-menu-btn,.mobile-nav{display:none}}
        
        /* Sidebar */
        .sidebar-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);z-index:999;animation:fadeIn .3s ease}
        .sidebar{background:#fff;border-radius:20px 0 0 20px;padding:25px 20px;box-shadow:0 0 30px rgba(0,0,0,.3);height:100vh;width:280px;position:fixed;top:0;right:-300px;z-index:1000;transition:right .3s ease;overflow-y:auto}
        .sidebar.active{right:0}
        .sidebar-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;padding-bottom:15px;border-bottom:2px solid #f0f0f0}
        .menu-item{padding:16px 15px;margin-bottom:8px;border-radius:12px;cursor:pointer;transition:all .3s ease;display:flex;align-items:center;gap:12px;color:#555;font-size:1rem}
        .menu-item:hover{background:#f8f9fa;transform:translateX(-5px)}
        .menu-item.active{background:linear-gradient(to right,#1a5fb4,#2d8fd5);color:#fff;box-shadow:0 5px 15px rgba(26,95,180,.3)}
        
        /* Main Content Cards */
        .main-content{background:#fff;border-radius:20px;padding:20px;box-shadow:0 5px 20px rgba(0,0,0,.08);margin-bottom:80px}
        .cards-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:20px;margin-bottom:30px}
        .card{background:#fff;border-radius:15px;padding:20px;box-shadow:0 5px 15px rgba(0,0,0,.08);transition:all .3s ease;border:1px solid #eee}
        .card:hover{transform:translateY(-5px);box-shadow:0 15px 30px rgba(0,0,0,.15)}
        .card-icon{font-size:2.5rem;margin-bottom:15px;width:60px;height:60px;display:flex;align-items:center;justify-content:center;border-radius:12px}
        .card-value{font-size:2.2rem;font-weight:700;color:#1a5fb4;margin-bottom:5px}
        
        /* Tables */
        .complaints-table-container{overflow-x:auto;margin-bottom:20px;border-radius:10px;border:1px solid #eee}
        .complaints-table{width:100%;border-collapse:collapse;min-width:800px}
        .complaints-table thead{background:linear-gradient(135deg,#1a5fb4,#2d8fd5);color:#fff}
        .complaints-table th{padding:15px;text-align:right;font-weight:600}
        .complaints-table td{padding:15px;text-align:right;border-bottom:1px solid #eee}
        .status-badge{padding:4px 12px;border-radius:20px;font-size:.8rem;font-weight:600;display:inline-block}
        .status-new{background:#e3f2fd;color:#1565c0}
        .status-in-progress{background:#fff3e0;color:#f57c00}
        .status-resolved{background:#e8f5e9;color:#2e7d32}
        .status-closed{background:#f5f5f5;color:#616161}
        
        /* Modals */
        .complaint-details-modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.9);display:none;justify-content:center;align-items:center;z-index:1100;padding:15px}
        .modal-content{background:#fff;border-radius:20px;width:100%;max-width:800px;max-height:90vh;overflow-y:auto;position:relative;animation:modalSlideUp .3s ease}
        @keyframes modalSlideUp{from{opacity:0;transform:translateY(50px)}to{opacity:1;transform:translateY(0)}}
        .modal-header{background:linear-gradient(135deg,#1a5fb4 0%,#2d8fd5 100%);color:#fff;padding:20px;border-radius:20px 20px 0 0;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:1}
        .close-modal{background:none;border:none;color:#fff;font-size:2rem;cursor:pointer;padding:5px}
        .modal-body{padding:25px}
        .details-grid{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:20px}
        .full-width{grid-column:1/-1}
        .detail-item{padding:15px;border-bottom:1px solid #eee;background:#f8f9fa;border-radius:10px}
        .detail-label{font-weight:700;color:#1a5fb4;margin-bottom:8px;font-size:.95rem}
        
        /* Action Buttons */
        .action-btn{padding:8px 12px;border:none;border-radius:8px;cursor:pointer;font-size:.85rem;display:inline-flex;align-items:center;justify-content:center;gap:5px;transition:all .2s ease;color:white;margin:2px}
        .btn-view{background:#3498db}
        .btn-edit{background:#f39c12}
        .btn-delete{background:#e74c3c}
        .btn-print{background:#2c3e50}
        .btn-download-pdf{background:#27ae60}
        .btn-reply{background:#9b59b6}
        
        /* Utility */
        .loading-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,.9);display:none;justify-content:center;align-items:center;z-index:9999}
        .loading-spinner{width:60px;height:60px;border:5px solid #f3f3f3;border-top:5px solid #1a5fb4;border-radius:50%;animation:spin 1s linear infinite}
        @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
        .admin-only{display:none}
        .content-section{display:none}
        .content-section.active{display:block}
        
        /* Responsive */
        @media (max-width:768px){
            .details-grid{grid-template-columns:1fr}
            .mobile-menu-btn{display:flex;align-items:center;justify-content:center;gap:8px;background:#1a5fb4;color:#fff;border:none;padding:12px;border-radius:10px;width:100%;margin-bottom:15px}
            .mobile-nav{position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:2px solid #1a5fb4;display:flex;justify-content:space-around;padding:10px;z-index:999;box-shadow:0 -5px 20px rgba(0,0,0,.1)}
            .mobile-nav-item{display:flex;flex-direction:column;align-items:center;color:#666;text-decoration:none;font-size:.8rem}
            .mobile-nav-item.active{color:#1a5fb4}
        }
    </style>
</head>
<body>

    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <div class="login-logo"><i class="fas fa-user-shield"></i></div>
            <h2 class="login-title">تسجيل دخول المسؤول</h2>
            <form id="loginForm" class="login-form">
                <div class="form-group">
                    <label class="form-label">اسم المستخدم</label>
                    <input type="text" class="form-control" id="username" required>
                </div>
                <div class="form-group">
                    <label class="form-label">كلمة المرور</label>
                    <input type="password" class="form-control" id="password" required>
                </div>
                <div class="login-error" id="loginError">خطأ في البيانات</div>
                <button type="submit" class="login-btn"><i class="fas fa-sign-in-alt"></i> تسجيل الدخول</button>
            </form>
        </div>
    </div>

    <div id="dashboardScreen" style="display:none;">
        <header>
            <div class="container">
                <h1 class="logo">نظام الشكاوى الموحد</h1>
                <p class="subtitle">لوحة التحكم الإدارية الاحترافية</p>
            </div>
        </header>

        <div class="container">
            <button class="mobile-menu-btn" id="mobileMenuBtn"><i class="fas fa-bars"></i> القائمة</button>
            
            <div class="admin-bar">
                <div style="display:flex;justify-content:space-between;align-items:center">
                    <h3 id="adminWelcome">مرحباً، المسؤول</h3>
                    <button class="action-btn btn-delete" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> خروج</button>
                </div>
                <div class="admin-stats" style="display:flex;gap:15px;margin-top:10px">
                    <div class="stat-box"><strong>الكل:</strong> <span id="totalComplaints">0</span></div>
                    <div class="stat-box"><strong>جديدة:</strong> <span id="newComplaints">0</span></div>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="sidebar-overlay" id="sidebarOverlay"></div>
                <div class="sidebar" id="sidebar">
                    <div class="sidebar-header">
                        <h3 class="sidebar-title">القائمة</h3>
                        <button class="close-modal" style="color:#333" id="closeSidebar"><i class="fas fa-times"></i></button>
                    </div>
                    <ul class="sidebar-menu">
                        <li class="menu-item active" data-section="dashboard"><i class="fas fa-tachometer-alt"></i> الرئيسية</li>
                        <li class="menu-item" data-section="complaints"><i class="fas fa-file-alt"></i> الشكاوى</li>
                        <li class="menu-item admin-only" data-section="users"><i class="fas fa-users"></i> المستخدمين</li>
                        <li class="menu-item admin-only" data-section="settings"><i class="fas fa-cog"></i> الإعدادات</li>
                    </ul>
                </div>

                <div class="main-content">
                    
                    <div id="dashboardSection" class="content-section active">
                        <h2>لوحة المعلومات</h2>
                        <div class="cards-grid">
                            <div class="card"><div class="card-icon" style="color:#1565c0"><i class="fas fa-inbox"></i></div><h3 class="card-title">شكاوى جديدة</h3><div class="card-value" id="cardNewComplaints">0</div></div>
                            <div class="card"><div class="card-icon" style="color:#2e7d32"><i class="fas fa-check-circle"></i></div><h3 class="card-title">تم الحل</h3><div class="card-value" id="cardCompletedComplaints">0</div></div>
                            <div class="card"><div class="card-icon" style="color:#f57c00"><i class="fas fa-clock"></i></div><h3 class="card-title">قيد المعالجة</h3><div class="card-value" id="cardInProgress">0</div></div>
                        </div>
                    </div>

                    <div id="complaintsSection" class="content-section">
                        <div style="display:flex;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:20px">
                            <h2>إدارة الشكاوى</h2>
                            <div class="filter-controls">
                                <input type="text" id="searchComplaints" placeholder="بحث..." style="padding:10px;border-radius:5px;border:1px solid #ddd">
                                <select id="filterStatus" style="padding:10px;border-radius:5px;border:1px solid #ddd">
                                    <option value="">جميع الحالات</option>
                                    <option value="جديدة">جديدة</option>
                                    <option value="مكتملة">مكتملة</option>
                                </select>
                            </div>
                        </div>
                        <div class="complaints-table-container">
                            <table class="complaints-table">
                                <thead><tr><th>رقم</th><th>الاسم</th><th>القسم</th><th>الحالة</th><th>التاريخ</th><th>إجراءات</th></tr></thead>
                                <tbody id="complaintsTableBody"></tbody>
                            </table>
                        </div>
                        <div class="pagination">
                            <button id="prevPage" disabled>السابق</button>
                            <span id="pageInfo">1 / 1</span>
                            <button id="nextPage" disabled>التالي</button>
                        </div>
                    </div>

                    <div id="usersSection" class="content-section">
                        <h2>إدارة المستخدمين</h2>
                        <div id="usersGrid" class="cards-grid"></div>
                    </div>
                    
                    <div id="settingsSection" class="content-section">
                        <h2>الإعدادات</h2>
                        <p>إعدادات النظام (قيد التطوير)</p>
                    </div>

                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>جميع الحقوق محفوظة © 2026 - نظام الشكاوى الموحد</p>
        </div>
        
        <div class="mobile-nav">
            <a href="#" class="mobile-nav-item active" onclick="showSection('dashboard');"><i class="fas fa-tachometer-alt"></i></a>
            <a href="#" class="mobile-nav-item" onclick="showSection('complaints');"><i class="fas fa-file-alt"></i></a>
            <a href="#" class="mobile-nav-item" onclick="showSection('settings');"><i class="fas fa-cog"></i></a>
        </div>
    </div>

    <div class="complaint-details-modal" id="complaintDetailsModal">
        <div class="modal-content" id="printArea">
            <div class="modal-header">
                <h3 class="modal-title">تفاصيل الشكوى</h3>
                <button class="close-modal" id="closeModal">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                </div>
            <div class="modal-header-controls" id="modalControls" style="padding:20px;border-top:1px solid #eee;text-align:center">
                </div>
        </div>
    </div>

    <div class="loading-overlay" id="loadingOverlay"><div class="loading-spinner"></div></div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>
        // === Firebase Config ===
        const firebaseConfig = {
            apiKey: "AIzaSyBIIStbiZD0ZJ6su7C1bwZlBvqx-PP-t58",
            authDomain: "shakawa-e0a3c.firebaseapp.com",
            databaseURL: "https://shakawa-e0a3c-default-rtdb.firebaseio.com",
            projectId: "shakawa-e0a3c",
            storageBucket: "shakawa-e0a3c.firebasestorage.app",
            messagingSenderId: "111620348664",
            appId: "1:111620348664:web:670fdf5caed46eb691b90d",
            measurementId: "G-SGNTJZDQ1L"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // === State Variables ===
        let currentUser = null;
        let allComplaints = [];
        let filteredComplaints = [];
        let currentPage = 1;
        const itemsPerPage = 10;

        // === Event Listeners ===
        document.addEventListener('DOMContentLoaded', () => {
            const savedUser = localStorage.getItem('adminUser');
            if(savedUser) {
                currentUser = JSON.parse(savedUser);
                initDashboard();
            } else {
                document.getElementById('loginScreen').style.display = 'flex';
            }

            // Tabs Navigation
            document.querySelectorAll('.menu-item, .mobile-nav-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    const section = this.getAttribute('data-section') || this.getAttribute('onclick').match(/'([^']+)'/)[1];
                    showSection(section);
                    // Active Class Logic
                    document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
                    if(this.classList.contains('menu-item')) this.classList.add('active');
                });
            });

            // Mobile Menu
            document.getElementById('mobileMenuBtn').onclick = () => {
                document.getElementById('sidebar').classList.add('active');
                document.getElementById('sidebarOverlay').style.display = 'block';
            };
            document.getElementById('closeSidebar').onclick = closeSidebar;
            document.getElementById('sidebarOverlay').onclick = closeSidebar;

            // Login
            document.getElementById('loginForm').onsubmit = handleLogin;
            document.getElementById('logoutBtn').onclick = () => {
                localStorage.removeItem('adminUser');
                location.reload();
            };

            // Modal Close
            document.getElementById('closeModal').onclick = () => {
                document.getElementById('complaintDetailsModal').classList.remove('active-print');
                document.getElementById('complaintDetailsModal').style.display = 'none';
            };

            // Filters
            document.getElementById('searchComplaints').addEventListener('input', applyFilters);
            document.getElementById('filterStatus').addEventListener('change', applyFilters);
        });

        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('active');
            document.getElementById('sidebarOverlay').style.display = 'none';
        }

        async function handleLogin(e) {
            e.preventDefault();
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            
            // تحقق بسيط (يمكنك توسيعه)
            if(u === 'admin' && p === '123456') {
                currentUser = { name: 'المدير العام', role: 'admin' };
                localStorage.setItem('adminUser', JSON.stringify(currentUser));
                initDashboard();
            } else {
                // تحقق من قاعدة البيانات
                const snap = await database.ref('users').get();
                let found = false;
                snap.forEach(child => {
                    const user = child.val();
                    if(user.username === u && user.password === p) {
                        currentUser = { ...user, key: child.key };
                        localStorage.setItem('adminUser', JSON.stringify(currentUser));
                        found = true;
                    }
                });
                if(found) initDashboard();
                else document.getElementById('loginError').style.display = 'block';
            }
        }

        function initDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboardScreen').style.display = 'block';
            document.getElementById('adminWelcome').textContent = 'مرحباً، ' + currentUser.name;
            
            if(currentUser.role === 'admin') {
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'flex');
            }

            loadComplaints();
        }

        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(el => el.classList.remove('active'));
            document.getElementById(sectionId + 'Section').classList.add('active');
            if(window.innerWidth < 769) closeSidebar();
        }

        // === Data Loading ===
        function loadComplaints() {
            document.getElementById('loadingOverlay').style.display = 'flex';
            database.ref('complaints').on('value', snap => {
                allComplaints = [];
                snap.forEach(child => allComplaints.push({ ...child.val(), key: child.key }));
                allComplaints.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                // Update Stats
                document.getElementById('totalComplaints').innerText = allComplaints.length;
                document.getElementById('newComplaints').innerText = allComplaints.filter(c => c.status === 'جديدة').length;
                
                document.getElementById('cardNewComplaints').innerText = allComplaints.filter(c => c.status === 'جديدة').length;
                document.getElementById('cardCompletedComplaints').innerText = allComplaints.filter(c => c.status === 'مكتملة').length;
                
                applyFilters();
                document.getElementById('loadingOverlay').style.display = 'none';
            });
        }

        function applyFilters() {
            const search = document.getElementById('searchComplaints').value.toLowerCase();
            const status = document.getElementById('filterStatus').value;

            filteredComplaints = allComplaints.filter(c => {
                const matchesSearch = (c.fullName || '').toLowerCase().includes(search) || (c.complaintNumber || '').includes(search);
                const matchesStatus = status ? c.status === status : true;
                return matchesSearch && matchesStatus;
            });
            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('complaintsTableBody');
            tbody.innerHTML = '';
            
            // Pagination Logic
            const start = (currentPage - 1) * itemsPerPage;
            const pagedData = filteredComplaints.slice(start, start + itemsPerPage);

            pagedData.forEach(c => {
                const date = c.createdAt ? new Date(c.createdAt).toLocaleDateString('ar-EG') : '-';
                let statusClass = 'status-new';
                if(c.status === 'مكتملة') statusClass = 'status-resolved';
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>${c.complaintNumber || '---'}</strong></td>
                    <td>${c.fullName}</td>
                    <td>${c.department || '-'}</td>
                    <td><span class="status-badge ${statusClass}">${c.status}</span></td>
                    <td>${date}</td>
                    <td>
                        <button class="action-btn btn-view" onclick="viewComplaint('${c.key}')"><i class="fas fa-eye"></i> عرض</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            
            // Update Pagination Controls
            document.getElementById('pageInfo').innerText = `${currentPage} / ${Math.ceil(filteredComplaints.length / itemsPerPage) || 1}`;
            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = currentPage >= Math.ceil(filteredComplaints.length / itemsPerPage);
            
            document.getElementById('prevPage').onclick = () => { currentPage--; renderTable(); };
            document.getElementById('nextPage').onclick = () => { currentPage++; renderTable(); };
        }

        // === View & Print & PDF Logic ===

        function viewComplaint(key) {
            const c = allComplaints.find(x => x.key === key);
            if(!c) return;

            const modalBody = document.getElementById('modalBody');
            const date = c.createdAt ? new Date(c.createdAt).toLocaleString('ar-EG') : '-';
            
            modalBody.innerHTML = `
                <div class="details-grid">
                    <div class="detail-item"><div class="detail-label">رقم الشكوى</div>${c.complaintNumber || '-'}</div>
                    <div class="detail-item"><div class="detail-label">الاسم</div>${c.fullName}</div>
                    <div class="detail-item"><div class="detail-label">الرقم القومي</div>${c.nationalId || '-'}</div>
                    <div class="detail-item"><div class="detail-label">الهاتف</div>${c.phone1 || '-'}</div>
                    <div class="detail-item"><div class="detail-label">القسم</div>${c.department || '-'}</div>
                    <div class="detail-item"><div class="detail-label">الحالة</div>${c.status || 'جديدة'}</div>
                    <div class="detail-item"><div class="detail-label">تاريخ التقديم</div>${date}</div>
                    <div class="detail-item full-width">
                        <div class="detail-label">تفاصيل المشكلة</div>
                        <p style="white-space: pre-line;">${c.problemDetails || 'لا توجد تفاصيل'}</p>
                    </div>
                    ${c.address ? `<div class="detail-item full-width"><div class="detail-label">العنوان</div>${c.address}</div>` : ''}
                </div>
            `;

            const controls = document.getElementById('modalControls');
            controls.innerHTML = `
                <button class="action-btn btn-print" onclick="printComplaint()"><i class="fas fa-print"></i> طباعة</button>
                <button class="action-btn btn-download-pdf" onclick="downloadPDF('${c.complaintNumber}')"><i class="fas fa-file-pdf"></i> تحميل PDF (عربي)</button>
            `;
            if(currentUser.role === 'admin') {
                controls.innerHTML += `<button class="action-btn btn-delete" onclick="deleteComplaint('${key}')"><i class="fas fa-trash"></i> حذف</button>`;
            }

            document.getElementById('complaintDetailsModal').style.display = 'flex';
        }

        // دالة الطباعة الاحترافية
        function printComplaint() {
            const modal = document.getElementById('complaintDetailsModal');
            modal.classList.add('active-print');
            window.print();
            setTimeout(() => {
                modal.classList.remove('active-print');
            }, 500);
        }

        // دالة تصدير PDF العربية الصحيحة
        function downloadPDF(complaintNo) {
            const element = document.getElementById('printArea');
            const opt = {
                margin:       10,
                filename:     `شكوى_${complaintNo || 'report'}.pdf`,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2, useCORS: true },
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            // إخفاء أزرار التحكم مؤقتاً عند التصدير
            document.getElementById('modalControls').style.display = 'none';
            document.querySelector('.close-modal').style.display = 'none';

            html2pdf().set(opt).from(element).save().then(() => {
                // إعادة إظهار الأزرار
                document.getElementById('modalControls').style.display = 'block';
                document.querySelector('.close-modal').style.display = 'block';
            });
        }

        function deleteComplaint(key) {
            if(confirm('هل أنت متأكد من حذف هذه الشكوى؟')) {
                database.ref('complaints/' + key).remove();
                document.getElementById('complaintDetailsModal').style.display = 'none';
            }
        }
    </script>
</body>
</html>
