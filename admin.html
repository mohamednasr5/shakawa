<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>لوحة القيادة - نظام الشكاوى المتطور</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary: #2563eb;
            --secondary: #1e40af;
            --bg-light: #f3f4f6;
            --bg-white: #ffffff;
            --text-dark: #1f2937;
            --text-gray: #6b7280;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --transition: all 0.3s ease;
        }

        /* Dark Mode Variables */
        [data-theme="dark"] {
            --primary: #3b82f6;
            --bg-light: #111827;
            --bg-white: #1f2937;
            --text-dark: #f9fafb;
            --text-gray: #9ca3af;
            --border: #374151;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Tajawal', sans-serif; outline: none; }
        body { background-color: var(--bg-light); color: var(--text-dark); transition: var(--transition); overflow-x: hidden; }
        
        /* Utils */
        .hidden { display: none !important; }
        .flex { display: flex; align-items: center; }
        .grid { display: grid; gap: 1.5rem; }
        .card { background: var(--bg-white); padding: 1.5rem; border-radius: 1rem; box-shadow: var(--shadow); border: 1px solid var(--border); }
        
        /* Sidebar & Layout */
        .dashboard-container { display: grid; grid-template-columns: 280px 1fr; min-height: 100vh; }
        
        .sidebar { background: var(--bg-white); border-left: 1px solid var(--border); padding: 1.5rem; position: sticky; top: 0; height: 100vh; overflow-y: auto; z-index: 100; }
        .logo-area { display: flex; align-items: center; gap: 10px; margin-bottom: 2.5rem; color: var(--primary); font-weight: 800; font-size: 1.4rem; }
        
        .nav-item { padding: 12px 15px; margin-bottom: 8px; border-radius: 10px; cursor: pointer; color: var(--text-gray); font-weight: 500; transition: var(--transition); display: flex; align-items: center; gap: 12px; }
        .nav-item:hover, .nav-item.active { background: var(--primary); color: #fff; transform: translateX(-5px); }
        .nav-item i { width: 24px; text-align: center; }

        /* Main Content */
        .main-content { padding: 2rem; overflow-y: auto; height: 100vh; }
        
        /* Header */
        .top-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .search-box { position: relative; width: 300px; }
        .search-box input { width: 100%; padding: 10px 40px 10px 15px; border-radius: 20px; border: 1px solid var(--border); background: var(--bg-white); color: var(--text-dark); }
        .search-box i { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--text-gray); }
        
        .header-actions { display: flex; gap: 15px; align-items: center; }
        .icon-btn { width: 40px; height: 40px; border-radius: 50%; background: var(--bg-white); border: 1px solid var(--border); display: flex; justify-content: center; align-items: center; cursor: pointer; color: var(--text-dark); position: relative; transition: var(--transition); }
        .icon-btn:hover { background: var(--border); }
        .badge-dot { position: absolute; top: 0; right: 0; width: 12px; height: 12px; background: var(--danger); border-radius: 50%; border: 2px solid var(--bg-white); }

        /* Stat Cards */
        .stats-grid { grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); margin-bottom: 2rem; }
        .stat-card { display: flex; justify-content: space-between; align-items: center; }
        .stat-info h3 { font-size: 2rem; font-weight: 800; margin-bottom: 5px; }
        .stat-info p { color: var(--text-gray); font-size: 0.9rem; }
        .stat-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; }
        
        /* Charts Area */
        .charts-grid { grid-template-columns: 2fr 1fr; margin-bottom: 2rem; }
        @media (max-width: 992px) { .charts-grid { grid-template-columns: 1fr; } }

        /* Table */
        .table-container { overflow-x: auto; border-radius: 1rem; background: var(--bg-white); box-shadow: var(--shadow); }
        table { width: 100%; border-collapse: collapse; white-space: nowrap; }
        th { background: var(--bg-light); padding: 1rem; text-align: right; color: var(--text-gray); font-weight: 600; font-size: 0.85rem; text-transform: uppercase; }
        td { padding: 1rem; border-bottom: 1px solid var(--border); color: var(--text-dark); }
        tr:hover { background-color: rgba(0,0,0,0.02); }
        
        /* Status Badges */
        .badge { padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
        .bg-new { background: #dbeafe; color: #1e40af; }
        .bg-pending { background: #ffedd5; color: #9a3412; }
        .bg-success { background: #d1fae5; color: #065f46; }
        .bg-dark { background: #e5e7eb; color: #374151; }

        /* Action Buttons */
        .action-btn { padding: 6px; border-radius: 6px; border: none; cursor: pointer; margin-left: 5px; color: #fff; transition: transform 0.2s; }
        .action-btn:hover { transform: scale(1.1); }
        .btn-view { background: var(--primary); }
        .btn-pdf { background: var(--text-gray); }
        .btn-del { background: var(--danger); }

        /* Login Screen */
        .login-wrapper { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary); z-index: 2000; display: flex; justify-content: center; align-items: center; }
        .login-card { background: #fff; padding: 3rem; border-radius: 1.5rem; width: 90%; max-width: 450px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
        .login-input { width: 100%; padding: 15px; margin-bottom: 15px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 1rem; transition: 0.3s; }
        .login-input:focus { border-color: var(--primary); }
        .btn-main { width: 100%; padding: 15px; background: var(--primary); color: #fff; border: none; border-radius: 10px; font-weight: bold; font-size: 1.1rem; cursor: pointer; }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .dashboard-container { grid-template-columns: 1fr; }
            .sidebar { display: none; }
            .mobile-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--bg-white); border-top: 1px solid var(--border); display: flex; justify-content: space-around; padding: 10px; z-index: 999; }
            .mobile-nav-item { text-align: center; font-size: 0.75rem; color: var(--text-gray); }
            .mobile-nav-item i { font-size: 1.25rem; margin-bottom: 2px; display: block; }
            .mobile-nav-item.active { color: var(--primary); }
            .charts-grid { display: none; } /* Hide charts on mobile for performance */
        }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1050; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-box { background: var(--bg-white); width: 95%; max-width: 800px; max-height: 90vh; overflow-y: auto; border-radius: 1.5rem; animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Pagination */
        .pagination { display: flex; justify-content: center; margin-top: 1.5rem; gap: 5px; }
        .page-btn { padding: 8px 12px; border: 1px solid var(--border); background: var(--bg-white); border-radius: 6px; cursor: pointer; }
        .page-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); }

        /* Print Styles */
        @media print {
            .sidebar, .top-header, .mobile-nav, .action-btn, .pagination, .filters, .stats-grid, .charts-grid { display: none !important; }
            .main-content { padding: 0; height: auto; overflow: visible; }
            body, .card { background: #fff; color: #000; box-shadow: none; border: none; }
            table th, table td { border: 1px solid #000 !important; }
        }
    </style>
</head>
<body>

    <div id="loginScreen" class="login-wrapper">
        <div class="login-card">
            <div style="font-size: 3rem; color: var(--primary); margin-bottom: 1rem;"><i class="fas fa-shield-alt"></i></div>
            <h2 style="margin-bottom: 0.5rem; color: #333;">تسجيل دخول المسؤول</h2>
            <p style="color: #666; margin-bottom: 2rem;">نظام إدارة الشكاوى الموحد v2.0</p>
            <form id="loginForm">
                <input type="text" id="loginUser" class="login-input" placeholder="اسم المستخدم" required>
                <input type="password" id="loginPass" class="login-input" placeholder="كلمة المرور" required>
                <button type="submit" class="btn-main">دخول آمن <i class="fas fa-arrow-left"></i></button>
            </form>
        </div>
    </div>

    <div id="dashboardApp" class="dashboard-container hidden">
        <aside class="sidebar">
            <div class="logo-area">
                <i class="fas fa-layer-group"></i>
                <span>لوحة التحكم</span>
            </div>
            <nav>
                <div class="nav-item active" onclick="navigate('home')">
                    <i class="fas fa-home"></i> الرئيسية
                </div>
                <div class="nav-item" onclick="navigate('complaints')">
                    <i class="fas fa-inbox"></i> الشكاوى
                    <span id="sideBadge" class="badge bg-danger hidden" style="margin-right:auto; background:red; color:#fff; font-size:0.7rem;">0</span>
                </div>
                <div class="nav-item" onclick="navigate('users')">
                    <i class="fas fa-users-cog"></i> المستخدمين
                </div>
                <div class="nav-item" onclick="navigate('settings')">
                    <i class="fas fa-sliders-h"></i> الإعدادات
                </div>
                <div style="margin-top: 2rem; border-top: 1px solid var(--border); padding-top: 1rem;">
                    <div class="nav-item" onclick="logout()" style="color: var(--danger);">
                        <i class="fas fa-sign-out-alt"></i> تسجيل خروج
                    </div>
                </div>
            </nav>
        </aside>

        <main class="main-content">
            <header class="top-header">
                <div>
                    <h2 id="pageTitle" style="font-weight: 800;">نظرة عامة</h2>
                    <p style="color: var(--text-gray);" id="welcomeMsg">أهلاً بك، المسؤول</p>
                </div>
                
                <div class="header-actions">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="globalSearch" placeholder="بحث سريع في كل شيء...">
                    </div>
                    
                    <button class="icon-btn" onclick="toggleTheme()">
                        <i class="fas fa-moon" id="themeIcon"></i>
                    </button>
                    
                    <button class="icon-btn" onclick="testNotification()">
                        <i class="fas fa-bell"></i>
                        <span id="notifDot" class="badge-dot hidden"></span>
                    </button>
                </div>
            </header>

            <div id="view-home" class="view-section">
                <div class="grid stats-grid">
                    <div class="card stat-card">
                        <div class="stat-info">
                            <h3 id="statTotal" style="color: var(--primary);">0</h3>
                            <p>إجمالي الشكاوى</p>
                        </div>
                        <div class="stat-icon" style="background: #dbeafe; color: var(--primary);"><i class="fas fa-folder"></i></div>
                    </div>
                    <div class="card stat-card">
                        <div class="stat-info">
                            <h3 id="statNew" style="color: var(--danger);">0</h3>
                            <p>شكاوى جديدة</p>
                        </div>
                        <div class="stat-icon" style="background: #fee2e2; color: var(--danger);"><i class="fas fa-bell"></i></div>
                    </div>
                    <div class="card stat-card">
                        <div class="stat-info">
                            <h3 id="statSolved" style="color: var(--success);">0</h3>
                            <p>تم حلها</p>
                        </div>
                        <div class="stat-icon" style="background: #d1fae5; color: var(--success);"><i class="fas fa-check"></i></div>
                    </div>
                    <div class="card stat-card">
                        <div class="stat-info">
                            <h3 id="statPending" style="color: var(--warning);">0</h3>
                            <p>قيد المعالجة</p>
                        </div>
                        <div class="stat-icon" style="background: #ffedd5; color: var(--warning);"><i class="fas fa-clock"></i></div>
                    </div>
                </div>

                <div class="grid charts-grid">
                    <div class="card">
                        <h4><i class="fas fa-chart-line"></i> نشاط الشكاوى</h4>
                        <canvas id="mainChart" height="200"></canvas>
                    </div>
                    <div class="card">
                        <h4><i class="fas fa-chart-pie"></i> توزيع الأقسام</h4>
                        <canvas id="pieChart" height="200"></canvas>
                    </div>
                </div>

                <div class="card">
                    <div class="flex" style="justify-content: space-between; margin-bottom: 1rem;">
                        <h4><i class="fas fa-history"></i> أحدث 5 شكاوى</h4>
                        <button onclick="navigate('complaints')" style="border:none; background:none; color:var(--primary); cursor:pointer;">عرض الكل</button>
                    </div>
                    <div class="table-container">
                        <table id="latestTable">
                            <thead><tr><th>الرقم</th><th>الاسم</th><th>القسم</th><th>الحالة</th><th>التاريخ</th><th>إجراء</th></tr></thead>
                            <tbody id="latestTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-complaints" class="view-section hidden">
                <div class="card" style="margin-bottom: 1.5rem;">
                    <div class="flex" style="justify-content: space-between; flex-wrap: wrap; gap: 10px;">
                        <div class="flex" style="gap: 10px;">
                            <select id="filterStatus" class="login-input" style="width: 150px; margin:0; padding: 8px;">
                                <option value="">الكل</option>
                                <option value="جديدة">جديدة</option>
                                <option value="قيد المعالجة">قيد المعالجة</option>
                                <option value="مكتملة">مكتملة</option>
                            </select>
                            <select id="filterDept" class="login-input" style="width: 150px; margin:0; padding: 8px;">
                                <option value="">كل الأقسام</option>
                            </select>
                        </div>
                        <button onclick="exportExcel()" class="btn-main" style="width: auto; padding: 8px 15px; background: #10b981;"><i class="fas fa-file-excel"></i> تصدير Excel</button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table id="mainTable">
                        <thead><tr><th>الرقم</th><th>الاسم</th><th>القسم</th><th>الهاتف</th><th>الحالة</th><th>التاريخ</th><th>تحكم</th></tr></thead>
                        <tbody id="mainTableBody"></tbody>
                    </table>
                </div>
                <div id="pagination" class="pagination"></div>
            </div>
            
            <div id="view-users" class="view-section hidden">
                <div class="card">
                    <div class="flex" style="justify-content: space-between;">
                        <h3>صلاحيات المسؤولين</h3>
                        <button onclick="openUserModal()" class="btn-main" style="width: auto; padding: 8px 15px;">+ إضافة</button>
                    </div>
                    <div id="usersList" class="grid stats-grid" style="margin-top: 1.5rem;"></div>
                </div>
            </div>

            <div id="view-settings" class="view-section hidden">
                <div class="card">
                    <h3>الإعدادات العامة</h3>
                    <p style="margin-top: 10px;">تفعيل التنبيهات الصوتية: <input type="checkbox" checked></p>
                    <hr style="margin: 20px 0; border-color: var(--border);">
                    <button class="btn-main" style="width: auto;" onclick="requestNotification()">طلب إذن الإشعارات</button>
                </div>
            </div>
        </main>
    </div>

    <div class="mobile-nav hidden" id="mobileNav">
        <div class="mobile-nav-item active" onclick="navigate('home')"><i class="fas fa-home"></i> الرئيسية</div>
        <div class="mobile-nav-item" onclick="navigate('complaints')"><i class="fas fa-inbox"></i> الشكاوى</div>
        <div class="mobile-nav-item" onclick="navigate('users')"><i class="fas fa-users"></i> المستخدمين</div>
    </div>

    <div class="modal-overlay" id="complaintModal">
        <div class="modal-box">
            <div style="background: var(--primary); color: #fff; padding: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
                <h3 id="modalTitle">تفاصيل الشكوى</h3>
                <button onclick="closeModal()" style="background:none; border:none; color:#fff; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            <div style="padding: 2rem;" id="modalContent">
                </div>
        </div>
    </div>

    <div class="modal-overlay" id="userModal">
        <div class="modal-box" style="max-width: 400px;">
            <div style="padding: 2rem;">
                <h3>إضافة مستخدم جديد</h3>
                <input type="text" id="newUserName" class="login-input" placeholder="الاسم" style="margin-top: 1rem;">
                <input type="text" id="newUserUser" class="login-input" placeholder="اسم المستخدم">
                <input type="password" id="newUserPass" class="login-input" placeholder="كلمة المرور">
                <select id="newUserRole" class="login-input">
                    <option value="admin">مدير</option>
                    <option value="viewer">مشاهد</option>
                </select>
                <button onclick="saveNewUser()" class="btn-main">حفظ</button>
                <button onclick="document.getElementById('userModal').style.display='none'" class="btn-main" style="background: var(--text-gray); margin-top: 5px;">إلغاء</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // --- 1. إعدادات النظام ---
        const firebaseConfig = {
            apiKey: "AIzaSyBIIStbiZD0ZJ6su7C1bwZlBvqx-PP-t58",
            authDomain: "shakawa-e0a3c.firebaseapp.com",
            databaseURL: "https://shakawa-e0a3c-default-rtdb.firebaseio.com",
            projectId: "shakawa-e0a3c",
            storageBucket: "shakawa-e0a3c.firebasestorage.app",
            messagingSenderId: "111620348664",
            appId: "1:111620348664:web:670fdf5caed46eb691b90d",
            measurementId: "G-SGNTJZDQ1L"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // حالة التطبيق
        let state = {
            complaints: [],
            users: [],
            departments: new Set(),
            currentPage: 1,
            rowsPerPage: 10,
            filter: { status: '', dept: '', search: '' },
            user: null
        };

        // --- 2. إدارة الدخول (Auth) ---
        // تسجيل الدخول
        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const u = document.getElementById('loginUser').value.trim();
            const p = document.getElementById('loginPass').value.trim();

            if (u === 'admin' && p === '742018') { // الدخول الرئيسي
                initSession({ name: 'المدير العام', role: 'admin' });
            } else {
                // التحقق من المستخدمين في قاعدة البيانات
                const found = state.users.find(usr => usr.username === u && usr.password === p);
                if (found) initSession(found);
                else Swal.fire('خطأ', 'بيانات الدخول غير صحيحة', 'error');
            }
        });

        function initSession(user) {
            state.user = user;
            localStorage.setItem('admin_user', JSON.stringify(user));
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboardApp').classList.remove('hidden');
            if (window.innerWidth <= 768) document.getElementById('mobileNav').classList.remove('hidden');
            document.getElementById('welcomeMsg').textContent = `أهلاً بك، ${user.name}`;
            renderUsers(); // تحميل قائمة المستخدمين
            
            // صوت الترحيب
            playTone('success');
        }

        function logout() {
            localStorage.removeItem('admin_user');
            location.reload();
        }

        // --- 3. جلب البيانات (Realtime) ---
        // تحميل الشكاوى
        db.ref('complaints').on('value', (snap) => {
            const data = snap.val();
            const oldLength = state.complaints.length;
            state.complaints = [];
            state.departments.clear();
            
            if (data) {
                Object.keys(data).forEach(key => {
                    const item = { id: key, ...data[key] };
                    state.complaints.push(item);
                    if (item.department) state.departments.add(item.department);
                });
                // ترتيب تنازلي (الأحدث أولاً)
                state.complaints.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            }

            // تحديث الواجهة
            updateStats();
            updateCharts();
            renderTable();
            populateDeptsFilter();

            // تنبيه بوجود شكوى جديدة
            if (state.complaints.length > oldLength && oldLength !== 0) {
                playTone('notification');
                Swal.fire({
                    position: 'top-end',
                    icon: 'info',
                    title: 'تم استلام شكوى جديدة',
                    showConfirmButton: false,
                    timer: 1500,
                    toast: true
                });
            }
        });

        // تحميل المستخدمين
        db.ref('users').on('value', (snap) => {
            const data = snap.val();
            state.users = [];
            if (data) {
                Object.keys(data).forEach(key => state.users.push({ key, ...data[key] }));
            }
            renderUsers();
        });

        // --- 4. العرض والواجهة (UI Rendering) ---
        function updateStats() {
            const total = state.complaints.length;
            const newC = state.complaints.filter(c => c.status === 'جديدة').length;
            const solved = state.complaints.filter(c => c.status === 'مكتملة' || c.status === 'تم الرد').length;
            const pending = state.complaints.filter(c => c.status === 'قيد المعالجة').length;

            animateValue('statTotal', parseInt(document.getElementById('statTotal').innerText), total, 1000);
            document.getElementById('statNew').textContent = newC;
            document.getElementById('statSolved').textContent = solved;
            document.getElementById('statPending').textContent = pending;

            // تحديث النقطة الحمراء
            if (newC > 0) {
                document.getElementById('notifDot').classList.remove('hidden');
                document.getElementById('sideBadge').classList.remove('hidden');
                document.getElementById('sideBadge').textContent = newC;
            } else {
                document.getElementById('notifDot').classList.add('hidden');
                document.getElementById('sideBadge').classList.add('hidden');
            }
        }

        function renderTable() {
            // تصفية البيانات
            let filtered = state.complaints.filter(c => {
                const s = state.filter.search.toLowerCase();
                const matchesSearch = !s || 
                    (c.fullName && c.fullName.toLowerCase().includes(s)) ||
                    (c.complaintNumber && c.complaintNumber.includes(s)) ||
                    (c.nationalId && c.nationalId.includes(s));
                const matchesStatus = !state.filter.status || c.status === state.filter.status;
                const matchesDept = !state.filter.dept || c.department === state.filter.dept;
                return matchesSearch && matchesStatus && matchesDept;
            });

            // الجدول الصغير (الرئيسية)
            const latestBody = document.getElementById('latestTableBody');
            latestBody.innerHTML = filtered.slice(0, 5).map(c => rowTemplate(c, true)).join('');

            // الجدول الكبير (صفحة الشكاوى) مع Pagination
            const mainBody = document.getElementById('mainTableBody');
            const start = (state.currentPage - 1) * state.rowsPerPage;
            const end = start + state.rowsPerPage;
            const pageData = filtered.slice(start, end);
            
            mainBody.innerHTML = pageData.map(c => rowTemplate(c, false)).join('');
            renderPagination(filtered.length);
        }

        function rowTemplate(c, isMini) {
            const statusClass = c.status === 'جديدة' ? 'bg-new' : (c.status === 'مكتملة' ? 'bg-success' : 'bg-pending');
            const dateStr = new Date(c.createdAt).toLocaleDateString('ar-EG');
            
            if (isMini) {
                return `<tr>
                    <td>${c.complaintNumber || '#'}</td>
                    <td>${escapeHtml(c.fullName)}</td>
                    <td>${escapeHtml(c.department)}</td>
                    <td><span class="badge ${statusClass}">${c.status}</span></td>
                    <td>${dateStr}</td>
                    <td><button class="action-btn btn-view" onclick="openModal('${c.id}')"><i class="fas fa-eye"></i></button></td>
                </tr>`;
            }
            return `<tr>
                <td style="font-weight:bold">${c.complaintNumber || '#'}</td>
                <td>${escapeHtml(c.fullName)}</td>
                <td>${escapeHtml(c.department)}</td>
                <td>${c.phone1 || '-'}</td>
                <td><span class="badge ${statusClass}">${c.status}</span></td>
                <td>${dateStr}</td>
                <td>
                    <button class="action-btn btn-view" onclick="openModal('${c.id}')" title="عرض"><i class="fas fa-eye"></i></button>
                    <button class="action-btn btn-pdf" onclick="printReport('${c.id}')" title="طباعة"><i class="fas fa-print"></i></button>
                    ${state.user && state.user.role === 'admin' ? `<button class="action-btn btn-del" onclick="deleteItem('${c.id}')" title="حذف"><i class="fas fa-trash"></i></button>` : ''}
                </td>
            </tr>`;
        }

        // --- 5. الرسوم البيانية (Charts) ---
        let mainChart, pieChart;
        function updateCharts() {
            // تجهيز البيانات
            const depts = {};
            state.complaints.forEach(c => {
                const d = c.department || 'غير محدد';
                depts[d] = (depts[d] || 0) + 1;
            });

            // Pie Chart (Departments)
            const ctxPie = document.getElementById('pieChart').getContext('2d');
            if (pieChart) pieChart.destroy();
            pieChart = new Chart(ctxPie, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(depts),
                    datasets: [{
                        data: Object.values(depts),
                        backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6']
                    }]
                },
                options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
            });

            // Line Chart (Activity - Mock for demo, normally grouped by date)
            const ctxMain = document.getElementById('mainChart').getContext('2d');
            if (mainChart) mainChart.destroy();
            mainChart = new Chart(ctxMain, {
                type: 'bar',
                data: {
                    labels: ['جديدة', 'قيد المعالجة', 'مكتملة'],
                    datasets: [{
                        label: 'حالة الشكاوى',
                        data: [
                            state.complaints.filter(c => c.status === 'جديدة').length,
                            state.complaints.filter(c => c.status === 'قيد المعالجة').length,
                            state.complaints.filter(c => c.status === 'مكتملة').length
                        ],
                        backgroundColor: ['#3b82f6', '#f59e0b', '#10b981'],
                        borderRadius: 5
                    }]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true } } }
            });
        }

        // --- 6. التفاصيل والتحكم (Modal Actions) ---
        function openModal(id) {
            const c = state.complaints.find(x => x.id === id);
            if (!c) return;
            
            // توليد QR Code
            const link = `https://mohamednasr5.github.io/shakawa/?id=${c.complaintNumber}`;
            const qr = `https://chart.googleapis.com/chart?cht=qr&chs=120x120&chl=${encodeURIComponent(link)}&choe=UTF-8`;

            // HTML المحتوى
            const html = `
                <div style="display:grid; grid-template-columns: 2fr 1fr; gap:20px;">
                    <div>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; background:var(--bg-light); padding:15px; border-radius:10px;">
                            <div><strong>الاسم:</strong> ${escapeHtml(c.fullName)}</div>
                            <div><strong>الرقم القومي:</strong> ${escapeHtml(c.nationalId)}</div>
                            <div><strong>الهاتف:</strong> ${escapeHtml(c.phone1)}</div>
                            <div><strong>القسم:</strong> ${escapeHtml(c.department)}</div>
                        </div>
                        <div style="margin-top:15px;">
                            <strong>تفاصيل المشكلة:</strong>
                            <p style="background:#fff; border:1px solid var(--border); padding:10px; border-radius:5px; margin-top:5px; min-height:80px;">${escapeHtml(c.problemDetails)}</p>
                        </div>
                    </div>
                    <div style="text-align:center;">
                        <img src="${qr}" style="border:1px solid #ddd; padding:5px; border-radius:5px;">
                        <div style="margin-top:10px; font-weight:bold; font-size:1.2rem; color:var(--primary);">${c.complaintNumber || '#'}</div>
                    </div>
                </div>
                
                <hr style="margin: 20px 0; border-color: var(--border);">
                
                <div style="display:flex; justify-content:space-between; align-items:center; background:var(--bg-light); padding:15px; border-radius:10px;">
                    <div class="flex" style="gap:10px;">
                        <strong>تحديث الحالة:</strong>
                        <select id="updateStatusSelect" class="login-input" style="width:auto; margin:0; padding:5px;">
                            <option value="جديدة" ${c.status==='جديدة'?'selected':''}>جديدة</option>
                            <option value="قيد المعالجة" ${c.status==='قيد المعالجة'?'selected':''}>قيد المعالجة</option>
                            <option value="تم الرد" ${c.status==='تم الرد'?'selected':''}>تم الرد</option>
                            <option value="مكتملة" ${c.status==='مكتملة'?'selected':''}>مكتملة</option>
                        </select>
                        <button onclick="updateStatus('${c.id}')" class="btn-main" style="width:auto; padding:5px 15px;">حفظ</button>
                    </div>
                    <button onclick="printReport('${c.id}')" class="btn-main" style="width:auto; background:var(--text-gray);"><i class="fas fa-print"></i> طباعة</button>
                </div>
            `;
            
            document.getElementById('modalContent').innerHTML = html;
            document.getElementById('complaintModal').style.display = 'flex';
        }

        function closeModal() { document.getElementById('complaintModal').style.display = 'none'; }
        
        function updateStatus(id) {
            const newStatus = document.getElementById('updateStatusSelect').value;
            db.ref('complaints/' + id).update({ status: newStatus, updatedAt: new Date().toISOString() })
                .then(() => {
                    Swal.fire('تم', 'تم تحديث حالة الشكوى', 'success');
                    closeModal();
                });
        }

        function deleteItem(id) {
            Swal.fire({
                title: 'هل أنت متأكد؟',
                text: "لا يمكن التراجع عن الحذف!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'نعم، احذف',
                cancelButtonText: 'إلغاء'
            }).then((result) => {
                if (result.isConfirmed) {
                    db.ref('complaints/' + id).remove();
                }
            });
        }

        // --- 7. وظائف إضافية (Print, Excel, Utils) ---
        function printReport(id) {
            const c = state.complaints.find(x => x.id === id);
            const win = window.open('', '_blank');
            win.document.write(`
                <html dir="rtl"><head><title>تقرير شكوى</title>
                <style>body{font-family:'Segoe UI',sans-serif;padding:40px} .header{text-align:center;border-bottom:2px solid #000;padding-bottom:20px;margin-bottom:30px} table{width:100%;border-collapse:collapse} td{padding:10px;border-bottom:1px solid #ddd} .label{font-weight:bold;width:150px}</style>
                </head><body>
                <div class="header"><h1>نظام الشكاوى الموحد</h1><h3>تقرير تفصيلي للشكوى رقم ${c.complaintNumber}</h3></div>
                <table>
                    <tr><td class="label">الاسم:</td><td>${c.fullName}</td></tr>
                    <tr><td class="label">الرقم القومي:</td><td>${c.nationalId}</td></tr>
                    <tr><td class="label">القسم:</td><td>${c.department}</td></tr>
                    <tr><td class="label">تاريخ الطلب:</td><td>${new Date(c.createdAt).toLocaleString('ar-EG')}</td></tr>
                    <tr><td class="label">الحالة الحالية:</td><td>${c.status}</td></tr>
                </table>
                <h3 style="margin-top:30px">تفاصيل الشكوى:</h3>
                <div style="border:1px solid #000; padding:20px; min-height:100px">${c.problemDetails}</div>
                <div style="margin-top:50px; text-align:left;"><strong>توقيع المسؤول:</strong> ....................</div>
                <script>window.print()<\/script>
                </body></html>
            `);
        }

        function exportExcel() {
            const data = state.complaints.map(c => ({
                "الرقم": c.complaintNumber, "الاسم": c.fullName, "القسم": c.department, "الحالة": c.status, "التاريخ": new Date(c.createdAt).toLocaleDateString()
            }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "الشكاوى");
            XLSX.writeFile(wb, "تقرير_الشكاوى.xlsx");
        }

        // --- 8. المساعدة والتنقل ---
        function navigate(viewId) {
            // إخفاء كل الواجهات
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            // إظهار الواجهة المطلوبة
            document.getElementById('view-' + viewId).classList.remove('hidden');
            
            // تحديث القائمة النشطة
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            // البحث عن الزر المناسب وتنشيطه (تقريبي)
            event.currentTarget.classList.add('active');
            
            // العنوان
            const titles = { 'home': 'نظرة عامة', 'complaints': 'إدارة الشكاوى', 'users': 'المستخدمين', 'settings': 'الإعدادات' };
            document.getElementById('pageTitle').textContent = titles[viewId];
        }

        // أدوات مساعدة
        function escapeHtml(text) { return text ? text.toString().replace(/</g, "&lt;") : '-'; }
        
        function populateDeptsFilter() {
            const sel = document.getElementById('filterDept');
            sel.innerHTML = '<option value="">كل الأقسام</option>';
            state.departments.forEach(d => sel.innerHTML += `<option value="${d}">${d}</option>`);
        }

        // بحث وتصفية
        document.getElementById('globalSearch').addEventListener('input', (e) => {
            state.filter.search = e.target.value;
            renderTable();
        });
        document.getElementById('filterStatus').addEventListener('change', (e) => { state.filter.status = e.target.value; renderTable(); });
        document.getElementById('filterDept').addEventListener('change', (e) => { state.filter.dept = e.target.value; renderTable(); });

        // الوضع الليلي
        function toggleTheme() {
            if(document.body.getAttribute('data-theme') === 'dark') {
                document.body.removeAttribute('data-theme');
                document.getElementById('themeIcon').classList.replace('fa-sun', 'fa-moon');
            } else {
                document.body.setAttribute('data-theme', 'dark');
                document.getElementById('themeIcon').classList.replace('fa-moon', 'fa-sun');
            }
        }

        // مؤثرات صوتية ورقمية
        function animateValue(id, start, end, duration) {
            if (start === end) return;
            const obj = document.getElementById(id);
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = Math.floor(progress * (end - start) + start);
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        }

        function playTone(type) {
            // بسيطة لغرض المثال (يمكن استبدالها بملفات صوتية حقيقية)
            // في البيئة الحقيقية تحتاج user interaction أولاً
        }

        // --- التهيئة عند التحميل ---
        window.onload = () => {
            // التحقق من وجود جلسة محفوظة
            const saved = localStorage.getItem('admin_user');
            if (saved) initSession(JSON.parse(saved));
        };
        
        // --- إدارة المستخدمين (إضافة/حذف) ---
        function openUserModal() { document.getElementById('userModal').style.display='flex'; }
        function saveNewUser() {
            const n = document.getElementById('newUserName').value;
            const u = document.getElementById('newUserUser').value;
            const p = document.getElementById('newUserPass').value;
            const r = document.getElementById('newUserRole').value;
            
            if(n && u && p) {
                db.ref('users').push({ name: n, username: u, password: p, role: r });
                document.getElementById('userModal').style.display='none';
                Swal.fire('تم', 'تم إضافة المستخدم', 'success');
            }
        }
        function renderUsers() {
            const container = document.getElementById('usersList');
            container.innerHTML = `
                <div class="card stat-card" style="border-right: 4px solid var(--primary);">
                    <div class="stat-info">
                        <h3>المدير العام</h3>
                        <p>Super Admin</p>
                    </div>
                </div>
            `;
            state.users.forEach(u => {
                container.innerHTML += `
                    <div class="card stat-card">
                        <div class="stat-info">
                            <h3>${escapeHtml(u.name)}</h3>
                            <p>${u.role}</p>
                        </div>
                        <button onclick="db.ref('users/${u.key}').remove()" style="color:red;border:none;background:none;cursor:pointer">حذف</button>
                    </div>
                `;
            });
        }
        
        // Pagination Logic
        function renderPagination(totalItems) {
            const pages = Math.ceil(totalItems / state.rowsPerPage);
            const container = document.getElementById('pagination');
            container.innerHTML = '';
            for(let i=1; i<=pages; i++) {
                const btn = document.createElement('button');
                btn.className = `page-btn ${i === state.currentPage ? 'active' : ''}`;
                btn.innerText = i;
                btn.onclick = () => { state.currentPage = i; renderTable(); };
                container.appendChild(btn);
            }
        }
    </script>
</body>
</html>
