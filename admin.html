<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم - نظام الشكاوى الموحد</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Cairo', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* أنماط تسجيل الدخول */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .login-box {
            background: white;
            border-radius: 15px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .login-logo {
            font-size: 2.5rem;
            color: #1a5fb4;
            margin-bottom: 10px;
        }
        
        .login-title {
            font-size: 1.5rem;
            color: #2c3e50;
            margin-bottom: 30px;
        }
        
        .login-form .form-group {
            margin-bottom: 20px;
            text-align: right;
        }
        
        .login-form .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .login-form .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border 0.3s;
        }
        
        .login-form .form-control:focus {
            border-color: #1a5fb4;
            outline: none;
            box-shadow: 0 0 0 2px rgba(26, 95, 180, 0.2);
        }
        
        .login-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(to right, #1a5fb4, #2d8fd5);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .login-btn:hover {
            background: linear-gradient(to right, #155093, #1a5fb4);
        }
        
        .login-error {
            color: #e74c3c;
            margin-top: 15px;
            padding: 10px;
            background: #fde8e8;
            border-radius: 6px;
            display: none;
        }
        
        /* أنماط لوحة التحكم */
        header {
            background: linear-gradient(135deg, #1a5fb4 0%, #2d8fd5 100%);
            color: white;
            padding: 25px 0;
            text-align: center;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            margin-bottom: 40px;
            position: relative;
            overflow: hidden;
        }
        
        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #ff7e5f, #feb47b, #86a8e7, #91eae4);
            background-size: 400% 400%;
            animation: gradientShift 8s ease infinite;
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .logo {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .admin-bar {
            background: linear-gradient(135deg, #2c3e50 0%, #4a6572 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .admin-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .admin-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3498db, #2c3e50);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        
        .admin-stats {
            display: flex;
            gap: 20px;
        }
        
        .stat-box {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            border-radius: 8px;
            text-align: center;
            min-width: 120px;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .logout-btn:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 30px;
        }
        
        .sidebar {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            height: fit-content;
        }
        
        .sidebar-title {
            font-size: 1.3rem;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .sidebar-menu {
            list-style: none;
        }
        
        .menu-item {
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #555;
        }
        
        .menu-item:hover {
            background: #f8f9fa;
            transform: translateX(-5px);
        }
        
        .menu-item.active {
            background: linear-gradient(to right, #1a5fb4, #2d8fd5);
            color: white;
        }
        
        .menu-icon {
            font-size: 1.2rem;
        }
        
        .main-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .content-title {
            font-size: 1.8rem;
            color: #2c3e50;
        }
        
        .filters-container {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .filter-label {
            font-size: 0.9rem;
            color: #666;
            font-weight: 600;
        }
        
        .filter-select {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            min-width: 180px;
            background: white;
            font-size: 0.95rem;
        }
        
        .search-box {
            position: relative;
            flex-grow: 1;
            max-width: 400px;
        }
        
        .search-input {
            width: 100%;
            padding: 12px 45px 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }
        
        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }
        
        .complaints-table-container {
            overflow-x: auto;
            border-radius: 10px;
            border: 1px solid #eee;
        }
        
        .complaints-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }
        
        .complaints-table th {
            background: linear-gradient(to right, #f8f9fa, #e9ecef);
            padding: 15px;
            text-align: right;
            font-weight: 700;
            color: #2c3e50;
            border-bottom: 2px solid #dee2e6;
        }
        
        .complaints-table td {
            padding: 15px;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
        }
        
        .complaints-table tbody tr {
            transition: all 0.3s ease;
        }
        
        .complaints-table tbody tr:hover {
            background: #f8f9fa;
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-block;
            text-align: center;
            min-width: 100px;
        }
        
        .status-new {
            background: #d4edda;
            color: #155724;
        }
        
        .status-in-progress {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-resolved {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .status-closed {
            background: #d6d8d9;
            color: #383d41;
        }
        
        .priority-badge {
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
        }
        
        .priority-normal {
            background: #d4edda;
            color: #155724;
        }
        
        .priority-important {
            background: #fff3cd;
            color: #856404;
        }
        
        .priority-critical {
            background: #f8d7da;
            color: #721c24;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s ease;
        }
        
        .btn-view {
            background: #3498db;
            color: white;
        }
        
        .btn-view:hover {
            background: #2980b9;
        }
        
        .btn-reply {
            background: #28a745;
            color: white;
        }
        
        .btn-reply:hover {
            background: #218838;
        }
        
        .btn-delete {
            background: #dc3545;
            color: white;
        }
        
        .btn-delete:hover {
            background: #c82333;
        }
        
        .btn-export {
            background: #6c757d;
            color: white;
        }
        
        .btn-export:hover {
            background: #5a6268;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 30px;
            gap: 10px;
        }
        
        .page-btn {
            padding: 8px 15px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .page-btn:hover {
            background: #f8f9fa;
        }
        
        .page-btn.active {
            background: #1a5fb4;
            color: white;
            border-color: #1a5fb4;
        }
        
        .page-info {
            margin: 0 15px;
            color: #666;
        }
        
        /* أنماط عرض تفاصيل الشكوى */
        .complaint-details-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        
        .modal-header {
            background: linear-gradient(135deg, #1a5fb4 0%, #2d8fd5 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 1.5rem;
        }
        
        .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 1.8rem;
            cursor: pointer;
            line-height: 1;
        }
        
        .modal-body {
            padding: 30px;
        }
        
        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .detail-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .detail-label {
            font-weight: 700;
            color: #1a5fb4;
            margin-bottom: 5px;
        }
        
        .responses-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #f0f0f0;
        }
        
        .response-item {
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            position: relative;
        }
        
        .response-admin {
            background-color: #d4edda;
            border-right: 4px solid #28a745;
        }
        
        .response-client {
            background-color: #f8f9fa;
            border-right: 4px solid #6c757d;
        }
        
        .response-date {
            font-size: 0.85rem;
            color: #666;
            margin-top: 8px;
            text-align: left;
        }
        
        .reply-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border: 1px solid #e9ecef;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border 0.3s;
        }
        
        .form-control:focus {
            border-color: #1a5fb4;
            outline: none;
            box-shadow: 0 0 0 2px rgba(26, 95, 180, 0.2);
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(to right, #1a5fb4, #2d8fd5);
            color: white;
        }
        
        .btn-primary:hover {
            background: linear-gradient(to right, #155093, #1a5fb4);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        /* أنماط قسم الإحصائيات */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 20px;
            border-top: 5px solid;
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card.new {
            border-color: #28a745;
        }
        
        .stat-card.progress {
            border-color: #ffc107;
        }
        
        .stat-card.resolved {
            border-color: #17a2b8;
        }
        
        .stat-card.closed {
            border-color: #6c757d;
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: white;
        }
        
        .stat-icon.new {
            background: linear-gradient(135deg, #28a745, #20c997);
        }
        
        .stat-icon.progress {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
        }
        
        .stat-icon.resolved {
            background: linear-gradient(135deg, #17a2b8, #0dcaf0);
        }
        
        .stat-icon.closed {
            background: linear-gradient(135deg, #6c757d, #adb5bd);
        }
        
        .stat-content h3 {
            font-size: 1.8rem;
            margin-bottom: 5px;
            color: #2c3e50;
        }
        
        .stat-content p {
            color: #666;
            font-size: 0.95rem;
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .chart-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .chart-title {
            font-size: 1.3rem;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .chart-placeholder {
            height: 300px;
            background: #f8f9fa;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 1.1rem;
        }
        
        /* أنماط قسم المستخدمين */
        .users-table-container {
            overflow-x: auto;
            border-radius: 10px;
            border: 1px solid #eee;
        }
        
        .users-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        
        .users-table th {
            background: linear-gradient(to right, #f8f9fa, #e9ecef);
            padding: 15px;
            text-align: right;
            font-weight: 700;
            color: #2c3e50;
            border-bottom: 2px solid #dee2e6;
        }
        
        .users-table td {
            padding: 15px;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
        }
        
        /* أنماط قسم الإعدادات */
        .settings-form {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .settings-group {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .settings-title {
            font-size: 1.3rem;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
            margin-left: 15px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #28a745;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        .toggle-label {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.9rem;
            margin-top: 50px;
        }
        
        /* أنماط نافذة إضافة مستخدم */
        .user-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }
        
        .user-modal-content {
            background: white;
            border-radius: 15px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        
        /* أنماط زر اتصال وواتساب */
        .phone-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        
        .call-btn, .whatsapp-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s ease;
            text-decoration: none;
        }
        
        .call-btn {
            background: #28a745;
            color: white;
        }
        
        .call-btn:hover {
            background: #218838;
        }
        
        .whatsapp-btn {
            background: #25D366;
            color: white;
        }
        
        .whatsapp-btn:hover {
            background: #1da851;
        }
        
        /* أنماط المشكلات الحرجة */
        .complaint-row.critical {
            background-color: rgba(220, 53, 69, 0.1) !important;
            animation: blinkCritical 1s infinite;
            position: relative;
        }
        
        .complaint-row.critical::before {
            content: '!';
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: #dc3545;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        @keyframes blinkCritical {
            0%, 100% { background-color: rgba(220, 53, 69, 0.1); }
            50% { background-color: rgba(220, 53, 69, 0.2); }
        }
        
        /* أنماط طباعة الشكوى */
        @media print {
            body * {
                visibility: hidden;
            }
            .print-section, .print-section * {
                visibility: visible;
            }
            .print-section {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 20px;
                font-family: 'Cairo', sans-serif;
                direction: rtl;
            }
            
            .print-header {
                text-align: center;
                margin-bottom: 30px;
                border-bottom: 3px double #333;
                padding-bottom: 20px;
            }
            
            .print-logo {
                font-size: 28px;
                font-weight: bold;
                color: #1a5fb4;
                margin-bottom: 10px;
            }
            
            .print-details {
                page-break-inside: avoid;
            }
            
            .print-problem-details {
                page-break-inside: avoid;
                margin: 20px 0;
            }
            
            @page {
                size: A4;
                margin: 20mm;
            }
            
            body {
                font-size: 14px;
                line-height: 1.5;
            }
            
            .no-print {
                display: none !important;
            }
        }
        
        .print-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #333;
            padding-bottom: 20px;
        }
        
        .print-logo {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .print-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .print-detail-item {
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .print-detail-label {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .print-problem-details {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-right: 4px solid #1a5fb4;
        }
        
        .admin-only {
            display: none;
        }
        
        .admin-only.visible {
            display: inline-flex;
        }
        
        /* أقسام القائمة الجانبية المخفية للمشرفين */
        .menu-item.hidden-for-supervisor {
            display: none !important;
        }
        
        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                display: none;
            }
            
            .mobile-menu-btn {
                display: block;
                background: none;
                border: none;
                font-size: 1.5rem;
                color: #2c3e50;
                cursor: pointer;
            }
        }
        
        @media (max-width: 768px) {
            .admin-bar {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .admin-stats {
                flex-wrap: wrap;
                justify-content: center;
                width: 100%;
            }
            
            .filters-container {
                flex-direction: column;
            }
            
            .filter-select {
                min-width: 100%;
            }
            
            .charts-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- شاشة تسجيل الدخول -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <div class="login-logo">
                <i class="fas fa-user-shield"></i>
            </div>
            <h2 class="login-title">تسجيل دخول المسؤول</h2>
            <form id="loginForm" class="login-form">
                <div class="form-group">
                    <label class="form-label">اسم المستخدم / البريد الإلكتروني</label>
                    <input type="text" class="form-control" id="username" placeholder="أدخل اسم المستخدم" required>
                </div>
                <div class="form-group">
                    <label class="form-label">كلمة المرور</label>
                    <input type="password" class="form-control" id="password" placeholder="أدخل كلمة المرور" required>
                </div>
                <div class="login-error" id="loginError">
                    اسم المستخدم أو كلمة المرور غير صحيحة
                </div>
                <button type="submit" class="login-btn">
                    <i class="fas fa-sign-in-alt"></i>
                    تسجيل الدخول
                </button>
            </form>
        </div>
    </div>
    
    <!-- لوحة التحكم (تظهر بعد تسجيل الدخول) -->
    <div id="dashboardScreen" style="display: none;">
        <header>
            <div class="container">
                <h1 class="logo">لوحة التحكم - نظام الشكاوى الموحد</h1>
                <p class="subtitle">إدارة الشكاوى والطلبات المقدمة من المواطنين</p>
            </div>
        </header>
        
        <div class="container">
            <div class="admin-bar">
                <div class="admin-info">
                    <div class="admin-avatar">
                        <i class="fas fa-user-shield"></i>
                    </div>
                    <div>
                        <h3 style="margin-bottom: 5px;" id="adminWelcome">مرحباً، المسؤول أحمد</h3>
                        <p style="opacity: 0.9; font-size: 0.9rem;" id="adminLastLogin">آخر دخول: اليوم الساعة 10:30 صباحاً</p>
                    </div>
                </div>
                
                <div class="admin-stats">
                    <div class="stat-box">
                        <div class="stat-value" id="totalComplaints">0</div>
                        <div class="stat-label">إجمالي الشكاوى</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="newComplaints">0</div>
                        <div class="stat-label">شكاوى جديدة</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="resolvedComplaints">0</div>
                        <div class="stat-label">تم حلها</div>
                    </div>
                </div>
                
                <button class="logout-btn" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    تسجيل الخروج
                </button>
            </div>
            
            <div class="dashboard-grid">
                <div class="sidebar">
                    <h3 class="sidebar-title">القائمة الرئيسية</h3>
                    <ul class="sidebar-menu">
                        <li class="menu-item active" data-section="dashboard">
                            <i class="fas fa-tachometer-alt menu-icon"></i>
                            <span>لوحة التحكم</span>
                        </li>
                        <li class="menu-item" data-section="complaints">
                            <i class="fas fa-file-alt menu-icon"></i>
                            <span>إدارة الشكاوى</span>
                            <span class="badge" id="complaintsBadge" style="background: #e74c3c; color: white; border-radius: 10px; padding: 2px 8px; font-size: 0.8rem; margin-right: auto; display: none;">0</span>
                        </li>
                        <li class="menu-item admin-only" data-section="users">
                            <i class="fas fa-users menu-icon"></i>
                            <span>المستخدمين</span>
                        </li>
                        <li class="menu-item admin-only" data-section="reports">
                            <i class="fas fa-chart-bar menu-icon"></i>
                            <span>التقارير والإحصائيات</span>
                        </li>
                        <li class="menu-item admin-only" data-section="settings">
                            <i class="fas fa-cog menu-icon"></i>
                            <span>الإعدادات</span>
                        </li>
                    </ul>
                </div>
                
                <div class="main-content">
                    <!-- قسم لوحة التحكم -->
                    <div id="dashboardSection" class="content-section">
                        <div class="content-header">
                            <h2 class="content-title">لوحة التحكم</h2>
                            <div>
                                <button class="btn btn-export admin-only">
                                    <i class="fas fa-download"></i>
                                    تصدير تقرير
                                </button>
                            </div>
                        </div>
                        
                        <div class="stats-grid">
                            <div class="stat-card new">
                                <div class="stat-icon new">
                                    <i class="fas fa-file-alt"></i>
                                </div>
                                <div class="stat-content">
                                    <h3 id="statNew">0</h3>
                                    <p>شكاوى جديدة</p>
                                </div>
                            </div>
                            <div class="stat-card progress">
                                <div class="stat-icon progress">
                                    <i class="fas fa-spinner"></i>
                                </div>
                                <div class="stat-content">
                                    <h3 id="statInProgress">0</h3>
                                    <p>قيد المتابعة</p>
                                </div>
                            </div>
                            <div class="stat-card resolved">
                                <div class="stat-icon resolved">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div class="stat-content">
                                    <h3 id="statResolved">0</h3>
                                    <p>تم حلها</p>
                                </div>
                            </div>
                            <div class="stat-card closed">
                                <div class="stat-icon closed">
                                    <i class="fas fa-archive"></i>
                                </div>
                                <div class="stat-content">
                                    <h3 id="statClosed">0</h3>
                                    <p>مغلقة</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="charts-container">
                            <div class="chart-card">
                                <h3 class="chart-title">توزيع الشكاوى حسب القسم</h3>
                                <div class="chart-placeholder">
                                    <i class="fas fa-chart-pie" style="font-size: 2rem; margin-left: 10px;"></i>
                                    <span>رسم بياني لتوزيع الشكاوى حسب القسم</span>
                                </div>
                            </div>
                            <div class="chart-card">
                                <h3 class="chart-title">الشكاوى خلال الشهر</h3>
                                <div class="chart-placeholder">
                                    <i class="fas fa-chart-line" style="font-size: 2rem; margin-left: 10px;"></i>
                                    <span>رسم بياني لعدد الشكاوى خلال الشهر</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="content-header" style="margin-top: 40px;">
                            <h2 class="content-title">آخر الشكاوى</h2>
                            <button class="btn btn-primary" onclick="showSection('complaints')">
                                <i class="fas fa-eye"></i>
                                عرض الكل
                            </button>
                        </div>
                        
                        <div class="complaints-table-container">
                            <table class="complaints-table">
                                <thead>
                                    <tr>
                                        <th>رقم الشكوى</th>
                                        <th>الاسم</th>
                                        <th>القسم</th>
                                        <th>الحالة</th>
                                        <th>التاريخ</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="recentComplaintsTable">
                                    <!-- سيتم ملؤها بواسطة JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- قسم إدارة الشكاوى -->
                    <div id="complaintsSection" class="content-section" style="display: none;">
                        <div class="content-header">
                            <h2 class="content-title">إدارة الشكاوى</h2>
                            <button class="btn btn-primary" id="refreshComplaints">
                                <i class="fas fa-sync-alt"></i>
                                تحديث القائمة
                            </button>
                        </div>
                        
                        <div class="filters-container">
                            <div class="filter-group">
                                <label class="filter-label">حالة الشكوى</label>
                                <select class="filter-select" id="filterStatus">
                                    <option value="">جميع الحالات</option>
                                    <option value="جديدة">جديدة</option>
                                    <option value="قيد المتابعة">قيد المتابعة</option>
                                    <option value="تم الرد">تم الرد</option>
                                    <option value="مكتملة">مكتملة</option>
                                    <option value="مغلقة">مغلقة</option>
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <label class="filter-label">القسم</label>
                                <select class="filter-select" id="filterDepartment">
                                    <option value="">جميع الأقسام</option>
                                    <option value="مشكلة خاصة بالقضاء والمحاكم">مشكلة خاصة بالقضاء والمحاكم</option>
                                    <option value="مساعدة مالية">مساعدة مالية</option>
                                    <option value="مشكلة خاصة بالصحة">مشكلة خاصة بالصحة</option>
                                    <option value="مشكلات مياه الشرب والصرف الصحي">مشكلات مياه الشرب والصرف الصحي</option>
                                    <option value="مشكلة خاصة بالتعليم">مشكلة خاصة بالتعليم</option>
                                    <option value="مشكلة خاصة بالشرطة والداخلية">مشكلة خاصة بالشرطة والداخلية</option>
                                    <option value="حالة طارئة">حالة طارئة</option>
                                    <option value="مشكلات أخرى">مشكلات أخرى</option>
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <label class="filter-label">نوع المشكلة</label>
                                <select class="filter-select" id="filterPriority">
                                    <option value="">جميع الأنواع</option>
                                    <option value="عادية">عادية</option>
                                    <option value="مهمة">مهمة</option>
                                    <option value="فى غاية الأهمية">فى غاية الأهمية</option>
                                </select>
                            </div>
                            
                            <div class="filter-group search-box">
                                <label class="filter-label">بحث</label>
                                <div style="position: relative;">
                                    <input type="text" class="search-input" id="searchInput" placeholder="ابحث برقم الشكوى أو الاسم...">
                                    <i class="fas fa-search search-icon"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="complaints-table-container">
                            <table class="complaints-table">
                                <thead>
                                    <tr>
                                        <th>رقم الشكوى</th>
                                        <th>الاسم</th>
                                        <th>الرقم القومي</th>
                                        <th>القسم</th>
                                        <th>نوع المشكلة</th>
                                        <th>الحالة</th>
                                        <th>التاريخ</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="complaintsTable">
                                    <!-- سيتم ملؤها بواسطة JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="pagination">
                            <button class="page-btn" id="prevPage">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                            <span class="page-info">الصفحة <span id="currentPage">1</span> من <span id="totalPages">1</span></span>
                            <button class="page-btn" id="nextPage">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- قسم المستخدمين -->
                    <div id="usersSection" class="content-section" style="display: none;">
                        <div class="content-header">
                            <h2 class="content-title">إدارة المستخدمين</h2>
                            <div>
                                <button class="btn btn-secondary" onclick="loadUsers()" style="margin-right: 10px;">
                                    <i class="fas fa-sync-alt"></i>
                                    تحديث
                                </button>
                                <button class="btn btn-primary" onclick="showAddUserModal()">
                                    <i class="fas fa-user-plus"></i>
                                    إضافة مستخدم
                                </button>
                            </div>
                        </div>
                        
                        <div class="users-table-container">
                            <table class="users-table">
                                <thead>
                                    <tr>
                                        <th>الاسم</th>
                                        <th>البريد الإلكتروني</th>
                                        <th>رقم الهاتف</th>
                                        <th>الدور</th>
                                        <th>القسم المسؤول عنه</th>
                                        <th>الحالة</th>
                                        <th>آخر نشاط</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTable">
                                    <!-- سيتم ملؤها بواسطة JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- قسم التقارير والإحصائيات -->
                    <div id="reportsSection" class="content-section" style="display: none;">
                        <div class="content-header">
                            <h2 class="content-title">التقارير والإحصائيات</h2>
                            <div>
                                <button class="btn btn-export" style="margin-left: 10px;">
                                    <i class="fas fa-file-pdf"></i>
                                    تصدير PDF
                                </button>
                                <button class="btn btn-export">
                                    <i class="fas fa-file-excel"></i>
                                    تصدير Excel
                                </button>
                            </div>
                        </div>
                        
                        <div class="filters-container">
                            <div class="filter-group">
                                <label class="filter-label">الفترة الزمنية</label>
                                <select class="filter-select" id="reportPeriod">
                                    <option value="week">آخر أسبوع</option>
                                    <option value="month">آخر شهر</option>
                                    <option value="quarter">آخر 3 أشهر</option>
                                    <option value="year">آخر سنة</option>
                                    <option value="custom">مخصص</option>
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <label class="filter-label">من تاريخ</label>
                                <input type="date" class="filter-select" id="reportFromDate">
                            </div>
                            
                            <div class="filter-group">
                                <label class="filter-label">إلى تاريخ</label>
                                <input type="date" class="filter-select" id="reportToDate">
                            </div>
                            
                            <div class="filter-group">
                                <label class="filter-label">&nbsp;</label>
                                <button class="btn btn-primary" style="height: 42px;">
                                    <i class="fas fa-filter"></i>
                                    تطبيق التصفية
                                </button>
                            </div>
                        </div>
                        
                        <div class="charts-container">
                            <div class="chart-card">
                                <h3 class="chart-title">توزيع الشكاوى حسب الحالة</h3>
                                <div class="chart-placeholder">
                                    <i class="fas fa-chart-pie" style="font-size: 2rem; margin-left: 10px;"></i>
                                    <span>رسم بياني دائري لتوزيع الشكاوى حسب الحالة</span>
                                </div>
                            </div>
                            <div class="chart-card">
                                <h3 class="chart-title">الشكاوى حسب القسم</h3>
                                <div class="chart-placeholder">
                                    <i class="fas fa-chart-bar" style="font-size: 2rem; margin-left: 10px;"></i>
                                    <span>رسم بياني عمودي للشكاوى حسب القسم</span>
                                </div>
                            </div>
                            <div class="chart-card">
                                <h3 class="chart-title">الشكاوى حسب الأولوية</h3>
                                <div class="chart-placeholder">
                                    <i class="fas fa-chart-bar" style="font-size: 2rem; margin-left: 10px;"></i>
                                    <span>رسم بياني عمودي للشكاوى حسب الأولوية</span>
                                </div>
                            </div>
                            <div class="chart-card">
                                <h3 class="chart-title">الشكاوى خلال الوقت</h3>
                                <div class="chart-placeholder">
                                    <i class="fas fa-chart-line" style="font-size: 2rem; margin-left: 10px;"></i>
                                    <span>رسم بياني خطي للشكاوى خلال الوقت</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- قسم الإعدادات -->
                    <div id="settingsSection" class="content-section" style="display: none;">
                        <div class="content-header">
                            <h2 class="content-title">إعدادات النظام</h2>
                            <button class="btn btn-primary">
                                <i class="fas fa-save"></i>
                                حفظ التغييرات
                            </button>
                        </div>
                        
                        <div class="settings-form">
                            <div class="settings-group">
                                <h3 class="settings-title">الإعدادات العامة</h3>
                                <div class="toggle-label">
                                    <span>تفعيل إشعارات البريد الإلكتروني</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="toggle-label">
                                    <span>تفعيل إشعارات الواتساب</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                                <div class="toggle-label">
                                    <span>تفعيل النظام الآلي للردود</span>
                                    <label class="toggle-switch">
                                        <input type="checkbox">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="settings-group">
                                <h3 class="settings-title">إعدادات الإشعارات</h3>
                                <div class="form-group">
                                    <label class="form-label">البريد الإلكتروني للإشعارات</label>
                                    <input type="email" class="form-control" value="admin@shakawa.com">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">رقم واتساب للإشعارات</label>
                                    <input type="text" class="form-control" value="+201234567890">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">وقت إرسال التقارير اليومية</label>
                                    <input type="time" class="form-control" value="09:00">
                                </div>
                            </div>
                            
                            <div class="settings-group">
                                <h3 class="settings-title">إعدادات المظهر</h3>
                                <div class="form-group">
                                    <label class="form-label">لون السمة الرئيسية</label>
                                    <input type="color" class="form-control" value="#1a5fb4" style="height: 50px; width: 100px; padding: 5px;">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">عدد العناصر في الصفحة</label>
                                    <select class="form-control">
                                        <option value="10">10 عناصر</option>
                                        <option value="25" selected>25 عنصر</option>
                                        <option value="50">50 عنصر</option>
                                        <option value="100">100 عنصر</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="footer">
                <p>© 2023 نظام الشكاوى الموحد - لوحة التحكم الإدارية</p>
                <p>جميع الحقوق محفوظة - الإصدار 2.1.0</p>
            </div>
        </div>
        
        <!-- نافذة عرض تفاصيل الشكوى -->
        <div class="complaint-details-modal" id="complaintDetailsModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">تفاصيل الشكوى</h3>
                    <button class="close-modal" id="closeModal">&times;</button>
                </div>
                <div class="modal-body" id="modalBody">
                    <!-- سيتم ملؤها بواسطة JavaScript -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Firebase SDK - Compat Version -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <script>
        // بيانات المسؤولين الرئيسيين
        const ADMIN_USERS = [
            {
                username: "admin",
                password: "742018",
                name: "مهندس محمد نصر",
                role: "admin"
            },
            {
                username: "engineer",
                password: "123456",
                name: "مهندس محمد نصر",
                role: "admin"
            }
        ];
        
        // قائمة الأقسام المتاحة
        const DEPARTMENTS = [
            "مشكلة خاصة بالقضاء والمحاكم",
            "مساعدة مالية",
            "مشكلة خاصة بالصحة",
            "مشكلات مياه الشرب والصرف الصحي",
            "مشكلة خاصة بالتعليم",
            "مشكلة خاصة بالشرطة والداخلية",
            "حالة طارئة",
            "مشكلات أخرى"
        ];
        
        // حالة تسجيل الدخول
        let isLoggedIn = false;
        let currentUser = null;
        
        // متغيرات التطبيق
        let currentSection = 'dashboard';
        let allComplaints = [];
        let filteredComplaints = [];
        let allUsers = [];
        let currentPage = 1;
        const itemsPerPage = 10;
        
        // تهيئة Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBIIStbiZD0ZJ6su7C1bwZlBvqx-PP-t58",
            authDomain: "shakawa-e0a3c.firebaseapp.com",
            projectId: "shakawa-e0a3c",
            storageBucket: "shakawa-e0a3c.firebasestorage.app",
            messagingSenderId: "111620348664",
            appId: "1:111620348664:web:670fdf5caed46eb691b90d",
            measurementId: "G-SGNTJZDQ1L"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // تهيئة الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            // التحقق من حالة تسجيل الدخول
            checkLoginStatus();
            
            // إضافة مستمعي الأحداث لتسجيل الدخول
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // إضافة مستمعي الأحداث للقائمة الجانبية
            const menuItems = document.querySelectorAll('.menu-item');
            menuItems.forEach(item => {
                item.addEventListener('click', function() {
                    if (this.classList.contains('admin-only') && !(currentUser && currentUser.role === 'admin')) {
                        showMessage('يجب تسجيل الدخول كمسؤول للوصول إلى هذا القسم', 'error');
                        return;
                    }
                    
                    // إزالة النشاط من جميع العناصر
                    menuItems.forEach(i => i.classList.remove('active'));
                    // إضافة النشاط للعنصر الحالي
                    this.classList.add('active');
                    // عرض القسم المحدد
                    const sectionId = this.getAttribute('data-section');
                    showSection(sectionId);
                });
            });
            
            // إضافة مستمعي الأحداث للتصفية
            document.getElementById('filterStatus').addEventListener('change', filterComplaints);
            document.getElementById('filterDepartment').addEventListener('change', filterComplaints);
            document.getElementById('filterPriority').addEventListener('change', filterComplaints);
            document.getElementById('searchInput').addEventListener('input', filterComplaints);
            
            // إضافة مستمعي الأحداث للترقيم
            document.getElementById('prevPage').addEventListener('click', () => changePage(-1));
            document.getElementById('nextPage').addEventListener('click', () => changePage(1));
            
            // إضافة مستمعي الأحداث للأزرار
            document.getElementById('refreshComplaints').addEventListener('click', loadComplaints);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            document.getElementById('closeModal').addEventListener('click', closeModal);
            
            // إغلاق النافذة المنبثقة عند النقر خارجها
            document.getElementById('complaintDetailsModal').addEventListener('click', function(e) {
                if (e.target === this) closeModal();
            });
        });
        
        // دالة التحقق من حالة تسجيل الدخول
        function checkLoginStatus() {
            const savedLogin = localStorage.getItem('adminLoggedIn');
            const savedUser = localStorage.getItem('adminUser');
            
            if (savedLogin === 'true' && savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    isLoggedIn = true;
                    showDashboard();
                    loadComplaints();
                } catch (e) {
                    localStorage.removeItem('adminLoggedIn');
                    localStorage.removeItem('adminUser');
                    showLogin();
                }
            } else {
                showLogin();
            }
        }
        
        // دالة تسجيل الدخول
        function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');
            
            // البحث عن المستخدم في قائمة المسؤولين الرئيسيين
            const adminUser = ADMIN_USERS.find(user => 
                user.username === username && user.password === password
            );
            
            if (adminUser) {
                loginSuccess(adminUser);
            } else {
                // البحث في قاعدة بيانات المستخدمين
                checkDatabaseUser(username, password);
            }
        }
        
        // دالة تسجيل الدخول الناجح
        function loginSuccess(userData) {
            isLoggedIn = true;
            currentUser = {
                username: userData.username,
                name: userData.name,
                role: userData.role,
                loginTime: new Date().toISOString(),
                allowedDepartments: userData.allowedDepartments || DEPARTMENTS // جميع الأقسام للمسؤولين
            };
            
            // حفظ حالة تسجيل الدخول
            localStorage.setItem('adminLoggedIn', 'true');
            localStorage.setItem('adminUser', JSON.stringify(currentUser));
            
            showDashboard();
            loadComplaints();
            showMessage(`مرحباً ${currentUser.name}! تم تسجيل الدخول بنجاح`, 'success');
        }
        
        // دالة للتحقق من المستخدمين في قاعدة البيانات
        async function checkDatabaseUser(username, password) {
            try {
                const usersRef = database.ref('users');
                const snapshot = await usersRef.once('value');
                
                if (!snapshot.exists()) {
                    document.getElementById('loginError').style.display = 'block';
                    return;
                }
                
                let userFound = false;
                snapshot.forEach((childSnapshot) => {
                    const user = childSnapshot.val();
                    
                    // التحقق من البريد الإلكتروني أو اسم المستخدم
                    const isEmailMatch = user.email && user.email === username;
                    const isUsernameMatch = user.username && user.username === username;
                    
                    if ((isEmailMatch || isUsernameMatch) && user.password && atob(user.password) === password) {
                        // التحقق من حالة المستخدم
                        if (user.status && user.status !== 'active') {
                            showMessage('حسابك غير نشط، يرجى التواصل مع المسؤول', 'error');
                            return;
                        }
                        
                        isLoggedIn = true;
                        currentUser = {
                            username: user.email || user.username,
                            name: user.name,
                            role: user.role,
                            loginTime: new Date().toISOString(),
                            key: childSnapshot.key,
                            allowedDepartments: user.allowedDepartments || []
                        };
                        
                        // تحديث آخر دخول
                        database.ref('users/' + childSnapshot.key).update({
                            lastLogin: new Date().toISOString(),
                            loginCount: (user.loginCount || 0) + 1
                        });
                        
                        // حفظ حالة تسجيل الدخول
                        localStorage.setItem('adminLoggedIn', 'true');
                        localStorage.setItem('adminUser', JSON.stringify(currentUser));
                        
                        showDashboard();
                        loadComplaints();
                        showMessage(`مرحباً ${user.name}! تم تسجيل الدخول بنجاح`, 'success');
                        
                        userFound = true;
                    }
                });
                
                if (!userFound) {
                    document.getElementById('loginError').style.display = 'block';
                }
                
            } catch (error) {
                console.error('Error checking database user:', error);
                document.getElementById('loginError').style.display = 'block';
            }
        }
        
        // دالة تسجيل الخروج
        function handleLogout() {
            if (confirm('هل تريد تسجيل الخروج من لوحة التحكم؟')) {
                isLoggedIn = false;
                currentUser = null;
                localStorage.removeItem('adminLoggedIn');
                localStorage.removeItem('adminUser');
                showLogin();
            }
        }
        
        // دالة عرض شاشة تسجيل الدخول
        function showLogin() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('dashboardScreen').style.display = 'none';
        }
        
        // دالة عرض لوحة التحكم
        function showDashboard() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboardScreen').style.display = 'block';
            
            // تحديث ترحيب المسؤول
            updateAdminWelcome();
            
            // التحكم بعرض عناصر القائمة الجانبية حسب صلاحية المستخدم
            updateSidebarPermissions();
        }
        
        // دالة تحديث ترحيب المسؤول
        function updateAdminWelcome() {
            if (currentUser) {
                const welcomeElement = document.getElementById('adminWelcome');
                const lastLoginElement = document.getElementById('adminLastLogin');
                
                welcomeElement.textContent = `مرحباً، ${currentUser.name}`;
                
                // تنسيق وقت آخر دخول
                if (currentUser.loginTime) {
                    const loginTime = new Date(currentUser.loginTime);
                    const options = {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    };
                    lastLoginElement.textContent = `آخر دخول: ${loginTime.toLocaleDateString('ar-EG', options)}`;
                }
            }
        }
        
        // دالة تحديث صلاحيات القائمة الجانبية
        function updateSidebarPermissions() {
            const adminOnlyElements = document.querySelectorAll('.admin-only');
            
            if (currentUser && currentUser.role === 'admin') {
                // المسؤول يرى كل شيء
                adminOnlyElements.forEach(el => {
                    el.classList.add('visible');
                });
            } else if (currentUser && currentUser.role === 'moderator') {
                // المشرف لا يرى بعض الأقسام
                adminOnlyElements.forEach(el => {
                    if (el.getAttribute('data-section') === 'users' || 
                        el.getAttribute('data-section') === 'settings') {
                        el.classList.add('hidden-for-supervisor');
                        el.classList.remove('visible');
                    } else {
                        el.classList.add('visible');
                    }
                });
            } else {
                // المستخدم العادي لا يرى أي عناصر إدارية
                adminOnlyElements.forEach(el => {
                    el.classList.remove('visible');
                    el.classList.add('hidden-for-supervisor');
                });
            }
        }
        
        // دالة عرض القسم المحدد
        function showSection(sectionId) {
            // إخفاء جميع الأقسام
            const sections = document.querySelectorAll('.content-section');
            sections.forEach(section => {
                section.style.display = 'none';
            });
            
            // عرض القسم المحدد
            document.getElementById(sectionId + 'Section').style.display = 'block';
            currentSection = sectionId;
            
            // إذا كان القسم هو الشكاوى، قم بتحديث القائمة
            if (sectionId === 'complaints') {
                filterComplaints();
            }
            
            // إذا كان القسم هو المستخدمين، قم بتحميل المستخدمين
            if (sectionId === 'users' && currentUser && currentUser.role === 'admin') {
                loadUsers();
            }
        }
        
        // دالة تحميل الشكاوى من Firebase
        async function loadComplaints() {
            try {
                const complaintsRef = database.ref('complaints');
                const snapshot = await complaintsRef.once('value');
                
                if (!snapshot.exists()) {
                    allComplaints = [];
                    showMessage('لا توجد شكاوى في النظام', 'info');
                    return;
                }
                
                allComplaints = [];
                snapshot.forEach((childSnapshot) => {
                    const complaint = childSnapshot.val();
                    complaint.key = childSnapshot.key;
                    allComplaints.push(complaint);
                });
                
                // ترتيب الشكاوى من الأحدث إلى الأقدم
                allComplaints.sort((a, b) => {
                    return new Date(b.createdAt) - new Date(a.createdAt);
                });
                
                // تحديث الإحصائيات
                updateDashboardStats();
                
                // تحديث قائمة الشكوى
                filterComplaints();
                
                // تحديث القائمة الجانبية
                updateSidebarBadge();
                
                // التحقق من المشكلات الحرجة
                setTimeout(checkCriticalProblems, 1000);
                
            } catch (error) {
                console.error('Error loading complaints:', error);
                showMessage('حدث خطأ أثناء تحميل الشكاوى', 'error');
            }
        }
        
        // دالة تصفية الشكاوى مع مراعاة صلاحيات المشرف
        function filterComplaints() {
            const statusFilter = document.getElementById('filterStatus').value;
            const departmentFilter = document.getElementById('filterDepartment').value;
            const priorityFilter = document.getElementById('filterPriority').value;
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            
            // تصفية أولية حسب صلاحيات المستخدم
            let prelimFilteredComplaints = allComplaints;
            
            // إذا كان المستخدم مشرفاً وله أقسام محددة
            if (currentUser && currentUser.role === 'moderator' && 
                currentUser.allowedDepartments && currentUser.allowedDepartments.length > 0) {
                
                prelimFilteredComplaints = allComplaints.filter(complaint => {
                    return currentUser.allowedDepartments.includes(complaint.department);
                });
            }
            
            // تطبيق المرشحات الإضافية
            filteredComplaints = prelimFilteredComplaints.filter(complaint => {
                // تطبيق مرشح الحالة
                if (statusFilter && complaint.status !== statusFilter) {
                    return false;
                }
                
                // تطبيق مرشح القسم
                if (departmentFilter && complaint.department !== departmentFilter) {
                    return false;
                }
                
                // تطبيق مرشح الأولوية
                if (priorityFilter && complaint.priority !== priorityFilter) {
                    return false;
                }
                
                // تطبيق البحث النصي
                if (searchText) {
                    const matchesNumber = complaint.complaintNumber && 
                                          complaint.complaintNumber.toLowerCase().includes(searchText);
                    const matchesName = complaint.fullName && 
                                        complaint.fullName.toLowerCase().includes(searchText);
                    const matchesNationalId = complaint.nationalId && 
                                              complaint.nationalId.includes(searchText);
                    
                    if (!matchesNumber && !matchesName && !matchesNationalId) {
                        return false;
                    }
                }
                
                return true;
            });
            
            // عرض الشكاوى المصفاة
            currentPage = 1;
            displayComplaintsTable();
            updatePagination();
            
            // إذا كان القسم الحالي هو لوحة التحكم، قم بتحديث الشكاوى الأخيرة
            if (currentSection === 'dashboard') {
                displayRecentComplaints();
            }
        }
        
        // دالة عرض الشكاوى في الجدول
        function displayComplaintsTable() {
            const tableBody = document.getElementById('complaintsTable');
            
            if (filteredComplaints.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: #666;">
                            <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 15px; display: block; opacity: 0.5;"></i>
                            لا توجد شكاوى تطابق معايير البحث
                        </td>
                    </tr>
                `;
                return;
            }
            
            // حساب العناصر التي يجب عرضها في الصفحة الحالية
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const currentItems = filteredComplaints.slice(startIndex, endIndex);
            
            let html = '';
            
            currentItems.forEach(complaint => {
                // تحديد فئة الحالة
                let statusClass = 'status-new';
                if (complaint.status === 'قيد المتابعة') statusClass = 'status-in-progress';
                if (complaint.status === 'تم الرد' || complaint.status === 'مكتملة') statusClass = 'status-resolved';
                if (complaint.status === 'مغلقة') statusClass = 'status-closed';
                
                // تحديد فئة الأولوية
                let priorityClass = 'priority-normal';
                let isCritical = false;
                if (complaint.priority === 'مهمة') priorityClass = 'priority-important';
                if (complaint.priority === 'فى غاية الأهمية') {
                    priorityClass = 'priority-critical';
                    isCritical = true;
                }
                
                // تنسيق التاريخ
                const complaintDate = new Date(complaint.createdAt).toLocaleDateString('ar-EG', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                // تحديد فئة الصف (حرجة أم لا)
                const rowClass = isCritical ? 'class="complaint-row critical"' : 'class="complaint-row"';
                
                html += `
                    <tr ${rowClass} data-complaint-id="${complaint.key}">
                        <td><strong>${complaint.complaintNumber || 'غير متوفر'}</strong></td>
                        <td>${complaint.fullName || 'غير متوفر'}</td>
                        <td>${complaint.nationalId || 'غير متوفر'}</td>
                        <td>${complaint.department || 'غير متوفر'}</td>
                        <td><span class="priority-badge ${priorityClass}">${complaint.priority || 'عادية'}</span></td>
                        <td><span class="status-badge ${statusClass}">${complaint.status || 'جديدة'}</span></td>
                        <td>${complaintDate}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="action-btn btn-view" onclick="viewComplaint('${complaint.key}')">
                                    <i class="fas fa-eye"></i>
                                    عرض
                                </button>
                                <button class="action-btn btn-reply" onclick="replyToComplaint('${complaint.key}')">
                                    <i class="fas fa-reply"></i>
                                    رد
                                </button>
                                ${currentUser && currentUser.role === 'admin' ? `
                                <button class="action-btn btn-delete" onclick="deleteComplaint('${complaint.key}')">
                                    <i class="fas fa-trash"></i>
                                    حذف
                                </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
        }
        
        // دالة عرض الشكاوى الأخيرة في لوحة التحكم
        function displayRecentComplaints() {
            const tableBody = document.getElementById('recentComplaintsTable');
            
            // تصفية حسب صلاحيات المستخدم
            let recentComplaints = allComplaints;
            
            if (currentUser && currentUser.role === 'moderator' && 
                currentUser.allowedDepartments && currentUser.allowedDepartments.length > 0) {
                
                recentComplaints = allComplaints.filter(complaint => {
                    return currentUser.allowedDepartments.includes(complaint.department);
                });
            }
            
            recentComplaints = recentComplaints.slice(0, 5); // عرض أول 5 شكاوى فقط
            
            if (recentComplaints.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 20px; color: #666;">
                            لا توجد شكاوى حالياً
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            
            recentComplaints.forEach(complaint => {
                // تحديد فئة الحالة
                let statusClass = 'status-new';
                if (complaint.status === 'قيد المتابعة') statusClass = 'status-in-progress';
                if (complaint.status === 'تم الرد' || complaint.status === 'مكتملة') statusClass = 'status-resolved';
                if (complaint.status === 'مغلقة') statusClass = 'status-closed';
                
                // تنسيق التاريخ
                const complaintDate = new Date(complaint.createdAt).toLocaleDateString('ar-EG', {
                    month: 'short',
                    day: 'numeric'
                });
                
                html += `
                    <tr>
                        <td><strong>${complaint.complaintNumber || 'غير متوفر'}</strong></td>
                        <td>${complaint.fullName || 'غير متوفر'}</td>
                        <td>${complaint.department || 'غير متوفر'}</td>
                        <td><span class="status-badge ${statusClass}">${complaint.status || 'جديدة'}</span></td>
                        <td>${complaintDate}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="action-btn btn-view" onclick="viewComplaint('${complaint.key}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="action-btn btn-reply" onclick="replyToComplaint('${complaint.key}')">
                                    <i class="fas fa-reply"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
        }
        
        // دالة تحديث الترقيم
        function updatePagination() {
            const totalPages = Math.ceil(filteredComplaints.length / itemsPerPage);
            
            document.getElementById('totalPages').textContent = totalPages;
            document.getElementById('currentPage').textContent = currentPage;
            
            // تعطيل أزرار الترقيم عند الضرورة
            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = currentPage === totalPages || totalPages === 0;
        }
        
        // دالة تغيير الصفحة
        function changePage(direction) {
            const totalPages = Math.ceil(filteredComplaints.length / itemsPerPage);
            const newPage = currentPage + direction;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                displayComplaintsTable();
                updatePagination();
            }
        }
        
        // دالة تحديث إحصائيات لوحة التحكم مع مراعاة صلاحيات المشرف
        function updateDashboardStats() {
            // الشكاوى التي يمكن للمستخدم رؤيتها
            let visibleComplaints = allComplaints;
            
            if (currentUser && currentUser.role === 'moderator' && 
                currentUser.allowedDepartments && currentUser.allowedDepartments.length > 0) {
                
                visibleComplaints = allComplaints.filter(complaint => {
                    return currentUser.allowedDepartments.includes(complaint.department);
                });
            }
            
            // إحصائيات عامة
            document.getElementById('totalComplaints').textContent = visibleComplaints.length;
            
            const newComplaints = visibleComplaints.filter(c => c.status === 'جديدة').length;
            const resolvedComplaints = visibleComplaints.filter(c => c.status === 'مكتملة' || c.status === 'تم الرد').length;
            
            document.getElementById('newComplaints').textContent = newComplaints;
            document.getElementById('resolvedComplaints').textContent = resolvedComplaints;
            
            // تحديث بطاقات الإحصائيات
            document.getElementById('statNew').textContent = newComplaints;
            document.getElementById('statInProgress').textContent = visibleComplaints.filter(c => c.status === 'قيد المتابعة').length;
            document.getElementById('statResolved').textContent = resolvedComplaints;
            document.getElementById('statClosed').textContent = visibleComplaints.filter(c => c.status === 'مغلقة').length;
            
            // تحديث الشكاوى الأخيرة
            displayRecentComplaints();
        }
        
        // دالة تحديث الشارة في القائمة الجانبية
        function updateSidebarBadge() {
            let visibleComplaints = allComplaints;
            
            if (currentUser && currentUser.role === 'moderator' && 
                currentUser.allowedDepartments && currentUser.allowedDepartments.length > 0) {
                
                visibleComplaints = allComplaints.filter(complaint => {
                    return currentUser.allowedDepartments.includes(complaint.department);
                });
            }
            
            const newComplaints = visibleComplaints.filter(c => c.status === 'جديدة').length;
            const badge = document.getElementById('complaintsBadge');
            
            if (newComplaints > 0) {
                badge.textContent = newComplaints;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }
        
        // دالة التحقق من المشكلات الحرجة
        function checkCriticalProblems() {
            let visibleComplaints = allComplaints;
            
            if (currentUser && currentUser.role === 'moderator' && 
                currentUser.allowedDepartments && currentUser.allowedDepartments.length > 0) {
                
                visibleComplaints = allComplaints.filter(complaint => {
                    return currentUser.allowedDepartments.includes(complaint.department);
                });
            }
            
            const criticalComplaints = visibleComplaints.filter(complaint => 
                complaint.priority === 'فى غاية الأهمية' && 
                (complaint.status === 'جديدة' || complaint.status === 'قيد المتابعة')
            );
            
            if (criticalComplaints.length > 0) {
                // تشغيل التنبيه الصوتي
                playAlertSound();
                
                // عرض تنبيه
                if (criticalComplaints.length === 1) {
                    showMessage(`هناك مشكلة حرجة تتطلب اهتمامك فوراً!`, 'error');
                } else {
                    showMessage(`هناك ${criticalComplaints.length} مشكلة حرجة تتطلب اهتمامك فوراً!`, 'error');
                }
            }
        }
        
        // دالة تشغيل التنبيه الصوتي
        function playAlertSound() {
            // إنشاء صوت تنبيه باستخدام Web Audio API
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
                
                // تكرار الصوت 3 مرات
                setTimeout(() => {
                    oscillator.start(audioContext.currentTime + 0.6);
                    oscillator.stop(audioContext.currentTime + 1.1);
                }, 600);
                
                setTimeout(() => {
                    oscillator.start(audioContext.currentTime + 1.2);
                    oscillator.stop(audioContext.currentTime + 1.7);
                }, 1200);
                
            } catch (e) {
                console.log('لا يمكن تشغيل الصوت:', e);
            }
        }
        
        // دالة عرض تفاصيل الشكوى
        function viewComplaint(complaintKey) {
            const complaint = allComplaints.find(c => c.key === complaintKey);
            
            if (!complaint) {
                showMessage('لم يتم العثور على الشكوى', 'error');
                return;
            }
            
            // التحقق من صلاحيات المشرف
            if (currentUser && currentUser.role === 'moderator' && 
                currentUser.allowedDepartments && currentUser.allowedDepartments.length > 0) {
                
                if (!currentUser.allowedDepartments.includes(complaint.department)) {
                    showMessage('ليس لديك صلاحية لعرض هذه الشكوى', 'error');
                    return;
                }
            }
            
            // تحديد فئة الأولوية
            let priorityClass = 'priority-normal';
            if (complaint.priority === 'مهمة') priorityClass = 'priority-important';
            if (complaint.priority === 'فى غاية الأهمية') priorityClass = 'priority-critical';
            
            // تنسيق التواريخ
            const createdAt = new Date(complaint.createdAt).toLocaleString('ar-EG');
            const updatedAt = new Date(complaint.updatedAt || complaint.createdAt).toLocaleString('ar-EG');
            
            // بناء الردود
            let responsesHTML = '';
            if (complaint.responses && complaint.responses.length > 0) {
                complaint.responses.forEach(response => {
                    const responseDate = new Date(response.date).toLocaleString('ar-EG');
                    const responseClass = response.sender === 'admin' ? 'response-admin' : 'response-client';
                    const senderName = response.sender === 'admin' ? (response.adminName || 'المسؤول') : 'مكتب الحاج أحمد الحديدي';
                    
                    responsesHTML += `
                        <div class="response-item ${responseClass}">
                            <strong>${senderName}</strong>
                            <p>${response.text}</p>
                            <div class="response-date">${responseDate}</div>
                        </div>
                    `;
                });
            } else {
                responsesHTML = '<p style="text-align: center; color: #888;">لا توجد ردود حتى الآن</p>';
            }
            
            // بناء محتوى النافذة المنبثقة
            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = `
                <div class="no-print" style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                    <button class="btn btn-primary" onclick="printComplaint('${complaint.key}')">
                        <i class="fas fa-print"></i>
                        طباعة الطلب كاملاً
                    </button>
                    <button class="btn btn-secondary" onclick="closeModal()">
                        <i class="fas fa-times"></i>
                        إغلاق
                    </button>
                </div>
                
                <div class="print-section">
                    <div class="print-header">
                        <div class="print-logo">نظام الشكاوى الموحد - أحمد الحديدي</div>
                        <h2 style="margin: 10px 0;">تفاصيل الطلب الكاملة</h2>
                        <p>رقم الطلب: <strong>${complaint.complaintNumber || 'غير متوفر'}</strong> | تاريخ الطباعة: ${new Date().toLocaleString('ar-EG')}</p>
                    </div>
                    
                    <div class="print-details" style="grid-template-columns: repeat(3, 1fr);">
                        <!-- معلومات المستخدم -->
                        <div class="print-detail-item" style="grid-column: span 3; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <h3 style="color: #1a5fb4; margin-bottom: 10px;">معلومات مقدم الطلب</h3>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                                <div>
                                    <div class="print-detail-label">الاسم:</div>
                                    <div><strong>${complaint.fullName || 'غير متوفر'}</strong></div>
                                </div>
                                <div>
                                    <div class="print-detail-label">الرقم القومي:</div>
                                    <div>${complaint.nationalId || 'غير متوفر'}</div>
                                </div>
                                <div>
                                    <div class="print-detail-label">الوحدة المحلية:</div>
                                    <div>${complaint.localUnit || 'غير متوفر'}</div>
                                </div>
                                <div>
                                    <div class="print-detail-label">العنوان:</div>
                                    <div>${complaint.address || 'غير متوفر'}</div>
                                </div>
                                <div>
                                    <div class="print-detail-label">رقم الهاتف:</div>
                                    <div>
                                        ${complaint.phone1 || 'غير متوفر'} 
                                        ${complaint.phone2 ? ' / ' + complaint.phone2 : ''}
                                    </div>
                                </div>
                                <div>
                                    <div class="print-detail-label">البريد الإلكتروني:</div>
                                    <div>${complaint.email || 'غير متوفر'}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- معلومات الطلب -->
                        <div class="print-detail-item" style="grid-column: span 3; background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 15px;">
                            <h3 style="color: #1a5fb4; margin-bottom: 10px;">معلومات الطلب</h3>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                                <div>
                                    <div class="print-detail-label">القسم:</div>
                                    <div><strong>${complaint.department || 'غير متوفر'}</strong></div>
                                </div>
                                <div>
                                    <div class="print-detail-label">نوع المشكلة:</div>
                                    <div class="${priorityClass}" style="padding: 5px 10px; border-radius: 4px; display: inline-block;">${complaint.priority || 'عادية'}</div>
                                </div>
                                <div>
                                    <div class="print-detail-label">الحالة:</div>
                                    <div><strong>${complaint.status || 'جديدة'}</strong></div>
                                </div>
                                <div>
                                    <div class="print-detail-label">رقم المرجع:</div>
                                    <div>${complaint.referenceNumber || 'غير محدد'}</div>
                                </div>
                                <div>
                                    <div class="print-detail-label">تاريخ الإرسال:</div>
                                    <div>${createdAt}</div>
                                </div>
                                <div>
                                    <div class="print-detail-label">آخر تحديث:</div>
                                    <div>${updatedAt}</div>
                                </div>
                                <div>
                                    <div class="print-detail-label">مدة المعالجة:</div>
                                    <div>${calculateProcessingTime(complaint.createdAt, complaint.updatedAt || complaint.createdAt)}</div>
                                </div>
                                <div>
                                    <div class="print-detail-label">الجهة المحالة إليها:</div>
                                    <div>${complaint.assignedTo || 'قيد التحديد'}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- تفاصيل المشكلة -->
                        <div class="print-detail-item" style="grid-column: span 3; margin-top: 20px;">
                            <div class="print-problem-details">
                                <h3 style="margin-bottom: 15px; color: #1a5fb4; border-bottom: 2px solid #1a5fb4; padding-bottom: 10px;">تفاصيل المشكلة / الطلب</h3>
                                <div style="white-space: pre-line; line-height: 1.8; font-size: 16px; padding: 15px; background: white; border-radius: 8px; border: 1px solid #ddd;">
                                    ${complaint.problemDetails || 'لا توجد تفاصيل'}
                                </div>
                            </div>
                        </div>
                        
                        <!-- المرفقات -->
                        ${complaint.attachments && complaint.attachments.length > 0 ? `
                            <div class="print-detail-item" style="grid-column: span 3; margin-top: 20px;">
                                <div class="print-problem-details">
                                    <h3 style="margin-bottom: 15px; color: #1a5fb4; border-bottom: 2px solid #1a5fb4; padding-bottom: 10px;">المرفقات</h3>
                                    <div style="padding: 15px; background: white; border-radius: 8px; border: 1px solid #ddd;">
                                        <ul>
                                            ${complaint.attachments.map(attachment => `
                                                <li style="margin-bottom: 10px;">
                                                    <strong>${attachment.name || 'مرفق'}</strong> - ${attachment.type || 'غير معروف'}
                                                    ${attachment.url ? `<br><small>${attachment.url}</small>` : ''}
                                                </li>
                                            `).join('')}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- الردود والمتابعات -->
                        ${complaint.responses && complaint.responses.length > 0 ? `
                            <div class="print-detail-item" style="grid-column: span 3; margin-top: 20px;">
                                <div class="print-problem-details">
                                    <h3 style="margin-bottom: 15px; color: #1a5fb4; border-bottom: 2px solid #1a5fb4; padding-bottom: 10px;">سجل الردود والمتابعات</h3>
                                    <div style="padding: 15px; background: white; border-radius: 8px; border: 1px solid #ddd;">
                                        ${complaint.responses.map(response => {
                                            const responseDate = new Date(response.date).toLocaleString('ar-EG');
                                            const senderType = response.sender === 'admin' ? 'إداري' : 'مقدم الطلب';
                                            const senderName = response.sender === 'admin' ? (response.adminName || 'المسؤول') : complaint.fullName;
                                            
                                            return `
                                                <div style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee; background: ${response.sender === 'admin' ? '#f8f9fa' : 'white'}; padding: 15px; border-radius: 6px;">
                                                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                                        <strong style="color: #1a5fb4;">${senderName} (${senderType})</strong>
                                                        <span style="color: #666; font-size: 14px;">${responseDate}</span>
                                                    </div>
                                                    <p style="margin-top: 10px; line-height: 1.6; background: white; padding: 10px; border-radius: 4px; border-right: 3px solid ${response.sender === 'admin' ? '#28a745' : '#6c757d'};">
                                                        ${response.text}
                                                    </p>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- ختم الجهة -->
                        <div class="print-detail-item" style="grid-column: span 3; margin-top: 40px; text-align: left;">
                            <div style="border-top: 2px solid #333; padding-top: 20px; text-align: center;">
                                <p>ختم الجهة المعنية</p>
                                <p style="margin-top: 30px;">_______________________</p>
                                <p>التوقيع</p>
                                <p style="margin-top: 30px;">تاريخ الإصدار: ${new Date().toLocaleDateString('ar-EG')}</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="responses-section no-print">
                    <h3 style="margin-bottom: 20px;">الردود والمتابعات</h3>
                    ${responsesHTML}
                    
                    <div class="reply-form">
                        <h4>إضافة رد إداري</h4>
                        <div class="form-group">
                            <label class="form-label">نص الرد</label>
                            <textarea id="adminReplyText" class="form-control" placeholder="أدخل ردك هنا..." rows="4"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">تغيير حالة الشكوى</label>
                            <select id="adminStatusChange" class="form-control">
                                <option value="">اختر حالة جديدة</option>
                                <option value="جديدة">جديدة</option>
                                <option value="قيد المتابعة">قيد المتابعة</option>
                                <option value="تم الرد">تم الرد</option>
                                <option value="مكتملة">مكتملة</option>
                                <option value="مغلقة">مغلقة</option>
                            </select>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="submitAdminReply('${complaint.key}')" class="btn btn-primary">
                                <i class="fas fa-paper-plane"></i> إرسال الرد
                            </button>
                            <button onclick="closeModal()" class="btn btn-secondary">
                                <i class="fas fa-times"></i> إلغاء
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // عرض النافذة المنبثقة
            document.getElementById('complaintDetailsModal').style.display = 'flex';
        }
        
        // دالة حساب مدة المعالجة
        function calculateProcessingTime(startDate, endDate) {
            if (!startDate) return 'غير محدد';
            
            const start = new Date(startDate);
            const end = endDate ? new Date(endDate) : new Date();
            
            const diffMs = end - start;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            const diffHours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            
            if (diffDays > 0) {
                return `${diffDays} يوم و ${diffHours} ساعة`;
            } else {
                return `${diffHours} ساعة`;
            }
        }
        
        // دالة طباعة الشكوى
        function printComplaint(complaintKey) {
            window.print();
        }
        
        // دالة إرسال رد إداري
        async function submitAdminReply(complaintKey) {
            if (!currentUser || (currentUser.role !== 'admin' && currentUser.role !== 'moderator')) {
                showMessage('يجب تسجيل الدخول كمسؤول أو مشرف لإرسال رد', 'error');
                return;
            }
            
            const replyText = document.getElementById('adminReplyText').value.trim();
            const newStatus = document.getElementById('adminStatusChange').value;
            
            if (!replyText && !newStatus) {
                showMessage('يرجى إدخال رد أو تغيير حالة الشكوى', 'error');
                return;
            }
            
            try {
                const complaintRef = database.ref('complaints/' + complaintKey);
                
                // الحصول على البيانات الحالية
                const snapshot = await complaintRef.once('value');
                const currentData = snapshot.val();
                
                // التحقق من صلاحيات المشرف
                if (currentUser.role === 'moderator' && currentUser.allowedDepartments) {
                    if (!currentUser.allowedDepartments.includes(currentData.department)) {
                        showMessage('ليس لديك صلاحية للرد على هذه الشكوى', 'error');
                        return;
                    }
                }
                
                // إعداد التحديثات
                const updates = {};
                
                // إضافة الرد إذا كان موجوداً
                if (replyText) {
                    const newReply = {
                        text: replyText,
                        date: new Date().toISOString(),
                        sender: currentUser.role,
                        adminName: currentUser.name
                    };
                    
                    const updatedResponses = currentData.responses ? [...currentData.responses, newReply] : [newReply];
                    updates.responses = updatedResponses;
                }
                
                // تحديث الحالة إذا تم اختيارها
                if (newStatus) {
                    updates.status = newStatus;
                }
                
                // تحديث وقت التعديل
                updates.updatedAt = new Date().toISOString();
                
                // تطبيق التحديثات
                await complaintRef.update(updates);
                
                // تحديث البيانات المحلية
                const complaintIndex = allComplaints.findIndex(c => c.key === complaintKey);
                if (complaintIndex !== -1) {
                    // تحديث الردود
                    if (replyText) {
                        if (!allComplaints[complaintIndex].responses) {
                            allComplaints[complaintIndex].responses = [];
                        }
                        allComplaints[complaintIndex].responses.push({
                            text: replyText,
                            date: new Date().toISOString(),
                            sender: currentUser.role,
                            adminName: currentUser.name
                        });
                    }
                    
                    // تحديث الحالة
                    if (newStatus) {
                        allComplaints[complaintIndex].status = newStatus;
                    }
                    
                    allComplaints[complaintIndex].updatedAt = new Date().toISOString();
                }
                
                // إغلاق النافذة المنبثقة
                closeModal();
                
                // تحديث العرض
                filterComplaints();
                updateDashboardStats();
                
                // عرض رسالة نجاح
                showMessage('تم إرسال الرد بنجاح', 'success');
                
            } catch (error) {
                console.error('Error submitting admin reply:', error);
                showMessage('حدث خطأ أثناء إرسال الرد', 'error');
            }
        }
        
        // دالة الرد على شكوى (فتح نموذج الرد)
        function replyToComplaint(complaintKey) {
            if (!currentUser || (currentUser.role !== 'admin' && currentUser.role !== 'moderator')) {
                showMessage('يجب تسجيل الدخول كمسؤول أو مشرف للرد على الشكاوى', 'error');
                return;
            }
            
            // التحقق من صلاحيات المشرف
            const complaint = allComplaints.find(c => c.key === complaintKey);
            if (currentUser.role === 'moderator' && currentUser.allowedDepartments) {
                if (!currentUser.allowedDepartments.includes(complaint.department)) {
                    showMessage('ليس لديك صلاحية للرد على هذه الشكوى', 'error');
                    return;
                }
            }
            
            // عرض تفاصيل الشكوى مع التركيز على نموذج الرد
            viewComplaint(complaintKey);
            
            // تمرير التركيز إلى حقل الرد بعد تأخير بسيط
            setTimeout(() => {
                document.getElementById('adminReplyText').focus();
            }, 500);
        }
        
        // دالة حذف شكوى
        async function deleteComplaint(complaintKey) {
            if (!currentUser || currentUser.role !== 'admin') {
                showMessage('يجب تسجيل الدخول كمسؤول لحذف الشكاوى', 'error');
                return;
            }
            
            if (!confirm('هل أنت متأكد من حذف هذه الشكوى؟ لا يمكن التراجع عن هذا الإجراء.')) {
                return;
            }
            
            try {
                await database.ref('complaints/' + complaintKey).remove();
                
                // تحديث البيانات المحلية
                allComplaints = allComplaints.filter(c => c.key !== complaintKey);
                
                // تحديث العرض
                filterComplaints();
                updateDashboardStats();
                
                showMessage('تم حذف الشكوى بنجاح', 'success');
                
            } catch (error) {
                console.error('Error deleting complaint:', error);
                showMessage('حدث خطأ أثناء حذف الشكوى', 'error');
            }
        }
        
        // دالة إغلاق النافذة المنبثقة
        function closeModal() {
            document.getElementById('complaintDetailsModal').style.display = 'none';
        }
        
        // دالة تحميل المستخدمين
        async function loadUsers() {
            if (!currentUser || currentUser.role !== 'admin') {
                showMessage('يجب تسجيل الدخول كمسؤول للوصول إلى إدارة المستخدمين', 'error');
                return;
            }
            
            try {
                const usersRef = database.ref('users');
                const snapshot = await usersRef.once('value');
                
                if (!snapshot.exists()) {
                    allUsers = [];
                    displayUsersTable();
                    return;
                }
                
                allUsers = [];
                snapshot.forEach((childSnapshot) => {
                    const user = childSnapshot.val();
                    user.key = childSnapshot.key;
                    allUsers.push(user);
                });
                
                displayUsersTable();
                
            } catch (error) {
                console.error('Error loading users:', error);
                showMessage('حدث خطأ أثناء تحميل المستخدمين', 'error');
            }
        }
        
        // دالة عرض المستخدمين في الجدول
        function displayUsersTable() {
            const tableBody = document.getElementById('usersTable');
            
            if (allUsers.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: #666;">
                            <i class="fas fa-users" style="font-size: 3rem; margin-bottom: 15px; display: block; opacity: 0.5;"></i>
                            لا يوجد مستخدمين مسجلين
                            <br>
                            <button onclick="showAddUserModal()" class="btn btn-primary" style="margin-top: 15px;">
                                <i class="fas fa-user-plus"></i>
                                إضافة مستخدم جديد
                            </button>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            
            allUsers.forEach(user => {
                // تنسيق تاريخ آخر نشاط
                const lastActivity = user.lastLogin ? 
                    new Date(user.lastLogin).toLocaleDateString('ar-EG') : 
                    'لم يسجل دخول';
                
                // تحديد فئة الحالة
                let statusBadge = '';
                if (user.status === 'active') {
                    statusBadge = '<span class="status-badge status-new">نشط</span>';
                } else if (user.status === 'inactive') {
                    statusBadge = '<span class="status-badge status-in-progress">غير نشط</span>';
                } else if (user.status === 'suspended') {
                    statusBadge = '<span class="status-badge status-closed">موقوف</span>';
                }
                
                // عرض الأقسام المسموح بها
                let allowedDepartmentsText = 'جميع الأقسام';
                if (user.role === 'moderator' && user.allowedDepartments && user.allowedDepartments.length > 0) {
                    if (user.allowedDepartments.length === 1) {
                        allowedDepartmentsText = user.allowedDepartments[0];
                    } else if (user.allowedDepartments.length <= 3) {
                        allowedDepartmentsText = user.allowedDepartments.join('، ');
                    } else {
                        allowedDepartmentsText = `${user.allowedDepartments.length} قسم`;
                    }
                }
                
                html += `
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #3498db, #2c3e50); display: flex; align-items: center; justify-content: center; color: white;">
                                    ${user.name ? user.name.charAt(0) : 'U'}
                                </div>
                                <div>
                                    <strong>${user.name || 'غير معروف'}</strong><br>
                                    <small style="color: #666;">${user.role === 'admin' ? 'مسؤول' : user.role === 'moderator' ? 'مشرف' : 'مستخدم'}</small>
                                </div>
                            </div>
                        </td>
                        <td>${user.email || 'غير محدد'}</td>
                        <td>${user.phone || 'غير محدد'}</td>
                        <td>${user.role === 'admin' ? 'مسؤول' : user.role === 'moderator' ? 'مشرف' : 'مستخدم'}</td>
                        <td>${allowedDepartmentsText}</td>
                        <td>${statusBadge}</td>
                        <td>${lastActivity}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="action-btn btn-view" onclick="editUser('${user.key}')">
                                    <i class="fas fa-edit"></i>
                                    تعديل
                                </button>
                                <button class="action-btn btn-delete" onclick="deleteUser('${user.key}')">
                                    <i class="fas fa-trash"></i>
                                    حذف
                                </button>
                                <button class="action-btn btn-reply" onclick="resetUserPassword('${user.key}')">
                                    <i class="fas fa-key"></i>
                                    إعادة تعيين كلمة المرور
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
        }
        
        // دالة عرض نموذج إضافة مستخدم
        function showAddUserModal() {
            if (!currentUser || currentUser.role !== 'admin') {
                showMessage('يجب تسجيل الدخول كمسؤول لإضافة مستخدمين', 'error');
                return;
            }
            
            const modalHTML = `
                <div class="user-modal" id="addUserModal">
                    <div class="user-modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">إضافة مستخدم جديد</h3>
                            <button class="close-modal" onclick="closeUserModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form id="addUserForm">
                                <div class="form-group">
                                    <label class="form-label">اسم المستخدم</label>
                                    <input type="text" class="form-control" id="userName" required>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">اسم المستخدم (للتسجيل)</label>
                                    <input type="text" class="form-control" id="userUsername" required>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">البريد الإلكتروني</label>
                                    <input type="email" class="form-control" id="userEmail" required>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">رقم الهاتف</label>
                                    <input type="tel" class="form-control" id="userPhone" required>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">كلمة المرور</label>
                                    <input type="password" class="form-control" id="userPassword" required>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">تأكيد كلمة المرور</label>
                                    <input type="password" class="form-control" id="userConfirmPassword" required>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">الدور</label>
                                    <select class="form-control" id="userRole" onchange="toggleDepartmentSelection()">
                                        <option value="user">مستخدم عادي</option>
                                        <option value="moderator">مشرف</option>
                                        <option value="admin">مسؤول</option>
                                    </select>
                                </div>
                                
                                <div class="form-group" id="departmentSelection" style="display: none;">
                                    <label class="form-label">الأقسام المسموح بها (للمشرفين)</label>
                                    <div id="departmentsCheckboxList" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 6px; padding: 10px;">
                                        ${DEPARTMENTS.map(dept => `
                                            <div style="margin-bottom: 8px;">
                                                <label style="display: flex; align-items: center; cursor: pointer;">
                                                    <input type="checkbox" value="${dept}" style="margin-left: 8px;">
                                                    ${dept}
                                                </label>
                                            </div>
                                        `).join('')}
                                    </div>
                                    <div style="margin-top: 10px;">
                                        <button type="button" class="btn btn-secondary" onclick="selectAllDepartments()" style="padding: 5px 10px; font-size: 14px;">
                                            تحديد الكل
                                        </button>
                                        <button type="button" class="btn btn-secondary" onclick="deselectAllDepartments()" style="padding: 5px 10px; font-size: 14px; margin-right: 10px;">
                                            إلغاء التحديد
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">الحالة</label>
                                    <select class="form-control" id="userStatus">
                                        <option value="active">نشط</option>
                                        <option value="inactive">غير نشط</option>
                                        <option value="suspended">موقوف</option>
                                    </select>
                                </div>
                                
                                <div style="display: flex; gap: 10px; margin-top: 30px;">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i>
                                        حفظ المستخدم
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="closeUserModal()">
                                        <i class="fas fa-times"></i>
                                        إلغاء
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            document.getElementById('addUserModal').style.display = 'flex';
            
            document.getElementById('addUserForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await saveUser();
            });
            
            // تحفيز تغيير الدور لضبط عرض اختيار الأقسام
            document.getElementById('userRole').dispatchEvent(new Event('change'));
        }
        
        // دالة تبديل عرض اختيار الأقسام
        function toggleDepartmentSelection() {
            const role = document.getElementById('userRole').value;
            const departmentSelection = document.getElementById('departmentSelection');
            
            if (role === 'moderator') {
                departmentSelection.style.display = 'block';
            } else {
                departmentSelection.style.display = 'none';
            }
        }
        
        // دالة تحديد جميع الأقسام
        function selectAllDepartments() {
            const checkboxes = document.querySelectorAll('#departmentsCheckboxList input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
        }
        
        // دالة إلغاء تحديد جميع الأقسام
        function deselectAllDepartments() {
            const checkboxes = document.querySelectorAll('#departmentsCheckboxList input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
        }
        
        // دالة حفظ المستخدم
        async function saveUser() {
            const name = document.getElementById('userName').value.trim();
            const username = document.getElementById('userUsername').value.trim();
            const email = document.getElementById('userEmail').value.trim();
            const phone = document.getElementById('userPhone').value.trim();
            const password = document.getElementById('userPassword').value;
            const confirmPassword = document.getElementById('userConfirmPassword').value;
            const role = document.getElementById('userRole').value;
            const status = document.getElementById('userStatus').value;
            
            // التحقق من صحة البيانات
            if (!name || !username || !email || !phone || !password) {
                showMessage('يرجى ملء جميع الحقول المطلوبة', 'error');
                return;
            }
            
            // التحقق من كلمات المرور
            if (password !== confirmPassword) {
                showMessage('كلمات المرور غير متطابقة', 'error');
                return;
            }
            
            // التحقق من صحة البريد الإلكتروني
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showMessage('يرجى إدخال بريد إلكتروني صحيح', 'error');
                return;
            }
            
            // الحصول على الأقسام المختارة للمشرفين
            let allowedDepartments = [];
            if (role === 'moderator') {
                const checkboxes = document.querySelectorAll('#departmentsCheckboxList input[type="checkbox"]:checked');
                checkboxes.forEach(checkbox => {
                    allowedDepartments.push(checkbox.value);
                });
                
                if (allowedDepartments.length === 0) {
                    showMessage('يرجى اختيار قسم واحد على الأقل للمشرف', 'error');
                    return;
                }
            }
            
            try {
                // التحقق من عدم وجود مستخدم بنفس البريد الإلكتروني أو اسم المستخدم
                const usersRef = database.ref('users');
                const snapshot = await usersRef.once('value');
                
                let userExists = false;
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const user = childSnapshot.val();
                        if (user.email === email) {
                            showMessage('البريد الإلكتروني مسجل مسبقاً', 'error');
                            userExists = true;
                            return;
                        }
                        if (user.username === username) {
                            showMessage('اسم المستخدم مسجل مسبقاً', 'error');
                            userExists = true;
                            return;
                        }
                    });
                }
                
                if (userExists) return;
                
                // إنشاء معرف فريد للمستخدم
                const newUserRef = usersRef.push();
                const userId = newUserRef.key;
                
                const userData = {
                    id: userId,
                    name: name,
                    username: username,
                    email: email,
                    phone: phone,
                    password: btoa(password), // تشفير بسيط
                    role: role,
                    status: status,
                    allowedDepartments: allowedDepartments,
                    createdAt: new Date().toISOString(),
                    createdBy: currentUser ? currentUser.name : 'admin',
                    lastLogin: null,
                    loginCount: 0,
                    permissions: getDefaultPermissions(role)
                };
                
                await newUserRef.set(userData);
                
                // تحديث قائمة المستخدمين المحلية
                allUsers.push({...userData, key: userId});
                
                closeUserModal();
                displayUsersTable();
                showMessage('تم إضافة المستخدم بنجاح', 'success');
                
            } catch (error) {
                console.error('Error saving user:', error);
                showMessage('حدث خطأ أثناء حفظ المستخدم', 'error');
            }
        }
        
        // دالة للحصول على صلاحيات افتراضية حسب الدور
        function getDefaultPermissions(role) {
            switch(role) {
                case 'admin':
                    return {
                        canViewComplaints: true,
                        canEditComplaints: true,
                        canDeleteComplaints: true,
                        canManageUsers: true,
                        canViewReports: true,
                        canExportData: true,
                        canManageSettings: true
                    };
                case 'moderator':
                    return {
                        canViewComplaints: true,
                        canEditComplaints: true,
                        canDeleteComplaints: false,
                        canManageUsers: false,
                        canViewReports: true,
                        canExportData: false,
                        canManageSettings: false
                    };
                default: // user
                    return {
                        canViewComplaints: true,
                        canEditComplaints: false,
                        canDeleteComplaints: false,
                        canManageUsers: false,
                        canViewReports: false,
                        canExportData: false,
                        canManageSettings: false
                    };
            }
        }
        
        // دالة إغلاق نافذة المستخدم
        function closeUserModal() {
            const modal = document.getElementById('addUserModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // دالة حذف مستخدم
        async function deleteUser(userKey) {
            if (!confirm('هل أنت متأكد من حذف هذا المستخدم؟')) {
                return;
            }
            
            try {
                await database.ref('users/' + userKey).remove();
                
                // تحديث القائمة المحلية
                allUsers = allUsers.filter(user => user.key !== userKey);
                
                displayUsersTable();
                showMessage('تم حذف المستخدم بنجاح', 'success');
            } catch (error) {
                console.error('Error deleting user:', error);
                showMessage('حدث خطأ أثناء حذف المستخدم', 'error');
            }
        }
        
        // دالة تعديل مستخدم
        function editUser(userKey) {
            const user = allUsers.find(u => u.key === userKey);
            if (!user) return;
            
            showAddUserModal();
            
            // تغيير النص
            document.querySelector('.modal-title').textContent = 'تعديل المستخدم';
            document.querySelector('button[type="submit"]').innerHTML = '<i class="fas fa-save"></i> تحديث المستخدم';
            
            // ملء الحقول بقيم المستخدم
            document.getElementById('userName').value = user.name || '';
            document.getElementById('userUsername').value = user.username || '';
            document.getElementById('userEmail').value = user.email || '';
            document.getElementById('userPhone').value = user.phone || '';
            document.getElementById('userRole').value = user.role || 'user';
            document.getElementById('userStatus').value = user.status || 'active';
            
            // جعل حقول كلمة المرور غير إلزامية للتعديل
            document.getElementById('userPassword').required = false;
            document.getElementById('userConfirmPassword').required = false;
            document.getElementById('userPassword').placeholder = 'اتركه فارغاً للحفاظ على كلمة المرور الحالية';
            document.getElementById('userConfirmPassword').placeholder = 'اتركه فارغاً للحفاظ على كلمة المرور الحالية';
            
            // تحديد الأقسام للمشرفين
            if (user.role === 'moderator' && user.allowedDepartments) {
                const checkboxes = document.querySelectorAll('#departmentsCheckboxList input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = user.allowedDepartments.includes(checkbox.value);
                });
            }
            
            // تحديث عرض اختيار الأقسام
            document.getElementById('userRole').dispatchEvent(new Event('change'));
            
            // تغيير دالة الحفظ
            const form = document.getElementById('addUserForm');
            form.onsubmit = async function(e) {
                e.preventDefault();
                await updateUser(userKey);
            };
        }
        
        // دالة تحديث المستخدم
        async function updateUser(userKey) {
            const name = document.getElementById('userName').value.trim();
            const username = document.getElementById('userUsername').value.trim();
            const email = document.getElementById('userEmail').value.trim();
            const phone = document.getElementById('userPhone').value.trim();
            const password = document.getElementById('userPassword').value;
            const role = document.getElementById('userRole').value;
            const status = document.getElementById('userStatus').value;
            
            try {
                const updates = {
                    name: name,
                    username: username,
                    email: email,
                    phone: phone,
                    role: role,
                    status: status,
                    updatedAt: new Date().toISOString()
                };
                
                // الحصول على الأقسام المختارة للمشرفين
                if (role === 'moderator') {
                    const checkboxes = document.querySelectorAll('#departmentsCheckboxList input[type="checkbox"]:checked');
                    const allowedDepartments = [];
                    checkboxes.forEach(checkbox => {
                        allowedDepartments.push(checkbox.value);
                    });
                    
                    if (allowedDepartments.length === 0) {
                        showMessage('يرجى اختيار قسم واحد على الأقل للمشرف', 'error');
                        return;
                    }
                    
                    updates.allowedDepartments = allowedDepartments;
                } else {
                    updates.allowedDepartments = [];
                }
                
                // تحديث كلمة المرور فقط إذا تم إدخالها
                if (password) {
                    const confirmPassword = document.getElementById('userConfirmPassword').value;
                    if (password !== confirmPassword) {
                        showMessage('كلمات المرور غير متطابقة', 'error');
                        return;
                    }
                    updates.password = btoa(password);
                }
                
                await database.ref('users/' + userKey).update(updates);
                
                // تحديث القائمة المحلية
                const userIndex = allUsers.findIndex(u => u.key === userKey);
                if (userIndex !== -1) {
                    allUsers[userIndex] = {...allUsers[userIndex], ...updates};
                }
                
                closeUserModal();
                displayUsersTable();
                showMessage('تم تحديث المستخدم بنجاح', 'success');
                
            } catch (error) {
                console.error('Error updating user:', error);
                showMessage('حدث خطأ أثناء تحديث المستخدم', 'error');
            }
        }
        
        // دالة إعادة تعيين كلمة المرور
        async function resetUserPassword(userKey) {
            const newPassword = prompt('أدخل كلمة المرور الجديدة:');
            if (!newPassword) return;
            
            const confirmPassword = prompt('أكد كلمة المرور الجديدة:');
            if (newPassword !== confirmPassword) {
                showMessage('كلمات المرور غير متطابقة', 'error');
                return;
            }
            
            try {
                await database.ref('users/' + userKey).update({
                    password: btoa(newPassword),
                    updatedAt: new Date().toISOString()
                });
                
                showMessage('تم إعادة تعيين كلمة المرور بنجاح', 'success');
            } catch (error) {
                console.error('Error resetting password:', error);
                showMessage('حدث خطأ أثناء إعادة تعيين كلمة المرور', 'error');
            }
        }
        
        // دالة عرض الرسائل
        function showMessage(message, type) {
            // إنشاء عنصر الرسالة
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                border-radius: 6px;
                color: ${type === 'error' ? '#721c24' : '#155724'};
                background-color: ${type === 'error' ? '#f8d7da' : '#d4edda'};
                border: 1px solid ${type === 'error' ? '#f5c6cb' : '#c3e6cb'};
                z-index: 10000;
                box-shadow: 0 5px 15px rgba(0,0,0,0.1);
                max-width: 400px;
                animation: slideIn 0.3s ease;
            `;
            
            // إضافة أيقونة حسب نوع الرسالة
            const icon = type === 'error' ? 'fa-exclamation-circle' : 'fa-check-circle';
            messageDiv.innerHTML = `
                <i class="fas ${icon}" style="margin-left: 10px;"></i>
                ${message}
            `;
            
            // إضافة الرسالة إلى الصفحة
            document.body.appendChild(messageDiv);
            
            // إزالة الرسالة بعد 5 ثوان
            setTimeout(() => {
                messageDiv.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.parentNode.removeChild(messageDiv);
                    }
                }, 300);
            }, 5000);
        }
        
        // إضافة أنيميشن للرسائل
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
