<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>لوحة التحكم - نظام الشكاوى الموحد</title>
    
    <link rel="manifest" href="manifest-admin.json">
    <meta name="theme-color" content="#1a5fb4">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="إدارة الشكاوى">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap');
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="icon" type="image/png" href="icon-192x192.png">
    <link rel="apple-touch-icon" href="icon-512x512.png">
    
    <style>
        /* ==================== أنماط CSS الرئيسية ==================== */
        *{box-sizing:border-box;margin:0;padding:0;font-family:'Cairo',sans-serif;-webkit-tap-highlight-color:transparent}
        html{font-size:16px;scroll-behavior:smooth}
        body{background:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%);color:#333;line-height:1.6;min-height:100vh;overflow-x:hidden;padding-bottom:80px}
        .container{max-width:1400px;margin:0 auto;padding:15px}
        
        .login-screen{display:none}
        
        header{background:linear-gradient(135deg,#1a5fb4 0%,#2d8fd5 100%);color:#fff;padding:20px 0 25px;text-align:center;border-radius:0 0 25px 25px;box-shadow:0 8px 25px rgba(0,0,0,.15);margin-bottom:20px;position:relative;overflow:hidden}
        header::before{content:'';position:absolute;top:0;left:0;right:0;height:5px;background:linear-gradient(90deg,#ff7e5f,#feb47b,#86a8e7,#91eae4);background-size:400% 400%;animation:gradientShift 8s ease infinite}
        @keyframes gradientShift{0%{background-position:0 50%}50%{background-position:100% 50%}100%{background-position:0 50%}}
        .logo{font-size:1.8rem;margin-bottom:8px;text-shadow:2px 2px 4px rgba(0,0,0,.2);padding:0 15px;line-height:1.4}
        .subtitle{font-size:1rem;opacity:.9;max-width:600px;margin:0 auto;padding:0 15px;line-height:1.5}
        
        .admin-bar{background:linear-gradient(135deg,#2c3e50 0%,#4a6572 100%);color:#fff;padding:15px;border-radius:15px;margin-bottom:20px;box-shadow:0 5px 15px rgba(0,0,0,.1);display:flex;flex-direction:column;gap:15px}
        .admin-info{display:flex;align-items:center;gap:12px}
        .admin-avatar{width:50px;height:50px;border-radius:50%;background:linear-gradient(135deg,#3498db,#2c3e50);display:flex;align-items:center;justify-content:center;font-size:1.4rem;box-shadow:0 4px 10px rgba(0,0,0,.2);flex-shrink:0}
        .admin-text{flex-grow:1;overflow:hidden}
        .admin-text h3{margin-bottom:5px;font-size:1.1rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .admin-text p{opacity:.9;font-size:.85rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .admin-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
        .stat-box{background:rgba(255,255,255,.15);padding:12px 8px;border-radius:10px;text-align:center;backdrop-filter:blur(10px)}
        .stat-value{font-size:1.5rem;font-weight:700;margin-bottom:5px}
        .stat-label{font-size:.8rem;opacity:.9;line-height:1.3}
        .logout-btn{background:#e74c3c;color:#fff;border:none;padding:12px 20px;border-radius:10px;cursor:pointer;font-weight:600;transition:all .3s;display:flex;align-items:center;justify-content:center;gap:8px;font-size:1rem;width:100%}
        .logout-btn:hover{background:#c0392b;transform:translateY(-2px)}
        
        .dashboard-grid{display:flex;flex-direction:column;gap:20px}
        .sidebar-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);z-index:999;animation:fadeIn .3s ease}
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        .sidebar{background:#fff;border-radius:20px 0 0 20px;padding:25px 20px;box-shadow:0 0 30px rgba(0,0,0,.3);height:100vh;width:280px;position:fixed;top:0;right:-300px;z-index:1000;transition:right .3s ease;overflow-y:auto}
        .sidebar.active{right:0}
        .sidebar-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;padding-bottom:15px;border-bottom:2px solid #f0f0f0}
        .sidebar-title{font-size:1.3rem;color:#2c3e50;font-weight:700}
        .close-sidebar{background:none;border:none;font-size:1.5rem;color:#666;cursor:pointer;padding:5px}
        .sidebar-menu{list-style:none}
        .menu-item{padding:16px 15px;margin-bottom:8px;border-radius:12px;cursor:pointer;transition:all .3s ease;display:flex;align-items:center;gap:12px;color:#555;font-size:1rem;position:relative}
        .menu-item:hover{background:#f8f9fa;transform:translateX(-5px)}
        .menu-item.active{background:linear-gradient(to right,#1a5fb4,#2d8fd5);color:#fff;box-shadow:0 5px 15px rgba(26,95,180,.3)}
        .menu-icon{font-size:1.2rem;width:24px;text-align:center}
        .badge{background:#e74c3c;color:#fff;border-radius:50%;padding:4px 8px;font-size:.75rem;margin-right:auto;display:inline-block;min-width:22px;text-align:center;font-weight:700;animation:pulse 2s infinite}
        @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
        
        .main-content{background:#fff;border-radius:20px;padding:20px;box-shadow:0 5px 20px rgba(0,0,0,.08);margin-bottom:80px}
        .footer{text-align:center;padding:20px 15px;color:#666;font-size:.9rem;margin-top:30px;background:#fff;border-radius:15px;box-shadow:0 5px 15px rgba(0,0,0,.05);line-height:1.7}
        .footer a{color:#1a5fb4;text-decoration:none;font-weight:700;display:inline-flex;align-items:center;gap:6px}
        .footer a:hover{color:#155093}
        .admin-only{display:none}
        
        .loading-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,.9);display:none;justify-content:center;align-items:center;z-index:9999}
        .loading-spinner{width:60px;height:60px;border:5px solid #f3f3f3;border-top:5px solid #1a5fb4;border-radius:50%;animation:spin 1s linear infinite}
        @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
        
        .message{position:fixed;top:20px;right:20px;padding:15px 20px;border-radius:12px;z-index:10000;box-shadow:0 10px 30px rgba(0,0,0,.2);max-width:90%;animation:slideInMessage .3s ease;font-size:.95rem;line-height:1.5;background:#d4edda;color:#155724}
        .message.error{background:#f8d7da;color:#721c24}
        @keyframes slideInMessage{from{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:translateY(0)}}
        
        .content-section{display:none}
        .content-section.active{display:block}
        .section-header{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:15px;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #f0f0f0}
        .section-title{font-size:1.5rem;color:#2c3e50;font-weight:700}
        .section-controls{display:flex;gap:10px;flex-wrap:wrap}
        .filter-controls{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:20px}
        .filter-group{flex:1;min-width:150px}
        .filter-label{display:block;margin-bottom:5px;font-weight:600;color:#555;font-size:.9rem}
        .filter-select,.filter-input{width:100%;padding:10px;border:2px solid #ddd;border-radius:8px;font-size:.9rem;background:#f8f9fa}
        .filter-select:focus,.filter-input:focus{border-color:#1a5fb4;outline:none;background:#fff}
        
        .cards-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:20px;margin-bottom:30px}
        .card{background:#fff;border-radius:15px;padding:20px;box-shadow:0 5px 15px rgba(0,0,0,.08);transition:all .3s ease;border:1px solid #eee}
        .card:hover{transform:translateY(-5px);box-shadow:0 15px 30px rgba(0,0,0,.15)}
        .card-icon{font-size:2.5rem;margin-bottom:15px;width:60px;height:60px;display:flex;align-items:center;justify-content:center;border-radius:12px}
        .card-title{font-size:1.1rem;color:#2c3e50;margin-bottom:10px;font-weight:600}
        .card-value{font-size:2.2rem;font-weight:700;color:#1a5fb4;margin-bottom:5px}
        .card-label{font-size:.9rem;color:#666}
        .priority-card.high{background:linear-gradient(135deg,#ff6b6b,#ff8e8e);color:#fff}
        .priority-card.medium{background:linear-gradient(135deg,#f39c12,#f1c40f);color:#fff}
        .priority-card.low{background:linear-gradient(135deg,#2ecc71,#27ae60);color:#fff}
        
        .status-badge{padding:4px 12px;border-radius:20px;font-size:.8rem;font-weight:600;display:inline-block}
        .status-new{background:#e3f2fd;color:#1565c0}
        .status-in-progress{background:#fff3e0;color:#f57c00}
        .status-resolved{background:#e8f5e9;color:#2e7d32}
        .status-closed{background:#f5f5f5;color:#616161}
        
        .complaints-table-container{overflow-x:auto;margin-bottom:20px;border-radius:10px;border:1px solid #eee;-webkit-overflow-scrolling:touch}
        .complaints-table{width:100%;border-collapse:collapse;min-width:900px}
        .complaints-table thead{background:linear-gradient(135deg,#1a5fb4,#2d8fd5);color:#fff}
        .complaints-table th{padding:15px 10px;text-align:right;font-weight:600;font-size:.95rem;white-space:nowrap}
        .complaints-table tbody tr{border-bottom:1px solid #eee;transition:background .2s}
        .complaints-table tbody tr:hover{background:#f8f9fa}
        .complaints-table tbody tr.unread{background:#fff9e6;font-weight:600}
        .complaints-table td{padding:15px 10px;text-align:right;font-size:.9rem}
        .complaints-table .actions{display:flex;gap:8px;flex-wrap:wrap}
        
        .pagination{display:flex;justify-content:center;align-items:center;gap:10px;margin-top:20px;flex-wrap:wrap}
        .pagination-btn{background:#f8f9fa;border:1px solid #ddd;padding:8px 15px;border-radius:8px;cursor:pointer;font-size:.9rem;transition:all .2s}
        .pagination-btn:hover{background:#e9ecef}
        .pagination-btn:disabled{opacity:.5;cursor:not-allowed}
        .pagination-btn.active{background:#1a5fb4;color:#fff;border-color:#1a5fb4}
        .pagination-info{color:#666;font-size:.9rem}
        
        /* أنماط الردود المحدثة */
        .responses-container{margin:25px 0;padding:20px;background:#f8f9fa;border-radius:12px;border:2px solid #e0e0e0}
        .responses-title{color:#2c3e50;margin-bottom:15px;display:flex;align-items:center;gap:10px;font-size:1.2rem;font-weight:700}
        .responses-list{display:flex;flex-direction:column;gap:12px}
        .response-item{padding:15px;border-radius:10px;animation:fadeIn .3s ease;position:relative}
        .response-admin{background:linear-gradient(135deg,#d4edda,#c3e6cb);border-right:4px solid #28a745;margin-right:20px}
        .response-client{background:linear-gradient(135deg,#e3f2fd,#bbdefb);border-left:4px solid #3498db;margin-left:20px}
        .response-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;flex-wrap:wrap;gap:10px}
        .response-sender{display:flex;align-items:center;gap:8px;font-weight:600;color:#2c3e50}
        .response-time{font-size:.85rem;color:#666;font-weight:500}
        .response-content{white-space:pre-line;line-height:1.6;padding:10px;background:rgba(255,255,255,.7);border-radius:8px;margin-top:8px;color:#333}
        .response-actions{display:flex;gap:8px;margin-top:10px}
        .response-actions button{padding:6px 12px;border:none;border-radius:6px;cursor:pointer;font-size:.85rem;font-weight:600;transition:all .2s}
        
        /* أنماط الردود الجاهزة */
        .quick-replies-container{margin-bottom:15px;padding:15px;background:#fff;border-radius:8px;border:2px solid #e0e0e0}
        .quick-replies-title{font-weight:600;color:#2c3e50;margin-bottom:10px;font-size:.95rem}
        .quick-replies-list{display:flex;flex-wrap:wrap;gap:8px}
        .quick-reply-btn{background:#e3f2fd;color:#1565c0;border:none;padding:8px 15px;border-radius:20px;cursor:pointer;font-size:.85rem;font-weight:600;transition:all .2s}
        .quick-reply-btn:hover{background:#1565c0;color:#fff;transform:translateY(-2px)}
        
        .reply-form{margin-top:20px;padding:20px;background:#f8f9fa;border-radius:12px;border:2px solid #e0e0e0}
        .reply-form h4{color:#2c3e50;margin-bottom:15px;display:flex;align-items:center;gap:10px}
        .reply-form textarea{width:100%;min-height:120px;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:.95rem;resize:vertical}
        .reply-form textarea:focus{border-color:#1a5fb4;outline:none;background:#fff}
        .reply-form .form-actions{display:flex;gap:10px;margin-top:15px;flex-wrap:wrap}
        
        .status-form{margin-top:20px;padding:20px;background:#f8f9fa;border-radius:12px;border:2px solid #e0e0e0}
        .status-form h4{color:#2c3e50;margin-bottom:15px;display:flex;align-items:center;gap:10px}
        .status-form select{width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:.95rem;background:#fff}
        .status-form select:focus{border-color:#1a5fb4;outline:none}
        .status-form .form-actions{display:flex;gap:10px;margin-top:15px;flex-wrap:wrap}
        
        .mobile-menu-btn{display:flex;align-items:center;justify-content:center;gap:8px;background:#1a5fb4;color:#fff;border:none;padding:12px 15px;border-radius:10px;cursor:pointer;font-weight:600;margin-bottom:15px;width:100%;display:none}
        .mobile-nav{position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:2px solid #1a5fb4;display:flex;justify-content:space-around;padding:12px 10px;z-index:999;box-shadow:0 -5px 20px rgba(0,0,0,.1);display:flex}
        .mobile-nav-item{display:flex;flex-direction:column;align-items:center;gap:5px;color:#666;text-decoration:none;font-size:.8rem;flex:1;padding:8px 5px;border-radius:10px;transition:all .2s;position:relative;cursor:pointer}
        .mobile-nav-item:hover{background:#f8f9fa}
        .mobile-nav-item.active{background:#1a5fb4;color:#fff}
        .mobile-nav-icon{font-size:1.2rem}
        .mobile-nav-badge{position:absolute;top:-5px;right:10px;background:#e74c3c;color:#fff;border-radius:50%;padding:2px 6px;font-size:.7rem;min-width:18px;text-align:center;font-weight:700;display:none}
        
        .btn-export{background:linear-gradient(135deg,#27ae60,#2ecc71);color:#fff;padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-weight:600;display:flex;align-items:center;gap:8px;font-size:.95rem}
        .btn-export:hover{background:linear-gradient(135deg,#229954,#27ae60);transform:translateY(-2px)}
        .btn-add{background:linear-gradient(135deg,#3498db,#2980b9);color:#fff;padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-weight:600;display:flex;align-items:center;gap:8px;font-size:.95rem}
        .btn-add:hover{background:linear-gradient(135deg,#2980b9,#1f618d);transform:translateY(-2px)}
        .btn-print{background:linear-gradient(135deg,#9b59b6,#8e44ad);color:#fff;padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-weight:600;display:flex;align-items:center;gap:8px;font-size:.95rem}
        .btn-print:hover{background:linear-gradient(135deg,#8e44ad,#7d3c98);transform:translateY(-2px)}
        
        .users-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:20px;margin-top:20px}
        .user-card{background:#fff;border-radius:15px;padding:20px;box-shadow:0 5px 15px rgba(0,0,0,.08);border:1px solid #eee;transition:all .3s}
        .user-card:hover{transform:translateY(-5px);box-shadow:0 15px 30px rgba(0,0,0,.15)}
        .user-card-header{display:flex;align-items:center;gap:15px;margin-bottom:15px}
        .user-avatar{width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,#3498db,#2c3e50);display:flex;align-items:center;justify-content:center;font-size:1.5rem;color:#fff;flex-shrink:0}
        .user-info h3{color:#2c3e50;font-size:1.1rem;margin-bottom:5px}
        .user-role{display:inline-block;padding:4px 12px;border-radius:20px;font-size:.8rem;font-weight:600;background:#e3f2fd;color:#1565c0;margin-bottom:8px}
        .user-role.admin{background:#e8f5e9;color:#2e7d32}
        .user-email{font-size:.85rem;color:#666;display:flex;align-items:center;gap:5px}
        .user-departments{margin-top:12px;padding-top:12px;border-top:1px solid #eee}
        .user-departments-title{font-size:.85rem;color:#666;margin-bottom:8px;font-weight:600}
        .department-tags{display:flex;flex-wrap:wrap;gap:6px}
        .department-tag{background:#fff3e0;color:#f57c00;padding:4px 10px;border-radius:15px;font-size:.75rem;font-weight:600}
        .user-actions{display:flex;gap:8px;margin-top:15px}
        .user-actions button{flex:1;padding:8px;font-size:.85rem;min-width:0}
        
        .form-modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.9);display:none;justify-content:center;align-items:center;z-index:1100;padding:15px}
        .form-modal .modal-content{max-width:600px}
        .form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:15px;margin-bottom:15px}
        .form-group{display:flex;flex-direction:column}
        .form-group label{margin-bottom:8px;font-weight:600;color:#2c3e50;font-size:.95rem}
        .form-group input,.form-group select,.form-group textarea{padding:12px;border:2px solid #ddd;border-radius:8px;font-size:.95rem;background:#f8f9fa}
        .form-group input:focus,.form-group select:focus,.form-group textarea:focus{border-color:#1a5fb4;outline:none;background:#fff}
        .form-group.full-width{grid-column:1/-1}
        .multi-select{min-height:150px;border:2px solid #ddd;border-radius:8px;padding:10px;background:#f8f9fa;max-height:200px;overflow-y:auto}
        .multi-select label{display:flex;align-items:center;gap:10px;padding:8px;margin-bottom:5px;cursor:pointer;border-radius:5px;transition:background .2s}
        .multi-select label:hover{background:#e9ecef}
        .multi-select input[type="checkbox"]{width:18px;height:18px;cursor:pointer}
        .form-actions{display:flex;gap:10px;margin-top:20px;flex-wrap:wrap}
        .form-actions button{flex:1;padding:12px;min-width:120px}
        
        .settings-grid{display:grid;grid-template-columns:1fr;gap:20px}
        .settings-card{background:#fff;border-radius:15px;padding:25px;box-shadow:0 5px 15px rgba(0,0,0,.08);border:1px solid #eee}
        .settings-card h3{color:#2c3e50;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #f0f0f0;font-size:1.2rem}
        .setting-item{margin-bottom:20px;padding-bottom:20px;border-bottom:1px solid #eee}
        .setting-item:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0}
        .setting-label{display:block;font-weight:600;margin-bottom:8px;color:#2c3e50}
        .setting-description{font-size:.85rem;color:#666;margin-top:5px;line-height:1.5}
        .setting-input,.setting-select,.setting-textarea{width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:.95rem;background:#f8f9fa}
        .setting-input:focus,.setting-select:focus,.setting-textarea:focus{border-color:#1a5fb4;outline:none;background:#fff}
        .setting-textarea{min-height:120px;resize:vertical}
        
        .toggle-switch{position:relative;display:inline-block;width:60px;height:34px;vertical-align:middle}
        .toggle-switch input{opacity:0;width:0;height:0}
        .toggle-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;transition:.4s;border-radius:34px}
        .toggle-slider:before{position:absolute;content:"";height:26px;width:26px;left:4px;bottom:4px;background-color:white;transition:.4s;border-radius:50%}
        input:checked+.toggle-slider{background-color:#1a5fb4}
        input:checked+.toggle-slider:before{transform:translateX(26px)}
        
        .departments-list{display:flex;flex-wrap:wrap;gap:10px;margin-top:15px}
        .department-item{background:#e3f2fd;color:#1565c0;padding:10px 15px;border-radius:20px;display:flex;align-items:center;gap:10px;font-weight:600}
        .department-item .delete-dept{color:#e74c3c;cursor:pointer;font-size:1.1rem;transition:transform .2s}
        .department-item .delete-dept:hover{transform:scale(1.2)}
        .add-department-form{display:flex;gap:10px;margin-top:15px;flex-wrap:wrap}
        .add-department-form input{flex:1;min-width:200px}
        .modal-actions{display:flex;gap:10px;padding:20px;background:#f8f9fa;border-radius:0 0 20px 20px;flex-wrap:wrap}
        .modal-actions button{flex:1;min-width:120px}
        
        .complaint-details-modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.9);display:none;justify-content:center;align-items:center;z-index:1100;padding:15px}
        .modal-content{background:#fff;border-radius:20px;width:100%;max-width:900px;max-height:90vh;overflow-y:auto;position:relative;animation:modalSlideUp .3s ease}
        @keyframes modalSlideUp{from{opacity:0;transform:translateY(50px)}to{opacity:1;transform:translateY(0)}}
        .modal-header{background:linear-gradient(135deg,#1a5fb4 0%,#2d8fd5 100%);color:#fff;padding:20px;border-radius:20px 20px 0 0;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:1}
        .modal-title{font-size:1.4rem;font-weight:700}
        .close-modal{background:none;border:none;color:#fff;font-size:2rem;cursor:pointer;line-height:1;padding:5px}
        .modal-body{padding:20px}
        .details-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:15px;margin-bottom:20px}
        .detail-item{padding:15px;border-bottom:1px solid #eee;background:#f8f9fa;border-radius:10px}
        .detail-item.full-width{grid-column:1/-1}
        .detail-label{font-weight:700;color:#1a5fb4;margin-bottom:8px;font-size:.95rem}
        .detail-value{color:#333;line-height:1.6;white-space:pre-wrap;word-break:break-word}
        
        .action-btn{padding:10px 15px;border:none;border-radius:8px;cursor:pointer;font-size:.9rem;display:flex;align-items:center;justify-content:center;gap:5px;transition:all .2s ease;min-width:100px;font-weight:600}
        .btn-view{background:#3498db;color:#fff}
        .btn-view:hover{background:#2980b9}
        .btn-reply{background:#9b59b6;color:#fff}
        .btn-reply:hover{background:#8e44ad}
        .btn-edit{background:#f39c12;color:#fff}
        .btn-edit:hover{background:#e67e22}
        .btn-delete{background:#e74c3c;color:#fff}
        .btn-delete:hover{background:#c0392b}
        .btn-status{background:#27ae60;color:#fff}
        .btn-status:hover{background:#229954}
        .btn-secondary{background:#6c757d;color:#fff}
        .btn-secondary:hover{background:#5a6268}
        
        .national-id{font-family:monospace;font-size:1.05rem;letter-spacing:1px;direction:ltr;text-align:right}
        .new-request-indicator{display:inline-block;width:10px;height:10px;background:#e74c3c;border-radius:50%;margin-left:8px;animation:blink 1.5s infinite}
        @keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
        
        #pwa-toast{position:fixed;top:20px;right:20px;padding:15px 20px;border-radius:12px;color:white;font-weight:bold;z-index:10000;box-shadow:0 4px 15px rgba(0,0,0,0.2);max-width:400px;animation:slideIn 0.3s ease;display:none}
        @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
        @keyframes slideOut{from{transform:translateX(0);opacity:1}to{transform:translateX(100%);opacity:0}}
        
        /* أنماط الطباعة */
        @media print{
            body *{visibility:hidden}
            .print-area,.print-area *{visibility:visible}
            .print-area{position:absolute;left:0;top:0;width:100%}
            .no-print{display:none !important}
            .modal-header{background:#1a5fb4 !important;-webkit-print-color-adjust:exact;print-color-adjust:exact}
        }
        
        @media (max-width:768px){
            .mobile-menu-btn,.mobile-nav{display:flex}
            .cards-grid{grid-template-columns:1fr}
            .details-grid{grid-template-columns:1fr}
            .complaints-table th,.complaints-table td{padding:10px 8px;font-size:.85rem}
            .section-header{flex-direction:column;align-items:flex-start}
            .filter-controls{flex-direction:column}
            .users-grid{grid-template-columns:1fr}
            .admin-info{flex-direction:column;text-align:center}
            .admin-text h3,.admin-text p{text-align:center}
            .logo{font-size:1.5rem}
            .subtitle{font-size:.9rem}
            .response-admin{margin-right:10px}
            .response-client{margin-left:10px}
            .form-row{grid-template-columns:1fr}
            .form-actions{flex-direction:column}
            .form-actions button{width:100%}
            .modal-content{max-width:100%;max-height:95vh}
            .modal-actions{flex-direction:column}
            .modal-actions button{width:100%}
        }
        @media (min-width:769px){
            .dashboard-grid{display:grid;grid-template-columns:280px 1fr}
            .sidebar{position:static;width:100%;height:auto;right:0;box-shadow:none;border-radius:15px}
            .sidebar-overlay{display:none !important}
            .close-sidebar{display:none}
            .mobile-menu-btn,.mobile-nav{display:none}
        }
        @media (max-width:480px){
            .admin-stats{grid-template-columns:1fr}
            .card-value{font-size:1.8rem}
            .complaints-table .actions{flex-direction:column}
            .action-btn{width:100%}
        }
    </style>
</head>
<body>
    <div id="loginScreen" class="login-screen"></div>

    <div id="dashboardScreen">
        <header>
            <div class="container">
                <h1 class="logo">لوحة التحكم - نظام الشكاوى الموحد</h1>
                <p class="subtitle">إدارة الشكاوى والطلبات المقدمة من المواطنين</p>
            </div>
        </header>

        <div class="container">
            <button class="mobile-menu-btn" id="mobileMenuBtn">
                <i class="fas fa-bars"></i>
                عرض القائمة
            </button>

            <div class="admin-bar">
                <div class="admin-info">
                    <div class="admin-avatar">
                        <i class="fas fa-user-shield"></i>
                    </div>
                    <div class="admin-text">
                        <h3 id="adminWelcome">مرحباً، المسؤول</h3>
                        <p id="adminLastLogin">آخر دخول: -</p>
                    </div>
                </div>

                <div class="admin-stats">
                    <div class="stat-box">
                        <div class="stat-value" id="totalComplaints">0</div>
                        <div class="stat-label">إجمالي الشكاوى</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="newComplaints">0</div>
                        <div class="stat-label">شكاوى جديدة</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="resolvedComplaints">0</div>
                        <div class="stat-label">تم حلها</div>
                    </div>
                </div>

                <button class="logout-btn" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    تسجيل الخروج
                </button>
            </div>

            <div class="dashboard-grid">
                <div class="sidebar-overlay" id="sidebarOverlay"></div>
                <div class="sidebar" id="sidebar">
                    <div class="sidebar-header">
                        <h3 class="sidebar-title">القائمة الرئيسية</h3>
                        <button class="close-sidebar" id="closeSidebar">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <ul class="sidebar-menu">
                        <li class="menu-item active" data-section="dashboard">
                            <i class="fas fa-tachometer-alt menu-icon"></i>
                            <span>لوحة التحكم</span>
                        </li>
                        <li class="menu-item" data-section="complaints">
                            <i class="fas fa-file-alt menu-icon"></i>
                            <span>إدارة الشكاوى</span>
                            <span class="badge" id="complaintsBadge" style="display:none;">0</span>
                        </li>
                        <li class="menu-item admin-only" data-section="reports">
                            <i class="fas fa-chart-bar menu-icon"></i>
                            <span>التقارير والتحليلات</span>
                        </li>
                        <li class="menu-item admin-only" data-section="users">
                            <i class="fas fa-users menu-icon"></i>
                            <span>المستخدمين</span>
                        </li>
                        <li class="menu-item admin-only" data-section="settings">
                            <i class="fas fa-cog menu-icon"></i>
                            <span>الإعدادات</span>
                        </li>
                        <li class="menu-item admin-only" data-section="departments">
                            <i class="fas fa-building menu-icon"></i>
                            <span>الأقسام</span>
                        </li>
                        <li class="menu-item admin-only" data-section="audit">
                            <i class="fas fa-history menu-icon"></i>
                            <span>سجلات التدقيق</span>
                        </li>
                        <li class="menu-item admin-only" data-section="backup">
                            <i class="fas fa-database menu-icon"></i>
                            <span>النسخ الاحتياطي</span>
                        </li>
                    </ul>
                </div>

                <div class="main-content">
                    <!-- قسم لوحة التحكم الرئيسية -->
                    <div id="dashboardSection" class="content-section active">
                        <div class="section-header">
                            <h2 class="section-title">لوحة التحكم الرئيسية</h2>
                            <div class="section-controls">
                                <button class="btn-export" onclick="generateDailyReport()">
                                    <i class="fas fa-file-pdf"></i>
                                    تقرير يومي
                                </button>
                                <button class="btn-add" onclick="requestNotificationPermission()">
                                    <i class="fas fa-bell"></i>
                                    تفعيل الإشعارات
                                </button>
                            </div>
                        </div>
                        
                        <div class="cards-grid">
                            <div class="card priority-card high">
                                <div class="card-icon">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </div>
                                <h3 class="card-title">شكاوى عاجلة</h3>
                                <div class="card-value" id="urgentComplaints">0</div>
                                <p class="card-label">تحتاج متابعة فورية</p>
                            </div>

                            <div class="card">
                                <div class="card-icon" style="background:#e3f2fd;color:#1565c0">
                                    <i class="fas fa-inbox"></i>
                                </div>
                                <h3 class="card-title">شكاوى جديدة</h3>
                                <div class="card-value" id="cardNewComplaints">0</div>
                                <p class="card-label">في انتظار المراجعة</p>
                            </div>

                            <div class="card">
                                <div class="card-icon" style="background:#e8f5e9;color:#2e7d32">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <h3 class="card-title">شكاوى مكتملة</h3>
                                <div class="card-value" id="cardCompletedComplaints">0</div>
                                <p class="card-label">تم حلها</p>
                            </div>

                            <div class="card">
                                <div class="card-icon" style="background:#fff3e0;color:#f57c00">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <h3 class="card-title">قيد المعالجة</h3>
                                <div class="card-value" id="cardInProgress">0</div>
                                <p class="card-label">قيد العمل</p>
                            </div>
                        </div>

                        <div class="section-header">
                            <h2 class="section-title">أحدث الشكاوى</h2>
                        </div>
                        <div class="complaints-table-container">
                            <table class="complaints-table">
                                <thead>
                                    <tr>
                                        <th>رقم الشكوى</th>
                                        <th>الاسم</th>
                                        <th>القسم</th>
                                        <th>الحالة</th>
                                        <th>التاريخ</th>
                                        <th>إجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="latestComplaintsBody">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- قسم إدارة الشكاوى -->
                    <div id="complaintsSection" class="content-section">
                        <div class="section-header">
                            <h2 class="section-title">إدارة الشكاوى</h2>
                            <div class="section-controls">
                                <button class="btn-export" onclick="exportToExcel()">
                                    <i class="fas fa-file-excel"></i>
                                    تصدير Excel
                                </button>
                            </div>
                        </div>

                        <div class="filter-controls">
                            <div class="filter-group">
                                <label class="filter-label">بحث في الشكاوى</label>
                                <input type="text" id="searchComplaints" class="filter-input" placeholder="ابحث برقم الطلب، الاسم، الرقم القومي...">
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">القسم</label>
                                <select id="filterDepartment" class="filter-select">
                                    <option value="">جميع الأقسام</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">الحالة</label>
                                <select id="filterStatus" class="filter-select">
                                    <option value="">جميع الحالات</option>
                                    <option value="جديدة">جديدة</option>
                                    <option value="قيد المراجعة">قيد المراجعة</option>
                                    <option value="قيد المعالجة">قيد المعالجة</option>
                                    <option value="تم الرد">تم الرد</option>
                                    <option value="مكتملة">مكتملة</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">الأولوية</label>
                                <select id="filterPriority" class="filter-select">
                                    <option value="">جميع الأولويات</option>
                                    <option value="عادية">عادية</option>
                                    <option value="مهمة">مهمة</option>
                                    <option value="فى غاية الأهمية">فى غاية الأهمية</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">من تاريخ</label>
                                <input type="date" id="filterDateFrom" class="filter-input">
                            </div>
                            <div class="filter-group">
                                <label class="filter-label">إلى تاريخ</label>
                                <input type="date" id="filterDateTo" class="filter-input">
                            </div>
                        </div>

                        <div class="complaints-table-container">
                            <table class="complaints-table">
                                <thead>
                                    <tr>
                                        <th>رقم الشكوى</th>
                                        <th>الاسم</th>
                                        <th>القسم</th>
                                        <th>الحالة</th>
                                        <th>الأولوية</th>
                                        <th>التاريخ</th>
                                        <th>إجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="complaintsTableBody">
                                </tbody>
                            </table>
                        </div>

                        <div class="pagination">
                            <button class="pagination-btn" onclick="changePage(-1)" id="prevPage">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                            <span class="pagination-info" id="pageInfo">الصفحة 1 من 1</span>
                            <button class="pagination-btn" onclick="changePage(1)" id="nextPage">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                        </div>
                    </div>

                    <!-- قسم التقارير -->
                    <div id="reportsSection" class="content-section admin-only">
                        <div class="section-header">
                            <h2 class="section-title">التقارير والتحليلات</h2>
                        </div>
                        <div class="cards-grid">
                            <div class="card">
                                <div class="card-icon" style="background:#e3f2fd;color:#1565c0">
                                    <i class="fas fa-chart-pie"></i>
                                </div>
                                <h3 class="card-title">تقرير يومي</h3>
                                <p class="card-label">تحليل أداء اليوم</p>
                                <button class="btn-export" onclick="generateDailyReport()" style="margin-top:10px;width:100%">
                                    <i class="fas fa-file-pdf"></i>
                                    إنشاء تقرير
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- قسم المستخدمين -->
                    <div id="usersSection" class="content-section admin-only">
                        <div class="section-header">
                            <h2 class="section-title">إدارة المستخدمين</h2>
                            <div class="section-controls">
                                <button class="btn-add" onclick="showAddUserModal()">
                                    <i class="fas fa-user-plus"></i>
                                    إضافة مستخدم
                                </button>
                            </div>
                        </div>
                        <div class="users-grid" id="usersGrid"></div>
                    </div>

                    <!-- قسم الإعدادات -->
                    <div id="settingsSection" class="content-section admin-only">
                        <div class="section-header">
                            <h2 class="section-title">إعدادات النظام</h2>
                        </div>
                        <div class="settings-grid" id="settingsGrid"></div>
                    </div>

                    <!-- قسم الأقسام -->
                    <div id="departmentsSection" class="content-section admin-only">
                        <div class="section-header">
                            <h2 class="section-title">إدارة الأقسام</h2>
                        </div>
                        <div class="settings-card">
                            <h3>الأقسام الحالية</h3>
                            <div class="departments-list" id="departmentsList"></div>
                            <div class="add-department-form">
                                <input type="text" id="newDepartmentName" placeholder="اسم القسم الجديد" class="filter-input">
                                <button class="btn-add" onclick="addDepartment()">
                                    <i class="fas fa-plus"></i>
                                    إضافة قسم
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- قسم سجلات التدقيق -->
                    <div id="auditSection" class="content-section admin-only">
                        <div class="section-header">
                            <h2 class="section-title">سجلات التدقيق</h2>
                            <div class="section-controls">
                                <button class="btn-export" onclick="exportAuditLogs()">
                                    <i class="fas fa-file-excel"></i>
                                    تصدير السجلات
                                </button>
                                <button class="btn-print" onclick="printAuditLogs()">
                                    <i class="fas fa-print"></i>
                                    طباعة
                                </button>
                            </div>
                        </div>
                        <div class="complaints-table-container">
                            <table class="complaints-table">
                                <thead>
                                    <tr>
                                        <th>التاريخ والوقت</th>
                                        <th>المستخدم</th>
                                        <th>كلمة السر</th>
                                        <th>الإجراء</th>
                                        <th>التفاصيل</th>
                                    </tr>
                                </thead>
                                <tbody id="auditLogsBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- قسم النسخ الاحتياطي -->
                    <div id="backupSection" class="content-section admin-only">
                        <div class="section-header">
                            <h2 class="section-title">النسخ الاحتياطي والاستعادة</h2>
                        </div>
                        <div class="settings-card">
                            <h3>إدارة النسخ الاحتياطي</h3>
                            <div class="setting-item">
                                <button class="btn-export" onclick="createBackup()" style="width:100%">
                                    <i class="fas fa-download"></i>
                                    إنشاء نسخة احتياطية
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <footer class="footer">
                <p>
                    نظام الشكاوى الموحد © 2024 | تم التطوير بواسطة 
                    <a href="https://github.com/mohamednasr5" target="_blank">
                        <i class="fab fa-github"></i>
                        Mohamed Nasr
                    </a>
                </p>
            </footer>
        </div>
    </div>

    <!-- نافذة تفاصيل الشكوى -->
    <div id="complaintDetailsModal" class="complaint-details-modal">
        <div class="modal-content">
            <div class="modal-header no-print">
                <h2 class="modal-title">تفاصيل الشكوى</h2>
                <button class="close-modal" onclick="closeComplaintDetails()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body print-area" id="complaintDetailsBody"></div>
        </div>
    </div>

    <!-- نافذة إضافة/تعديل مستخدم -->
    <div id="userFormModal" class="form-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="userFormTitle">إضافة مستخدم جديد</h2>
                <button class="close-modal" onclick="closeUserModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>اسم المستخدم</label>
                            <input type="text" id="userName" required>
                        </div>
                        <div class="form-group">
                            <label>البريد الإلكتروني</label>
                            <input type="email" id="userEmail" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>كلمة المرور</label>
                            <input type="password" id="userPassword">
                        </div>
                        <div class="form-group">
                            <label>الدور الوظيفي</label>
                            <select id="userRole" required>
                                <option value="user">مستخدم عادي</option>
                                <option value="admin">مدير النظام</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <label>الأقسام المسموحة</label>
                        <div class="multi-select" id="userDepartments"></div>
                    </div>
                </form>
            </div>
            <div class="modal-actions">
                <button class="btn-add" onclick="saveUser()">
                    <i class="fas fa-save"></i>
                    حفظ
                </button>
                <button class="btn-secondary" onclick="closeUserModal()">
                    <i class="fas fa-times"></i>
                    إلغاء
                </button>
            </div>
        </div>
    </div>

    <!-- نافذة التحميل -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Toast للإشعارات -->
    <div id="pwa-toast"></div>

    <!-- الشريط السفلي للموبايل -->
    <nav class="mobile-nav">
        <div class="mobile-nav-item active" data-section="dashboard">
            <i class="fas fa-tachometer-alt mobile-nav-icon"></i>
            <span>الرئيسية</span>
        </div>
        <div class="mobile-nav-item" data-section="complaints">
            <i class="fas fa-file-alt mobile-nav-icon"></i>
            <span>الشكاوى</span>
            <span class="mobile-nav-badge" id="mobileComplaintsBadge">0</span>
        </div>
        <div class="mobile-nav-item admin-only" data-section="reports">
            <i class="fas fa-chart-bar mobile-nav-icon"></i>
            <span>التقارير</span>
        </div>
        <div class="mobile-nav-item admin-only" data-section="settings">
            <i class="fas fa-cog mobile-nav-icon"></i>
            <span>الإعدادات</span>
        </div>
    </nav>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        // ==================== تكوين Firebase ====================
        const firebaseConfig = {
            apiKey: "AIzaSyBijgu_hqojFcy3BWTbZLJxweVf0q2FUx4",
            authDomain: "shekwa-8c46d.firebaseapp.com",
            projectId: "shekwa-8c46d",
            storageBucket: "shekwa-8c46d.firebasestorage.app",
            messagingSenderId: "1042965815891",
            appId: "1:1042965815891:web:f4d8acb76e9b7a6f2e9d09"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // ==================== متغيرات عامة ====================
        let currentUser = null;
        let allComplaints = [];
        let filteredComplaints = [];
        let currentPage = 1;
        const complaintsPerPage = 10;
        let currentComplaintId = null;

        // ==================== الردود الجاهزة ====================
        const quickReplies = [
            "شكراً لتواصلكم معنا، تم استلام شكواكم وجاري دراستها",
            "نعتذر عن التأخير، سيتم الرد عليكم في أقرب وقت",
            "تم تحويل شكواكم للقسم المختص للمتابعة",
            "شكواكم قيد المعالجة حالياً، يرجى الانتظار",
            "تم حل المشكلة، شكراً لصبركم",
            "يرجى تزويدنا بمزيد من التفاصيل",
            "تم إغلاق الشكوى بنجاح",
            "نأسف للإزعاج، سيتم اتخاذ الإجراءات اللازمة"
        ];

        // ==================== التحقق من تسجيل الدخول ====================
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                await loadUserData();
                await loadComplaints();
                await loadDepartments();
                await loadUsers();
                await loadAuditLogs();
                await loadDepartmentsList();
                startRealtimeListeners();
            } else {
                window.location.href = 'admin-login.html';
            }
        });

        // ==================== تحميل بيانات المستخدم ====================
        async function loadUserData() {
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    document.getElementById('adminWelcome').textContent = `مرحباً، ${userData.name || 'المسؤول'}`;
                    
                    if (userData.lastLogin) {
                        const lastLogin = userData.lastLogin.toDate();
                        document.getElementById('adminLastLogin').textContent = 
                            `آخر دخول: ${lastLogin.toLocaleDateString('ar-EG')} ${lastLogin.toLocaleTimeString('ar-EG')}`;
                    }

                    // تحديث آخر دخول
                    await db.collection('users').doc(currentUser.uid).update({
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    // إظهار الأقسام الخاصة بالمدير
                    if (userData.role === 'admin') {
                        document.querySelectorAll('.admin-only').forEach(el => {
                            el.style.display = el.classList.contains('menu-item') ? 'flex' : 'block';
                        });
                    }

                    // تسجيل عملية تسجيل الدخول
                    await logAudit('تسجيل دخول', `المستخدم ${userData.name} قام بتسجيل الدخول`, userData.email);
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        // ==================== تحميل الشكاوى ====================
        async function loadComplaints() {
            try {
                showLoading();
                const snapshot = await db.collection('complaints')
                    .orderBy('timestamp', 'desc')
                    .get();
                
                allComplaints = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                filteredComplaints = [...allComplaints];
                updateStatistics();
                displayComplaints();
                hideLoading();
            } catch (error) {
                console.error('Error loading complaints:', error);
                showMessage('حدث خطأ في تحميل الشكاوى', 'error');
                hideLoading();
            }
        }

        // ==================== تحديث الإحصائيات ====================
        function updateStatistics() {
            const total = allComplaints.length;
            const newComplaints = allComplaints.filter(c => c.status === 'جديدة').length;
            const resolved = allComplaints.filter(c => c.status === 'مكتملة').length;
            const urgent = allComplaints.filter(c => c.priority === 'فى غاية الأهمية').length;
            const inProgress = allComplaints.filter(c => c.status === 'قيد المعالجة').length;

            document.getElementById('totalComplaints').textContent = total;
            document.getElementById('newComplaints').textContent = newComplaints;
            document.getElementById('resolvedComplaints').textContent = resolved;
            document.getElementById('urgentComplaints').textContent = urgent;
            document.getElementById('cardNewComplaints').textContent = newComplaints;
            document.getElementById('cardCompletedComplaints').textContent = resolved;
            document.getElementById('cardInProgress').textContent = inProgress;

            if (newComplaints > 0) {
                document.getElementById('complaintsBadge').style.display = 'inline-block';
                document.getElementById('complaintsBadge').textContent = newComplaints;
                document.getElementById('mobileComplaintsBadge').style.display = 'inline-block';
                document.getElementById('mobileComplaintsBadge').textContent = newComplaints;
            }
        }

        // ==================== عرض الشكاوى ====================
        function displayComplaints() {
            const startIndex = (currentPage - 1) * complaintsPerPage;
            const endIndex = startIndex + complaintsPerPage;
            const pageComplaints = filteredComplaints.slice(startIndex, endIndex);

            const tbody = document.getElementById('complaintsTableBody');
            const latestBody = document.getElementById('latestComplaintsBody');

            tbody.innerHTML = pageComplaints.map(complaint => createComplaintRow(complaint)).join('');
            latestBody.innerHTML = filteredComplaints.slice(0, 5).map(complaint => createComplaintRow(complaint, true)).join('');

            updatePagination();
        }

        // ==================== إنشاء صف شكوى ====================
        function createComplaintRow(complaint, isLatest = false) {
            const isUnread = complaint.status === 'جديدة';
            const statusClass = getStatusClass(complaint.status);
            
            return `
                <tr class="${isUnread ? 'unread' : ''}">
                    <td>
                        ${isUnread ? '<span class="new-request-indicator"></span>' : ''}
                        #${complaint.requestNumber}
                    </td>
                    <td>${complaint.name}</td>
                    <td>${complaint.department}</td>
                    <td><span class="status-badge ${statusClass}">${complaint.status}</span></td>
                    ${!isLatest ? `<td><span class="status-badge" style="background:#f0f0f0;color:#666">${complaint.priority}</span></td>` : ''}
                    <td>${new Date(complaint.timestamp?.toDate()).toLocaleDateString('ar-EG')}</td>
                    <td>
                        <div class="actions">
                            <button class="action-btn btn-view" onclick="viewComplaintDetails('${complaint.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn btn-edit" onclick="updateComplaintStatus('${complaint.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }

        function getStatusClass(status) {
            const statusMap = {
                'جديدة': 'status-new',
                'قيد المراجعة': 'status-in-progress',
                'قيد المعالجة': 'status-in-progress',
                'تم الرد': 'status-in-progress',
                'مكتملة': 'status-resolved'
            };
            return statusMap[status] || 'status-new';
        }

        // ==================== عرض تفاصيل الشكوى ====================
        async function viewComplaintDetails(complaintId) {
            try {
                showLoading();
                currentComplaintId = complaintId;
                const doc = await db.collection('complaints').doc(complaintId).get();
                
                if (!doc.exists) {
                    showMessage('الشكوى غير موجودة', 'error');
                    return;
                }

                const complaint = doc.data();
                const modalBody = document.getElementById('complaintDetailsBody');

                // جلب الردود
                const responsesSnapshot = await db.collection('complaints')
                    .doc(complaintId)
                    .collection('responses')
                    .orderBy('timestamp', 'asc')
                    .get();

                const responses = responsesSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                modalBody.innerHTML = `
                    <div class="details-grid">
                        <div class="detail-item">
                            <div class="detail-label">رقم الشكوى</div>
                            <div class="detail-value">#${complaint.requestNumber}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">التاريخ</div>
                            <div class="detail-value">${new Date(complaint.timestamp?.toDate()).toLocaleString('ar-EG')}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">الاسم الكامل</div>
                            <div class="detail-value">${complaint.name}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">رقم الهاتف</div>
                            <div class="detail-value">${complaint.phone}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">البريد الإلكتروني</div>
                            <div class="detail-value">${complaint.email || 'غير متوفر'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">الرقم القومي</div>
                            <div class="detail-value national-id">${complaint.nationalId}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">القسم</div>
                            <div class="detail-value">${complaint.department}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">الحالة</div>
                            <div class="detail-value">
                                <span class="status-badge ${getStatusClass(complaint.status)}">${complaint.status}</span>
                            </div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">الأولوية</div>
                            <div class="detail-value">${complaint.priority}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">العنوان</div>
                            <div class="detail-value">${complaint.address}</div>
                        </div>
                        <div class="detail-item full-width">
                            <div class="detail-label">تفاصيل الشكوى</div>
                            <div class="detail-value">${complaint.description}</div>
                        </div>
                    </div>

                    ${responses.length > 0 ? `
                        <div class="responses-container">
                            <h3 class="responses-title">
                                <i class="fas fa-comments"></i>
                                الردود (${responses.length})
                            </h3>
                            <div class="responses-list">
                                ${responses.map(response => `
                                    <div class="response-item ${response.isAdmin ? 'response-admin' : 'response-client'}">
                                        <div class="response-header">
                                            <span class="response-sender">
                                                <i class="fas fa-${response.isAdmin ? 'user-shield' : 'user'}"></i>
                                                ${response.isAdmin ? 'الإدارة' : 'المواطن'}
                                            </span>
                                            <span class="response-time">${new Date(response.timestamp?.toDate()).toLocaleString('ar-EG')}</span>
                                        </div>
                                        <div class="response-content">${response.message}</div>
                                        ${currentUser.uid === 'WjKVdKGLyJbZtZZNYmf0WxELqr13' || response.isAdmin ? `
                                            <div class="response-actions">
                                                <button class="btn-delete" style="padding:6px 12px;font-size:.85rem" onclick="deleteResponse('${complaintId}', '${response.id}')">
                                                    <i class="fas fa-trash"></i> حذف
                                                </button>
                                            </div>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <div class="reply-form">
                        <h4>
                            <i class="fas fa-reply"></i>
                            إضافة رد
                        </h4>
                        
                        <div class="quick-replies-container">
                            <div class="quick-replies-title">
                                <i class="fas fa-bolt"></i>
                                الردود الجاهزة:
                            </div>
                            <div class="quick-replies-list">
                                ${quickReplies.map((reply, index) => `
                                    <button class="quick-reply-btn" onclick="insertQuickReply(\`${reply}\`)">
                                        ${reply}
                                    </button>
                                `).join('')}
                            </div>
                        </div>

                        <textarea id="replyMessage" placeholder="اكتب ردك هنا..." rows="5"></textarea>
                        <div class="form-actions">
                            <button class="action-btn btn-reply" onclick="sendReply()">
                                <i class="fas fa-paper-plane"></i>
                                إرسال الرد
                            </button>
                            <button class="action-btn btn-print no-print" onclick="window.print()">
                                <i class="fas fa-print"></i>
                                طباعة
                            </button>
                        </div>
                    </div>

                    <div class="status-form">
                        <h4>
                            <i class="fas fa-edit"></i>
                            تحديث حالة الشكوى
                        </h4>
                        <select id="newStatus">
                            <option value="جديدة" ${complaint.status === 'جديدة' ? 'selected' : ''}>جديدة</option>
                            <option value="قيد المراجعة" ${complaint.status === 'قيد المراجعة' ? 'selected' : ''}>قيد المراجعة</option>
                            <option value="قيد المعالجة" ${complaint.status === 'قيد المعالجة' ? 'selected' : ''}>قيد المعالجة</option>
                            <option value="تم الرد" ${complaint.status === 'تم الرد' ? 'selected' : ''}>تم الرد</option>
                            <option value="مكتملة" ${complaint.status === 'مكتملة' ? 'selected' : ''}>مكتملة</option>
                        </select>
                        <div class="form-actions">
                            <button class="action-btn btn-status" onclick="updateStatus('${complaintId}')">
                                <i class="fas fa-check"></i>
                                تحديث الحالة
                            </button>
                            <button class="action-btn btn-secondary no-print" onclick="closeComplaintDetails()">
                                <i class="fas fa-times"></i>
                                إغلاق
                            </button>
                        </div>
                    </div>
                `;

                document.getElementById('complaintDetailsModal').style.display = 'flex';
                hideLoading();

                // تسجيل في سجل التدقيق
                await logAudit('عرض شكوى', `تم عرض الشكوى #${complaint.requestNumber}`);
            } catch (error) {
                console.error('Error viewing complaint:', error);
                showMessage('حدث خطأ في عرض التفاصيل', 'error');
                hideLoading();
            }
        }

        // ==================== إدراج رد جاهز ====================
        function insertQuickReply(reply) {
            const textarea = document.getElementById('replyMessage');
            const currentValue = textarea.value;
            textarea.value = currentValue ? currentValue + '\n\n' + reply : reply;
            textarea.focus();
        }

        // ==================== إرسال رد ====================
        async function sendReply() {
            const message = document.getElementById('replyMessage').value.trim();
            
            if (!message) {
                showMessage('يرجى كتابة رد قبل الإرسال', 'error');
                return;
            }

            try {
                showLoading();
                
                // إضافة الرد إلى مجموعة الردود
                await db.collection('complaints')
                    .doc(currentComplaintId)
                    .collection('responses')
                    .add({
                        message: message,
                        isAdmin: true,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        userId: currentUser.uid,
                        userName: currentUser.displayName || 'الإدارة'
                    });

                // تحديث حالة الشكوى
                await db.collection('complaints').doc(currentComplaintId).update({
                    status: 'تم الرد',
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });

                // تسجيل في سجل التدقيق مع تضمين الرد
                const complaintDoc = await db.collection('complaints').doc(currentComplaintId).get();
                const complaint = complaintDoc.data();
                await logAudit('إضافة رد', `تم الرد على الشكوى #${complaint.requestNumber} - الرد: "${message}"`);

                showMessage('تم إرسال الرد بنجاح');
                viewComplaintDetails(currentComplaintId);
                await loadComplaints();
            } catch (error) {
                console.error('Error sending reply:', error);
                showMessage('حدث خطأ في إرسال الرد', 'error');
                hideLoading();
            }
        }

        // ==================== حذف رد ====================
        async function deleteResponse(complaintId, responseId) {
            if (!confirm('هل أنت متأكد من حذف هذا الرد؟')) {
                return;
            }

            try {
                showLoading();
                
                // الحصول على بيانات الرد قبل حذفه
                const responseDoc = await db.collection('complaints')
                    .doc(complaintId)
                    .collection('responses')
                    .doc(responseId)
                    .get();
                
                const responseData = responseDoc.data();

                // حذف الرد
                await db.collection('complaints')
                    .doc(complaintId)
                    .collection('responses')
                    .doc(responseId)
                    .delete();

                // تسجيل في سجل التدقيق
                const complaintDoc = await db.collection('complaints').doc(complaintId).get();
                const complaint = complaintDoc.data();
                await logAudit('حذف رد', `تم حذف رد من الشكوى #${complaint.requestNumber} - الرد المحذوف: "${responseData.message}"`);

                showMessage('تم حذف الرد بنجاح');
                viewComplaintDetails(complaintId);
            } catch (error) {
                console.error('Error deleting response:', error);
                showMessage('حدث خطأ في حذف الرد', 'error');
                hideLoading();
            }
        }

        // ==================== تحديث حالة الشكوى ====================
        async function updateStatus(complaintId) {
            const newStatus = document.getElementById('newStatus').value;
            
            try {
                showLoading();
                
                const complaintDoc = await db.collection('complaints').doc(complaintId).get();
                const complaint = complaintDoc.data();
                const oldStatus = complaint.status;

                await db.collection('complaints').doc(complaintId).update({
                    status: newStatus,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });

                // تسجيل في سجل التدقيق
                await logAudit('تحديث حالة', `تم تحديث حالة الشكوى #${complaint.requestNumber} من "${oldStatus}" إلى "${newStatus}"`);

                showMessage('تم تحديث الحالة بنجاح');
                closeComplaintDetails();
                await loadComplaints();
            } catch (error) {
                console.error('Error updating status:', error);
                showMessage('حدث خطأ في تحديث الحالة', 'error');
                hideLoading();
            }
        }

        function updateComplaintStatus(complaintId) {
            viewComplaintDetails(complaintId);
        }

        function closeComplaintDetails() {
            document.getElementById('complaintDetailsModal').style.display = 'none';
            currentComplaintId = null;
        }

        // ==================== سجل التدقيق ====================
        async function logAudit(action, details, userEmail = null) {
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                const userData = userDoc.data();

                await db.collection('auditLogs').add({
                    action: action,
                    details: details,
                    userId: currentUser.uid,
                    userName: userData.name || currentUser.email,
                    userEmail: userEmail || currentUser.email,
                    userPassword: '********',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (error) {
                console.error('Error logging audit:', error);
            }
        }

        async function loadAuditLogs() {
            try {
                const snapshot = await db.collection('auditLogs')
                    .orderBy('timestamp', 'desc')
                    .limit(100)
                    .get();

                const tbody = document.getElementById('auditLogsBody');
                tbody.innerHTML = snapshot.docs.map(doc => {
                    const log = doc.data();
                    const date = log.timestamp ? new Date(log.timestamp.toDate()) : new Date();
                    
                    return `
                        <tr>
                            <td>${date.toLocaleString('ar-EG')}</td>
                            <td>${log.userName || log.userEmail}</td>
                            <td>${log.userPassword}</td>
                            <td><strong>${log.action}</strong></td>
                            <td>${log.details}</td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading audit logs:', error);
            }
        }

        // ==================== طباعة سجلات التدقيق ====================
        function printAuditLogs() {
            window.print();
        }

        // ==================== تصدير سجلات التدقيق ====================
        async function exportAuditLogs() {
            try {
                showLoading();
                const snapshot = await db.collection('auditLogs')
                    .orderBy('timestamp', 'desc')
                    .get();

                const logs = snapshot.docs.map(doc => {
                    const log = doc.data();
                    const date = log.timestamp ? new Date(log.timestamp.toDate()) : new Date();
                    
                    return {
                        'التاريخ والوقت': date.toLocaleString('ar-EG'),
                        'المستخدم': log.userName || log.userEmail,
                        'البريد الإلكتروني': log.userEmail,
                        'كلمة السر': log.userPassword,
                        'الإجراء': log.action,
                        'التفاصيل': log.details
                    };
                });

                const ws = XLSX.utils.json_to_sheet(logs);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'سجلات التدقيق');
                
                ws['!cols'] = [
                    { wch: 20 },
                    { wch: 20 },
                    { wch: 25 },
                    { wch: 15 },
                    { wch: 20 },
                    { wch: 50 }
                ];

                XLSX.writeFile(wb, `audit_logs_${new Date().toISOString().split('T')[0]}.xlsx`);
                
                showMessage('تم تصدير السجلات بنجاح');
                await logAudit('تصدير سجلات', 'تم تصدير سجلات التدقيق إلى Excel');
                hideLoading();
            } catch (error) {
                console.error('Error exporting audit logs:', error);
                showMessage('حدث خطأ في تصدير السجلات', 'error');
                hideLoading();
            }
        }

        // ==================== الفلترة والبحث ====================
        document.getElementById('searchComplaints')?.addEventListener('input', applyFilters);
        document.getElementById('filterDepartment')?.addEventListener('change', applyFilters);
        document.getElementById('filterStatus')?.addEventListener('change', applyFilters);
        document.getElementById('filterPriority')?.addEventListener('change', applyFilters);
        document.getElementById('filterDateFrom')?.addEventListener('change', applyFilters);
        document.getElementById('filterDateTo')?.addEventListener('change', applyFilters);

        function applyFilters() {
            const search = document.getElementById('searchComplaints').value.toLowerCase();
            const department = document.getElementById('filterDepartment').value;
            const status = document.getElementById('filterStatus').value;
            const priority = document.getElementById('filterPriority').value;
            const dateFrom = document.getElementById('filterDateFrom').value;
            const dateTo = document.getElementById('filterDateTo').value;

            filteredComplaints = allComplaints.filter(complaint => {
                const matchSearch = !search || 
                    complaint.name.toLowerCase().includes(search) ||
                    complaint.requestNumber.toString().includes(search) ||
                    complaint.nationalId.includes(search) ||
                    complaint.phone.includes(search);

                const matchDepartment = !department || complaint.department === department;
                const matchStatus = !status || complaint.status === status;
                const matchPriority = !priority || complaint.priority === priority;

                const complaintDate = new Date(complaint.timestamp?.toDate()).toISOString().split('T')[0];
                const matchDateFrom = !dateFrom || complaintDate >= dateFrom;
                const matchDateTo = !dateTo || complaintDate <= dateTo;

                return matchSearch && matchDepartment && matchStatus && matchPriority && matchDateFrom && matchDateTo;
            });

            currentPage = 1;
            displayComplaints();
        }

        // ==================== الترقيم ====================
        function updatePagination() {
            const totalPages = Math.ceil(filteredComplaints.length / complaintsPerPage);
            document.getElementById('pageInfo').textContent = `الصفحة ${currentPage} من ${totalPages}`;
            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = currentPage === totalPages;
        }

        function changePage(direction) {
            const totalPages = Math.ceil(filteredComplaints.length / complaintsPerPage);
            currentPage += direction;
            if (currentPage < 1) currentPage = 1;
            if (currentPage > totalPages) currentPage = totalPages;
            displayComplaints();
        }

        // ==================== تصدير Excel ====================
        async function exportToExcel() {
            try {
                showLoading();
                
                const data = filteredComplaints.map(complaint => ({
                    'رقم الشكوى': complaint.requestNumber,
                    'الاسم': complaint.name,
                    'الهاتف': complaint.phone,
                    'البريد الإلكتروني': complaint.email || '',
                    'الرقم القومي': complaint.nationalId,
                    'القسم': complaint.department,
                    'الحالة': complaint.status,
                    'الأولوية': complaint.priority,
                    'العنوان': complaint.address,
                    'التفاصيل': complaint.description,
                    'التاريخ': new Date(complaint.timestamp?.toDate()).toLocaleString('ar-EG')
                }));

                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'الشكاوى');

                ws['!cols'] = [
                    { wch: 15 },
                    { wch: 20 },
                    { wch: 15 },
                    { wch: 25 },
                    { wch: 15 },
                    { wch: 20 },
                    { wch: 15 },
                    { wch: 15 },
                    { wch: 30 },
                    { wch: 50 },
                    { wch: 20 }
                ];

                XLSX.writeFile(wb, `complaints_${new Date().toISOString().split('T')[0]}.xlsx`);
                
                showMessage('تم التصدير بنجاح');
                await logAudit('تصدير بيانات', `تم تصدير ${filteredComplaints.length} شكوى إلى Excel`);
                hideLoading();
            } catch (error) {
                console.error('Error exporting:', error);
                showMessage('حدث خطأ في التصدير', 'error');
                hideLoading();
            }
        }

        // ==================== تحميل الأقسام ====================
        async function loadDepartments() {
            try {
                const doc = await db.collection('settings').doc('departments').get();
                if (doc.exists) {
                    const departments = doc.data().list || [];
                    const select = document.getElementById('filterDepartment');
                    select.innerHTML = '<option value="">جميع الأقسام</option>';
                    departments.forEach(dept => {
                        const option = document.createElement('option');
                        option.value = dept;
                        option.textContent = dept;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading departments:', error);
            }
        }

        // ==================== تحميل المستخدمين ====================
        async function loadUsers() {
            try {
                const snapshot = await db.collection('users').get();
                const usersGrid = document.getElementById('usersGrid');
                
                usersGrid.innerHTML = snapshot.docs.map(doc => {
                    const user = doc.data();
                    return `
                        <div class="user-card">
                            <div class="user-card-header">
                                <div class="user-avatar">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="user-info">
                                    <h3>${user.name}</h3>
                                    <span class="user-role ${user.role === 'admin' ? 'admin' : ''}">${user.role === 'admin' ? 'مدير' : 'مستخدم'}</span>
                                    <div class="user-email">
                                        <i class="fas fa-envelope"></i>
                                        ${user.email}
                                    </div>
                                </div>
                            </div>
                            ${user.departments ? `
                                <div class="user-departments">
                                    <div class="user-departments-title">الأقسام المسموحة:</div>
                                    <div class="department-tags">
                                        ${user.departments.map(dept => `<span class="department-tag">${dept}</span>`).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        // ==================== إدارة المستخدمين ====================
        async function showAddUserModal() {
            try {
                const deptDoc = await db.collection('settings').doc('departments').get();
                const departments = deptDoc.exists ? deptDoc.data().list || [] : [];
                
                const deptCheckboxes = departments.map(dept => `
                    <label>
                        <input type="checkbox" value="${dept}">
                        ${dept}
                    </label>
                `).join('');
                
                document.getElementById('userDepartments').innerHTML = deptCheckboxes;
                document.getElementById('userFormTitle').textContent = 'إضافة مستخدم جديد';
                document.getElementById('userForm').reset();
                document.getElementById('userFormModal').style.display = 'flex';
                
                await logAudit('فتح نافذة', 'فتح نافذة إضافة مستخدم جديد');
            } catch (error) {
                console.error('Error showing add user modal:', error);
                showMessage('حدث خطأ في فتح النافذة', 'error');
            }
        }

        function closeUserModal() {
            document.getElementById('userFormModal').style.display = 'none';
            document.getElementById('userForm').reset();
        }

              async function saveUser() {
            const name = document.getElementById('userName').value.trim();
            const email = document.getElementById('userEmail').value.trim();
            const password = document.getElementById('userPassword').value;
            const role = document.getElementById('userRole').value;
            
            const selectedDepartments = Array.from(
                document.querySelectorAll('#userDepartments input[type="checkbox"]:checked')
            ).map(cb => cb.value);

            if (!name || !email) {
                showMessage('يرجى ملء جميع الحقول المطلوبة', 'error');
                return;
            }

            if (!password || password.length < 6) {
                showMessage('كلمة المرور يجب أن تكون 6 أحرف على الأقل', 'error');
                return;
            }

            try {
                showLoading();

                // حفظ المستخدم الحالي
                const currentUserTemp = auth.currentUser;

                // إنشاء المستخدم الجديد
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const userId = userCredential.user.uid;

                // حفظ بيانات المستخدم في Firestore
                await db.collection('users').doc(userId).set({
                    name: name,
                    email: email,
                    role: role,
                    departments: selectedDepartments,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: currentUser.uid
                });

                // تسجيل خروج المستخدم الجديد فوراً
                await auth.signOut();

                // إعادة تسجيل دخول المستخدم الأصلي
                await auth.signInWithEmailAndPassword(currentUserTemp.email, prompt('الرجاء إدخال كلمة مرورك لإكمال العملية:'));

                await logAudit('إضافة مستخدم', `تم إضافة مستخدم جديد: ${name} (${email}) - الدور: ${role}`);

                showMessage('تم إضافة المستخدم بنجاح');
                closeUserModal();
                await loadUsers();
                hideLoading();
            } catch (error) {
                console.error('Error saving user:', error);
                let errorMessage = 'حدث خطأ في إضافة المستخدم';
                
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'البريد الإلكتروني مستخدم بالفعل';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'البريد الإلكتروني غير صالح';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'كلمة المرور ضعيفة';
                }
                
                showMessage(errorMessage, 'error');
                hideLoading();
            }
        }


        // ==================== إدارة الأقسام ====================
        async function addDepartment() {
            const deptName = document.getElementById('newDepartmentName').value.trim();
            
            if (!deptName) {
                showMessage('يرجى كتابة اسم القسم', 'error');
                return;
            }

            try {
                showLoading();
                
                const deptDoc = await db.collection('settings').doc('departments').get();
                let departments = [];
                
                if (deptDoc.exists) {
                    departments = deptDoc.data().list || [];
                }
                
                if (departments.includes(deptName)) {
                    showMessage('القسم موجود بالفعل', 'error');
                    hideLoading();
                    return;
                }
                
                departments.push(deptName);
                
                await db.collection('settings').doc('departments').set({
                    list: departments,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });

                await logAudit('إضافة قسم', `تم إضافة قسم جديد: ${deptName}`);

                showMessage('تم إضافة القسم بنجاح');
                document.getElementById('newDepartmentName').value = '';
                await loadDepartmentsList();
                await loadDepartments();
                hideLoading();
            } catch (error) {
                console.error('Error adding department:', error);
                showMessage('حدث خطأ في إضافة القسم', 'error');
                hideLoading();
            }
        }

        async function loadDepartmentsList() {
            try {
                const doc = await db.collection('settings').doc('departments').get();
                if (doc.exists) {
                    const departments = doc.data().list || [];
                    const listDiv = document.getElementById('departmentsList');
                    
                    listDiv.innerHTML = departments.map(dept => `
                        <div class="department-item">
                            <span>${dept}</span>
                            <i class="fas fa-times delete-dept" onclick="deleteDepartment('${dept.replace(/'/g, "\\'")}')"></i>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading departments list:', error);
            }
        }

        async function deleteDepartment(deptName) {
            if (!confirm(`هل أنت متأكد من حذف القسم "${deptName}"؟`)) {
                return;
            }

            try {
                showLoading();
                
                const deptDoc = await db.collection('settings').doc('departments').get();
                let departments = deptDoc.data().list || [];
                
                departments = departments.filter(d => d !== deptName);
                
                await db.collection('settings').doc('departments').set({
                    list: departments,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });

                await logAudit('حذف قسم', `تم حذف القسم: ${deptName}`);

                showMessage('تم حذف القسم بنجاح');
                await loadDepartmentsList();
                await loadDepartments();
                hideLoading();
            } catch (error) {
                console.error('Error deleting department:', error);
                showMessage('حدث خطأ في حذف القسم', 'error');
                hideLoading();
            }
        }

        // ==================== النسخ الاحتياطي ====================
        async function createBackup() {
            try {
                showLoading();
                showMessage('جاري إنشاء النسخة الاحتياطية...');

                const complaintsSnapshot = await db.collection('complaints').get();
                const usersSnapshot = await db.collection('users').get();
                const settingsSnapshot = await db.collection('settings').get();
                const auditSnapshot = await db.collection('auditLogs').orderBy('timestamp', 'desc').limit(1000).get();

                const backup = {
                    version: '1.0',
                    timestamp: new Date().toISOString(),
                    complaints: [],
                    users: [],
                    settings: {},
                    auditLogs: []
                };

                for (const doc of complaintsSnapshot.docs) {
                    const complaint = { id: doc.id, ...doc.data() };
                    
                    const responsesSnapshot = await db.collection('complaints')
                        .doc(doc.id)
                        .collection('responses')
                        .get();
                    
                    complaint.responses = responsesSnapshot.docs.map(r => ({
                        id: r.id,
                        ...r.data()
                    }));
                    
                    backup.complaints.push(complaint);
                }

                backup.users = usersSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                settingsSnapshot.docs.forEach(doc => {
                    backup.settings[doc.id] = doc.data();
                });

                backup.auditLogs = auditSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                const jsonString = JSON.stringify(backup, (key, value) => {
                    if (value && value.toDate && typeof value.toDate === 'function') {
                        return value.toDate().toISOString();
                    }
                    return value;
                }, 2);

                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup_${new Date().toISOString().split('T')[0]}_${Date.now()}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                await logAudit('نسخ احتياطي', `تم إنشاء نسخة احتياطية تحتوي على ${backup.complaints.length} شكوى، ${backup.users.length} مستخدم، ${backup.auditLogs.length} سجل تدقيق`);

                showMessage('تم إنشاء النسخة الاحتياطية بنجاح');
                hideLoading();
            } catch (error) {
                console.error('Error creating backup:', error);
                showMessage('حدث خطأ في إنشاء النسخة الاحتياطية', 'error');
                hideLoading();
            }
        }

        // ==================== المستمعات الفورية ====================
        function startRealtimeListeners() {
            db.collection('complaints').onSnapshot(() => {
                loadComplaints();
            });
        }

        // ==================== التنقل بين الأقسام ====================
        document.querySelectorAll('.menu-item, .mobile-nav-item').forEach(item => {
            item.addEventListener('click', () => {
                const section = item.dataset.section;
                
                document.querySelectorAll('.menu-item').forEach(mi => mi.classList.remove('active'));
                document.querySelectorAll('.mobile-nav-item').forEach(mi => mi.classList.remove('active'));
                document.querySelectorAll('.content-section').forEach(cs => cs.classList.remove('active'));
                
                item.classList.add('active');
                document.querySelector(`.menu-item[data-section="${section}"]`)?.classList.add('active');
                document.querySelector(`.mobile-nav-item[data-section="${section}"]`)?.classList.add('active');
                document.getElementById(section + 'Section')?.classList.add('active');
                
                if (window.innerWidth <= 768) {
                    document.getElementById('sidebar').classList.remove('active');
                    document.getElementById('sidebarOverlay').style.display = 'none';
                }
            });
        });

        // ==================== القائمة الجانبية للموبايل ====================
        document.getElementById('mobileMenuBtn')?.addEventListener('click', () => {
            document.getElementById('sidebar').classList.add('active');
            document.getElementById('sidebarOverlay').style.display = 'block';
        });

        document.getElementById('closeSidebar')?.addEventListener('click', () => {
            document.getElementById('sidebar').classList.remove('active');
            document.getElementById('sidebarOverlay').style.display = 'none';
        });

        document.getElementById('sidebarOverlay')?.addEventListener('click', () => {
            document.getElementById('sidebar').classList.remove('active');
            document.getElementById('sidebarOverlay').style.display = 'none';
        });

        // ==================== تسجيل الخروج ====================
        document.getElementById('logoutBtn')?.addEventListener('click', async () => {
            if (confirm('هل تريد تسجيل الخروج؟')) {
                try {
                    await logAudit('تسجيل خروج', 'تم تسجيل الخروج من النظام');
                    await auth.signOut();
                    window.location.href = 'admin-login.html';
                } catch (error) {
                    console.error('Error logging out:', error);
                    showMessage('حدث خطأ في تسجيل الخروج', 'error');
                }
            }
        });

        // ==================== وظائف مساعدة ====================
        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function showMessage(msg, type = 'success') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = msg;
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }

        function generateDailyReport() {
            showMessage('جاري إنشاء التقرير...');
        }

        function requestNotificationPermission() {
            if ('Notification' in window) {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        showMessage('تم تفعيل الإشعارات');
                    }
                });
            }
        }
    </script>
</body>
</html>
