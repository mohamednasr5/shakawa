<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>لوحة التحكم - نظام الشكاوى الموحد</title>
    <link rel="manifest" href="manifest-admin.json">
    <meta name="theme-color" content="#1a5fb4">
    <meta name="mobile-web-app-capable" content="yes">
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ==================== CSS Styles (Full Original Design) ==================== */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Cairo', sans-serif; -webkit-tap-highlight-color: transparent; }
        html { font-size: 16px; scroll-behavior: smooth; }
        body { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); color: #333; min-height: 100vh; padding-bottom: 80px; }
        
        /* Utility Classes */
        .hidden { display: none !important; }
        .show { display: block !important; }
        
        /* Login Styles */
        .login-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, #1a5fb4 0%, #2d8fd5 100%); }
        .login-box { background: #fff; border-radius: 20px; padding: 40px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,.2); }
        .login-logo { font-size: 3rem; color: #1a5fb4; margin-bottom: 20px; }
        .form-control { width: 100%; padding: 15px; margin-bottom: 15px; border: 2px solid #ddd; border-radius: 10px; font-size: 1rem; }
        .login-btn { width: 100%; padding: 15px; background: #1a5fb4; color: #fff; border: none; border-radius: 10px; font-size: 1.1rem; cursor: pointer; }

        /* Dashboard Layout */
        header { background: linear-gradient(135deg, #1a5fb4 0%, #2d8fd5 100%); color: #fff; padding: 20px; text-align: center; border-radius: 0 0 30px 30px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .container { max-width: 1400px; margin: 0 auto; padding: 10px; }
        
        /* Admin Stats Bar */
        .admin-bar { background: #2c3e50; color: #fff; padding: 20px; border-radius: 15px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; margin-bottom: 20px; }
        .admin-info { display: flex; align-items: center; gap: 15px; }
        .admin-avatar { width: 50px; height: 50px; background: #3498db; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
        .admin-stats { display: flex; gap: 20px; text-align: center; }
        .stat-item h3 { font-size: 1.5rem; margin: 0; color: #3498db; }
        .stat-item span { font-size: 0.8rem; opacity: 0.8; }

        /* Grid Layout */
        .dashboard-layout { display: grid; grid-template-columns: 280px 1fr; gap: 20px; }
        
        /* Sidebar */
        .sidebar { background: #fff; padding: 20px; border-radius: 15px; height: fit-content; position: sticky; top: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .menu-item { padding: 15px; margin-bottom: 10px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; gap: 10px; color: #555; transition: .3s; }
        .menu-item:hover, .menu-item.active { background: #e3f2fd; color: #1a5fb4; font-weight: bold; }
        .menu-item i { width: 25px; text-align: center; }
        
        /* Cards */
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: #fff; padding: 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border-bottom: 4px solid transparent; }
        .card.blue { border-color: #3498db; }
        .card.green { border-color: #2ecc71; }
        .card.orange { border-color: #f39c12; }
        .card-icon { font-size: 2.5rem; margin-bottom: 15px; color: #1a5fb4; }
        .card-value { font-size: 2rem; font-weight: bold; }

        /* Tables */
        .table-responsive { overflow-x: auto; background: #fff; border-radius: 15px; padding: 5px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { background: #f8f9fa; padding: 15px; text-align: right; color: #1a5fb4; font-weight: bold; }
        td { padding: 15px; border-bottom: 1px solid #eee; }
        tr.unread { background-color: #fff8e1; font-weight: bold; }

        /* Buttons & Actions */
        .btn { padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; color: #fff; display: inline-flex; align-items: center; gap: 5px; font-size: 0.9rem; }
        .btn-view { background: #3498db; }
        .btn-pdf { background: #6c757d; }
        .btn-del { background: #e74c3c; }
        .btn-edit { background: #f39c12; }
        .btn-add { background: #27ae60; width: 100%; justify-content: center; padding: 12px; margin-top: 10px; }

        /* Badges */
        .status-badge { padding: 5px 10px; border-radius: 15px; font-size: 0.8rem; }
        .status-new { background: #e3f2fd; color: #1565c0; }
        .status-pending { background: #fff3e0; color: #e67e22; }
        .status-done { background: #e8f5e9; color: #2ecc71; }
        .notification-dot { width: 10px; height: 10px; background: #e74c3c; border-radius: 50%; display: inline-block; margin-left: 5px; }

        /* Modal */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: #fff; width: 95%; max-width: 800px; max-height: 90vh; overflow-y: auto; border-radius: 20px; animation: slideUp 0.3s; }
        .modal-header { background: #1a5fb4; color: #fff; padding: 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; }
        .modal-body { padding: 20px; }
        
        /* Chat/Response System */
        .responses-area { background: #f8f9fa; border: 1px solid #eee; padding: 15px; border-radius: 10px; margin-top: 20px; max-height: 300px; overflow-y: auto; }
        .response-msg { padding: 10px; margin-bottom: 10px; border-radius: 8px; max-width: 85%; }
        .msg-admin { background: #d1e7dd; margin-right: auto; border-right: 4px solid #198754; }
        .msg-user { background: #e2e3e5; margin-left: auto; border-left: 4px solid #6c757d; }
        .reply-box { margin-top: 15px; display: flex; gap: 10px; }
        .reply-input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .dashboard-layout { grid-template-columns: 1fr; }
            .sidebar { display: none; } /* Hide sidebar on mobile, use bottom nav */
            .admin-bar { flex-direction: column; text-align: center; }
            .admin-stats { width: 100%; justify-content: space-around; }
        }
        
        /* Bottom Nav for Mobile */
        .mobile-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: #fff; border-top: 1px solid #ddd; display: none; justify-content: space-around; padding: 10px; z-index: 999; }
        .nav-icon { text-align: center; color: #666; font-size: 0.8rem; }
        .nav-icon i { display: block; font-size: 1.2rem; margin-bottom: 2px; }
        .nav-icon.active { color: #1a5fb4; }
        @media (max-width: 768px) { .mobile-nav { display: flex; } }
        
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>

    <div id="loading" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#fff;z-index:9999;display:flex;justify-content:center;align-items:center;">
        <i class="fas fa-circle-notch fa-spin fa-3x" style="color:#1a5fb4"></i>
    </div>

    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <div class="login-logo"><i class="fas fa-user-shield"></i></div>
            <h2>تسجيل دخول المسؤول</h2>
            <br>
            <form id="loginForm">
                <input type="text" id="username" class="form-control" placeholder="اسم المستخدم" required>
                <input type="password" id="password" class="form-control" placeholder="كلمة المرور" required>
                <div id="loginError" style="color:red;display:none;margin-bottom:10px;">بيانات الدخول غير صحيحة</div>
                <button type="submit" class="login-btn">دخول</button>
            </form>
        </div>
    </div>

    <div id="dashboardScreen" class="hidden">
        <header>
            <div class="container">
                <h1>نظام الشكاوى الموحد</h1>
                <p>لوحة تحكم الإدارة والمتابعة</p>
            </div>
        </header>

        <div class="container">
            <div class="admin-bar">
                <div class="admin-info">
                    <div class="admin-avatar"><i class="fas fa-user"></i></div>
                    <div>
                        <h3 id="adminNameDisplay">المسؤول</h3>
                        <small id="lastLoginTime">آخر دخول: الان</small>
                    </div>
                </div>
                <div class="admin-stats">
                    <div class="stat-item">
                        <h3 id="statTotal">0</h3>
                        <span>الكل</span>
                    </div>
                    <div class="stat-item">
                        <h3 id="statNew" style="color:#e74c3c">0</h3>
                        <span>جديدة</span>
                    </div>
                </div>
                <button onclick="logout()" class="btn btn-del"><i class="fas fa-sign-out-alt"></i> خروج</button>
            </div>

            <div class="dashboard-layout">
                <div class="sidebar">
                    <div class="menu-item active" onclick="switchTab('dashboard')">
                        <i class="fas fa-chart-pie"></i> لوحة المعلومات
                    </div>
                    <div class="menu-item" onclick="switchTab('complaints')">
                        <i class="fas fa-file-alt"></i> إدارة الشكاوى
                        <span id="badgeNew" class="notification-dot hidden"></span>
                    </div>
                    <div class="menu-item" onclick="switchTab('users')">
                        <i class="fas fa-users-cog"></i> المستخدمين
                    </div>
                    <div class="menu-item" onclick="switchTab('settings')">
                        <i class="fas fa-cogs"></i> الإعدادات
                    </div>
                    <div class="menu-item" onclick="switchTab('departments')">
                        <i class="fas fa-building"></i> الأقسام
                    </div>
                </div>

                <div class="content-area">
                    
                    <div id="tab-dashboard" class="content-section">
                        <div class="cards-grid">
                            <div class="card blue">
                                <div class="card-icon"><i class="fas fa-inbox"></i></div>
                                <div class="card-value" id="cardNew">0</div>
                                <p>شكاوى جديدة</p>
                            </div>
                            <div class="card orange">
                                <div class="card-icon"><i class="fas fa-spinner"></i></div>
                                <div class="card-value" id="cardPending">0</div>
                                <p>قيد المعالجة</p>
                            </div>
                            <div class="card green">
                                <div class="card-icon"><i class="fas fa-check-circle"></i></div>
                                <div class="card-value" id="cardDone">0</div>
                                <p>تم الحل</p>
                            </div>
                        </div>
                        <h3>أحدث 5 شكاوى</h3>
                        <div class="table-responsive">
                            <table id="latestTable">
                                </table>
                        </div>
                    </div>

                    <div id="tab-complaints" class="content-section hidden">
                        <div style="display:flex; justify-content:space-between; margin-bottom:15px; flex-wrap:wrap; gap:10px;">
                            <input type="text" id="searchInput" class="form-control" style="width:auto; margin:0;" placeholder="بحث (الاسم، الرقم...)">
                            <button onclick="exportToExcel()" class="btn btn-add" style="width:auto; margin:0;"><i class="fas fa-file-excel"></i> تصدير Excel</button>
                        </div>
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>رقم الشكوى</th>
                                        <th>الاسم</th>
                                        <th>القسم</th>
                                        <th>الحالة</th>
                                        <th>التاريخ</th>
                                        <th>تحكم</th>
                                    </tr>
                                </thead>
                                <tbody id="complaintsTableBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <div id="tab-users" class="content-section hidden">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <h3>إدارة المسؤولين</h3>
                            <button onclick="openUserModal()" class="btn btn-add" style="width:auto;">+ إضافة مستخدم</button>
                        </div>
                        <div class="cards-grid" id="usersGrid" style="margin-top:20px;">
                            </div>
                    </div>

                    <div id="tab-settings" class="content-section hidden">
                        <div class="card">
                            <h3><i class="fas fa-bell"></i> إعدادات الإشعارات</h3>
                            <p>تفعيل الإشعارات لاستلام تنبيهات عند ورود شكوى جديدة.</p>
                            <button onclick="requestNotificationPermission()" class="btn btn-view" style="margin-top:10px;">تفعيل الإشعارات الآن</button>
                        </div>
                        <div class="card" style="margin-top:20px;">
                            <h3><i class="fas fa-info-circle"></i> معلومات النظام</h3>
                            <div class="form-group" style="margin-top:10px;">
                                <label>اسم النظام</label>
                                <input type="text" id="sysName" class="form-control" value="نظام الشكاوى الموحد">
                            </div>
                            <button onclick="alert('تم الحفظ')" class="btn btn-view">حفظ التغييرات</button>
                        </div>
                    </div>

                    <div id="tab-departments" class="content-section hidden">
                        <h3>الأقسام المتاحة</h3>
                        <div style="display:flex; gap:10px; margin-bottom:20px;">
                            <input type="text" id="newDeptInput" class="form-control" placeholder="اسم القسم الجديد" style="margin:0;">
                            <button onclick="addDepartment()" class="btn btn-add" style="width:auto; margin:0;">إضافة</button>
                        </div>
                        <div id="deptList" style="display:flex; flex-wrap:wrap; gap:10px;">
                            </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <div class="mobile-nav">
        <div class="nav-icon active" onclick="switchTab('dashboard')"><i class="fas fa-home"></i> الرئيسية</div>
        <div class="nav-icon" onclick="switchTab('complaints')"><i class="fas fa-file-alt"></i> الشكاوى</div>
        <div class="nav-icon" onclick="switchTab('users')"><i class="fas fa-users"></i> المستخدمين</div>
        <div class="nav-icon" onclick="switchTab('settings')"><i class="fas fa-cog"></i> الإعدادات</div>
    </div>

    <div id="complaintModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>تفاصيل الشكوى</h3>
                <button onclick="closeModal()" style="background:none; border:none; color:#fff; font-size:1.5rem;"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" id="modalContent">
                </div>
        </div>
    </div>

    <div id="userModal" class="modal">
        <div class="modal-content" style="max-width:500px;">
            <div class="modal-header">
                <h3>بيانات المستخدم</h3>
                <button onclick="document.getElementById('userModal').style.display='none'" style="background:none; border:none; color:#fff;"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <input type="text" id="formName" class="form-control" placeholder="الاسم">
                <input type="text" id="formUser" class="form-control" placeholder="اسم المستخدم (للدخول)">
                <input type="password" id="formPass" class="form-control" placeholder="كلمة المرور">
                <select id="formRole" class="form-control">
                    <option value="admin">مدير كامل الصلاحيات</option>
                    <option value="user">موظف (مشاهدة فقط)</option>
                </select>
                <button onclick="saveUser()" class="btn btn-add">حفظ المستخدم</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBIIStbiZD0ZJ6su7C1bwZlBvqx-PP-t58",
            authDomain: "shakawa-e0a3c.firebaseapp.com",
            databaseURL: "https://shakawa-e0a3c-default-rtdb.firebaseio.com",
            projectId: "shakawa-e0a3c",
            storageBucket: "shakawa-e0a3c.firebasestorage.app",
            messagingSenderId: "111620348664",
            appId: "1:111620348664:web:670fdf5caed46eb691b90d",
            measurementId: "G-SGNTJZDQ1L"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let allComplaints = [];
        let allUsers = [];
        let allDepts = [];
        let currentUser = null;
        let currentComplaintId = null;

        // --- Utility ---
        const escapeHtml = (text) => {
            if (!text) return text;
            return text.toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        };

        const formatDate = (date) => new Date(date).toLocaleString('ar-EG');

        // --- Auth ---
        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            
            // Hardcoded Admin + DB check simulation
            if (u === 'admin' && p === '742018') {
                loginSuccess({ name: 'المكتب الخدمي', role: 'admin' });
                return;
            }
            
            // Check in loaded users (Real scenario should be server-side or Auth)
            const userFound = allUsers.find(user => user.username === u && user.password === p);
            if(userFound) {
                loginSuccess(userFound);
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        });

        function loginSuccess(user) {
            currentUser = user;
            localStorage.setItem('shakawa_user', JSON.stringify(user));
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('dashboardScreen').classList.remove('hidden');
            document.getElementById('adminNameDisplay').textContent = user.name;
            initApp();
        }

        function logout() {
            localStorage.removeItem('shakawa_user');
            location.reload();
        }

        // --- Initialization ---
        window.onload = () => {
            document.getElementById('loading').style.display = 'none';
            // Pre-fetch users for login check
            database.ref('users').once('value', snap => {
                if(snap.val()) {
                    allUsers = Object.keys(snap.val()).map(k => ({key: k, ...snap.val()[k]}));
                }
                const savedUser = localStorage.getItem('shakawa_user');
                if (savedUser) {
                    loginSuccess(JSON.parse(savedUser));
                }
            });
        };

        function initApp() {
            loadComplaints();
            loadDepartments();
            renderUsers();
            
            // Notification Request
            if (Notification.permission === 'default') {
                setTimeout(requestNotificationPermission, 3000);
            }
        }

        // --- Realtime Data Loading ---
        function loadComplaints() {
            database.ref('complaints').on('value', (snapshot) => {
                const data = snapshot.val();
                allComplaints = [];
                if (data) {
                    Object.keys(data).forEach(key => {
                        allComplaints.push({ key, ...data[key] });
                    });
                    // Sort Newest First
                    allComplaints.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                }
                updateDashboard();
                renderComplaintsTable();
                checkForNewComplaints();
            });
        }

        // --- Rendering ---
        function updateDashboard() {
            // Stats
            document.getElementById('statTotal').textContent = allComplaints.length;
            const newC = allComplaints.filter(c => c.status === 'جديدة').length;
            document.getElementById('statNew').textContent = newC;
            document.getElementById('cardNew').textContent = newC;
            document.getElementById('cardPending').textContent = allComplaints.filter(c => c.status === 'قيد المعالجة').length;
            document.getElementById('cardDone').textContent = allComplaints.filter(c => c.status === 'مكتملة' || c.status === 'تم الرد').length;

            // Badge
            const badge = document.getElementById('badgeNew');
            if (newC > 0) badge.classList.remove('hidden');
            else badge.classList.add('hidden');

            // Latest Table
            const latest = allComplaints.slice(0, 5);
            let html = '';
            latest.forEach(c => {
                html += `<tr>
                    <td>${escapeHtml(c.fullName)}</td>
                    <td>${escapeHtml(c.department)}</td>
                    <td><span class="status-badge ${getStatusClass(c.status)}">${escapeHtml(c.status)}</span></td>
                </tr>`;
            });
            document.getElementById('latestTable').innerHTML = html || '<p style="padding:10px">لا توجد بيانات</p>';
        }

        function renderComplaintsTable(filterText = '') {
            const tbody = document.getElementById('complaintsTableBody');
            tbody.innerHTML = '';
            
            const filtered = allComplaints.filter(c => 
                (c.fullName && c.fullName.includes(filterText)) || 
                (c.complaintNumber && c.complaintNumber.includes(filterText)) ||
                (c.nationalId && c.nationalId.includes(filterText))
            );

            filtered.forEach(c => {
                const tr = document.createElement('tr');
                if (c.status === 'جديدة') tr.classList.add('unread');
                
                tr.innerHTML = `
                    <td>${escapeHtml(c.complaintNumber)}</td>
                    <td>${escapeHtml(c.fullName)}</td>
                    <td>${escapeHtml(c.department)}</td>
                    <td><span class="status-badge ${getStatusClass(c.status)}">${escapeHtml(c.status)}</span></td>
                    <td>${formatDate(c.createdAt)}</td>
                    <td>
                        <button class="btn btn-view" onclick="openComplaint('${c.key}')"><i class="fas fa-eye"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        document.getElementById('searchInput').addEventListener('input', (e) => {
            renderComplaintsTable(e.target.value);
        });

        function getStatusClass(s) {
            if (s === 'جديدة') return 'status-new';
            if (s === 'مكتملة' || s === 'تم الرد') return 'status-done';
            return 'status-pending';
        }

        // --- Detailed Modal & Responses ---
        function openComplaint(key) {
            currentComplaintId = key;
            const c = allComplaints.find(x => x.key === key);
            if (!c) return;

            // Generate QR
            const link = `https://mohamednasr5.github.io/shakawa/?id=${c.complaintNumber}`;
            const qr = `https://chart.googleapis.com/chart?cht=qr&chs=100x100&chl=${encodeURIComponent(link)}&choe=UTF-8`;

            let responsesHtml = '';
            if (c.responses) {
                Object.values(c.responses).forEach(r => {
                    const typeClass = r.senderRole === 'admin' ? 'msg-admin' : 'msg-user';
                    responsesHtml += `
                        <div class="response-msg ${typeClass}">
                            <small><b>${r.senderName}</b> - ${formatDate(r.timestamp)}</small>
                            <div>${escapeHtml(r.message)}</div>
                        </div>
                    `;
                });
            } else {
                responsesHtml = '<p style="color:#999;text-align:center">لا توجد ردود سابقة</p>';
            }

            const html = `
                <div style="display:flex; justify-content:space-between; align-items:start; flex-wrap:wrap;">
                    <div>
                        <h4>بيانات الشاكي</h4>
                        <p><b>الاسم:</b> ${escapeHtml(c.fullName)}</p>
                        <p><b>الرقم القومي:</b> ${escapeHtml(c.nationalId)}</p>
                        <p><b>الهاتف:</b> <a href="tel:${c.phone1}">${escapeHtml(c.phone1)}</a></p>
                        <p><b>القسم:</b> ${escapeHtml(c.department)}</p>
                    </div>
                    <div style="text-align:center;">
                        <img src="${qr}" style="border:1px solid #ddd; padding:5px;">
                        <br><small>رقم: ${c.complaintNumber}</small>
                    </div>
                </div>
                <hr style="margin:15px 0; border:0; border-top:1px solid #eee;">
                <h4>تفاصيل الشكوى</h4>
                <div style="background:#f9f9f9; padding:15px; border-radius:10px; border:1px solid #eee;">
                    ${escapeHtml(c.problemDetails)}
                </div>

                <div style="margin-top:20px;">
                    <h4>تحديث الحالة</h4>
                    <select id="updateStatusSelect" class="form-control" style="width:auto; display:inline-block;">
                        <option value="جديدة" ${c.status==='جديدة'?'selected':''}>جديدة</option>
                        <option value="قيد المعالجة" ${c.status==='قيد المعالجة'?'selected':''}>قيد المعالجة</option>
                        <option value="تم الرد" ${c.status==='تم الرد'?'selected':''}>تم الرد</option>
                        <option value="مكتملة" ${c.status==='مكتملة'?'selected':''}>مكتملة</option>
                    </select>
                    <button onclick="updateStatus()" class="btn btn-edit">حفظ الحالة</button>
                    <button onclick="printPDF('${c.key}')" class="btn btn-pdf"><i class="fas fa-print"></i> طباعة PDF</button>
                    <button onclick="deleteComplaint('${c.key}')" class="btn btn-del"><i class="fas fa-trash"></i> حذف</button>
                </div>

                <hr>
                <h4>الردود والمتابعة</h4>
                <div class="responses-area">
                    ${responsesHtml}
                </div>
                <div class="reply-box">
                    <input type="text" id="replyText" class="reply-input" placeholder="اكتب ردك هنا...">
                    <button onclick="sendReply()" class="btn btn-view"><i class="fas fa-paper-plane"></i></button>
                </div>
            `;

            document.getElementById('modalContent').innerHTML = html;
            document.getElementById('complaintModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('complaintModal').style.display = 'none';
            currentComplaintId = null;
        }

        // --- Actions Logic ---
        function updateStatus() {
            const newStatus = document.getElementById('updateStatusSelect').value;
            database.ref('complaints/' + currentComplaintId).update({
                status: newStatus,
                updatedAt: new Date().toISOString()
            }).then(() => alert('تم تحديث الحالة'));
        }

        function sendReply() {
            const text = document.getElementById('replyText').value;
            if (!text) return;

            const replyData = {
                message: text,
                senderName: currentUser.name,
                senderRole: currentUser.role,
                timestamp: new Date().toISOString()
            };

            database.ref(`complaints/${currentComplaintId}/responses`).push(replyData)
                .then(() => {
                    database.ref(`complaints/${currentComplaintId}`).update({ status: 'تم الرد' });
                    openComplaint(currentComplaintId); // Refresh modal
                });
        }

        function deleteComplaint(key) {
            if (confirm('هل أنت متأكد من الحذف النهائي؟')) {
                database.ref('complaints/' + key).remove();
                closeModal();
            }
        }

        // --- Users Management ---
        function renderUsers() {
            const container = document.getElementById('usersGrid');
            container.innerHTML = '';
            
            // Render Hardcoded Admin Card
            let html = `
                <div class="card blue">
                    <h4>المكتب الخدمي (Admin)</h4>
                    <p>مدير النظام</p>
                </div>
            `;

            // Render DB Users
            allUsers.forEach(u => {
                html += `
                    <div class="card">
                        <div style="display:flex;justify-content:space-between">
                            <h4>${escapeHtml(u.name)}</h4>
                            <button onclick="deleteUser('${u.key}')" style="color:red;border:none;background:none;cursor:pointer">X</button>
                        </div>
                        <p>${u.role === 'admin' ? 'مدير' : 'موظف'}</p>
                        <small>User: ${escapeHtml(u.username)}</small>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function openUserModal() { document.getElementById('userModal').style.display = 'flex'; }
        
        function saveUser() {
            const name = document.getElementById('formName').value;
            const username = document.getElementById('formUser').value;
            const pass = document.getElementById('formPass').value;
            const role = document.getElementById('formRole').value;

            if (name && username && pass) {
                database.ref('users').push({
                    name: name,
                    username: username,
                    password: pass,
                    role: role
                }).then(() => {
                    document.getElementById('userModal').style.display = 'none';
                    alert('تم إضافة المستخدم');
                    // Refresh handled by listener ideally, or reload page
                    location.reload(); 
                });
            }
        }

        function deleteUser(key) {
            if(confirm('حذف المستخدم؟')) {
                database.ref('users/' + key).remove().then(() => location.reload());
            }
        }

        // --- Departments ---
        function loadDepartments() {
            database.ref('departments').on('value', snap => {
                const div = document.getElementById('deptList');
                div.innerHTML = '';
                if(snap.val()) {
                    Object.keys(snap.val()).forEach(k => {
                        const dName = snap.val()[k];
                        div.innerHTML += `
                            <div style="background:#f1f1f1; padding:10px; border-radius:5px; display:flex; align-items:center; gap:10px;">
                                ${escapeHtml(dName)}
                                <i class="fas fa-times" style="color:red; cursor:pointer" onclick="removeDept('${k}')"></i>
                            </div>
                        `;
                    });
                }
            });
        }

        function addDepartment() {
            const val = document.getElementById('newDeptInput').value;
            if(val) {
                database.ref('departments').push(val);
                document.getElementById('newDeptInput').value = '';
            }
        }

        function removeDept(key) {
            if(confirm('حذف القسم؟')) database.ref('departments/'+key).remove();
        }

        // --- PDF & Excel ---
        function printPDF(key) {
            const c = allComplaints.find(x => x.key === key);
            if(!c) return;

            const win = window.open('', '_blank');
            if(!win) return alert('اسمح بالنوافذ المنبثقة');
            
            win.document.write(`
                <html dir="rtl">
                <head><title>تقرير ${c.complaintNumber}</title>
                <style>body{font-family:'Arial';padding:20px;text-align:right} .line{margin-bottom:10px;border-bottom:1px solid #ccc;padding:5px} label{font-weight:bold;color:#333;width:150px;display:inline-block}</style>
                </head>
                <body>
                    <h2 style="text-align:center">تقرير شكوى رقم ${c.complaintNumber}</h2>
                    <div class="line"><label>الاسم:</label> ${c.fullName}</div>
                    <div class="line"><label>الرقم القومي:</label> ${c.nationalId}</div>
                    <div class="line"><label>القسم:</label> ${c.department}</div>
                    <div class="line"><label>التاريخ:</label> ${formatDate(c.createdAt)}</div>
                    <div class="line"><label>الحالة:</label> ${c.status}</div>
                    <h3>التفاصيل:</h3>
                    <p style="border:1px solid #000;padding:10px">${c.problemDetails}</p>
                    <script>window.print()<\/script>
                </body></html>
            `);
            win.document.close();
        }

        function exportToExcel() {
            const rows = allComplaints.map(c => ({
                "رقم الشكوى": c.complaintNumber,
                "الاسم": c.fullName,
                "الرقم القومي": c.nationalId,
                "القسم": c.department,
                "الهاتف": c.phone1,
                "التفاصيل": c.problemDetails,
                "الحالة": c.status,
                "تاريخ الطلب": formatDate(c.createdAt)
            }));
            const ws = XLSX.utils.json_to_sheet(rows);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "الشكاوى");
            XLSX.writeFile(wb, "تقرير_الشكاوى.xlsx");
        }

        // --- Notifications ---
        function requestNotificationPermission() {
            Notification.requestPermission().then(perm => {
                if (perm === 'granted') alert('تم تفعيل الإشعارات');
            });
        }

        function checkForNewComplaints() {
            const lastId = localStorage.getItem('last_complaint_id');
            const newest = allComplaints[0];
            if (newest && newest.key !== lastId && Notification.permission === "granted") {
                new Notification("شكوى جديدة", { body: `من: ${newest.fullName} - ${newest.department}` });
                localStorage.setItem('last_complaint_id', newest.key);
                const sound = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3'); 
                sound.play().catch(e=>console.log(e));
            }
        }

        // --- Tabs Navigation ---
        window.switchTab = function(tabName) {
            document.querySelectorAll('.content-section').forEach(el => el.classList.add('hidden'));
            document.getElementById('tab-' + tabName).classList.remove('hidden');
            
            // Update Active Menu
            document.querySelectorAll('.menu-item, .nav-icon').forEach(el => el.classList.remove('active'));
            // Simple logic for active classes
        }
    </script>
</body>
</html>
