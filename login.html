<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>تسجيل دخول المسؤول - نظام الشكاوى الموحد</title>
    
    <link rel="manifest" href="manifest-admin.json">
    <meta name="theme-color" content="#1a5fb4">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="إدارة الشكاوى">
    
    <style>
        /* خط Cairo من Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap');
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="icon" type="image/png" href="icon-192x192.png">
    <link rel="apple-touch-icon" href="icon-512x512.png">
    
    <style>
        /* ==================== أنماط CSS الرئيسية ==================== */
        *{box-sizing:border-box;margin:0;padding:0;font-family:'Cairo',sans-serif;-webkit-tap-highlight-color:transparent}
        html{font-size:16px;scroll-behavior:smooth}
        body{background:linear-gradient(135deg,#1a5fb4 0%,#2d8fd5 100%);color:#fff;line-height:1.6;min-height:100vh;overflow-x:hidden;padding:20px}
        
        /* أنماط تسجيل الدخول */
        .login-container{display:flex;justify-content:center;align-items:center;min-height:calc(100vh - 40px)}
        .login-box{background:#fff;border-radius:20px;padding:40px 35px;width:100%;max-width:450px;box-shadow:0 20px 40px rgba(0,0,0,.3);text-align:center;animation:slideUp .5s ease}
        @keyframes slideUp{from{opacity:0;transform:translateY(50px)}to{opacity:1;transform:translateY(0)}}
        .login-logo{font-size:4rem;color:#1a5fb4;margin-bottom:20px}
        .login-title{font-size:1.8rem;color:#2c3e50;margin-bottom:30px;font-weight:700}
        .login-subtitle{color:#666;margin-bottom:35px;font-size:1rem;line-height:1.5}
        .login-form .form-group{margin-bottom:25px;text-align:right}
        .login-form .form-label{display:block;margin-bottom:10px;font-weight:600;color:#2c3e50;font-size:1.1rem}
        .login-form .form-control{width:100%;padding:18px 20px;border:2px solid #ddd;border-radius:12px;font-size:16px;transition:all .3s;background:#f8f9fa;color:#333}
        .login-form .form-control:focus{border-color:#1a5fb4;outline:none;box-shadow:0 0 0 3px rgba(26,95,180,.1);background:#fff}
        .login-btn{width:100%;padding:20px;background:linear-gradient(to right,#1a5fb4,#2d8fd5);color:#fff;border:none;border-radius:12px;font-size:18px;font-weight:700;cursor:pointer;transition:all .3s;display:flex;align-items:center;justify-content:center;gap:10px;margin-top:15px}
        .login-btn:hover{background:linear-gradient(to right,#155093,#1a5fb4);transform:translateY(-2px);box-shadow:0 10px 20px rgba(0,0,0,.15)}
        .login-error{color:#e74c3c;margin-top:20px;padding:15px;background:#fde8e8;border-radius:10px;display:none;font-size:1rem}
        .login-footer{color:#666;font-size:.9rem;margin-top:30px;padding-top:20px;border-top:1px solid #eee}
        .login-footer a{color:#1a5fb4;text-decoration:none;font-weight:600}
        .login-footer a:hover{text-decoration:underline}
        
        /* نافذة التحميل */
        .loading-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,.9);display:none;justify-content:center;align-items:center;z-index:9999}
        .loading-spinner{width:60px;height:60px;border:5px solid #f3f3f3;border-top:5px solid #1a5fb4;border-radius:50%;animation:spin 1s linear infinite}
        @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
        
        /* الرسائل */
        .message{position:fixed;top:20px;right:20px;padding:15px 20px;border-radius:12px;z-index:10000;box-shadow:0 10px 30px rgba(0,0,0,.2);max-width:90%;animation:slideInMessage .3s ease;font-size:.95rem;line-height:1.5;background:#d4edda;color:#155724}
        .message.error{background:#f8d7da;color:#721c24}
        @keyframes slideInMessage{from{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:translateY(0)}}
        
        /* الهيدر */
        .header{text-align:center;margin-bottom:40px}
        .header h1{font-size:2rem;margin-bottom:10px;text-shadow:2px 2px 4px rgba(0,0,0,.2)}
        .header p{opacity:.9;max-width:600px;margin:0 auto}
        
        /* إشعارات PWA */
        .pwa-notification{position:fixed;top:20px;right:20px;padding:15px 20px;border-radius:12px;color:white;font-weight:bold;z-index:10000;box-shadow:0 4px 15px rgba(0,0,0,0.2);max-width:400px;animation:slideIn 0.3s ease;display:none}
        @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
        @keyframes slideOut{from{transform:translateX(0);opacity:1}to{transform:translateX(100%);opacity:0}}
        
        /* استجابة للشاشات */
        @media (max-width:768px){
            body{padding:15px}
            .login-box{padding:30px 25px}
            .login-logo{font-size:3rem}
            .login-title{font-size:1.5rem}
            .login-subtitle{font-size:.9rem}
            .header h1{font-size:1.5rem}
            .header p{font-size:.9rem}
        }
        @media (max-width:480px){
            .login-box{padding:25px 20px}
            .login-logo{font-size:2.5rem}
            .login-title{font-size:1.3rem}
            .login-form .form-control{padding:15px}
            .login-btn{padding:16px;font-size:16px}
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>لوحة تحكم المسؤول</h1>
        <p>نظام الشكاوى الموحد - إدارة الشكاوى والطلبات المقدمة من المواطنين</p>
    </div>

    <div class="login-container">
        <div class="login-box">
            <div class="login-logo">
                <i class="fas fa-user-shield"></i>
            </div>
            <h2 class="login-title">تسجيل دخول المسؤول</h2>
            <p class="login-subtitle">أدخل بيانات الدخول للوصول إلى لوحة التحكم</p>
            
            <form id="loginForm" class="login-form">
                <div class="form-group">
                    <label class="form-label">اسم المستخدم</label>
                    <input type="text" class="form-control" id="username" placeholder="أدخل اسم المستخدم" required autofocus>
                </div>
                <div class="form-group">
                    <label class="form-label">كلمة المرور</label>
                    <input type="password" class="form-control" id="password" placeholder="أدخل كلمة المرور" required>
                </div>
                <div class="login-error" id="loginError">
                    <i class="fas fa-exclamation-triangle"></i>
                    اسم المستخدم أو كلمة المرور غير صحيحة
                </div>
                <button type="submit" class="login-btn" id="loginButton">
                    <i class="fas fa-sign-in-alt"></i>
                    تسجيل الدخول
                </button>
            </form>
            
            <div class="login-footer">
                <p><i class="fas fa-info-circle"></i> للدعم الفني: <a href="https://www.facebook.com/en.mohamed.nasr" target="_blank">المهندس محمد حماد</a></p>
            </div>
        </div>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <div id="pwaNotification" class="pwa-notification"></div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <script>
        // =============== تكوين Firebase ===============
        const firebaseConfig = {
            apiKey: "AIzaSyBIIStbiZD0ZJ6su7C1bwZlBvqx-PP-t58",
            authDomain: "shakawa-e0a3c.firebaseapp.com",
            databaseURL: "https://shakawa-e0a3c-default-rtdb.firebaseio.com",
            projectId: "shakawa-e0a3c",
            storageBucket: "shakawa-e0a3c.firebasestorage.app",
            messagingSenderId: "111620348664",
            appId: "1:111620348664:web:670fdf5caed46eb691b90d",
            measurementId: "G-SGNTJZDQ1L"
        };

        // تهيئة Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // =============== دوال المساعدة ===============
        let messageTimeout = null;
        
        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
        
        function showMessage(text, type = 'success') {
            if (messageTimeout) clearTimeout(messageTimeout);
            
            const oldMessage = document.querySelector('.message');
            if (oldMessage) oldMessage.remove();
            
            const div = document.createElement('div');
            div.className = 'message' + (type === 'error' ? ' error' : '');
            div.innerHTML = `<i class="fas ${type === 'error' ? 'fa-exclamation-circle' : 'fa-check-circle'}"></i> ${text}`;
            document.body.appendChild(div);
            
            messageTimeout = setTimeout(() => {
                div.remove();
            }, 4000);
        }
        
        function showPwaNotification(message, type = 'info') {
            const toast = document.getElementById('pwaNotification');
            if (!toast) return;
            
            const colors = {
                success: 'linear-gradient(135deg, #1a5fb4, #2d8fd5)',
                error: 'linear-gradient(135deg, #e74c3c, #c0392b)',
                info: 'linear-gradient(135deg, #3498db, #2980b9)'
            };
            
            toast.style.background = colors[type] || colors.info;
            toast.innerHTML = message;
            toast.style.display = 'block';
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    toast.style.display = 'none';
                    toast.style.animation = '';
                }, 300);
            }, 3000);
        }
        
        // =============== دالة تسجيل الدخول ===============
        async function handleLogin(username, password) {
            showLoading();
            
            try {
                // مسؤول رئيسي
                if (username === 'admin' && password === '742018') {
                    const userData = {
                        name: 'المكتب الخدمي للنائب أحمد الحديدي',
                        username: 'admin',
                        role: 'admin',
                        loginTime: new Date().toISOString()
                    };
                    
                    // حفظ بيانات الجلسة
                    localStorage.setItem('adminLoggedIn', 'true');
                    localStorage.setItem('adminUser', JSON.stringify(userData));
                    
                    // تسجيل عملية الدخول
                    await logLogin(username, 'admin', 'الدخول كمدير رئيسي');
                    
                    showMessage('تم تسجيل الدخول بنجاح', 'success');
                    
                    setTimeout(() => {
                        window.location.href = 'admin.html';
                    }, 1000);
                    return;
                }
                
                // البحث في قاعدة بيانات المستخدمين
                const snapshot = await database.ref('users').once('value');
                const users = snapshot.val() || {};
                let userFound = false;
                
                for (const key in users) {
                    const user = users[key];
                    if (user.username === username && user.password === password) {
                        const userData = {
                            name: user.name,
                            username: user.username,
                            role: user.role || 'user',
                            departments: user.departments || [],
                            loginTime: new Date().toISOString()
                        };
                        
                        // حفظ بيانات الجلسة
                        localStorage.setItem('adminLoggedIn', 'true');
                        localStorage.setItem('adminUser', JSON.stringify(userData));
                        
                        // تسجيل عملية الدخول
                        await logLogin(username, user.role, `الدخول كمستخدم: ${user.name}`);
                        
                        showMessage(`مرحباً ${user.name}!`, 'success');
                        
                        setTimeout(() => {
                            window.location.href = 'admin.html';
                        }, 1000);
                        
                        userFound = true;
                        break;
                    }
                }
                
                if (!userFound) {
                    document.getElementById('loginError').style.display = 'block';
                    showPwaNotification('اسم المستخدم أو كلمة المرور غير صحيحة', 'error');
                }
                
            } catch (error) {
                console.error('Error during login:', error);
                showMessage('حدث خطأ في الخادم، يرجى المحاولة مرة أخرى', 'error');
            } finally {
                hideLoading();
            }
        }
        
        // =============== دالة تسجيل عمليات الدخول ===============
        async function logLogin(username, role, details) {
            try {
                const logData = {
                    username: username,
                    role: role,
                    details: details,
                    timestamp: new Date().toISOString(),
                    ipAddress: await getIPAddress()
                };
                
                await database.ref('loginLogs').push(logData);
            } catch (error) {
                console.error('Error logging login:', error);
            }
        }
        
        // =============== دالة الحصول على عنوان IP ===============
        async function getIPAddress() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch {
                return 'غير معروف';
            }
        }
        
        // =============== تهيئة التطبيق ===============
        document.addEventListener('DOMContentLoaded', function() {
            // التحقق من وجود جلسة سابقة
            const isLoggedIn = localStorage.getItem('adminLoggedIn') === 'true';
            if (isLoggedIn) {
                window.location.href = 'admin.html';
                return;
            }
            
            // إضافة مستمع لزر الدخول
            const loginForm = document.getElementById('loginForm');
            if (loginForm) {
                loginForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const username = document.getElementById('username').value.trim();
                    const password = document.getElementById('password').value;
                    
                    if (!username || !password) {
                        showMessage('يرجى ملء جميع الحقول', 'error');
                        return;
                    }
                    
                    handleLogin(username, password);
                });
            }
            
            // جعل زر Enter يضغط على زر الدخول
            document.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.target.closest('textarea')) {
                    document.getElementById('loginButton').click();
                }
            });
            
            // تسجيل الحدث لضمان أن التطبيق تم تحميله
            console.log('Admin login page loaded successfully');
            
            // إظهار إشعار ترحيبي
            setTimeout(() => {
                showPwaNotification('مرحباً بك في لوحة تحكم نظام الشكاوى', 'info');
            }, 1000);
        });
        
        // =============== PWA Installation ===============
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // عرض زر التثبيت
            setTimeout(() => {
                showPwaNotification('يمكنك تثبيت التطبيق على شاشتك الرئيسية للوصول السريع', 'info');
            }, 3000);
        });
        
        window.addEventListener('appinstalled', () => {
            showPwaNotification('تم تثبيت التطبيق بنجاح!', 'success');
        });
    </script>
</body>
</html>
